<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>AngularJs route segment plugin | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2014/03/angularjs-route-segment-plugin/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2014/03/angularjs-route-segment-plugin/">AngularJs route segment plugin</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>26 Mar 2014</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/JavaScript">JavaScript</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h3>关于AngularJs</h3>
<p>AngularJs确实是一个很方便的Web开发框架，基本上以前最头痛的MVC分层，AJAX回调，数据绑定，显示管理，等等等等，angular都帮你做好了。而且最逆天的一点是你只需要最基本的js知识就可以进行开发了，angular将需要的技能堆栈都埋在里面了，开发者只需要使用最angular暴露出来的接口就行了。当然，这篇文章不是用来歌颂angularjs多么好用的。在开发过程中，你还是会发现angular有很多不支持的功能点，这个时候就不得不借助开源社区的能量了，你总是能找到很多好用的插件。</p>
<h3>我们遇到的问题</h3>
<p>这里，我们需要解决的问题是：angular官方并不支持在route跳转的时候，不刷新页面进行跳转。这么说可能有点抽象，举例来说。试想一下，我们现在有个站点，有一个货物列表页面，其中货物分为大类、小类、物品本身这样的层次。而页面的布局则是：</p>
<ul>
<li>最上面的nav（在任何页面跳转发生时，你都不希望它们被刷新）</li>
<li>左边第一栏，是货物大类列表，在页面刷新出来的时候从服务端取得该列表（在后续的分类及货物id变动跳转的时候，这部分不应该被刷新）</li>
<li>左边第二栏，是货物小类列表，即物品id列表，在选中某个大类的时候，从服务端取得该列表（在货物id变动跳转的时候，这部分不应该被刷新）</li>
<li>右边栏，具体的物品信息内容，在选中货物小类列表中的物品id的时候，从服务端获得并显示该页内容</li>
</ul>
<p>针对这样的需求，angular官方只能完全刷新整个页面，而不能做到我们上述的需求。这个时候，我们需要第三方的插件辅助。</p>
<h3>插件选择</h3>
<p>综合下来，可选的插件主要有两款：</p>
<ul>
<li><a href="http://angular-ui.github.io/" target="_blank">AngularUI</a>团队下的<a href="https://github.com/angular-ui/ui-router" target="_blank">UI-Router</a>插件</li>
<li><a href="http://angular-route-segment.com/" target="_blank">angular-route-segment</a>插件</li>
</ul>
<p>从行文标题就可以看出，我选择的是下者，angular-route-segment插件，理由我觉得segment插件作者网站上说的很清楚了：</p>
<blockquote><p>While it seems that this library has very similar goal to what <a href="https://github.com/angular-ui/ui-router/">UI-Router</a> provides, there are some important differences between their implementations, though.</p>
<p><em>UI-Router</em> implements its own URL routing mechanics with its own "state" concept on top of it.<em>angular-route-segment</em> doesn't try to replace something in AngularJS. It is based on built-in <code>$route</code> engine, so that it tries to extend it rather than to replace. <code>$routeSegmentProvider.when</code> method is just a shorthand to <code>$routeProvider.when </code>with the simplified syntax. Inner segment-handling logic is built on top of events propagated by <code>$route</code> service, with internal usage of some route params from it.</p>
<p>Such approach makes it possible to accomplish the desired nested routing task in more simpler manner, which produces less code, less complexity and potential bugs, provides better cohesion with Angular core engine and is easier to understand, use and debug.</p></blockquote>
<p>我做选择的时候有两点标准：</p>
<ul>
<li>易学易懂：这点很重要，segment明显比较容易上手，基本上没有新的概念，只需要熟悉几个segment函数就可以上手了</li>
<li>功能足够：不求万能全能，只要能满足需求就足够了</li>
</ul>
<p>当然，segment也有缺点，在我写这篇文章的时候，segment只有225个start，且已经2个月没更新了，最新的版本只支持angular的1.2.x版本，angular最新的发展方向1.3还未有支持的动静。反观UI-Router，2501个star，13个小时前刚更新过。从支持上来说，无疑是UI-Router更好。AngularUI团队下的东西都不错，虽然这个UI-Router我不是很满意。</p>
<p>segment还有一个很致命的问题就是，作者在写tutorial的时候，并没有很系统地介绍使用方法和设计中的几个关键的点，导致使用的时候发现各种不可理解的状况的发生。我是下载了github上的源码，玩了example一阵之后才完全理解的。</p>
<h3>segment的学习</h3>
<h4>类库引入和依赖注入</h4>
<p>[codesyntax lang="html4strict"]</p>
<pre>&lt;script src="../build/angular-route-segment.min.js"&gt;&lt;/script&gt;</pre>
<p>[/codesyntax]</p>
<p>或者使用requirejs，都可以。</p>
<p>在定义angular的app的时候，记得要进行依赖申明，这里必须记住一点，因为设计上segment是在angular route上的扩展，所以它是依赖于angular route插件的 。</p>
<p>[codesyntax lang="javascript"]</p>
<pre>var app = angular.module('app', ['ngRoute', 'route-segment', 'view-segment']);</pre>
<p>[/codesyntax]</p>
<h4>简单使用</h4>
<p>segment插件的使用分为两部分，一部分是和angular route差不多的app.config定义，另一部分则是页面上的directive使用。源代码也很清晰地分为了route-segment.js和view-segment.js两部分。</p>
<p>app.config举个例子来看：</p>
<p>[codesyntax lang="javascript"]</p>
<pre>app.config([
    "$routeProvider", "$routeSegmentProvider",
function($routeProvider, $routeSegmentProvider) {
    $routeSegmentProvider.options.autoLoadTemplates = true;
    $routeSegmentProvider.options.strictMode = true;
    $routeSegmentProvider.
        when("/item",                                     "item").
        when("/item/category/:categoryId",                "item.items").
        when("/item/category/:categoryId/item/:itemId",   "item.items.detail").
        when("/others",                                   "data").
        when("/others/data/:dataId",                      "data.detail").
        // ITEM
        segment("item", {
            "templateUrl": VIEW_URL + "item/home.html",
            "controller": "AppItemCtrl"
        }).
        within().
            segment("items", {
                "templateUrl":VIEW_URL + "item/items.html",
                "controller": "AppItemListModuleCtrl",
                "dependencies": ["categoryId"]
            }).
            within().
                segment("detail", {
                    "templateUrl": VIEW_URL + "item/detail.html",
                    "controller": "AppItemDetailCtrl",
                    "dependencies": ["itemId"]
                }).
        up().up().
        // DATA
        segment("data", { /* ... */ });
    $routeProvider.otherwise({redirectTo: "/item"});
}]);</pre>
<p>[/codesyntax]</p>
<p>这里的when语法和angular route的when不同，参数一都是path，但是参数二从route object换成了segment name，这里的segment名字需要小心，必须以“.”来分隔展现层次。比如说我刚才举的例子里的：“item”，“item.items”，“item.items.detail”。</p>
<p>segment函数则起到了之前when函数里route object定义的作用。dependencies很有用，表示的是path里的哪个/些参数变动的时候，该segment负责的展示区域会被刷新。</p>
<p>within是向下行走一个层级，up则是向上行走一个层级。</p>
<p>这里需要注意，作者并没有将otherwise继承到segment里去，所以需要定义otherwise的时候还必须注入原始的$routeProvider，这个真心无力吐槽。</p>
<p>directive很简单，在页面上写一句：</p>
<p>[codesyntax lang="html4strict"]</p>
<pre>&lt;div app-view-segment="0"&gt;&lt;/div&gt;</pre>
<p>[/codesyntax]</p>
<p>就OK了。</p>
<p>这里需要理解app-view-segment属性中的0，到底是什么意思。这里的0表示的是0级的segment。在刚才给的例子中，“item”、“data”都属于0级的segment，而“item.items”、“data.detail”则是1级的segment，“item.items.detail”则属于2级的segment。</p>
<p>插件会在页面上的directive处，检查当前的path所对应的segment配置，如果层级相符合，则将template植入该directive处。</p>
<p>这里吐槽下，这么重要的功能点，在官方的文档中居然是没解释的，我拿下example搞了半天才明白过来。</p>
<h4>范例分析</h4>
<p>回到我们一开始定义的问题场景上来。我们分解开来看这个页面流程。</p>
<h5>index页</h5>
<p>首先我们需要主页的nav永远不需要被刷新，index本体结构也不需要被刷新。那么这里我们需要index.html和一个固定controller相搭配，这个controller负责的仅仅只是提供segment对象到scope里，判断nav的高亮。</p>
<p>[codesyntax lang="html4strict"]</p>
<pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
    &lt;head&gt;
        &lt;!-- ... --&gt;
        &lt;script type="application/javascript"&gt;
            function AppNavCtrl($scope, $routeSegment) {
                $scope.segment = $routeSegment;
            }
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="navbar navbar-inverse navbar-fixed-top" ng-controller="AppNavCtrl"&gt;
            &lt;div class="container"&gt;
                &lt;div class="navbar-header"&gt;
                    &lt;a class="navbar-brand" href="#/item"&gt;仓储系统&lt;/a&gt;
                &lt;/div&gt;
                &lt;div class="navbar-collapse collapse"&gt;
                    &lt;ul class="nav navbar-nav"&gt;
                        &lt;li ng-class="{active: segment.startsWith('item')}"&gt;&lt;a href="#/item"&gt;物品列表&lt;/a&gt;&lt;/li&gt;
                        &lt;li ng-class="{active: segment.startsWith('data')}"&gt;&lt;a href="#/data"&gt;物品数据&lt;/a&gt;&lt;/li&gt;
                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="container"&gt;
            &lt;div class="row" app-view-segment="0"&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
<p>[/codesyntax]</p>
<p>这里为了演示方便，直接将首页的nav controller写在head里了，其实应该是和angular其他的controller放在同一个地方的。需要注意的地方有两点。</p>
<p>第一，segment中配置的path及其对应的controller，因为有route自动触发，所以不需要在HTML中写死，而nav的controller，因为在segment里没有配置（为了不被path更改而刷新），所以这里必须在nav的HTML上写上controller，以便在angular启动的时候给nav的scope传递segment对象。</p>
<p>第二，这里使用了segment.startWith方法，判断了页面的当前path是否应该在nav上高亮。</p>
<h5>item主页 / 大分类</h5>
<p>根据我们配置的segment：</p>
<p>[codesyntax lang="javascript"]</p>
<pre>...
when("/item", "item").
...
segment("item", {
    "templateUrl": VIEW_URL + "item/home.html",
    "controller": "AppItemCtrl"
}).
...</pre>
<p>[/codesyntax]</p>
<p>在item首页，我们会在directive app-view-segment="0" 的地方引入 “item/home.html” 这个template，并启动AppItemCtrl。这个controller会调用service，获取到物品的大分类，并展示在左边栏的第一列：</p>
<p>[codesyntax lang="html4strict"]</p>
<pre>&lt;div class="row"&gt;
    &lt;div class="col-md-2"&gt;
        &lt;!-- 这里负责显示物品大分类列表 --&gt;
    &lt;/div&gt;
    &lt;div class="col-md-3" app-view-segment="1"&gt;
        &lt;!-- 这里负责显示物品小分类 --&gt;
    &lt;/div&gt;
    &lt;div class="col-md-7" app-view-segment="2"&gt;
        &lt;!-- 这里负责显示物品细节 --&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre>
<p>[/codesyntax]</p>
<h5>item小分类 / item列表</h5>
<p>这里的controller负责获取当前物品大分类下的物品id列表，并进行展示。因为没有牵涉到结构性的部分，这里的controller代码和HTML代码就不需要展示了。</p>
<h5>item细节</h5>
<p>同上，这里的controller负责获得当前物品id所对应的物品细节，并进行展示。</p>
<p>这样，我们在一开始提出的angular原生不可解决问题，就已经完全解决了。</p>
<h3>Bug</h3>
<p>segment插件我用到现在有一个蛮大的bug，就是在配置了dependencies的segment，在url跳转的时候，即便segment的根节点已经完全不是当前segment了，只要path中的dependencies改变了，该segment还是会被触发。</p>
<p>举例来说：当前页面是：“/item/category/:categoryId/item/:itemId”，当离开这个页面的时候，即便我去的是“/data”这个完全不同的segment，item.items.detail这个segemnt还是会被触发。</p>
<p>鉴于segment插件已经2个月没有更新，且github上issues完全没有人理会的情况下，我也就没有去报这个bug了。</p>
<p>现在的解决方法是在有配置dependencies项的segment的controller里，进行</p>
<p>[codesyntax lang="javascript"]</p>
<pre>if (typeof $routeSegment.$routeParams.itemId === 'undefined') {
    return; // wrong route page
}</pre>
<p>[/codesyntax]</p>
<p>这样的检查。</p>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2018/01/node-profile/">Node.JS Profile</a></li>
    
    <li><a href="/2018/01/embedded-github-code/">Github 代码片段嵌入</a></li>
    
    <li><a href="/2018/01/graphql/">GraphQL笔记</a></li>
    
    <li><a href="/2017/12/msgpack-http/">Message Pack 解析问题</a></li>
    
    <li><a href="/2017/12/why-anxiety/">到底在焦虑什么</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2014/03/angularjs-route-segment-plugin/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2016</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
