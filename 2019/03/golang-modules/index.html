<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Golang Modules | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2019/03/golang-modules/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
  <style>
    /* Enhance table style */
    table {
      border: 2px solid #4F7849;
      background-color: #EEEEEE;
      width: 100%;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table.comicGreen th {
      border: 1px solid #4F7849;
      padding: 3px 5px;
    }
    table tbody td {
      font-size: 14px;
      color: #4F7849;
    }
    table tr:nth-child(even) {
      background: #CEE0CC;
    }
    table thead {
      background: #4F7849;
      border-bottom: 1px solid #444444;
    }
    table thead th {
      font-size: 16px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #D0E4F5;
      padding: 3px 5px;
    }
    table thead th:first-child {
      border-left: none;
    }
    table tfoot td {
      font-size: 21px;
    }

    /* Enhance pre style */
    pre {
      color: #FFFFFF;
      background-color: #000000;
      border-color: #000000;
    }

    /* Image bg color white while dark background */
    img {
      background-color: #FFFFFF;
    }

    /* Keep gist style clean */
    .gist table tr:nth-child(even) {
      background: #FFFFFF;
    }
    .gist td, th {
      border: none;
    }
  </style>
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2019/03/golang-modules/">Golang Modules</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>08 Mar 2019</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/Golang">Golang</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#1-前言" id="markdown-toc-1-前言">1. 前言</a></li>
  <li><a href="#2-历史--展望" id="markdown-toc-2-历史--展望">2. 历史 &amp; 展望</a></li>
  <li><a href="#3-官方文档" id="markdown-toc-3-官方文档">3. 官方文档</a></li>
  <li><a href="#GO_MOD_USE" id="markdown-toc-GO_MOD_USE">4. 使用 &amp; 常用命令</a>    <ul>
      <li><a href="#go111module" id="markdown-toc-go111module">GO111MODULE</a></li>
      <li><a href="#go-mod-init" id="markdown-toc-go-mod-init">go mod init</a></li>
      <li><a href="#go-get--u" id="markdown-toc-go-get--u">go get (-u)</a></li>
      <li><a href="#go-mod-graph" id="markdown-toc-go-mod-graph">go mod graph</a></li>
      <li><a href="#go-mod-download" id="markdown-toc-go-mod-download">go mod download</a></li>
      <li><a href="#go-mod-tidy" id="markdown-toc-go-mod-tidy">go mod tidy</a></li>
    </ul>
  </li>
  <li><a href="#5-模块定义--文件结构" id="markdown-toc-5-模块定义--文件结构">5. 模块定义 &amp; 文件结构</a>    <ul>
      <li><a href="#代码根目录的约定" id="markdown-toc-代码根目录的约定">代码根目录的约定</a></li>
      <li><a href="#模块定义官方范例" id="markdown-toc-模块定义官方范例">模块定义官方范例</a></li>
    </ul>
  </li>
  <li><a href="#6-版本定义--更新" id="markdown-toc-6-版本定义--更新">6. 版本定义 &amp; 更新</a>    <ul>
      <li><a href="#tag的命名规范" id="markdown-toc-tag的命名规范">tag的命名规范</a></li>
      <li><a href="#版本选择" id="markdown-toc-版本选择">版本选择</a></li>
      <li><a href="#版本引入" id="markdown-toc-版本引入">版本引入</a></li>
      <li><a href="#如何更新依赖的版本" id="markdown-toc-如何更新依赖的版本">如何更新依赖的版本</a></li>
    </ul>
  </li>
  <li><a href="#GO_MOD_FILE" id="markdown-toc-GO_MOD_FILE">7. 补充：go.mod &amp; replace指令</a>    <ul>
      <li><a href="#replace指令" id="markdown-toc-replace指令">replace指令</a></li>
    </ul>
  </li>
  <li><a href="#8-实际经验" id="markdown-toc-8-实际经验">8. 实际经验</a></li>
  <li><a href="#资料" id="markdown-toc-资料">资料</a></li>
</ul>

<h1 id="1-前言">1. 前言</h1>
<p>本文是Go语言系列文章<a href="/2019/02/golang-note/" target="_blank">Golang Notes</a>的其中一篇，完整的文章列表请去总章查看。</p>

<p>后续<code>模块</code>相关技术文字内容主要参考自官方wiki说明：<a href="https://github.com/golang/go/wiki/Modules" target="_blank">Go 1.11 Modules</a>。强烈建议有时间的可以自己通读一遍，任何第三方的讲解都不可能比这篇原文更详细、更细节。这是我见过的最<code>啰嗦</code>的技术说明文章之一。</p>

<p><strong>UPDATE 2019-03-21</strong></p>

<p>官方博客3.19姗姗来迟了一篇模块博文，算是补足了正规渠道的引导：<a href="https://blog.golang.org/using-go-modules" target="_blank">The Go Blog &gt; Using Go Modules</a>。比起之前的wiki，这篇博客算是做了点总结，不像wiki那么啰嗦了。</p>

<h1 id="2-历史--展望">2. 历史 &amp; 展望</h1>
<p>Go语言的包管理可以说是黑历史了，1.5之前基本上没有解决方案，1.5开始出了个vendor<code>文件夹</code>，后面几个版本大部分的工具都围绕着这个文件夹做文章。最后终于到了1.11版本才出了个官方的modules解决方案（vgo），算是尘埃落定。估计一开始做语言设计的时候，大佬觉得包管理根本没必要，怎么随意怎么来。结果后面大厂们都开始用go语言构建大型系统和生态了，才慢慢暴露出问题，文件下载随便一扔的解决方案太过随意，有太多太多的不安定要素。</p>

<p>我之前一直对go语言持观望态度（即便是这两年最火的时候），就是因为这个包管理的原因。于是到了1.11，我终于开始觉得可以入手了。</p>

<p>1.11正式release的module这个功能应该说是稳定了，后面理论上不会再有很大的改动。这从官方给的modules wiki就可以看得出来，洋洋洒洒长篇累牍写了那么长一篇文章。</p>

<p>当然以目前的现状来说，仍旧远不能称完善，这里可以简单展望一下：</p>

<ul>
  <li>包搜索过于困难：没有一个服务能根据需求功能进行包搜索（类似<a href="https://www.npmjs.com/" target="_blank">www.npmjs.org</a>）</li>
  <li>包有可能不存在：这问题之前npm遇到过，发布者将库删了，结果依赖它的一堆库都挂了。npm的解决方案比较野蛮，所有上了npm的包不允许删除，永远会留在里面，就杜绝了库消失的问题。go在这方面更弱，很多东西都是一个地址，要是github库被作者删了，或者转private了，马上就出问题，而且还没人管得着</li>
</ul>

<p>这些问题官方应该都是有意识到的，具体可以看这篇官方的博客：<a href="https://blog.golang.org/modules2019" target="_blank">Go Modules in 2019</a></p>

<h1 id="3-官方文档">3. 官方文档</h1>
<p>除了github那篇wiki，go语言的官网上并没有针对modules的详细文档（当然从内容上来说那篇也够了）。倒是命令行工具的help里有点内容（因内容过长，这里就不贴了，有兴趣的可以直接用命令查看，建议用<code>&gt; ~/Downloads/xxx.txt</code>方式输出查看）：</p>

<ul>
  <li>go help go.mod</li>
  <li>go help modules</li>
  <li>go help module-get</li>
</ul>

<h1 id="GO_MOD_USE">4. 使用 &amp; 常用命令</h1>
<p>正常使用modules的情况下，其实你并不需要特别做什么，一般就：</p>

<ul>
  <li>使用go mod init创建模块定义文件</li>
  <li>使用go get命令下载对应的依赖（或是更新对应的依赖）</li>
  <li>使用go build / go install命令来进行编译</li>
</ul>

<p>和modules功能出来之前没有任何不同，所有的模块管理工作在go的一系列命令中已经默认完成了。比如说<code>go build</code>或<code>go test</code>，等等，在执行这些命令的时候会自动对代码进行分析，找到缺失的依赖下载并将信息写入到对应的go.mod文件中。</p>

<h2 id="go111module">GO111MODULE</h2>
<p>这个环境变量用来控制是否启用modules功能，还是按之前的套路来处理go的包管理。一般来说都用这个版本了，没什么理由不把这个打开（<code>export GO111MODULE=on</code>）。如果你的代码是放在GOPATH之外的，那么默认就是打开的，放在GOPATH里的，默认是关闭的（我试下来是如此）。</p>

<h2 id="go-mod-init">go mod init</h2>
<p>初始化代码模块，本质上就是创建一个go.mod文件。关于go.mod，可以看<a href="#GO_MOD_FILE">这里</a>。</p>

<h2 id="go-get--u">go get (-u)</h2>
<p>获取或更新代码，同时会更新对应的go.mod文件。对modules来说，这个命令更多用在更新依赖的版本。</p>

<h2 id="go-mod-graph">go mod graph</h2>
<p>打印模块依赖图，也就是打印出模块之间的依赖关系。</p>

<h2 id="go-mod-download">go mod download</h2>
<p>将依赖下载到本地cache。这个命令的应用场景一般是一个成熟项目，go.mod文件已经编辑好了，协同工作的成员可以在拉下代码之后直接用这个命令进行下载，然后就可以开始工作了。</p>

<h2 id="go-mod-tidy">go mod tidy</h2>
<p>添加缺失的依赖，并移除没有使用的依赖。算是一个清理工具，一般在做版本的时候比较常用。</p>

<p>如果你在使用<code>go mod init</code>命令创建好一个干净空的go.mod文件之后，使用的是<code>go build</code>命令来进行对应的包解析和下载的话（同时go.mod文件的内容也生成了），之后你再使用<code>go mod tidy</code>来进行清理会发现：多出来很多之前<code>go build</code>命令没有放进go.mod文件的包。</p>

<p>这里官方有一个解释：<a href="https://github.com/golang/go/wiki/Modules#why-does-go-mod-tidy-record-indirect-and-test-dependencies-in-my-gomod" target="_blank">Why does ‘go mod tidy’ record indirect and test dependencies in my ‘go.mod’?</a></p>

<p>另，其他命令，例如’go build’和’go test’不会从go.mod移除依赖，即便是那些不再被需要的依赖。实质上会在go.mod里进行删除操作的，就只有<code>go mod tidy</code>这个命令。</p>

<h1 id="5-模块定义--文件结构">5. 模块定义 &amp; 文件结构</h1>
<h2 id="代码根目录的约定">代码根目录的约定</h2>
<p>一般来说，一个go项目就是一个github代码仓库。go语言的最佳实践是一个包一个文件夹，包名和文件夹名重合。所以这里其实就有一个约定，定死的，github仓库的根目录<code>必须</code>是代码的根目录。</p>

<blockquote>
  <p>github.com/my/repo/package_name/code.go  <br />
=&gt;  <br />
/Users/xxx/Codes/Golang/repo/package_name/code.go</p>

  <p>import “github.com/my/repo/package_name”</p>
</blockquote>

<p>如果不是这么放，下载下来的代码文件和代码中的import路径就不一致了，会导致找不到代码。</p>

<p>你不可以自己映射一个文件夹作为代码的根节点，比如说：/Users/xxx/Codes/Golang/repo/<code>src</code>/package_name/code.go。对于有强迫症的人来说，这还蛮恶心的。</p>

<p>几个例子可以看下（gin特别极端，所有源码就散落在根目录下，只有一个包，叫gin）：</p>

<ul>
  <li><a href="https://github.com/gin-gonic/gin" target="_blank">gin-gonic/gin</a></li>
  <li><a href="https://github.com/prometheus/prometheus" target="_blank">prometheus/prometheus</a></li>
</ul>

<h2 id="模块定义官方范例">模块定义官方范例</h2>
<p>如果你要在代码仓库 github.com/my/repo 创建一个包含两个包（如下列举）的模块：</p>

<ul>
  <li>github.com/my/repo/foo</li>
  <li>github.com/my/repo/bar</li>
</ul>

<p>那么你的go.mod文件的第一行将会定义一个模块，命名为：github.com/my/repo，而磁盘上的文件结构如下：</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>repo/
├── go.mod
├── bar
│   └── bar.go
└── foo
    └── foo.go</code></pre></figure>

<h1 id="6-版本定义--更新">6. 版本定义 &amp; 更新</h1>
<p>在<a href="#GO_MOD_USE">之前</a>我们已经说到，modules的出现并没有天翻地覆改变我们日常工作使用的命令和流程，但我们仍旧需要了解modules的很多细节，才能保证不犯错。这一节关于版本号相关的知识非常细节，也相当重要。</p>

<h2 id="tag的命名规范">tag的命名规范</h2>
<p>对于tag的命名，Go官方有明确的要求，不可以按自己的想法随便写。值得注意的点只有一点就是三位的版本号之前，必须添加一个<code>v</code>，也就是说，所有的版本号都应该是：<code>v1.2.3</code>这样的，而<code>不是</code> <code>1.2.3</code>这样。</p>

<p>看两个例子，打开链接之后观察下他们的版本号列表：</p>

<ul>
  <li>Node.js的web服务器：<a href="https://github.com/expressjs/express" target="_blank">expressjs/express</a></li>
  <li>Go的web服务器：<a href="https://github.com/gin-gonic/gin" target="_blank">gin-gonic/gin</a></li>
</ul>

<h2 id="版本选择">版本选择</h2>
<p>wiki原文可以查看：<a href="https://github.com/golang/go/wiki/Modules#version-selection" target="_blank">Version Selection</a></p>

<p>主要内容是说明在使用一些go命令，比如说’go build’、’go test’的时候，这些命令会怎么选择依赖的版本号。这里需要关注的是，如果有多个依赖对某个依赖都有版本要求，且版本号并不一致，这种情况下会发生什么：</p>

<blockquote>
  <p>As an example, if your module depends on module A which has a require D v1.0.0, and your module also depends on module B which has a require D v1.1.1, then minimal version selection would choose v1.1.1 of D to include in the build (given it is the highest listed require version). This selection of v1.1.1 remains consistent even if some time later a v1.2.0 of D becomes available. This is an example of how the modules system provides 100% reproducible builds. When ready, the module author or user might choose to upgrade to the latest available version of D or choose an explicit version for D.</p>
</blockquote>

<ul>
  <li>在工具第一次处理同个依赖的多处引入的情况下，会引入该依赖的最高版本。</li>
  <li>这个版本会在此后保持不变（go.mod中），即便这个依赖的新版本被release出来（作者更新）。这是为了保证产品100%可重复构建。用户可以自行选择升级与否。</li>
</ul>

<hr />

<p>值得注意的是原文wiki中有一句：</p>

<blockquote>
  <p>require M v1.2.3, which indicates module M is a dependency with allowed version &gt;= v1.2.3 (and &lt; v2, given v2 is considered incompatible with v1)</p>
</blockquote>

<p>我没理解这是什么意思，后续需要尝试。猜测：</p>

<ul>
  <li>虽然go.mod文件中对于M的版本定义是v1.2.3，但允许的版本可以&gt;=v1.2.3，并小于v2.x.x大版本</li>
  <li>如果git clone一个带go.mod文件的库（clone下来的时候磁盘上无cache文件），使用go mod download，go.mod里对于这个库的定义是v1.2.3，但最新的release是v1.3.9，那么会下载v1.3.9？</li>
</ul>

<h2 id="版本引入">版本引入</h2>
<p>wiki原文可以查看：<a href="https://github.com/golang/go/wiki/Modules#semantic-import-versioning" target="_blank">Semantic Import Versioning</a></p>

<p>使用过modules之后，会发现某些依赖的引入的最后带上了<code>.vN</code>这样的字符，这里有点细节可以看下：</p>

<p>major版本是v2或更高的，在require的时候都需要在路径最后带上<code>.vN</code>（官方给的例子里是<code>/vN</code>，但我实际看下来几个包都是<code>.vN</code>，先按实际例子来吧），比如说：</p>

<ul>
  <li>require gopkg.in/go-playground/validator.v8 v8.18.2</li>
  <li>require gopkg.in/yaml.v2 v2.2.2</li>
</ul>

<p>此外，在使用的时候（import）：<code>example&amp;#46;com/my/mod/mypkg</code>和<code>example&amp;#46;com/my/mod.v2/mypkg</code>被认为是两个不同的包，会分开下载安装，且不会影响最后的编译。</p>

<h2 id="如何更新依赖的版本">如何更新依赖的版本</h2>
<p>日常中对依赖进行版本升级或降级，应该使用<code>go get</code>命令：</p>

<ul>
  <li><code>go get dep</code>将依赖升级到最新版本（等同于<code>go get dep@latest</code>）</li>
  <li><code>go get -u dep</code>将依赖升级到最新的minor或者patch版本</li>
  <li><code>go get -u=patch dep</code>将依赖升级到最新的patch版本</li>
  <li><code>go get dep@v1.2.3</code>将依赖升级（或降级）到指定版本</li>
</ul>

<p>注意：使用<code>go get -u</code>或<code>go get -u=patch</code>将会一并更新<code>dep</code>的所有直接和间接依赖。最佳实践是先不要带上<code>-u</code>参数运行<code>go get</code>，更新完成没有问题之后，再带上<code>-u=patch</code>，然后<code>-u</code>，逐步更新。更新依赖的时候也最好一个一个更新，便于排查。</p>

<p>此外，同样会对go.mod文件进行更改的一系列命令，比如：’go build’、’go test’，或者是’go list’，会自动添加新需要的依赖进入go.mod来满足依赖（更新go.mod文件，并下载对应的新依赖）。</p>

<ul>
  <li>如果要查看所有可以使用的直接或间接依赖升级，请使用命令：<code>go list -u -m all</code></li>
  <li>如果需要查看一个依赖的可用版本，请使用命令：<code>go list -m -versions $depname</code></li>
</ul>

<p>这部分，更详细的可以参见：<a href="https://github.com/golang/go/wiki/Modules#how-to-upgrade-and-downgrade-dependencies" target="_blank">How to Upgrade and Downgrade Dependencies</a></p>

<h1 id="GO_MOD_FILE">7. 补充：go.mod &amp; replace指令</h1>
<p>官方wiki里关于go.mod的说明可以看这里：<a href="https://github.com/golang/go/wiki/Modules#gomod" target="_blank">go.mod</a>。</p>

<p>go.mod文件里的指令有：</p>

<ul>
  <li>module, to define the module path;</li>
  <li>go, to set the expected language version;</li>
  <li>require, to require a particular module at a given version or later;</li>
  <li>exclude, to exclude a particular module version from use; and</li>
  <li>replace, to replace a module version with a different module version.</li>
</ul>

<p>注意：exclude和replace指令只在主模块的go.mod文件中生效，在依赖中则会被忽略。</p>

<p>比如说依赖库里用到了 golang.org/x 里的包，你因为网络关系，在你自己的go.mod将这个库replace掉了，但下载完成之后你会发现在cache里还是会有golang.org/x的代码文件，因为第三方依赖可能用到它们了。</p>

<h2 id="replace指令">replace指令</h2>
<p>在go.mod文件中，用得比较频繁的指令一般就只有require和replace。require不用多说，非常简单，replace还是有点细节的。</p>

<p>一般的使用场景：</p>

<ul>
  <li>使用本地代码：replace example.com/original/import/path =&gt; /your/forked/import/path</li>
  <li>指定特定版本：replace example.com/some/dependency =&gt; example.com/some/dependency v1.2.3</li>
  <li>指定特定下载地址（特别适合国内）：replace golang.org/x/dependency =&gt; github.com/golang/dependency</li>
</ul>

<p>replace是一个指令，所以它是和require同等级别，相同的使用方法，并不是要和require组合起来使用的，单独使用即可。replace指令引入的包也会直接下载。</p>

<p>可以试验下下面的例子：</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>require <span class="o">(</span>
	...
<span class="o">)</span>

replace golang.org/x/net <span class="o">=</span>&gt; github.com/golang/net v0.0.0-20190301231341-16b79f2e4e95</code></pre></figure>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;fmt&quot;</span>
	<span class="s">&quot;golang.org/x/net/html&quot;</span>
	<span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">z</span><span class="p">,</span> <span class="nx">errp</span> <span class="o">:=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="s">&quot;&lt;html&gt;&lt;/html&gt;&quot;</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">errp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">errp</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<h1 id="8-实际经验">8. 实际经验</h1>
<p>如果定义一个模块名为<code>test-module</code>（一般不会这么干，都是以代码仓库为模块名，e.g <code>github.com/gin-gonic/gin</code>）。</p>

<p>则：</p>

<ul>
  <li>go.mod文件第一行为：<code>module test-module</code></li>
  <li>该模块代码文件必须存放在<code>$GOPATH/src/test-module</code>下</li>
  <li>代码包申明及引用相关：
    <ul>
      <li>代码文件的物理文件夹位置即包名</li>
      <li>源码文件中的包名申明只需要路径的最后一段在代码中写明，不需要完整路径
        <ul>
          <li>e.g</li>
          <li><code>test-module/lib/dao</code></li>
          <li>代码中的包为<code>package dao</code></li>
        </ul>
      </li>
      <li>其他代码引用的时候永远以模块名为起始，不能使用相对路径，即便是同模块的其他代码，e.g <code>import "test-module/lib/dao"</code></li>
      <li>正因此，go项目的源码总是散在根目录下面的，不可以自行组织子文件夹
        <ul>
          <li>✗ <code>$GOPATH/src/test-module/src/lib/dao</code></li>
          <li>✗ <code>$GOPATH/src/test-module/dao/lib/dao</code></li>
          <li>√ <code>$GOPATH/src/test-module/lib/dao</code></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>这也是为什么我的<a href="https://github.com/agreatfool/dist-system-practice" target="_blank">分布式实践项目代码库</a>不能作为一个go模块来使用，因为我的实践代码库中，源代码相关内容并不是存放在根目录下面的。</p>

<pre><code>dist-system-practice /-
                      | ... # 其他大量资料
                      | golang /- # 自定义的$GOPATH
                                | src /-
                                       | dist-system-practice # 这里才是真正的项目代码
</code></pre>

<p>而要作为一个go模块来使用，则文件结构只能是：</p>

<pre><code>dist-system-practice /-
                      | # 这里直接就是源码了
                      | lib 
                      | vendors
                      | web
                      | ...
</code></pre>

<p>代码直接放在代码库根目录下。</p>

<h1 id="资料">资料</h1>
<ul>
  <li><a href="https://github.com/golang/go/wiki/Modules" target="_blank">Go 1.11 Modules</a></li>
  <li><a href="https://blog.golang.org/modules2019" target="_blank">Go Modules in 2019</a></li>
  <li><a href="https://windmt.com/2018/11/08/first-look-go-modules/" target="_blank">Go 包管理解决之道 —— Modules 初试</a></li>
</ul>

<blockquote>
  <p>EOF</p>
</blockquote>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2019/12/wxpay/">微信支付接入</a></li>
    
    <li><a href="/2019/12/alipay/">支付宝接入</a></li>
    
    <li><a href="/2019/12/docker-registry/">Docker Registry 的简单使用</a></li>
    
    <li><a href="/2019/12/gitea-note/">Gitea简单介绍及使用</a></li>
    
    <li><a href="/2019/12/consul-note/">Consul Notes</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
      <li><a href="/category/V8Blog">V8Blog</a></li>
    
      <li><a href="/category/Docker">Docker</a></li>
    
      <li><a href="/category/Golang">Golang</a></li>
    
      <li><a href="/category/Career">Career</a></li>
    
      <li><a href="/category/Prometheus">Prometheus</a></li>
    
      <li><a href="/category/Grafana">Grafana</a></li>
    
      <li><a href="/category/Logging">Logging</a></li>
    
      <li><a href="/category/Jaeger">Jaeger</a></li>
    
      <li><a href="/category/Elasticsearch">Elasticsearch</a></li>
    
      <li><a href="/category/MessageQueue">MessageQueue</a></li>
    
      <li><a href="/category/Kafka">Kafka</a></li>
    
      <li><a href="/category/gRPC">gRPC</a></li>
    
      <li><a href="/category/Envoy">Envoy</a></li>
    
      <li><a href="/category/DistributedSystem">DistributedSystem</a></li>
    
      <li><a href="/category/Tor">Tor</a></li>
    
      <li><a href="/category/Node.js">Node.js</a></li>
    
      <li><a href="/category/CI">CI</a></li>
    
      <li><a href="/category/ServiceDiscovery">ServiceDiscovery</a></li>
    
      <li><a href="/category/Git">Git</a></li>
    
      <li><a href="/category/Payment">Payment</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2019/03/golang-modules/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2019</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
