<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Elasticsearch Notes | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2019/04/elasticsearch-note/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
  <style>
    /* Enhance table style */
    table {
      border: 2px solid #4F7849;
      background-color: #EEEEEE;
      width: 100%;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table.comicGreen th {
      border: 1px solid #4F7849;
      padding: 3px 5px;
    }
    table tbody td {
      font-size: 14px;
      color: #4F7849;
    }
    table tr:nth-child(even) {
      background: #CEE0CC;
    }
    table thead {
      background: #4F7849;
      border-bottom: 1px solid #444444;
    }
    table thead th {
      font-size: 16px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #D0E4F5;
      padding: 3px 5px;
    }
    table thead th:first-child {
      border-left: none;
    }
    table tfoot td {
      font-size: 21px;
    }

    /* Enhance pre style */
    pre {
      color: #FFFFFF;
      background-color: #000000;
      border-color: #000000;
    }

    /* Image bg color white while dark background */
    img {
      background-color: #FFFFFF;
    }

    /* Keep gist style clean */
    .gist table tr:nth-child(even) {
      background: #FFFFFF;
    }
    .gist td, th {
      border: none;
    }
  </style>
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2019/04/elasticsearch-note/">Elasticsearch Notes</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>25 Apr 2019</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/Elasticsearch">Elasticsearch</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/SearchEngine">SearchEngine</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Monitor">Monitor</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Metrics">Metrics</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Analytics">Analytics</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/DevOps">DevOps</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Keynote">Keynote</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#1-前言" id="markdown-toc-1-前言">1. 前言</a></li>
  <li><a href="#2-log-shipper" id="markdown-toc-2-log-shipper">2. Log Shipper</a>    <ul>
      <li><a href="#21-横向比较--选择" id="markdown-toc-21-横向比较--选择">2.1 横向比较 &amp; 选择</a></li>
      <li><a href="#22-架构设计" id="markdown-toc-22-架构设计">2.2 架构设计</a></li>
    </ul>
  </li>
  <li><a href="#3-filebeat" id="markdown-toc-3-filebeat">3. Filebeat</a>    <ul>
      <li><a href="#31-设计--基础概念" id="markdown-toc-31-设计--基础概念">3.1 设计 &amp; 基础概念</a></li>
      <li><a href="#32-使用" id="markdown-toc-32-使用">3.2 使用</a></li>
      <li><a href="#33-模块" id="markdown-toc-33-模块">3.3 模块</a></li>
      <li><a href="#34-过滤和丰富" id="markdown-toc-34-过滤和丰富">3.4 过滤和丰富</a></li>
      <li><a href="#35-文件状态记录--投递保证" id="markdown-toc-35-文件状态记录--投递保证">3.5 文件状态记录 &amp; 投递保证</a></li>
    </ul>
  </li>
  <li><a href="#4-elasticsearch" id="markdown-toc-4-elasticsearch">4. Elasticsearch</a>    <ul>
      <li><a href="#41-知识点" id="markdown-toc-41-知识点">4.1 知识点</a>        <ul>
          <li><a href="#411-基础概念" id="markdown-toc-411-基础概念">4.1.1 基础概念</a></li>
          <li><a href="#412-安装--配置" id="markdown-toc-412-安装--配置">4.1.2 安装 &amp; 配置</a></li>
          <li><a href="#413-api" id="markdown-toc-413-api">4.1.3 API</a></li>
          <li><a href="#414-query-dsl" id="markdown-toc-414-query-dsl">4.1.4 Query DSL</a></li>
          <li><a href="#415-sql" id="markdown-toc-415-sql">4.1.5 SQL</a></li>
          <li><a href="#416-ingest节点" id="markdown-toc-416-ingest节点">4.1.6 Ingest节点</a></li>
        </ul>
      </li>
      <li><a href="#ID_INDEX" id="markdown-toc-ID_INDEX">4.2 文档数据库 &amp; 索引</a>        <ul>
          <li><a href="#421-index-template" id="markdown-toc-421-index-template">4.2.1 Index Template</a></li>
          <li><a href="#422-设置index生命周期" id="markdown-toc-422-设置index生命周期">4.2.2 设置index生命周期</a></li>
          <li><a href="#423-index的自动创建设置" id="markdown-toc-423-index的自动创建设置">4.2.3 Index的自动创建设置</a></li>
        </ul>
      </li>
      <li><a href="#ID_STORAGE" id="markdown-toc-ID_STORAGE">4.3 存储</a></li>
      <li><a href="#ID_ARC_CLUSTER" id="markdown-toc-ID_ARC_CLUSTER">4.4 集群</a></li>
      <li><a href="#45-监控--高可用" id="markdown-toc-45-监控--高可用">4.5 监控 &amp; 高可用</a>        <ul>
          <li><a href="#451-监控" id="markdown-toc-451-监控">4.5.1 监控</a></li>
          <li><a href="#452-高可用" id="markdown-toc-452-高可用">4.5.2 高可用</a></li>
        </ul>
      </li>
      <li><a href="#46-性能调优" id="markdown-toc-46-性能调优">4.6 性能调优</a></li>
    </ul>
  </li>
  <li><a href="#5-kibana" id="markdown-toc-5-kibana">5. Kibana</a>    <ul>
      <li><a href="#ID_INDEX_PATTERN" id="markdown-toc-ID_INDEX_PATTERN">5.1 Index Pattern</a></li>
      <li><a href="#52-使用简介" id="markdown-toc-52-使用简介">5.2 使用简介</a></li>
      <li><a href="#53-qa" id="markdown-toc-53-qa">5.3 Q&amp;A</a></li>
    </ul>
  </li>
  <li><a href="#6-filebeat直连elasticsearch实践" id="markdown-toc-6-filebeat直连elasticsearch实践">6. Filebeat直连Elasticsearch实践</a>    <ul>
      <li><a href="#61-直连流程" id="markdown-toc-61-直连流程">6.1 直连流程</a></li>
      <li><a href="#62-应用场景" id="markdown-toc-62-应用场景">6.2 应用场景</a></li>
      <li><a href="#ID_INDEX_TEMPLATE" id="markdown-toc-ID_INDEX_TEMPLATE">6.3 Index Template</a></li>
      <li><a href="#64-issues" id="markdown-toc-64-issues">6.4 Issues</a>        <ul>
          <li><a href="#641-filebeat字段层级" id="markdown-toc-641-filebeat字段层级">6.4.1 Filebeat字段层级</a></li>
          <li><a href="#642-kibana-message字段" id="markdown-toc-642-kibana-message字段">6.4.2 Kibana message字段</a></li>
          <li><a href="#643-input--processors-fields" id="markdown-toc-643-input--processors-fields">6.4.3 input | processors fields</a></li>
          <li><a href="#ID_FILEBEAT_INDEX_TEMPLATE" id="markdown-toc-ID_FILEBEAT_INDEX_TEMPLATE">6.4.4 Index Template设置</a></li>
          <li><a href="#645-切片数量" id="markdown-toc-645-切片数量">6.4.5 切片数量</a></li>
          <li><a href="#646-kibana-timestamp" id="markdown-toc-646-kibana-timestamp">6.4.6 Kibana @timestamp</a></li>
          <li><a href="#647-elasticsearch-预创建数据" id="markdown-toc-647-elasticsearch-预创建数据">6.4.7 Elasticsearch 预创建数据</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#7-实践范例" id="markdown-toc-7-实践范例">7. 实践范例</a></li>
  <li><a href="#8-docker集群部署" id="markdown-toc-8-docker集群部署">8. Docker集群部署</a>    <ul>
      <li><a href="#ID_ES_CONFIG" id="markdown-toc-ID_ES_CONFIG">8.1 Elasticsearch配置</a>        <ul>
          <li><a href="#811-环境变量配置" id="markdown-toc-811-环境变量配置">8.1.1 环境变量配置</a></li>
          <li><a href="#812-多节点配置的共享" id="markdown-toc-812-多节点配置的共享">8.1.2 多节点配置的共享</a></li>
          <li><a href="#813-集群发现相关配置" id="markdown-toc-813-集群发现相关配置">8.1.3 集群发现相关配置</a></li>
        </ul>
      </li>
      <li><a href="#82-kibana配置" id="markdown-toc-82-kibana配置">8.2 Kibana配置</a></li>
      <li><a href="#83-filebeat配置" id="markdown-toc-83-filebeat配置">8.3 Filebeat配置</a></li>
    </ul>
  </li>
  <li><a href="#9-todo" id="markdown-toc-9-todo">9. TODO</a></li>
  <li><a href="#资料" id="markdown-toc-资料">资料</a>    <ul>
      <li><a href="#链接" id="markdown-toc-链接">链接</a></li>
    </ul>
  </li>
</ul>

<h1 id="1-前言">1. 前言</h1>
<p>之前做了Prometheus和Jaeger相关的调研工作，这两者虽然也涉及到日志聚合相关的技术或是类似的技术，但毕竟不是通用的日志聚合系统。通用的日志聚合系统需要能接受任何类型的日志，并将其索引入库以备后续的查询。市面上这方面的产品现在基本上是Elasticsearch为主要选择，已经可以说是很成熟了。所以这块需求我这里也是以ELK为第一备选进行相关的调研。</p>

<p>后续的调研内容版本如下：</p>

<pre><code>elasticsearch 7.0.0
elastic/filebeat 7.0.0
kibana 7.0.0
</code></pre>

<p>在提到Elasticsearch的时候我们一般不会只说Elasticsearch本身，而是会提到<code>ELK</code>这个词，这里说的其实就是从日志采集、清洗、转换、分发、到最后入库的整个流程，以及查询用的面板包含在内的一整套生态。因此下面行文会从：日志采集、日志存储、日志查询三方面着手。</p>

<p>官方文档：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/index.html" target="_blank">Elastic Stack and Product Documentation</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/index.html" target="_blank">Elasticsearch Reference</a></li>
  <li><a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/index.html" target="_blank">Filebeat Reference</a></li>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/index.html" target="_blank">Kibana User Guide</a></li>
</ul>

<h1 id="2-log-shipper">2. Log Shipper</h1>
<p>日志是在各个应用程序中生产的，此外也包括了操作系统级别的日志生产。因此日志的产生这个行为是分散在各个节点上的，日志的收集就是从分散的节点采集数据汇集到中心存储的一个过程，这也是所谓的<code>聚合</code>。而从分散的节点上采集数据，我们需要Agent（Log Shipper）来执行这个操作。</p>

<p>经典的<code>ELK</code>中，<code>L</code>代表的就是日志采集Agent：Logstash。当然，市面上也有非常多的其他选择，可以做到和Logstash类似的功能。从系统设计上来说，ELK三者本身是完全解耦分离的，所以所谓的ELK堆栈，只是一种经过验证的实践方案，其实中间除了E之外，L和K都是可以自由更换的。</p>

<h2 id="21-横向比较--选择">2.1 横向比较 &amp; 选择</h2>
<p>关于日志采集组件的备选有大量横向比较，推荐阅读：<a href="https://sematext.com/blog/logstash-alternatives/" target="_blank">5 Logstash Alternatives</a>。这篇的时间还算比较新<code>2018-10-09</code>，讲解也非常到位，基本上看这篇就OK了。</p>

<p>此外，<a href="https://gist.github.com/StevenACoffman/4e267f0f60c8e7fcb3f77b9e504f3bd7" target="_blank">StevenACoffman/fluent-filebeat-comparison.md</a>也可以看下。</p>

<p>排除比较年轻的项目，以及资历不太雄厚的项目，剩下的主要选项有三个：</p>

<ul>
  <li>Logstash
    <ul>
      <li>优势：功能强大；经过实践检验</li>
      <li>劣势：资源占用过大；JVM</li>
    </ul>
  </li>
  <li>Filebeat
    <ul>
      <li>优势：Go语言；部署简单；资源占用极小</li>
      <li>劣势：功能相对简单</li>
    </ul>
  </li>
  <li>Fluentd
    <ul>
      <li>优势：CNCF孵化项目</li>
      <li>劣势：Ruby语言实现</li>
    </ul>
  </li>
</ul>

<p>Log Shipper作为每个应用程序都需要附加的边车组件其中之一，Logstash的内存和CPU消耗在某些情况下是完全不能接受的（1GB内存，开玩笑）。JVM众所周知是比较难搞的虚拟机，如果要用好，调优需要有非常专门的知识，所以算是一个减分项。但放在Elasticsearch堆栈上来说，倒也不是那么严重，因为你无论如何都需要JVM知识来调优Elasticsearch本身。功能强大是Logstash的最大优势，能满足基本上所有的应用场景，在某些架构上，即便使用了Filebeat等高效轻量级的Log Shipper，在进入Elasticsearch入库之前仍旧需要一个Logstash来进行转换等工作。</p>

<p>Filebeat基本上没有缺点，如果它的功能能满足你的需求的话。如果不能满足，那么最新的Kafka输出能解决你的问题。使用Filebeat作为边车的Log Shipper，输出到Kafka，然后使用Logstash或者自己编写的组件来消费Kafka里的日志，最终入库到Elasticsearch。</p>

<p>Fluentd的最大优势在于CNCF的加持（背书）。但基于我多年的编程经验，ruby的性能一般来说是不可靠的，甚至使用JVM的Logstash都已经为性能付出了过大的代价，我又有什么理由要去相信口碑一直不怎么样的ruby呢。Logstash至少使用的JVM还和Elasticsearch本身是一个技术栈的，Fluentd会引入一个完全新的ruby虚拟机，就更加增加系统复杂度了。甚至，我在调研的初期就随手找到了：<a href="https://github.com/fluent/fluentd/issues/1657" target="_blank">Fluentd retains excessive amounts of memory after handling traffic peaks #1657</a>，<code>2017年</code>的BUG，到现在还是<code>Open状态</code>。</p>

<p>综上所述，任何情况下都应该使用Filebeat作为边车的Log Shipper。Filebeat能满足需求的直接入库到Elasticsearch，不能满足需求的日志进Kafka，然后使用Logstash或其他Consumer来进行转换，最终入库到Elasticsearch。</p>

<h2 id="22-架构设计">2.2 架构设计</h2>
<p><img src="/resources/2019/04/elasticsearch-note/log_shipper_arc.jpg" alt="Architecture" target="_blank" /></p>

<p>图中的Logstash部分可以替换成自编写的轻量级Consumer。</p>

<h1 id="3-filebeat">3. Filebeat</h1>
<p>非常细节的使用及配置，可以查看这篇中文的博客：<a href="https://www.cnblogs.com/cjsblog/p/9495024.html" target="_blank">Filebeat 模块与配置</a>。</p>

<h2 id="31-设计--基础概念">3.1 设计 &amp; 基础概念</h2>
<p><img src="/resources/2019/04/elasticsearch-note/filebeat.png" alt="Architecture" target="_blank" /></p>

<p>这张图看看就好，意义不大。</p>

<p>Filebeat是一种<a href="https://www.elastic.co/cn/products/beats" target="_blank">Elastic Beat</a>，其实现基于<code>libbeat</code>框架，更多的可以查看：<a href="https://www.elastic.co/guide/en/beats/libbeat/7.0/index.html" target="_blank">Beats Platform Reference</a>。</p>

<p>工作流：</p>

<ul>
  <li>输入：从指定的文件进行监控日志增加行为，并触发读取发送</li>
  <li>输出：可直接向Elasticsearch集群发送日志，也可以将日志输出到外部的消息队列（Kafka）里</li>
  <li>模块：对某些日志进行的采集行为及Elasticsearch集群对这些日志进行分析的配置化和固化</li>
  <li>消费：Elasticsearch集群解析日志入库，或从Kafka读取日志然后解析入库</li>
</ul>

<h2 id="32-使用">3.2 使用</h2>
<p>部分说明文档：</p>

<ul>
  <li>安装请参照：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-installation.html#filebeat-installation" target="_blank">Step 1: Install Filebeat</a></li>
  <li>配置请参照：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-configuration.html#filebeat-configuration" target="_blank">Step 2: Configure Filebeat</a></li>
  <li>容器内运行：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/running-on-docker.html#running-on-docker" target="_blank">Running Filebeat on Docker</a></li>
</ul>

<h2 id="33-模块">3.3 模块</h2>
<p>官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-modules-overview.html" target="_blank">Modules overview</a>。</p>

<blockquote>
  <p>Elasticsearch Ingest Node pipeline definition, which is used to parse the log lines.</p>
</blockquote>

<p>首先明确一点，Filebeat的模块并不是一般意义上的<code>功能模块</code>。按软件设计思维来说，模块意味着功能的拓展，意味着根据模块设计的要求（框架）可以将软件本身能做的事情大幅拓展。而Filebeat的模块则不是，在Filebeat里，模块意味着一系列既有行为的组合：</p>

<ul>
  <li>Nginx有两个日志：access和error</li>
  <li>Nginx在Elasticsearch上处理的Ingest Pipeline是XXX</li>
  <li>Nginx的日志格式是XXX，Elasticsearch里对应的字段是XXX</li>
  <li>Nginx日志对应的Kibana面板有XXX，可以看到XXX数据</li>
</ul>

<p>从上面的例子可见：Filebeat本身并没有做什么，它做的仍旧只是采集日志，发送出去，没了。只不过指定了Elasticsearch集群中处理这个日志的Ingest Pipeline是谁，日志应该怎么入库（事情是在Elasticsearch集群上完成的）。因此在功能性上Filebeat是<code>不可能替代</code>Logstash的，它的定位只是轻量级的应用端Log Shipper，如果要在功能上覆盖Logstash的功能点，就需要使用Elasticsearch自身的Ingest Pipeline，仍旧需要Filebeat以外的系统支持。</p>

<p>部分文档：</p>

<ul>
  <li>如何创建一个新的模块：<a href="https://www.elastic.co/guide/en/beats/devguide/7.0/filebeat-modules-devguide.html#filebeat-modules-devguide" target="_blank">Creating a New Filebeat Module</a></li>
  <li>模块清单：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-modules.html#filebeat-modules" target="_blank">Modules</a></li>
  <li>命令行列出模块：</li>
</ul>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ docker run --rm <span class="se">\</span>
    --name filebeat <span class="se">\</span>
    elastic/filebeat:7.0.0 modules list</code></pre></figure>

<h2 id="34-过滤和丰富">3.4 过滤和丰富</h2>
<p>Filebeat可以在配置中指定一些受限的过滤和清洗功能：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filtering-and-enhancing-data.html" target="_blank">Filter and enhance the exported data</a>。</p>

<p>可选的processor清单有：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/defining-processors.html#processors" target="_blank">Define processors</a>。</p>

<p>触发的条件：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/defining-processors.html#conditions" target="_blank">Conditions</a>。</p>

<h2 id="35-文件状态记录--投递保证">3.5 文件状态记录 &amp; 投递保证</h2>
<p>Filebeat对于输入的日志文件，会制作一个本地的注册文件，将状态都保存下来，因此在重启或者挂掉重新拉起来之后，Filebeat总是能知道之前发送到哪里。</p>

<p>Filebeat会保证本地的日志文件至少被输出一次，如果在输出的结果返回之前Filebeat就挂掉的话，在下次Filebeat启动之后，它还会将之前最后的日志再投递一次（对于Filebeat来说，它并不知道自己死前已经投递过一次，并被输出方接收到了）。因此，收取数据的服务端<code>可能</code>在某些情况下收到<code>重复的数据</code>。</p>

<h1 id="4-elasticsearch">4. Elasticsearch</h1>
<p>2套电子书非常不错：</p>

<ul>
  <li><a href="https://fdv.github.io/running-elasticsearch-fun-profit/" target="_blank">Operating Elasticsearch for Fun and Profit</a></li>
  <li><a href="https://es.xiaoleilu.com/index.html" target="_blank">Elasticsearch 权威指南（中文版）</a></li>
</ul>

<p>对于作为Elasticsearch底层的Lucene有兴趣的，可以查看这篇：<a href="https://www.infoq.cn/article/ejEG02VRoeGVaLw4j_LL" target="_blank">Lucene 查询原理及解析</a>。</p>

<h2 id="41-知识点">4.1 知识点</h2>
<p>这一节基本上都是简单的知识点和概念罗列，主要阐明：”这是什么”。详细的内容会在后续的章节里分析。</p>

<h3 id="411-基础概念">4.1.1 基础概念</h3>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/getting-started-concepts.html#getting-started-concepts" target="_blank">Basic Concepts</a>。</p>

<p>提到了几点：</p>

<ul>
  <li>Near Realtime (NRT)</li>
  <li>Cluster</li>
  <li>Node</li>
  <li>Index</li>
  <li>Document</li>
  <li>Shards &amp; Replicas</li>
</ul>

<h3 id="412-安装--配置">4.1.2 安装 &amp; 配置</h3>
<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker" target="_blank">Install Elasticsearch with Docker</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/settings.html#settings" target="_blank">Configuring Elasticsearch</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/jvm-options.html#jvm-options" target="_blank">Setting JVM options</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/important-settings.html#important-settings" target="_blank">Important Elasticsearch configuration</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/system-config.html#system-config" target="_blank">Important System Configuration</a></li>
</ul>

<p>后面三条对生产环境影响比较大，需要仔细阅读。更贴近实践的范例可以参见：<a href="#ID_ES_CONFIG">8.1 Elasticsearch配置</a>。</p>

<h3 id="413-api">4.1.3 API</h3>
<p>Elasticsearch的API文档相当散，主要是以下几项：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs.html" target="_blank">Document APIs</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search.html" target="_blank">Search APIs</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search-aggregations.html" target="_blank">Aggregations</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/indices.html" target="_blank">Indices APIs</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat.html" target="_blank">cat APIs</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cluster.html" target="_blank">Cluster APIs</a></li>
</ul>

<p>API最常见的用途是对Elasticsearch集群进行观察，并进行一些例如Index Template设置之类的，超乎于日常日志输入相关业务之外的管理和控制。</p>

<h3 id="414-query-dsl">4.1.4 Query DSL</h3>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/query-dsl.html" target="_blank">Query DSL</a>。</p>

<p>了解Elasticsearch的人肯定会问：Query DSL和Elasticsearch的基础Lucene之间是什么关系。关于这个知识点可以查看：<a href="https://stackoverflow.com/questions/27793721/what-is-the-difference-between-lucene-and-elasticsearch" target="_blank">What is the difference between Lucene and Elasticsearch</a>。</p>

<blockquote>
  <p>Elasticsearch is a JSON Based, Distributed, web server build over Lucene. Though it’s Lucene who is doing the actual work beneath, Elasticsearch provides us a convenient layer over Lucene. Each shard that gets created in Elasticsearch is a separate Lucene instance.</p>
</blockquote>

<p>Lucene是底层，Elasticsearch是基于Lucene之上的超集开发，而QueryDSL则是用户和Elasticsearch之间交互的桥梁。</p>

<h3 id="415-sql">4.1.5 SQL</h3>
<p>Elasticsearch还可以使用SQL进行查询：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/xpack-sql.html" target="_blank">SQL access</a>。</p>

<h3 id="416-ingest节点">4.1.6 Ingest节点</h3>
<p>在整个<a href="#ID_ARC_CLUSTER">Elasticsearch集群</a>中，有一部分节点是用来进行日志过滤、清洗、丰富化的，这些工作在这个设计出现之前是只能在Agent上实现的，一般来说就是Logstash，而现在在服务器节点上也可以处理相对应的工作了。</p>

<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/ingest.html#ingest" target="_blank">Ingest Node</a>。</p>

<p>通过定义Processors来进行日志的解析和处理：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/ingest-processors.html#ingest-processors" target="_blank">Processors</a>。</p>

<p>初步了解下来功能应该还算强大，可以使用脚本化代码进行功能拓展：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/script-processor.html#script-processor" target="_blank">Script Processor</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/modules-scripting-using.html#modules-scripting-using" target="_blank">How to use scripts</a></li>
</ul>

<p>此外还有插件机制：<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.0/ingest.html#ingest" target="_blank">Ingest Plugins</a>。</p>

<h2 id="ID_INDEX">4.2 文档数据库 &amp; 索引</h2>
<p>Elasticsearch是一个文档数据库，从本质上来看，它和Mongo其实相当类似。和传统RDBMS比较起来：</p>

<pre><code>Relational DB -&gt; Databases -&gt; Tables  -&gt; Rows      -&gt; Columns
Elasticsearch -&gt; Cluster   -&gt; Indices -&gt; Documents -&gt; Fields
</code></pre>

<p>简单理解：所谓的索引就是<code>表名</code>，用来定位查询以及根据该名字进行分片sharding。</p>

<p>举个例子：
PUT /employee/1</p>

<p>Index：<code>employee</code>  <br />
Document：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
    <span class="nt">&quot;first_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
    <span class="nt">&quot;last_name&quot;</span> <span class="p">:</span>  <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
    <span class="nt">&quot;age&quot;</span> <span class="p">:</span>        <span class="mi">25</span><span class="p">,</span>
    <span class="nt">&quot;about&quot;</span> <span class="p">:</span>      <span class="s2">&quot;I love to go rock climbing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;interests&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sports&quot;</span><span class="p">,</span> <span class="s2">&quot;music&quot;</span> <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>Fields：</p>

<ul>
  <li>first_name</li>
  <li>last_name</li>
  <li>age</li>
  <li>about</li>
  <li>interests</li>
</ul>

<p>索引非常重要，在集群模式（cluster）中，索引是用来进行分区的唯一指标。Elasticsearch会根据Index来决定当前数据落到哪台实际的存储服务器上。</p>

<p>此外，需要注意，Index可以被Reindex，但不可以Reshard。换句话说，在Index被创建出来的时候，其shards数量就已经被固定下来了，以后不可更改。如果有这样的需求的话，必须使用Reindex来重新分配并平衡Index，已经创建出来的就没办法了。而Replicas则可以随时更改数量。</p>

<p>关于索引的细节，以及一些集群相关的索引知识，可以查看：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs-index_.html" target="_blank">Index API</a>。</p>

<h3 id="421-index-template">4.2.1 Index Template</h3>
<p>和索引（<code>Index</code>）息息相关的有一个概念叫：<code>Index Template</code>。这部分比较重要也稍微有点复杂，后面会结合实际实践一并解释，会更容易理解：<a href="#ID_INDEX_TEMPLATE">6.3 Index Template</a>。</p>

<h3 id="422-设置index生命周期">4.2.2 设置index生命周期</h3>
<p>一般实践的时候，建议不要向单个Index内放入过多的文档，这会对写入和查询都造成比较大的压力。比较常见的做法是对输出端进行设置，将日志的输出索引设置成按日划分：<code>index: "dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}"</code>，这样就有一个最基本的保障。但这样做的缺陷一样非常明显，当单日的业务量上涨之后，单日的日志量可能就比较夸张。</p>

<p>在Elasticsearch中，Index的生命周期有另外的管理方法：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/getting-started-index-lifecycle-management.html#getting-started-index-lifecycle-management" target="_blank">Getting started with index lifecycle management</a>。</p>

<p>同时需要在Filebeat端进行配合：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/ilm.html" target="_blank">Configure index lifecycle management</a>。</p>

<h3 id="423-index的自动创建设置">4.2.3 Index的自动创建设置</h3>
<p>在大部分情况下Elasticsearch都是允许自动创建Index的。在某些情况下可能需要关闭自动创建的允许权限，可以参见文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs-index_.html#index-creation" target="_blank">Automatic Index Creation</a>，来查看如何操作。</p>

<h2 id="ID_STORAGE">4.3 存储</h2>
<p>在官方手册文档中，并没有关于存储相关的设计及实现的详细内容。在Blog中找到一篇：<a href="https://www.elastic.co/blog/found-dive-into-elasticsearch-storage" target="_blank">A Dive into the Elasticsearch Storage</a>，不过时间也稍微有点久，但还算可以用来一窥存储相关的技术点。</p>

<p>此外，<strong>shards：Lucene segments</strong></p>

<blockquote>
  <p>Each Elasticsearch index is divided into shards. Shards are both logical and physical division of an index. Each Elasticsearch shard is a Lucene index. The maximum number of documents you can have in a Lucene index is 2,147,483,519. The Lucene index is divided into smaller files called segments. A segment is a small Lucene index. Lucene searches in all segments sequentially.</p>
</blockquote>

<p><img src="/resources/2019/04/elasticsearch-note/elk_shards.png" alt="elk_shards" target="_blank" /></p>

<h2 id="ID_ARC_CLUSTER">4.4 集群</h2>
<p>关于架构和集群的基础概念可以阅读官方的一份PPT：<a href="https://www.elastic.co/pdf/architecture-best-practices.pdf" target="_blank">Elasticsearch Best Practice Architecture</a>。</p>

<p>主要是了解下Elasticsearch集群的节点分类：</p>

<p><img src="/resources/2019/04/elasticsearch-note/elk_node_types.png" alt="elk_node_types" target="_blank" /></p>

<p>然后看下之前提到过的ELK整体集群拓扑：</p>

<p><img src="/resources/2019/04/elasticsearch-note/elk_arch.png" alt="elk_arch" target="_blank" /></p>

<p>此外推荐一篇：<a href="https://thoughts.t37.net/designing-the-perfect-elasticsearch-cluster-the-almost-definitive-guide-e614eabc1a87" target="_blank">Designing the Perfect Elasticsearch Cluster: the (almost) Definitive Guide</a>。</p>

<p>在官方的文档库中我并没有找到比较新版本的文档有讲解到分布式和高可用之类的架构设计内容，大部分的文档都是各种API和各种细节。在老的版本中倒是找到一点信息：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_how_primary_and_replica_shards_interact.html" target="_blank">How Primary and Replica Shards Interact</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/distrib-write.html" target="_blank">Creating, Indexing, and Deleting a Document</a></li>
</ul>

<p>此外，中文书里的内容也可以阅读：<a href="https://es.xiaoleilu.com/020_Distributed_Cluster/00_Intro.html" target="_blank">集群内部工作方式</a>，注意这本中文书的版本已经相当老了，里面的内容有部分和现在的版本明显不同。</p>

<p>几点整理：</p>

<ul>
  <li>replica与数据主节点并不一定是1：1的关系（并不一定一个master拖一个slave这样的设计），这个replica节点数量是可设置的，一个主节点可能有多份完全一致的replica</li>
  <li>当你的replica设置越多，写入速度就越慢（参与的节点多），主节点写入完毕之后还要让所有的replica写入，全部都完成才会返回客户端完成</li>
  <li>当你的replica设置越多，查询（读取）速度就越快（参与的节点多）</li>
  <li>当发生查询请求时，查询请求是会落到所有的shard上的，所以集群shards做的越多，整个集群的查询性能开销就越大，这里就有一个平衡的问题</li>
</ul>

<h2 id="45-监控--高可用">4.5 监控 &amp; 高可用</h2>
<h3 id="451-监控">4.5.1 监控</h3>
<p>对于Elasticsearch的监控，官方有一套解决方案（Elasticsearch算是一个生态了，在上游和下游都有完整的处理）。可以查阅下官方文档：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/es-monitoring.html" target="_blank">Monitoring Elasticsearch</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/setup-xpack.html#setup-xpack" target="_blank">Set up X-Pack</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/getting-started-cluster-health.html#getting-started-cluster-health" target="_blank">Cluster Health</a></li>
</ul>

<p>当然也可以选用Prometheus作为监控：</p>

<ul>
  <li><a href="https://github.com/vvanholl/elasticsearch-prometheus-exporter" target="_blank">Prometheus Exporter Plugin for Elasticsearch</a></li>
</ul>

<h3 id="452-高可用">4.5.2 高可用</h3>
<p><strong>数据节点数量选择</strong></p>

<ul>
  <li><a href="https://thoughts.t37.net/resizing-your-elasticsearch-indexes-in-production-d7a0402d137e" target="_blank">Resizing your Elasticsearch Indexes in Production</a></li>
  <li><a href="https://www.signalfx.com/blog/scaling-elasticsearch-sharding-availability-hundreds-millions-documents/" target="_blank">Scaling Elasticsearch: Sharding and Availability for Hundreds Of Millions of Documents</a>：这篇当中有一段讲解了<code>Resharding With Zero Downtime</code>，这是非常有价值的一个topic</li>
</ul>

<p><strong>可恢复的集群最低配置</strong></p>

<ul>
  <li>3 locations to host your nodes. 2 locations to run half of your cluster, and one for the backup master node.</li>
  <li>3 master nodes. You need an odd number of eligible master nodes to avoid split brains when you lose a whole data center. Put one master node in each location so you hopefully never lose the quorum.</li>
  <li>2 http nodes, one in each primary data center.</li>
  <li>As many data nodes as you need, split evenly between both main locations.</li>
</ul>

<p><strong>故障恢复</strong></p>

<p>Elasticsearch在集群中分主节点shard和复制节点replica，当集群的设置足够多（数据冗余充分）的情况下，当某个物理节点不可用时，Elasticsearch会自动进行选举，将丢失的主节点shard的replica节点设置成主节点，并重新对集群进行平衡。举个例子：</p>

<p>事故发生前：</p>

<ul>
  <li>一共有3个物理节点</li>
  <li>一共有3个主节点shard</li>
  <li>每个主节点shard有2个复制节点replica</li>
  <li>当前物理节点1是作为整个集群的master节点进行服务的</li>
  <li>后续事故会发生在物理节点1，这个节点会下线</li>
</ul>

<p><img src="/resources/2019/04/elasticsearch-note/elk_ha_01.png" alt="Before" target="_blank" /></p>

<p>事故发生后：</p>

<ul>
  <li>master节点下线了，因此集群重新开始选取master节点，设定为物理节点2</li>
  <li>0号主节点shard（P0）本来就在物理节点3上，因此不受影响</li>
  <li>1号和2号主节点shard之前在物理节点1上，全部丢失，集群将物理节点2上的2号shard的replica（R2）提升为主节点shard（P2），并将物理节点3上的1号shard的replica（R1）提升为主节点shard（P1）</li>
  <li>此时所有的主节点shard都已恢复，且各主节点shard都存在一份replica</li>
  <li>后续集群会继续为各主节点shard复制缺失的一份replica</li>
</ul>

<p><img src="/resources/2019/04/elasticsearch-note/elk_ha_02.png" alt="After" target="_blank" /></p>

<h2 id="46-性能调优">4.6 性能调优</h2>
<p>Ebay有一篇非常细节非常棒的设计及性能优化分析博文：<a href="https://www.ebayinc.com/stories/blogs/tech/elasticsearch-performance-tuning-practice-at-ebay/" target="_blank">Elasticsearch Performance Tuning Practice at eBay</a>。从时间上来看，这篇文章也还算近：<code>2018-01-08</code>。</p>

<p>这篇博文分析了大规模Elasticsearch集群会面临的挑战，以及解决方案，还按实际的应用Scenario进行了问题分析以及给出了解决范例，很棒。</p>

<h1 id="5-kibana">5. Kibana</h1>
<p>Kibana这块相对来说比较简单。一些关键文档位置：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/docker.html#docker" target="_blank">Running Kibana on Docker</a></li>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/settings.html#settings" target="_blank">Configuring Kibana</a></li>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/kuery-query.html" target="_blank">Kibana Query Language</a></li>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/lucene-query.html#lucene-query" target="_blank">Lucene Query Syntax</a></li>
</ul>

<h2 id="ID_INDEX_PATTERN">5.1 Index Pattern</h2>
<p>在打开Kibana页面进行任何查询和设置之前，必须进行<code>Index Pattern</code>的设置。这是使用的前提。该设置是用来告知Kibana，Elasticsearch集群中的哪些Index是需要进行解析和观察的，作为后续所有查询的数据来源。</p>

<p>官方文档：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/index-patterns.html#index-patterns" target="_blank">Index Patterns</a> <a href="https://www.elastic.co/guide/cn/kibana/current/index-patterns.html" target="_blank">中文</a></li>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-define-index.html#tutorial-define-index" target="_blank">Defining your index patterns</a></li>
</ul>

<p>官方对于自动化的支持做的不太好，如果需要在Elasticsearch集群启动之后自动化对Kibana内设置Index Pattern的话，该需求是没有官方的解决方案的。找了一圈有一些hack方案，但都不稳定，非常容易因版本更新的原因后续就无法使用了。这方面后面只能说有需要再临时找对应版本的hack。</p>

<ul>
  <li><a href="https://github.com/elastic/kibana/issues/3709" target="_blank">Index pattern creation API #3709</a></li>
</ul>

<h2 id="52-使用简介">5.2 使用简介</h2>

<ul>
  <li>如果只是要简单过滤下数据进行简单的统计或者进行临时的debug日志搜索，那么在<code>Discover</code>页面直接使用条件搜索过滤即可：<a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-discovering.html#tutorial-discovering" target="_blank">Discovering your data</a></li>
  <li>如果需要对一个常用的搜索或数值结果进行定义，方便后续直接查看，那么可以使用<code>Visualize</code>页面制作图表，这里的Visualize是和Grafana里的<code>Panel</code>同样的概念：<a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-visualizing.html#tutorial-visualizing" target="_blank">Visualizing your data</a></li>
  <li>如果需要定义一系列常用的图表进行观察，则可以使用<code>Dashboard</code>页面进行设置，这里的Dashboard是和Grafana里的<code>Dashboard</code>同样的概念：<a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-dashboard.html#tutorial-dashboard" target="_blank">Displaying your visualizations in a dashboard</a></li>
</ul>

<p>一般如果将Elasticsearch作为日志聚合debug工具的话，不需要很复杂的设置，直接使用Discover即可。偶尔会有些例如同时在线或最近请求数量之类的观测需求，那么简单设置下Visualize即可。</p>

<h2 id="53-qa">5.3 Q&amp;A</h2>

<ul>
  <li><a href="https://stackoverflow.com/questions/47370280/whats-the-difference-between-the-field-and-field-keyword-fields-in-kibana" target="_blank">What’s the difference between the ‘field’ and ‘field.keyword’ fields in Kibana?</a></li>
</ul>

<h1 id="6-filebeat直连elasticsearch实践">6. Filebeat直连Elasticsearch实践</h1>
<h2 id="61-直连流程">6.1 直连流程</h2>
<p>在实际应用的场景中，大部分情况下我们需要的这是将本地日志的内容分类传送到Elasticsearch集群中，按条件定位到不同的索引内。最多也就是对日志里的字段进行一些简单的丰富化或转换。而完成这样的需求其实是不需要Logstash这样的工具，仅使用Filebeat就可以独立完成。这样做的好处是节约了大量系统资源（Golang vs Java），同时还兼具了高可用和性能。</p>

<p>流程也非常简单：</p>

<ul>
  <li>Filebeat监听本地日志变化</li>
  <li>Filebeat将新产生的日志内容按JSON进行解析</li>
  <li>Filebeat根据日志内的字段内容，进行<code>processors</code>处理，进行丰富化或进行格式转换</li>
  <li>Filebeat根据根据<code>Elasticsearch template setting</code>，启用在Elasticsearch集群上设置好的Index Template（只有这步是依赖Elasticsearch集群的，需要预先在Elasticsearch集群中设置好Template）</li>
  <li>Filebeat根据设置，将日志传输到Elasticsearch集群中不同的Index里</li>
</ul>

<p>基本上全部的处理都是在Filebeat里完成了，不需要Ingest Pipeline做什么，更不需要Logstash出马。</p>

<p>实际操作下来，还是有很多细节问题，后面一一细说。</p>

<h2 id="62-应用场景">6.2 应用场景</h2>
<p>先描述下应用场景，否则后面的一些配置和细节都不好说明。</p>

<p>系统有三个应用程序：</p>

<ul>
  <li>web</li>
  <li>service</li>
  <li>consumer</li>
</ul>

<p>每个应用程序都会输出一份日志：</p>

<ul>
  <li>web：/tmp/logs/app/app.web.stdout.log</li>
  <li>service：/tmp/logs/app/app.service.stdout.log</li>
  <li>consumer：/tmp/logs/app/app.consumer.stdout.log</li>
</ul>

<p>每个应用除了自身的业务日志之外，也会有一些使用中的组件会在对应的日志内输出内容：</p>

<ul>
  <li>web：
    <ul>
      <li>web：自身业务日志</li>
      <li>gin：web框架gin的日志</li>
    </ul>
  </li>
  <li>service：
    <ul>
      <li>service：自身业务日志</li>
      <li>gorm：数据库orm框架的日志</li>
    </ul>
  </li>
  <li>consumer：
    <ul>
      <li>consumer：自身业务日志</li>
      <li>gorm：数据库orm框架的日志</li>
    </ul>
  </li>
</ul>

<p>需求是跟踪、解析这三份日志文件，将输出的日志根据应用以及组件分发到Elasticsearch不同的Index中：</p>

<ul>
  <li>web：
    <ul>
      <li>web：分发到 dist-web-web-*</li>
      <li>gin：分发到 dist-web-gin-*</li>
    </ul>
  </li>
  <li>service：
    <ul>
      <li>service：分发到 dist-service-service-*</li>
      <li>gorm：分发到 dist-service-gorm-*</li>
    </ul>
  </li>
  <li>consumer：
    <ul>
      <li>consumer：分发到 dist-consumer-consumer-*</li>
      <li>gorm：分发到 dist-consumer-gorm-*</li>
    </ul>
  </li>
</ul>

<p>解决方案：</p>

<ul>
  <li>使用input配置下的fields配置，根据输入的文件，添加自定义字段：<code>fields.app: web|service|consumer</code></li>
  <li>使用processors，解析JSON日志内容、字段，添加自定义字段：<code>fields.module: web|gin|service|consumer|gorm</code></li>
  <li>根据字段<code>fields.app</code><code>fields.module</code>输出日志到不同的Index：<code>dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}</code></li>
</ul>

<h2 id="ID_INDEX_TEMPLATE">6.3 Index Template</h2>
<p>中间还需要补一个Elasticsearch的概念：<code>Index Template</code>。官方文档在：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/indices-templates.html" target="_blank">Index Templates</a>，也有一份<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index-templates.html" target="_blank">中文</a>的。</p>

<p>之前在<a href="#ID_INDEX">4.2 文档数据库 &amp; 索引</a>已经讲到了，Index即相当于RDBMS里的<code>表名</code>，且在Elasticsearch中是用来进行sharding的重要字段。而同时我们之前也提到过了，在大部分的情况下，Index是自动创建的，按某些格式：<code>dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}</code>。所以如果要针对每一个Index进行单独的配置，这基本上是不可能的。在Elasticsearch中，为了应对这样的需求，就有了<code>Index Template</code>这个设置。新创建的Index都会根据名字套用上某个Template（如果有匹配到的话），达到对Index进行设置的目的。</p>

<p>此外，Index Template里还设置了很多细节（这些设置都会在名字匹配的Index上生效）：</p>

<ul>
  <li>Index的shards数量</li>
  <li>Index的replicas数量</li>
  <li>Index如何分词、如何过滤</li>
  <li>Index对应日志中的字段应该怎么解析，分别都是什么类型的字段（如果不设置的话，Elasticsearch会根据第一次出现的值进行猜测，以后将不再更改，除非使用API手动重设）</li>
  <li>等等</li>
</ul>

<p>如果某个新创建的Index不符合任何Elasticsearch集群上已知的所有Template，则该Index内的所有设置都会按默认值来。一般来说这种情况下最严重的问题是：该Index将只会存在一个shard，且只会有一份replica。</p>

<p>所以，一般来说都需要在正式使用之前将需要的Index Template创建好，才可能开始向Elasticsearch输入日志，否则创建出来的Index会有问题，至少分片就不对。</p>

<p>额外的资料：</p>

<ul>
  <li>有一份中文的博文，讲解的很好，后续可以看下：<a href="https://www.jianshu.com/p/1f67e4436c37" target="_blank">初探 Elasticsearch Index Template（索引模板)</a>。</li>
  <li>官方社区有一个讨论帖，里面有comment对如何操作自定义Index Template有比较详细的步骤讲解：<a href="https://discuss.elastic.co/t/custom-filebeat-template-for-json-log-lines/114761/5" target="_blank">Custom filebeat template for JSON log lines</a>。</li>
</ul>

<h2 id="64-issues">6.4 Issues</h2>
<h3 id="641-filebeat字段层级">6.4.1 Filebeat字段层级</h3>
<p>Filebeat默认将日志JSON解析出来的内容放到<code>message</code>字段下，见下图的message字段内容：</p>

<p><img src="/resources/2019/04/elasticsearch-note/filebeat_json_no_root.png" alt="" target="_blank" /></p>

<p>如果不知道这点的话，在使用<code>processors</code>时候会发现设定的条件因字段没有找到而没有被触发。调试的时候会非常痛苦。</p>

<p>这里需要了解filebeat的设置：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-input-log.html#filebeat-input-log-config-json" target="_blank">Log input &gt; json</a>。</p>

<p>有几项配置需要了解下：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">filebeat.inputs</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">log</span>
    <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/...</span>
    <span class="l l-Scalar l-Scalar-Plain">json.keys_under_root</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">json.overwrite_keys</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">json.message_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">message</span>
    <span class="l l-Scalar l-Scalar-Plain">...</span></code></pre></figure>

<ul>
  <li><code>json.keys_under_root: true</code>：将之前存放在message字段里的JSON释放到根节点，效果见下图，可以和上面的图做下比对；一般来说这也是用户希望的效果</li>
  <li><code>json.overwrite_keys: true</code>：是否在冲突的时候使用释放出来的字段的值覆盖根目录下同Key的值，一般也需要配置</li>
  <li><code>json.message_key: message</code>：这项一般不要改，留默认的<code>message</code>即可，后面会解释原因</li>
</ul>

<p><img src="/resources/2019/04/elasticsearch-note/filebeat_json_root.png" alt="" target="_blank" /></p>

<p>如果不配置<code>json.keys_under_root: true</code>也不是不可以，但在查找日志JSON内容的时候就需要到message字段下去查找，而不是根节点。</p>

<h3 id="642-kibana-message字段">6.4.2 Kibana message字段</h3>
<p>Kibana页面上的原始日志页面，显示的是filebeat传输到Elasticsearch日志内容中的<code>message</code>字段内容，且显示的仅只有message字段的内容。并且，当Kibana发现Elasticsearch中存放的日志不存在message字段的时候，还会显示错误：<code>failed to find message</code>。因此之前提到，不要随意更改：<code>json.message_key: message</code>。要更改Kibana的行为也不是不可以，参见：</p>

<ul>
  <li><a href="https://discuss.elastic.co/t/log-ui-failed-to-format-message-from/163196" target="_blank">Log UI failed to format message from</a></li>
  <li><a href="https://github.com/elastic/kibana/pull/26579/files#diff-3d8e25bfa60ef76c1ce7b5e7a68232f2R9" target="_blank">[InfraOps] Update docs with data source configuration</a></li>
</ul>

<p>实际效果可以参见下面两张图的比对，第一张是没有使用<code>json.keys_under_root: true</code>的情况，第二张则是释放之后的情况：</p>

<p><img src="/resources/2019/04/elasticsearch-note/filebeat_logs_msg_no_root.png" alt="" target="_blank" />
<img src="/resources/2019/04/elasticsearch-note/filebeat_logs_msg_root.png" alt="" target="_blank" /></p>

<h3 id="643-input--processors-fields">6.4.3 input | processors fields</h3>
<p>在filebeat的input配置中，可以根据日志输入向日志内容中添加自定义的字段：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">filebeat.inputs</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">log</span>
    <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/app/logs/app.web.stdout.log</span>
    <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
    <span class="l l-Scalar l-Scalar-Plain">...</span></code></pre></figure>

<p>在processors配置中，也可以根据条件向日志内容中添加自定义的字段：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">processors</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">add_fields</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">contains</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">message</span><span class="p p-Indicator">:</span> <span class="s">&quot;WEB.Handler&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="s">&quot;web&quot;</span>
<span class="nn">...</span></code></pre></figure>

<p>但有一点需要明确，这些添加的字段，都会存放在根节点下的<code>fields</code>字段里。上面例子里的两个设置，会产生：</p>

<ul>
  <li>fields.app: web</li>
  <li>fields.module: web</li>
</ul>

<p>可以看下之前6.4.1图中的字段列表。</p>

<h3 id="ID_FILEBEAT_INDEX_TEMPLATE">6.4.4 Index Template设置</h3>
<p>Index Template虽然是在Elasticsearch上创建的（见：<a href="#ID_INDEX_TEMPLATE">6.3 Index Template</a>），但在filebeat端还是需要做设置的。主要是需要在filebeat端加载Elasticsearch上存在的Index Template，然后后续在filebeat向Elasticsearch传输日志的时候，就会应用这些Template。如果配置不正确的话，诸如shards数量之类的配置就会出错、不生效。</p>

<ul>
  <li>filebeat中关于Index Template的配置项：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/configuration-template.html" target="_blank">Load the Elasticsearch index template</a></li>
  <li>filebeat中如何加载Index Template：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-template.html" target="_blank">Step 4: Load the index template in Elasticsearch</a></li>
  <li>此外，该功能一般和输出相关配置有关：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/elasticsearch-output.html#indices-option-es" target="_blank">Configure the Elasticsearch output &gt; indices</a></li>
</ul>

<p>如果不想在Elasticsearch端创建自定义的Index Template，那么可以使用的Template只有一个，就是filebeat默认的：<code>filebeat-%{[agent.version]}-%{+yyyy.MM.dd}</code>，在当前的版本下就是：<code>filebeat-7.0.0-2019-05-29</code>。</p>

<p>该默认的Template在Elastcsearch上的配置可以通过API <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/indices-templates.html#getting" target="_blank">Getting templates</a> 进行观察：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="s2">&quot;filebeat-7.0.0&quot;</span><span class="err">:</span> <span class="p">{</span>
  <span class="nt">&quot;order&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;index_patterns&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;filebeat-7.0.0-*&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;lifecycle&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;filebeat-7.0.0&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rollover_alias&quot;</span><span class="p">:</span> <span class="s2">&quot;filebeat-7.0.0&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;mapping&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;total_fields&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;limit&quot;</span><span class="p">:</span> <span class="s2">&quot;10000&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;refresh_interval&quot;</span><span class="p">:</span> <span class="s2">&quot;5s&quot;</span><span class="p">,</span>
      <span class="nt">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
      <span class="err">...</span></code></pre></figure>

<p>可以看到，该Template的名字匹配pattern是：<code>filebeat-7.0.0-*</code>，所以如果要利用这个默认的Template的话，名字一定不能搞错。我之前做实验的时候使用过：</p>

<ul>
  <li>filebeat-web-web-7.0.0-*</li>
  <li>filebeat-web-gin-7.0.0-*</li>
  <li>…</li>
</ul>

<p>之类的，就因为名字不匹配导致没有套用上这个Template，最后shards数量之类的就全错了。</p>

<h3 id="645-切片数量">6.4.5 切片数量</h3>
<p>查看集群Index切片状态，可以通过API <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat-shards.html#cat-shards" target="_blank">cat shards</a>。</p>

<p>范例集群的切片设置为：<code>主节点</code>数量3，<code>replica</code>数量1。也就是说一个Index的切片总数为：<code>primary * (1 + replica)</code> = 6。公式括号中的1就是primary，每一份切片只会有一个primary。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ curl -X GET <span class="s2">&quot;http://127.0.0.1:9201/_cat/shards&quot;</span>
dist-consumer-gorm-7.0.0-2019.05.29     <span class="m">2</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
dist-consumer-gorm-7.0.0-2019.05.29     <span class="m">2</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
dist-consumer-gorm-7.0.0-2019.05.29     <span class="m">1</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
dist-consumer-gorm-7.0.0-2019.05.29     <span class="m">1</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.3 es_1
dist-consumer-gorm-7.0.0-2019.05.29     <span class="m">0</span> p STARTED <span class="m">1</span> <span class="m">17</span>.2kb <span class="m">172</span>.20.0.2 es_3
dist-consumer-gorm-7.0.0-2019.05.29     <span class="m">0</span> r STARTED <span class="m">1</span> <span class="m">17</span>.2kb <span class="m">172</span>.20.0.3 es_1
dist-web-gin-7.0.0-2019.05.29           <span class="m">2</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
dist-web-gin-7.0.0-2019.05.29           <span class="m">2</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
dist-web-gin-7.0.0-2019.05.29           <span class="m">1</span> r STARTED <span class="m">2</span> <span class="m">32</span>.3kb <span class="m">172</span>.20.0.4 es_2
dist-web-gin-7.0.0-2019.05.29           <span class="m">1</span> p STARTED <span class="m">2</span> <span class="m">32</span>.3kb <span class="m">172</span>.20.0.3 es_1
dist-web-gin-7.0.0-2019.05.29           <span class="m">0</span> p STARTED <span class="m">2</span> <span class="m">32</span>.3kb <span class="m">172</span>.20.0.2 es_3
dist-web-gin-7.0.0-2019.05.29           <span class="m">0</span> r STARTED <span class="m">2</span> <span class="m">32</span>.3kb <span class="m">172</span>.20.0.3 es_1
dist-service-gorm-7.0.0-2019.05.29      <span class="m">2</span> p STARTED <span class="m">4</span> <span class="m">33</span>.4kb <span class="m">172</span>.20.0.2 es_3
dist-service-gorm-7.0.0-2019.05.29      <span class="m">2</span> r STARTED <span class="m">4</span> <span class="m">33</span>.4kb <span class="m">172</span>.20.0.3 es_1
dist-service-gorm-7.0.0-2019.05.29      <span class="m">1</span> r STARTED <span class="m">1</span> <span class="m">16</span>.6kb <span class="m">172</span>.20.0.4 es_2
dist-service-gorm-7.0.0-2019.05.29      <span class="m">1</span> p STARTED <span class="m">1</span> <span class="m">16</span>.6kb <span class="m">172</span>.20.0.3 es_1
dist-service-gorm-7.0.0-2019.05.29      <span class="m">0</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
dist-service-gorm-7.0.0-2019.05.29      <span class="m">0</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
dist-consumer-consumer-7.0.0-2019.05.29 <span class="m">2</span> p STARTED <span class="m">1</span> <span class="m">14</span>.6kb <span class="m">172</span>.20.0.4 es_2
dist-consumer-consumer-7.0.0-2019.05.29 <span class="m">2</span> r STARTED <span class="m">1</span> <span class="m">14</span>.6kb <span class="m">172</span>.20.0.2 es_3
dist-consumer-consumer-7.0.0-2019.05.29 <span class="m">1</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
dist-consumer-consumer-7.0.0-2019.05.29 <span class="m">1</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.3 es_1
dist-consumer-consumer-7.0.0-2019.05.29 <span class="m">0</span> p STARTED <span class="m">1</span> <span class="m">14</span>.6kb <span class="m">172</span>.20.0.4 es_2
dist-consumer-consumer-7.0.0-2019.05.29 <span class="m">0</span> r STARTED <span class="m">1</span> <span class="m">14</span>.6kb <span class="m">172</span>.20.0.3 es_1
.kibana_1                               <span class="m">0</span> r STARTED <span class="m">6</span> <span class="m">50</span>.2kb <span class="m">172</span>.20.0.4 es_2
.kibana_1                               <span class="m">0</span> p STARTED <span class="m">6</span> <span class="m">50</span>.2kb <span class="m">172</span>.20.0.3 es_1
dist-service-service-7.0.0-2019.05.29   <span class="m">2</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
dist-service-service-7.0.0-2019.05.29   <span class="m">2</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
dist-service-service-7.0.0-2019.05.29   <span class="m">1</span> r STARTED <span class="m">3</span> <span class="m">28</span>.2kb <span class="m">172</span>.20.0.2 es_3
dist-service-service-7.0.0-2019.05.29   <span class="m">1</span> p STARTED <span class="m">3</span> <span class="m">14</span>.9kb <span class="m">172</span>.20.0.3 es_1
dist-service-service-7.0.0-2019.05.29   <span class="m">0</span> p STARTED <span class="m">1</span> <span class="m">13</span>.9kb <span class="m">172</span>.20.0.4 es_2
dist-service-service-7.0.0-2019.05.29   <span class="m">0</span> r STARTED <span class="m">1</span> <span class="m">13</span>.9kb <span class="m">172</span>.20.0.3 es_1
.kibana_task_manager                    <span class="m">0</span> p STARTED <span class="m">2</span> <span class="m">45</span>.4kb <span class="m">172</span>.20.0.4 es_2
.kibana_task_manager                    <span class="m">0</span> r STARTED <span class="m">2</span> <span class="m">45</span>.4kb <span class="m">172</span>.20.0.2 es_3
dist-web-web-7.0.0-2019.05.29           <span class="m">2</span> p STARTED <span class="m">2</span> <span class="m">27</span>.9kb <span class="m">172</span>.20.0.2 es_3
dist-web-web-7.0.0-2019.05.29           <span class="m">2</span> r STARTED <span class="m">2</span> <span class="m">27</span>.9kb <span class="m">172</span>.20.0.3 es_1
dist-web-web-7.0.0-2019.05.29           <span class="m">1</span> r STARTED <span class="m">1</span>   14kb <span class="m">172</span>.20.0.4 es_2
dist-web-web-7.0.0-2019.05.29           <span class="m">1</span> p STARTED <span class="m">1</span>   14kb <span class="m">172</span>.20.0.3 es_1
dist-web-web-7.0.0-2019.05.29           <span class="m">0</span> p STARTED <span class="m">1</span>   14kb <span class="m">172</span>.20.0.4 es_2
dist-web-web-7.0.0-2019.05.29           <span class="m">0</span> r STARTED <span class="m">1</span>   14kb <span class="m">172</span>.20.0.2 es_3
filebeat-7.0.0-2019.05.29-000001        <span class="m">2</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
filebeat-7.0.0-2019.05.29-000001        <span class="m">2</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
filebeat-7.0.0-2019.05.29-000001        <span class="m">1</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.2 es_3
filebeat-7.0.0-2019.05.29-000001        <span class="m">1</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.3 es_1
filebeat-7.0.0-2019.05.29-000001        <span class="m">0</span> p STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.4 es_2
filebeat-7.0.0-2019.05.29-000001        <span class="m">0</span> r STARTED <span class="m">0</span>   230b <span class="m">172</span>.20.0.3 es_1</code></pre></figure>

<p>输出的内容有几列，这里解释下含义：</p>

<ul>
  <li><code>Index名</code>：dist-consumer-gorm-7.0.0-2019.05.29</li>
  <li><code>节点编号</code>：切片在当前Index的切片组中的编号，从0开始，一个primary占用一个编号，所有该primary的从属replicas和primary共享同一个编号</li>
  <li><code>节点类型</code>：只有<code>p</code>和<code>r</code>，表示是primary还是replica</li>
  <li><code>节点状态</code>：正常状态为<code>STARTED</code>，启动中为<code>INITIALIZING</code>，错误状态为<code>UNASSIGNED</code>；unassigned相关参见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat-shards.html#reason-unassigned" target="_blank">Reasons for unassigned shard</a></li>
  <li><code>文档数量</code>：存储在该节点内的文档数量</li>
  <li><code>节点容量</code>：节点占用的磁盘容量</li>
  <li><code>节点IP</code>：节点的IP地址</li>
  <li><code>节点名</code>：节点在Elasticsearch集群中的名字</li>
</ul>

<h3 id="646-kibana-timestamp">6.4.6 Kibana @timestamp</h3>
<p>Filebeat向Elasticsearch传输的日志内容会添加一个字段：<code>@timestamp</code>。而Kibana在设置Index Pattern（<a href="#ID_INDEX_PATTERN">5.1 Index Pattern</a>）的时候，强制需要选择一项日志内的时间字段作为后续时间相关过滤的指标。如果用户没有自己的时间字段的话，一般都会选择<code>@timestamp</code>字段，因为该段总是存在的。</p>

<p>不过这里有一项需要注意：</p>

<p>@timestamp 是日志被filebeat处理的时间点，而不是日志发生的时间点。一般来说这两者可以混用，但在日志有堆积，处理比较慢的情况下，就不合适了。千万需要小心，一般来说尽量选择业务日志自带的时间字段，就不会有问题了。</p>

<h3 id="647-elasticsearch-预创建数据">6.4.7 Elasticsearch 预创建数据</h3>
<p>一般来说，在Elasticsearch启动的时候都会有创建一些预设配置的需求，特别是在docker中运行的时候，因为docker本来就具有高度自动化的特征，也就格外需要这样的预设数据。这方面只能说官方仍旧没有提供非常完备的支持，只能自行处理：</p>

<ul>
  <li><a href="https://discuss.elastic.co/t/best-practice-for-creating-an-index-when-an-es-docker-container-starts/126651" target="_blank">Best practice for creating an index when an ES docker container starts</a></li>
  <li><a href="https://stackoverflow.com/questions/35526532/how-to-add-an-elasticsearch-index-during-docker-build" target="_blank">How to add an elasticsearch index during docker build</a></li>
</ul>

<h1 id="7-实践范例">7. 实践范例</h1>
<p>和之前做Prometheus实验的时候一样，因为需要把握一些细节，所以实验使用的还是下载下来的Elasticsearch、Kibana以及Filebeat。作为配角的Nginx使用的则是镜像版本。</p>

<p>范例代码可以在Github查看：<a href="https://github.com/agreatfool/dist-system-practice/tree/master/experiment/elasticsearch" target="_blank">dist-system-practice/experiment/elasticsearch/</a>。</p>

<p>这则例子非常简单，基本上没有涉及任何比较核心的使用，粗略看下启动还是可以的。</p>

<h1 id="8-docker集群部署">8. Docker集群部署</h1>
<p>仍旧是使用docker-compose进行群组的编辑和启动，可运行范例可以查看：<a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/conf/elk-cluster.yaml" target="_blank">dist-system-practice/conf/elk-cluster.yaml</a>。</p>

<p>启动脚本：<a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/bash/dev/docker_elasticsearch.sh" target="_blank">dist-system-practice/bash/dev/docker_elasticsearch.sh</a>。</p>

<p>下面会根据职责一一解析配置文件。</p>

<h2 id="ID_ES_CONFIG">8.1 Elasticsearch配置</h2>
<p><strong>elk-cluster.yaml</strong></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">x-es-environment-defaults</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">C1</span><span class="p p-Indicator">:</span> <span class="nl">&amp;DISCOVERY_SEED_HOSTS</span> <span class="s">&quot;discovery.seed_hosts=es_1:9300,es_2:9300,es_3:9300&quot;</span> <span class="c1"># 集群中的所有可用节点，这个配置中需要完整给出节点的HOST和PORT</span>
  <span class="l l-Scalar l-Scalar-Plain">C2</span><span class="p p-Indicator">:</span> <span class="nl">&amp;CLUSTER_INITIAL_MASTER_NODES</span> <span class="s">&quot;cluster.initial_master_nodes=es_1,es_2,es_3&quot;</span> <span class="c1"># 集群初始化的master节点，这个配置中只需要给节点名，即 node.name=es_1 里面设置的名字</span>
  <span class="l l-Scalar l-Scalar-Plain">C4</span><span class="p p-Indicator">:</span> <span class="nl">&amp;ES_JAVA_OPTS</span> <span class="s">&quot;ES_JAVA_OPTS=\</span>
      <span class="s">-Xms256m</span><span class="nv"> </span><span class="s">\</span>
      <span class="s">-Xmx256m</span><span class="nv"> </span><span class="s">\</span>
    <span class="s">&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">x-es-ulimit-defaults</span><span class="p p-Indicator">:</span> <span class="nl">&amp;ES_ULIMIT_DEFAULTS</span>
  <span class="l l-Scalar l-Scalar-Plain">nproc</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
  <span class="l l-Scalar l-Scalar-Plain">nofile</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">soft</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
    <span class="l l-Scalar l-Scalar-Plain">hard</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
  <span class="l l-Scalar l-Scalar-Plain">memlock</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">soft</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-1</span>
    <span class="l l-Scalar l-Scalar-Plain">hard</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-1</span>

<span class="l l-Scalar l-Scalar-Plain">x-es-logging-defaults</span><span class="p p-Indicator">:</span> <span class="nl">&amp;ES_LOGGING_DEFAULTS</span>
  <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">max-size</span><span class="p p-Indicator">:</span> <span class="s">&quot;512m&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">net</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="s">&quot;bridge&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">es_vol_1_logs</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="s">&quot;local&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">es_vol_1_data</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="s">&quot;local&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">es_1</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch:7.0.0&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;es_1&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="s">&quot;es_1&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">es_vol_1_data:/usr/share/elasticsearch/data</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">es_vol_1_logs:/usr/share/elasticsearch/logs</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/private/tmp/elasticsearch.yaml:/usr/share/elasticsearch/config/elasticsearch.yml</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;net&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;9201:9201&quot;</span> <span class="c1"># 该PORT是给外部访问使用的，比如Kibana、Filebeat，以及客户端查询API</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;9300&quot;</span> <span class="c1"># 该PORT是给集群内部流量使用的，所以只要expose即可</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="s">&quot;always&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*ES_LOGGING_DEFAULTS</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.name=es_1</span> <span class="c1"># 节点名必须设置且不可重复</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http.port=9201</span> <span class="c1"># 这个PORT同上</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.master=true</span> <span class="c1"># 如果需要该节点作为master角色提供服务，则这里设置成true</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.data=true</span> <span class="c1"># 如果需要该节点作为数据节点提供服务（数据存储），则这里设置成true</span>
      <span class="p p-Indicator">-</span> <span class="nv">*DISCOVERY_SEED_HOSTS</span>
      <span class="p p-Indicator">-</span> <span class="nv">*CLUSTER_INITIAL_MASTER_NODES</span>
      <span class="p p-Indicator">-</span> <span class="nv">*ES_JAVA_OPTS</span>
    <span class="l l-Scalar l-Scalar-Plain">ulimits</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*ES_ULIMIT_DEFAULTS</span></code></pre></figure>

<p><strong>elasticsearch.yaml</strong></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">cluster.name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">es_cluster</span>
<span class="l l-Scalar l-Scalar-Plain">path.data</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/share/elasticsearch/data</span>
<span class="l l-Scalar l-Scalar-Plain">path.logs</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/share/elasticsearch/logs</span>
<span class="l l-Scalar l-Scalar-Plain">bootstrap.memory_lock</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="l l-Scalar l-Scalar-Plain">network.host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span>
<span class="l l-Scalar l-Scalar-Plain">transport.tcp.port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">9300</span></code></pre></figure>

<p>相关文档：</p>

<ul>
  <li>官方文档及范例配置文件：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker-cli-run-prod-mode" target="_blank">Install Elasticsearch with Docker</a></li>
  <li>理解Elasticsearch的集群发现：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/modules-discovery-hosts-providers.html#modules-discovery-hosts-providers" target="_blank">Discovery</a></li>
  <li>全局变量配置的使用：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/settings.html#_environment_variable_substitution" target="_blank">Environment variable substitution</a></li>
  <li>同上，不同的做法：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker-configuration-methods" target="_blank">Configuring Elasticsearch with Docker</a></li>
  <li>一些比较常见的问题：<a href="https://www.jianshu.com/p/fa31f38d241e" target="_blank">使用ElasticSearch踩过的坑</a></li>
  <li>一个非常完整的搭建例子：<a href="https://www.infvie.com/ops-notes/elkstack-beats" target="_blank">ELK Stack+Beats 搭建分布式日志平台</a></li>
  <li>大杂烩：<a href="https://www.jianshu.com/p/6a700cc61913" target="_blank">Elasticsearch安装配置</a></li>
  <li>带说明的非docker安装：<a href="https://logz.io/blog/elasticsearch-cluster-tutorial/" target="_blank">Creating an Elasticsearch Cluster: Getting Started</a></li>
</ul>

<h3 id="811-环境变量配置">8.1.1 环境变量配置</h3>
<p>Elasticsearch的环境变量配置要求使用配置文件中的配置项字符串，完全不用改动，全部都是小写，然后使用<code>=</code>连接配置项的值。此外需要注意，数组的配置和配置文件中有所不同，直接使用以<code>,</code>分隔的字符串即可：<code>discovery.seed_hosts=es_1:9300,es_2:9300,es_3:9300</code>。</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.name=es_1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http.port=9201</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.master=true</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node.data=true</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">...</span></code></pre></figure>

<h3 id="812-多节点配置的共享">8.1.2 多节点配置的共享</h3>
<p>Elasticsearch docker compose的配置中，需要把environment配置成数组，而YAML则恰恰不支持数组的Anchor Merge。这是YAML的一个功能性问题，不支持Array的平铺Merge：<a href="https://github.com/yaml/yaml/issues/35" target="_blank">Merge arrays #35</a>。社区的方案一般都需要在原生的YAML之外，再使用工具把嵌套的Array整平：<a href="https://stackoverflow.com/questions/4948933/is-there-a-way-to-alias-anchor-an-array-in-yaml" target="_blank">Is there a way to alias/anchor an array in YAML?</a>，这就在我的接受范围之外了，我不希望使用任何第三方工具来修改yaml文件。</p>

<p>最后方案为：</p>

<ul>
  <li>把不怎么需要在运行时修改的共通变量写入配置文件</li>
  <li>使用bind mount的方法加载配置文件到容器里</li>
  <li>在yaml中设置变量</li>
  <li>在多节点中使用变量，至少里面的值只需要改一个地方就可以生效了</li>
</ul>

<h3 id="813-集群发现相关配置">8.1.3 集群发现相关配置</h3>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/discovery-settings.html#discovery-settings" target="_blank">Important discovery and cluster formation settings</a>。</p>

<p>集群发现主要依赖两项配置：</p>

<ul>
  <li>discovery.seed_hosts=es_1:9300,es_2:9300,es_3:9300</li>
  <li>cluster.initial_master_nodes=es_1,es_2,es_3</li>
</ul>

<p><code>discovery.seed_hosts</code>用来告知Elasticsearch组成集群的所有节点都是谁，分别HOST和PORT是什么。无论是否是master节点，或者是否仅仅只是data节点，都需要列在这个选项中，告知给Elasticsearch。这个选项里的配置是常规的<code>host:port</code>。</p>

<p><code>cluster.initial_master_nodes</code>用来告知Elasticsearch，集群启动的时候初期可用的master节点是哪几个，之后Elasticsearch会从这些节点中选出master节点。列在这个配置中的节点，其<code>node.master=true</code>必须为true。</p>

<p>然后，这个配置有个坑，非常非常坑，这个配置中的所有字符串，列的都是节点的名字，即必须和<code>node.name=es_1</code>里的名字一致，不需要配置成<code>host:port</code>，只需要<code>node_name</code>。官方文档中的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker-cli-run-prod-mode" target="_blank">例子</a>因为是docker，所以节点的名字和docker network中的container名字是一致的，而且官方的例子用的都是默认port，所有的port都没写，所以我一开始误认为这个选项里的配置也是<code>host:port</code>，然后各种无法组成集群。而且Elasticsearch针对这种错误给的错误信息非常暧昧，完全找不到有用的信息。最后找了半天才在官方论坛的一个帖子里找到线索。我填了这个坑之后貌似官方文档就更新了。</p>

<p><a href="https://discuss.elastic.co/t/elastic-search-7-unable-to-bootstrap-the-cluster-due-to-master-not-discovered-yet/182073/2" target="_blank">Elastic Search 7 unable to bootstrap the cluster due to master not discovered yet</a>（这个comment离我找到它只隔了3天，超级新的问题）：</p>

<blockquote>
  <p>Remove the port from the cluster.initial_master_nodes setting, and it will work. We have updated the docs recently to make it clearer that either node name, or ip/port is to be used. Node name/port is not a valid combination.</p>
</blockquote>

<p><a href="https://discuss.elastic.co/t/elastic-search-7-unable-to-bootstrap-the-cluster-due-to-master-not-discovered-yet/182073/4" target="_blank">另一个comment</a>：</p>

<blockquote>
  <p>It is intentional. This setting does not denote a hostname, but the node name or the advertised publish address. In particular, it is not an address that is resolved or actively connected to. The discovery.seed_hosts setting is used for that. The cluster.initial_master_nodes setting is used to determine the identities of the subset of master-eligible nodes that participate in the bootstrapping process after discovery.seed_hosts has established a connection to the nodes.</p>
</blockquote>

<h2 id="82-kibana配置">8.2 Kibana配置</h2>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">kibana</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;kibana:7.0.0&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;kibana&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="s">&quot;kibana&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;es_1&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;es_2&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;es_3&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;net&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;5601:5601&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="s">&quot;always&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*ES_LOGGING_DEFAULTS</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SERVER_PORT=5601</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SERVER_HOST=0.0.0.0</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SERVER_NAME=es_cluster</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_HOSTS=[&quot;http://es_1:9201&quot;]</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">KIBANA_INDEX=.kibana</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DIBANA_DEFAULTAPPID=home</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_PINGTIMEOUT=1500</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_REQUESTTIMEOUT=10000</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_LOGQUERIES=false</span></code></pre></figure>

<p>相关文档：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/docker.html" target="_blank">Running Kibana on Docker</a></li>
  <li><a href="https://www.elastic.co/guide/en/kibana/7.0/docker.html#environment-variable-config" target="_blank">Environment variable configuration</a></li>
</ul>

<p>Kibana环境变量的配置和Elasticsearch不一致：</p>

<ul>
  <li>Elasticsearch使用的是数组，常量的键使用的直接是配置文件中的键，不需要转大写和下划线</li>
  <li>Kibana使用的是数组，常量的键使用的是配置文件中的键转大写，且将点转换成下划线</li>
</ul>

<p>当前版本有一个配置项相关非常严重的BUG：<a href="https://github.com/elastic/kibana/issues/32303" target="_blank">Kibana fails to validate config if elasticsearch.hosts is not a string #32303</a>。</p>

<p>简单来说就是<code>ELASTICSEARCH_HOSTS</code>这项配置，如果写成下面的任何一种，都不正确，Kibana会报错告知找不到Elasticsearch集群：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_HOSTS</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http://es_1:9201</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http://es_2:9202</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http://es_3:9203</span>

<span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_HOSTS=[&quot;http://es_1:9201&quot;,&quot;http://es_2:9202&quot;,&quot;http://es_3:9203&quot;]</span>

<span class="l l-Scalar l-Scalar-Plain">ELASTICSEARCH_HOSTS=es_1:9201,es_2:9202,es_3:9203</span></code></pre></figure>

<p>虽然上面的写法其实理论上来说都是合法的，但现在就是会出错。现在唯一的写法是：<code>ELASTICSEARCH_HOSTS=["http://es_1:9201"]</code>。写成数组格式，但里面只能放一个节点，这样就不会出错。</p>

<h2 id="83-filebeat配置">8.3 Filebeat配置</h2>
<p><strong>elk-cluster.yaml</strong></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">filebeat</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="s">&quot;elastic/filebeat:7.0.0&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;filebeat&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="s">&quot;filebeat&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;es_1&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;es_2&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;es_3&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;net&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/private/tmp/filebeat.yaml:/usr/share/filebeat/filebeat.yml</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/private/tmp/logs/app:/tmp/app/logs</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="s">&quot;always&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">&lt;&lt;</span><span class="p p-Indicator">:</span> <span class="nv">*ES_LOGGING_DEFAULTS</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ES_HOSTS=es_1:9201,es_2:9202,es_3:9203</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">LOGGING_LEVEL=debug</span> <span class="c1"># error, warning, info, debug</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NUM_OF_OUTPUT_WORKERS=9</span> <span class="c1"># workers会均匀分配到node：如果有3个ES的node，那么每个node会分到3个workers</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NUM_OF_SHARDS=3</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NUM_OF_REPLICAS=1</span></code></pre></figure>

<p><strong>filebeat.yaml</strong></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">filebeat.inputs</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">log</span>
  <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/app/logs/app.web.stdout.log</span>
  <span class="l l-Scalar l-Scalar-Plain">json.keys_under_root</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span> <span class="c1"># 释放日志JSON到根节点</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span> <span class="c1"># 根据日志文件，添加不同的app字段值，后续会使用该值进行不同的Index分发</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">log</span>
  <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/app/logs/app.service.stdout.log</span>
  <span class="l l-Scalar l-Scalar-Plain">json.keys_under_root</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">log</span>
  <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/app/logs/app.consumer.stdout.log</span>
  <span class="l l-Scalar l-Scalar-Plain">json.keys_under_root</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">consumer</span>

<span class="l l-Scalar l-Scalar-Plain">logging.level</span><span class="p p-Indicator">:</span> <span class="s">&#39;${LOGGING_LEVEL}&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">logging.selectors</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>

<span class="l l-Scalar l-Scalar-Plain">processors</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">add_fields</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">contains</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">message</span><span class="p p-Indicator">:</span> <span class="s">&quot;WEB.Handler&quot;</span> <span class="c1"># 根据日志内容，进行条件匹配</span>
      <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="s">&quot;web&quot;</span> <span class="c1"># 根据不同的匹配，添加不同的module字段值，后续会使用该值进行不同的Index分发</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">add_fields</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">contains</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">logger</span><span class="p p-Indicator">:</span> <span class="s">&quot;7c4b822813e7&quot;</span> <span class="c1"># &quot;logger&quot;:&quot;zap@v0.0.0-20190405225521-7c4b822813e7/zap.go:46&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="s">&quot;gin&quot;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">add_fields</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">contains</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">message</span><span class="p p-Indicator">:</span> <span class="s">&quot;gorm&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="s">&quot;gorm&quot;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">add_fields</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">contains</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">message</span><span class="p p-Indicator">:</span> <span class="s">&quot;Service.Rpc&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="s">&quot;service&quot;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">add_fields</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">contains</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">message</span><span class="p p-Indicator">:</span> <span class="s">&quot;Consumer&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">module</span><span class="p p-Indicator">:</span> <span class="s">&quot;consumer&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">setup.template.name</span><span class="p p-Indicator">:</span> <span class="s">&quot;dist&quot;</span> <span class="c1"># 启用的Elasticsearch Index Template，注意这个Template必须在Elasticsearch中存在</span>
<span class="l l-Scalar l-Scalar-Plain">setup.template.pattern</span><span class="p p-Indicator">:</span> <span class="s">&quot;dist-*&quot;</span> <span class="c1"># Index名字匹配模式</span>
<span class="l l-Scalar l-Scalar-Plain">setup.template.settings</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">index.number_of_shards</span><span class="p p-Indicator">:</span> <span class="s">&#39;${NUM_OF_SHARDS}&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">index.number_of_replicas</span><span class="p p-Indicator">:</span> <span class="s">&#39;${NUM_OF_REPLICAS}&#39;</span>

<span class="l l-Scalar l-Scalar-Plain">output.elasticsearch</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="s">&#39;${ES_HOSTS}&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">worker</span><span class="p p-Indicator">:</span> <span class="s">&#39;${NUM_OF_OUTPUT_WORKERS}&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">indices</span><span class="p p-Indicator">:</span> <span class="c1"># 根据之前添加的字段，决定应该发送日志到什么Index</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">index</span><span class="p p-Indicator">:</span> <span class="s">&quot;dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}&quot;</span> <span class="c1"># 注意这里使用到的Index名字需要匹配Index Template</span></code></pre></figure>

<p><strong>elk-index-template.json</strong></p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;order&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;index_patterns&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;dist-*&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nt">&quot;number_of_replicas&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;refresh_interval&quot;</span><span class="p">:</span> <span class="s2">&quot;5s&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>相关文档：</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/running-on-docker.html#_configure_filebeat_on_docker" target="_blank">Configure Filebeat on Docker</a></li>
  <li><a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/using-environ-vars.html#using-environ-vars" target="_blank">Use environment variables in the configuration</a></li>
</ul>

<p>Filebeat的环境变量配置和Kibana还有Elasticsearch都不一致，明明是一家公司的三个组件，居然相互之间的做法各不相同，也是服了。Filebeat的做法是在启动时设置环境变量，但这个环境变量不会自动转换并覆盖配置文件中的值，而是需要在配置文件中使用<code>${ENV_KEY}</code>这样的方法来使用环境变量的值。</p>

<p>此外，关于非常重要的Index Template设置，参见：<a href="#ID_FILEBEAT_INDEX_TEMPLATE">6.4.4 Index Template设置</a>。</p>

<h1 id="9-todo">9. TODO</h1>
<ul>
  <li>Elasticsearch集群及一些基本观察用的API熟悉</li>
  <li>Elasticsearch JVM相关参数和实践研究</li>
  <li>Elasticsearch reshard的策略，最佳实践</li>
  <li>Elasticsearch reshard时候的CPU、磁盘、内存，还有特别是网络的影响</li>
  <li>Elasticsearch reshard在各种集群规模下的耗时</li>
  <li>Elasticsearch的性能指标研究</li>
  <li>Elasticsearch性能测试</li>
  <li>Kibana使用深入</li>
  <li>添加Logstash部分内容，这块由于时间问题暂时不准备展开</li>
</ul>

<h1 id="资料">资料</h1>
<h2 id="链接">链接</h2>
<ul>
  <li><a href="https://sematext.com/blog/logstash-alternatives/" target="_blank">5 Logstash Alternatives</a></li>
  <li><a href="https://gist.github.com/StevenACoffman/4e267f0f60c8e7fcb3f77b9e504f3bd7" target="_blank">StevenACoffman/fluent-filebeat-comparison.md</a></li>
  <li><a href="https://github.com/fluent/fluentd/issues/1657" target="_blank">Fluentd retains excessive amounts of memory after handling traffic peaks #1657</a></li>
  <li><a href="https://www.cnblogs.com/cjsblog/p/9495024.html" target="_blank">Filebeat 模块与配置</a></li>
  <li><a href="https://fdv.github.io/running-elasticsearch-fun-profit/" target="_blank">Operating Elasticsearch for Fun and Profit</a></li>
  <li><a href="https://es.xiaoleilu.com/index.html" target="_blank">Elasticsearch 权威指南（中文版）</a></li>
  <li><a href="https://www.infoq.cn/article/ejEG02VRoeGVaLw4j_LL" target="_blank">Lucene 查询原理及解析</a></li>
  <li><a href="https://stackoverflow.com/questions/27793721/what-is-the-difference-between-lucene-and-elasticsearch" target="_blank">What is the difference between Lucene and Elasticsearch</a></li>
  <li><a href="https://thoughts.t37.net/designing-the-perfect-elasticsearch-cluster-the-almost-definitive-guide-e614eabc1a87" target="_blank">Designing the Perfect Elasticsearch Cluster: the (almost) Definitive Guide</a></li>
  <li><a href="https://es.xiaoleilu.com/020_Distributed_Cluster/00_Intro.html" target="_blank">集群内部工作方式</a></li>
  <li><a href="https://github.com/vvanholl/elasticsearch-prometheus-exporter" target="_blank">Prometheus Exporter Plugin for Elasticsearch</a></li>
  <li><a href="https://thoughts.t37.net/resizing-your-elasticsearch-indexes-in-production-d7a0402d137e" target="_blank">Resizing your Elasticsearch Indexes in Production</a></li>
  <li><a href="https://www.signalfx.com/blog/scaling-elasticsearch-sharding-availability-hundreds-millions-documents/" target="_blank">Scaling Elasticsearch: Sharding and Availability for Hundreds Of Millions of Documents</a></li>
  <li><a href="https://www.ebayinc.com/stories/blogs/tech/elasticsearch-performance-tuning-practice-at-ebay/" target="_blank">Elasticsearch Performance Tuning Practice at eBay</a></li>
  <li><a href="https://github.com/elastic/kibana/issues/3709" target="_blank">Index pattern creation API #3709</a></li>
  <li><a href="https://stackoverflow.com/questions/47370280/whats-the-difference-between-the-field-and-field-keyword-fields-in-kibana" target="_blank">What’s the difference between the ‘field’ and ‘field.keyword’ fields in Kibana?</a></li>
  <li><a href="https://www.jianshu.com/p/1f67e4436c37" target="_blank">初探 Elasticsearch Index Template（索引模板)</a></li>
  <li><a href="https://discuss.elastic.co/t/custom-filebeat-template-for-json-log-lines/114761/5" target="_blank">Custom filebeat template for JSON log lines</a></li>
  <li><a href="https://discuss.elastic.co/t/log-ui-failed-to-format-message-from/163196" target="_blank">Log UI failed to format message from</a></li>
  <li><a href="https://github.com/elastic/kibana/pull/26579/files#diff-3d8e25bfa60ef76c1ce7b5e7a68232f2R9" target="_blank">[InfraOps] Update docs with data source configuration</a></li>
  <li><a href="https://discuss.elastic.co/t/best-practice-for-creating-an-index-when-an-es-docker-container-starts/126651" target="_blank">Best practice for creating an index when an ES docker container starts</a></li>
  <li><a href="https://stackoverflow.com/questions/35526532/how-to-add-an-elasticsearch-index-during-docker-build" target="_blank">How to add an elasticsearch index during docker build</a></li>
  <li><a href="https://www.jianshu.com/p/fa31f38d241e" target="_blank">使用ElasticSearch踩过的坑</a></li>
  <li><a href="https://www.infvie.com/ops-notes/elkstack-beats" target="_blank">ELK Stack+Beats 搭建分布式日志平台</a></li>
  <li><a href="https://www.jianshu.com/p/6a700cc61913" target="_blank">Elasticsearch安装配置</a></li>
  <li><a href="https://logz.io/blog/elasticsearch-cluster-tutorial/" target="_blank">Creating an Elasticsearch Cluster: Getting Started</a></li>
  <li><a href="https://github.com/yaml/yaml/issues/35" target="_blank">Merge arrays #35</a></li>
  <li><a href="https://stackoverflow.com/questions/4948933/is-there-a-way-to-alias-anchor-an-array-in-yaml" target="_blank">Is there a way to alias/anchor an array in YAML?</a></li>
  <li><a href="https://discuss.elastic.co/t/elastic-search-7-unable-to-bootstrap-the-cluster-due-to-master-not-discovered-yet/182073/2" target="_blank">Elastic Search 7 unable to bootstrap the cluster due to master not discovered yet</a></li>
  <li><a href="https://github.com/elastic/kibana/issues/32303" target="_blank">Kibana fails to validate config if elasticsearch.hosts is not a string #32303</a></li>
</ul>

<blockquote>
  <p>EOF</p>
</blockquote>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2019/05/memcached-note/">Memcached Notes</a></li>
    
    <li><a href="/2019/05/golang-pipeline/">Golang Pipeline</a></li>
    
    <li><a href="/2019/05/envoy-note/">Envoy Notes</a></li>
    
    <li><a href="/2019/05/grpc-note/">gRPC Notes</a></li>
    
    <li><a href="/2019/04/kafka-note/">Kafka Notes</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
      <li><a href="/category/V8Blog">V8Blog</a></li>
    
      <li><a href="/category/Docker">Docker</a></li>
    
      <li><a href="/category/Golang">Golang</a></li>
    
      <li><a href="/category/Career">Career</a></li>
    
      <li><a href="/category/Prometheus">Prometheus</a></li>
    
      <li><a href="/category/Grafana">Grafana</a></li>
    
      <li><a href="/category/Logging">Logging</a></li>
    
      <li><a href="/category/Jaeger">Jaeger</a></li>
    
      <li><a href="/category/Elasticsearch">Elasticsearch</a></li>
    
      <li><a href="/category/MessageQueue">MessageQueue</a></li>
    
      <li><a href="/category/Kafka">Kafka</a></li>
    
      <li><a href="/category/gRPC">gRPC</a></li>
    
      <li><a href="/category/Envoy">Envoy</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2019/04/elasticsearch-note/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2019</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
