<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Consul Notes | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2019/12/consul-note/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
  <style>
    /* Enhance table style */
    table {
      border: 2px solid #4F7849;
      background-color: #EEEEEE;
      width: 100%;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table.comicGreen th {
      border: 1px solid #4F7849;
      padding: 3px 5px;
    }
    table tbody td {
      font-size: 14px;
      color: #4F7849;
    }
    table tr:nth-child(even) {
      background: #CEE0CC;
    }
    table thead {
      background: #4F7849;
      border-bottom: 1px solid #444444;
    }
    table thead th {
      font-size: 16px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #D0E4F5;
      padding: 3px 5px;
    }
    table thead th:first-child {
      border-left: none;
    }
    table tfoot td {
      font-size: 21px;
    }

    /* Enhance pre style */
    pre {
      color: #FFFFFF;
      background-color: #000000;
      border-color: #000000;
    }

    /* Image bg color white while dark background */
    img {
      background-color: #FFFFFF;
    }

    /* Keep gist style clean */
    .gist table tr:nth-child(even) {
      background: #FFFFFF;
    }
    .gist td, th {
      border: none;
    }
  </style>
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2019/12/consul-note/">Consul Notes</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>25 Dec 2019</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/Consul">Consul</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/ServiceDiscovery">ServiceDiscovery</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/DevOps">DevOps</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Keynote">Keynote</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#1-前言" id="markdown-toc-1-前言">1. 前言</a></li>
  <li><a href="#2-选型" id="markdown-toc-2-选型">2. 选型</a></li>
  <li><a href="#3-架构" id="markdown-toc-3-架构">3. 架构</a></li>
  <li><a href="#4-使用" id="markdown-toc-4-使用">4. 使用</a>    <ul>
      <li><a href="#41-启动" id="markdown-toc-41-启动">4.1 启动</a></li>
      <li><a href="#42-api" id="markdown-toc-42-api">4.2 API</a>        <ul>
          <li><a href="#421-根据节点健康状态获取节点" id="markdown-toc-421-根据节点健康状态获取节点">4.2.1 根据节点健康状态获取节点</a></li>
          <li><a href="#422-获取所有服务" id="markdown-toc-422-获取所有服务">4.2.2 获取所有服务</a></li>
          <li><a href="#423-根据服务名获取所有对应的服务节点" id="markdown-toc-423-根据服务名获取所有对应的服务节点">4.2.3 根据服务名获取所有对应的服务节点</a></li>
          <li><a href="#424-根据service-id获取具体信息" id="markdown-toc-424-根据service-id获取具体信息">4.2.4 根据service id获取具体信息</a></li>
          <li><a href="#425-删除某个服务的注册" id="markdown-toc-425-删除某个服务的注册">4.2.5 删除某个服务的注册</a></li>
        </ul>
      </li>
      <li><a href="#43-ui" id="markdown-toc-43-ui">4.3 UI</a></li>
      <li><a href="#44-template" id="markdown-toc-44-template">4.4 Template</a></li>
      <li><a href="#45-dns" id="markdown-toc-45-dns">4.5 DNS</a></li>
      <li><a href="#46-application" id="markdown-toc-46-application">4.6 Application</a></li>
      <li><a href="#47-health-check" id="markdown-toc-47-health-check">4.7 Health Check</a></li>
    </ul>
  </li>
  <li><a href="#appendix" id="markdown-toc-appendix">Appendix</a>    <ul>
      <li><a href="#资料" id="markdown-toc-资料">资料</a></li>
      <li><a href="#ID_APP_AGENT_HELP" id="markdown-toc-ID_APP_AGENT_HELP">consul agent –help</a></li>
      <li><a href="#consul-help" id="markdown-toc-consul-help">consul –help</a></li>
    </ul>
  </li>
</ul>

<h1 id="1-前言">1. 前言</h1>
<p>Consul一般用来作为服务注册和服务发现软件。<a href="https://www.consul.io/intro/index.html" target="_blank">官方介绍</a>如下：</p>

<blockquote>
  <p>Consul is a service mesh solution providing a full featured control plane with service discovery, configuration, and segmentation functionality. Each of these features can be used individually as needed, or they can be used together to build a full service mesh. Consul requires a data plane and supports both a proxy and native integration model. Consul ships with a simple built-in proxy so that everything works out of the box, but also supports 3rd party proxy integrations such as Envoy.</p>
</blockquote>

<p>文档资料：</p>

<ul>
  <li><a href="https://www.consul.io/" target="_blank">consul.io</a></li>
  <li><a href="https://www.consul.io/docs/index.html" target="_blank">Consul Documentation</a></li>
  <li><a href="https://www.consul.io/docs/internals/index.html" target="_blank">Consul Internals</a></li>
  <li><a href="https://www.consul.io/api/index.html" target="_blank">API Introduction</a></li>
</ul>

<h1 id="2-选型">2. 选型</h1>
<p>市面上常用的开源服务发现软件主要有：<a href="https://github.com/hashicorp/consul" target="_blank">consul</a>、<a href="https://github.com/etcd-io/etcd" target="_blank">etcd</a>、<a href="https://github.com/apache/zookeeper" target="_blank">zookeeper</a>。前两者都是用golang研发的，而zookeeper则是java研发的（你懂我意思吧）。</p>

<p>这里就有选型的问题了，不过了解下来相互之间的差异不能说很大，基本上都在可接受范围内。特别是consul和etcd都使用raft作为分布式一致性协议，可以说非常趋同了。etcd关注度更高（特别是K8S官方使用了它），功能简单，主要在大型系统中作为分布式K/V存储使用；而consul的功能更强大（完整、开箱即用）且易用性更高。</p>

<p>相关资料：</p>

<ul>
  <li><a href="https://www.consul.io/intro/vs/zookeeper.html" target="_blank">Consul vs. ZooKeeper, doozerd, etcd</a>：这篇是consul官方的，不过我觉得讲得其实不多，没什么价值</li>
  <li><a href="https://gist.github.com/yurishkuro/10cb2dc42f42a007a8ce0e055ed0d171" target="_blank">etcd vs consul vs ???</a>：文章的作者居然是Jaeger的作者，看完我才刚发现；写得很好，基本上主要的点都比对出来了，价值极高</li>
  <li><a href="https://www.servercoder.com/2018/03/30/consul-vs-zookeeper-etcd/" target="_blank">服务发现框架选型，Consul还是Zookeeper还是etcd</a>：中文，带表格比对，简单易理解</li>
  <li><a href="https://matthewpalmer.net/kubernetes-app-developer/articles/how-does-kubernetes-use-etcd.html" target="_blank">How Does Kubernetes Use etcd?</a>：主要说明了K8S为什么以及如何使用etcd，主要还是作为存储系统</li>
</ul>

<h1 id="3-架构">3. 架构</h1>
<p>官方的架构介绍在：<a href="https://www.consul.io/docs/internals/architecture.html" target="_blank">Consul Architecture</a>。</p>

<p><img src="/resources/2019/12/consul-note/consul-arch.png" alt="" target="_blank" /></p>

<p>简单来说：</p>

<ul>
  <li>节点分为<code>client</code>和<code>server</code></li>
  <li>server负责存储数据，并形成集群，使用raft保证集群一致性</li>
  <li>client负责直接和业务对象连接，并将数据同步到server上</li>
  <li>所有的节点都是通过gossip连接起来的</li>
</ul>

<h1 id="4-使用">4. 使用</h1>
<h2 id="41-启动">4.1 启动</h2>
<p>一般直接使用docker镜像：<a href="https://hub.docker.com/_/consul" target="_blank">consul</a>。</p>

<p>启动方面非常简单，全部都是用<code>agent</code>命令，参数细节放在后面的附录部分，太长了：<a href="#ID_APP_AGENT_HELP">consul agent –help</a>。</p>

<p>常用参数：</p>

<ul>
  <li><code>--node=$name</code>指定节点名称</li>
  <li><code>--server</code>表示节点是server节点</li>
  <li><code>--bootstrap</code>表示节点以bootstrap模式启动</li>
  <li><code>--ui</code>表示当前节点会提供管理UI界面</li>
  <li><code>--client=0.0.0.0</code>指定监听地址</li>
  <li><code>--join=$host</code>指定启动时尝试加入集群时连接的目标节点</li>
</ul>

<p>下面给个例子，集群3个server节点，2个client节点：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span>  <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">consul:1.6.1</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">net</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">18500:8500</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8600</span> <span class="c1"># DNS</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8500</span> <span class="c1"># HTTP API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8501</span> <span class="c1"># HTTPS API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8502</span> <span class="c1"># gRPC API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8301</span> <span class="c1"># LAN Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8302</span> <span class="c1"># Wan Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8300</span> <span class="c1"># Server RPC address</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json-file</span>
      <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">max-size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">512m</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wget http://127.0.0.1:8500/v1/health/node/consul-server1 -q -O - &gt; /dev/null 2&gt;&amp;1</span>
      <span class="l l-Scalar l-Scalar-Plain">interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20s</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul_server1_data:/consul/data</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONSUL_BIND_INTERFACE=eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span>
      <span class="nv">agent</span><span class="p p-Indicator">,</span>
      <span class="nv">--node=consul-server1</span><span class="p p-Indicator">,</span>
      <span class="nv">--server</span><span class="p p-Indicator">,</span>
      <span class="nv">--bootstrap</span><span class="p p-Indicator">,</span>
      <span class="nv">--client=0.0.0.0</span><span class="p p-Indicator">,</span>
      <span class="nv">--ui</span>
    <span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server2</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">consul:1.6.1</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server2</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server2</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">net</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8600</span> <span class="c1"># DNS</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8500</span> <span class="c1"># HTTP API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8501</span> <span class="c1"># HTTPS API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8502</span> <span class="c1"># gRPC API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8301</span> <span class="c1"># LAN Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8302</span> <span class="c1"># Wan Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8300</span> <span class="c1"># Server RPC address</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json-file</span>
      <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">max-size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">512m</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wget http://127.0.0.1:8500/v1/health/node/consul-server2 -q -O - &gt; /dev/null 2&gt;&amp;1</span>
      <span class="l l-Scalar l-Scalar-Plain">interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20s</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul_server2_data:/consul/data</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONSUL_BIND_INTERFACE=eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span>
      <span class="nv">agent</span><span class="p p-Indicator">,</span>
      <span class="nv">--node=consul-server2</span><span class="p p-Indicator">,</span>
      <span class="nv">--server</span><span class="p p-Indicator">,</span>
      <span class="nv">--client=0.0.0.0</span><span class="p p-Indicator">,</span>
      <span class="nv">--join=fullstack_consul_server1</span>
    <span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server3</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">consul:1.6.1</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server3</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server3</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">net</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8600</span> <span class="c1"># DNS</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8500</span> <span class="c1"># HTTP API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8501</span> <span class="c1"># HTTPS API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8502</span> <span class="c1"># gRPC API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8301</span> <span class="c1"># LAN Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8302</span> <span class="c1"># Wan Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8300</span> <span class="c1"># Server RPC address</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json-file</span>
      <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">max-size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">512m</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wget http://127.0.0.1:8500/v1/health/node/consul-server3 -q -O - &gt; /dev/null 2&gt;&amp;1</span>
      <span class="l l-Scalar l-Scalar-Plain">interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20s</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul_server3_data:/consul/data</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONSUL_BIND_INTERFACE=eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span>
      <span class="nv">agent</span><span class="p p-Indicator">,</span>
      <span class="nv">--node=consul-server3</span><span class="p p-Indicator">,</span>
      <span class="nv">--server</span><span class="p p-Indicator">,</span>
      <span class="nv">--client=0.0.0.0</span><span class="p p-Indicator">,</span>
      <span class="nv">--join=fullstack_consul_server1</span>
    <span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_client1</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">consul:1.6.1</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_client1</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_client1</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">net</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8600</span> <span class="c1"># DNS</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8500</span> <span class="c1"># HTTP API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8501</span> <span class="c1"># HTTPS API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8502</span> <span class="c1"># gRPC API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8301</span> <span class="c1"># LAN Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8302</span> <span class="c1"># Wan Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8300</span> <span class="c1"># Server RPC address</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server2</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server3</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json-file</span>
      <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">max-size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">512m</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wget http://127.0.0.1:8500/v1/health/node/consul-client -q -O - &gt; /dev/null 2&gt;&amp;1</span>
      <span class="l l-Scalar l-Scalar-Plain">interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20s</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul_client1_data:/consul/data</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONSUL_BIND_INTERFACE=eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span>
      <span class="nv">agent</span><span class="p p-Indicator">,</span>
      <span class="nv">--node=consul-client1</span><span class="p p-Indicator">,</span>
      <span class="nv">--client=0.0.0.0</span><span class="p p-Indicator">,</span>
      <span class="nv">--join=fullstack_consul_server1</span>
    <span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_client2</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">consul:1.6.1</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_client2</span>
    <span class="l l-Scalar l-Scalar-Plain">hostname</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_client2</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">net</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8600</span> <span class="c1"># DNS</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8500</span> <span class="c1"># HTTP API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8501</span> <span class="c1"># HTTPS API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8502</span> <span class="c1"># gRPC API</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8301</span> <span class="c1"># LAN Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8302</span> <span class="c1"># Wan Serf</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8300</span> <span class="c1"># Server RPC address</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server1</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server2</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
      <span class="l l-Scalar l-Scalar-Plain">fullstack_consul_server3</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
    <span class="l l-Scalar l-Scalar-Plain">logging</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">driver</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json-file</span>
      <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">max-size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">512m</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wget http://127.0.0.1:8500/v1/health/node/consul-client -q -O - &gt; /dev/null 2&gt;&amp;1</span>
      <span class="l l-Scalar l-Scalar-Plain">interval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
      <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20s</span>
      <span class="l l-Scalar l-Scalar-Plain">retries</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul_client2_data:/consul/data</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CONSUL_BIND_INTERFACE=eth0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span>
      <span class="nv">agent</span><span class="p p-Indicator">,</span>
      <span class="nv">--node=consul-client2</span><span class="p p-Indicator">,</span>
      <span class="nv">--client=0.0.0.0</span><span class="p p-Indicator">,</span>
      <span class="nv">--join=fullstack_consul_server1</span>
    <span class="p p-Indicator">]</span></code></pre></figure>

<p>部署完成后节点如下：</p>

<p><img src="/resources/2019/12/consul-note/nodes.png" alt="" target="_blank" /></p>

<h2 id="42-api">4.2 API</h2>
<p>官方API文档在：<a href="https://www.consul.io/api/index.html" target="_blank">API Introduction</a>。Consul使用RESTful的HTTP请求来提供服务，所有的客户端或命令行工具无非就是RESTful API的封装。所以如果有需要，可以直接使用curl来发送HTTP请求调用接口。</p>

<p>下面的例子中会涉及到一些demo应用程序的节点：</p>

<ul>
  <li>app server 3个节点</li>
  <li>app gateway 3个节点</li>
</ul>

<p>client1连接了：</p>

<p><img src="/resources/2019/12/consul-note/client1.png" alt="" target="_blank" /></p>

<p>client2连接了：</p>

<p><img src="/resources/2019/12/consul-note/client1.png" alt="" target="_blank" /></p>

<h3 id="421-根据节点健康状态获取节点">4.2.1 根据节点健康状态获取节点</h3>
<p>文档：<a href="https://www.consul.io/api/health.html#list-checks-in-state" target="_blank">List Checks in State</a></p>

<p>这个接口可以有效过滤掉已经失效的节点。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ curl http://127.0.0.1:18500/v1/health/state/any <span class="p">|</span> jq .</code></pre></figure>

<p>结果：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;serfHealth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Serf Health Status&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;Agent alive and reachable&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">15</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;service:1fw20gk4kq30tk&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Service &#39;server&#39; check&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP GET http://fullstack_server2:50052/health: 200 OK Output: OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20gk4kq30tk&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">29</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;service:1fw20gk4kq35py&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Service &#39;gateway&#39; check&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP GET http://fullstack_gateway3:3000/health: 200 OK Output: OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20gk4kq35py&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;gateway&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">32</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;service:1fw20hk4kq5i2h&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Service &#39;gateway&#39; check&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP GET http://fullstack_gateway1:3000/health: 200 OK Output: OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20hk4kq5i2h&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;gateway&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">49</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;serfHealth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Serf Health Status&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;Agent alive and reachable&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">13</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;service:1fw20hk4kq30n8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Service &#39;server&#39; check&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP GET http://fullstack_server3:50052/health: 200 OK Output: OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20hk4kq30n8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">27</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;service:1fw20ik4kq35th&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Service &#39;gateway&#39; check&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP GET http://fullstack_gateway2:3000/health: 200 OK Output: OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20ik4kq35th&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;gateway&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">34</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;service:eewk9hk4kq2uvy&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Service &#39;server&#39; check&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP GET http://fullstack_server1:50052/health: 200 OK Output: OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;eewk9hk4kq2uvy&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">23</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-server1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;serfHealth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Serf Health Status&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;Agent alive and reachable&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">5</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-server2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;serfHealth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Serf Health Status&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;Agent alive and reachable&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">10</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-server3&quot;</span><span class="p">,</span>
    <span class="nt">&quot;CheckID&quot;</span><span class="p">:</span> <span class="s2">&quot;serfHealth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Serf Health Status&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;passing&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Notes&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Output&quot;</span><span class="p">:</span> <span class="s2">&quot;Agent alive and reachable&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;Definition&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">8</span>
  <span class="p">}</span>
<span class="p">]</span></code></pre></figure>

<p>any可以更换成其他状态：<code>any, passing, warning, or critical</code>。</p>

<h3 id="422-获取所有服务">4.2.2 获取所有服务</h3>
<p>文档：<a href="https://www.consul.io/api/catalog.html#list-services" target="_blank">List Services</a></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ curl http://127.0.0.1:18500/v1/catalog/services <span class="p">|</span> jq . </code></pre></figure>

<p>结果：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;consul&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&quot;gateway&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&quot;server&quot;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
  <p>The keys are the service names, and the array values provide all known tags for a given service.</p>
</blockquote>

<h3 id="423-根据服务名获取所有对应的服务节点">4.2.3 根据服务名获取所有对应的服务节点</h3>
<p>文档：<a href="https://www.consul.io/api/catalog.html#list-nodes-for-service" target="_blank">List Nodes for Service</a></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ curl http://127.0.0.1:18500/v1/catalog/service/:service_name <span class="p">|</span> jq . </code></pre></figure>

<p><code>server</code>的结果：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;f33332e4-3881-b975-d647-bc21a4ca41da&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Datacenter&quot;</span><span class="p">:</span> <span class="s2">&quot;dc1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;TaggedAddresses&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;lan&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.8&quot;</span><span class="p">,</span>
      <span class="nt">&quot;wan&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.8&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;NodeMeta&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;consul-network-segment&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceKind&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20gk4kq30tk&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;ServiceAddress&quot;</span><span class="p">:</span> <span class="s2">&quot;fullstack_server2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceWeights&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;Passing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;Warning&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceMeta&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;ServicePort&quot;</span><span class="p">:</span> <span class="mi">50051</span><span class="p">,</span>
    <span class="nt">&quot;ServiceEnableTagOverride&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;ServiceProxy&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;MeshGateway&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceConnect&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">26</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;feaba61d-83ce-a7e6-3e99-f1b2fa889bf8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.7&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Datacenter&quot;</span><span class="p">:</span> <span class="s2">&quot;dc1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;TaggedAddresses&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;lan&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.7&quot;</span><span class="p">,</span>
      <span class="nt">&quot;wan&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.7&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;NodeMeta&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;consul-network-segment&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceKind&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20hk4kq30n8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;ServiceAddress&quot;</span><span class="p">:</span> <span class="s2">&quot;fullstack_server3&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceWeights&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;Passing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;Warning&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceMeta&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;ServicePort&quot;</span><span class="p">:</span> <span class="mi">50051</span><span class="p">,</span>
    <span class="nt">&quot;ServiceEnableTagOverride&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;ServiceProxy&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;MeshGateway&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceConnect&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">24</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;feaba61d-83ce-a7e6-3e99-f1b2fa889bf8&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Node&quot;</span><span class="p">:</span> <span class="s2">&quot;consul-client2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.7&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Datacenter&quot;</span><span class="p">:</span> <span class="s2">&quot;dc1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;TaggedAddresses&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;lan&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.7&quot;</span><span class="p">,</span>
      <span class="nt">&quot;wan&quot;</span><span class="p">:</span> <span class="s2">&quot;172.26.0.7&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;NodeMeta&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;consul-network-segment&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceKind&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceID&quot;</span><span class="p">:</span> <span class="s2">&quot;eewk9hk4kq2uvy&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceName&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceTags&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="nt">&quot;ServiceAddress&quot;</span><span class="p">:</span> <span class="s2">&quot;fullstack_server1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ServiceWeights&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;Passing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;Warning&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceMeta&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;ServicePort&quot;</span><span class="p">:</span> <span class="mi">50051</span><span class="p">,</span>
    <span class="nt">&quot;ServiceEnableTagOverride&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;ServiceProxy&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;MeshGateway&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nt">&quot;ServiceConnect&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="nt">&quot;CreateIndex&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
    <span class="nt">&quot;ModifyIndex&quot;</span><span class="p">:</span> <span class="mi">22</span>
  <span class="p">}</span>
<span class="p">]</span></code></pre></figure>

<h3 id="424-根据service-id获取具体信息">4.2.4 根据service id获取具体信息</h3>
<p>文档：<a href="https://www.consul.io/api/agent/service.html#get-service-configuration" target="_blank">Get Service Configuration</a></p>

<p>需要注意，这个操作只能获取所查询agent（某个client）上注册的服务的信息。下面举两个例子，刚才有说到<code>fullstack_server2</code>是注册在<code>fullstack_consul_client1</code>上的；而<code>fullstack_server3</code>是注册在<code>fullstack_consul_client2</code>上的。</p>

<p><strong>fullstack_server2</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="c1"># 首先需要登入到docker network中的某台机器上，因为client都没有向主机暴露端口</span>
<span class="c1"># docker exec -it fullstack_consul_server1 /bin/sh</span>
$ curl http://fullstack_consul_client1:8500/v1/agent/service/1fw20gk4kq30tk <span class="p">|</span> jq .</code></pre></figure>

<p>结果：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20gk4kq30tk&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&quot;Meta&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="mi">50051</span><span class="p">,</span>
  <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="s2">&quot;fullstack_server2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Weights&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;Passing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;Warning&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&quot;EnableTagOverride&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&quot;ContentHash&quot;</span><span class="p">:</span> <span class="s2">&quot;b13f5888fa84e5d&quot;</span>
<span class="p">}</span></code></pre></figure>

<p><strong>fullstack_server3</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="c1"># 首先需要登入到docker network中的某台机器上，因为client都没有向主机暴露端口</span>
<span class="c1"># docker exec -it fullstack_consul_server1 /bin/sh</span>
$ curl http://fullstack_consul_client2:8500/v1/agent/service/1fw20hk4kq30n8 <span class="p">|</span> jq .</code></pre></figure>

<p>结果：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;1fw20hk4kq30n8&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;server&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&quot;Meta&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="mi">50051</span><span class="p">,</span>
  <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="s2">&quot;fullstack_server3&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Weights&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;Passing&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;Warning&quot;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&quot;EnableTagOverride&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&quot;ContentHash&quot;</span><span class="p">:</span> <span class="s2">&quot;120b74b874209fe8&quot;</span>
<span class="p">}</span></code></pre></figure>

<h3 id="425-删除某个服务的注册">4.2.5 删除某个服务的注册</h3>
<p>文档：<a href="https://www.consul.io/api/agent/service.html#deregister-service" target="_blank">Deregister Service</a></p>

<p>做开发的时候，为了测试，有的时候需要手动删除某些服务，这时候就要用到这个接口了。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ curl --request PUT http://127.0.0.1:18500/v1/agent/service/deregister/:service_id <span class="p">|</span> jq .</code></pre></figure>

<h2 id="43-ui">4.3 UI</h2>
<p>访问：http://127.0.0.1:18500，就会开启管理UI。</p>

<p><img src="/resources/2019/12/consul-note/ui.png" alt="" target="_blank" /></p>

<p>实际功能非常有限，主要是观察下集群及服务的状况。</p>

<h2 id="44-template">4.4 Template</h2>
<p>Consul有一个非常好用的功能就是能把注册的服务，通过一个模板，生成配置文件并输出到指定的位置。最常见的使用案例就是consul配合nginx，多个业务服务跑在后台，注册到consul，通过consul将业务后台的信息生成成nginx配置文件。同时，任何业务后台的变动都会触发配置文件的重新生成。consul的template还可以指定一个外部命令，在刚才提到的例子中就可以触发nginx的reload，使改变的配置文件生效。</p>

<p>template有单独的镜像：<a href="https://hub.docker.com/r/hashicorp/consul-template/" target="_blank">hashicorp/consul-template</a></p>

<p>范例nginx配置模板，文件位置：<code>./vendor/consul/nginx</code></p>

<pre><code>   
upstream gateway {
    server : max_fails=3 fail_timeout=60 weight=1;
    server 127.0.0.1:65535; # force a 502
}  

server {
    listen 80;
    server_name localhost;

    access_log /var/log/nginx/fullstack.access.log;
    error_log /var/log/nginx/fullstack.error.log;

    root /usr/share/nginx/html;

    index index.html index.htm index.nginx-debian.html;

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    location / {
        proxy_set_header x-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header HOST $http_host;
        proxy_set_header X-Forwarded-Proto https;
        proxy_redirect http:// https://;
        proxy_connect_timeout 240;
        proxy_send_timeout 240;
        proxy_read_timeout 240;
        proxy_pass http://gateway;
    }
}
</code></pre>

<p>template启动：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ docker run --rm -it --name templateX <span class="se">\</span>
    -v ./vendor/consul/nginx:/tmp/nginx.ctmpl <span class="se">\ </span><span class="c1"># 将模板配置文件映射到容器内</span>
    -v /tmp/template:/consul-template/data <span class="se">\ </span>   <span class="c1"># 将主机的临时文件夹映射到容器内配置文件的生成位置，方便后续在主机上直接查看生成的配置文件</span>
    hashicorp/consul-template:0.22.1-alpine <span class="se">\</span>
    -dry <span class="se">\</span>
    -log-level<span class="o">=</span>debug <span class="se">\</span>
    -consul-addr<span class="o">=</span>host.docker.internal:18500 <span class="se">\</span>
    -consul-retry <span class="se">\</span>
    -consul-retry-attempts<span class="o">=</span><span class="m">5</span> <span class="se">\</span>
    -consul-retry-backoff<span class="o">=</span>500ms <span class="se">\</span>
    -template<span class="o">=</span>/tmp/nginx.ctmpl:/consul-template/data/default.conf</code></pre></figure>

<p>查看生成的：<code>/tmp/template/default.conf</code></p>

<figure class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span></span><span class="k">upstream</span> <span class="s">gateway</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="s">fullstack_gateway3:3000</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
    <span class="kn">server</span> <span class="s">fullstack_gateway1:3000</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>
    <span class="kn">server</span> <span class="s">fullstack_gateway2:3000</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=60</span> <span class="s">weight=1</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">localhost</span><span class="p">;</span>

    <span class="kn">access_log</span> <span class="s">/var/log/nginx/fullstack.access.log</span><span class="p">;</span>
    <span class="kn">error_log</span> <span class="s">/var/log/nginx/fullstack.error.log</span><span class="p">;</span>

    <span class="kn">root</span> <span class="s">/usr/share/nginx/html</span><span class="p">;</span>

    <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.nginx-debian.html</span><span class="p">;</span>

    <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
    <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
        <span class="kn">root</span>   <span class="s">/usr/share/nginx/html</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span> <span class="s">x-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">HOST</span> <span class="nv">$http_host</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="s">https</span><span class="p">;</span>
        <span class="kn">proxy_redirect</span> <span class="s">http://</span> <span class="s">https://</span><span class="p">;</span>
        <span class="kn">proxy_connect_timeout</span> <span class="mi">240</span><span class="p">;</span>
        <span class="kn">proxy_send_timeout</span> <span class="mi">240</span><span class="p">;</span>
        <span class="kn">proxy_read_timeout</span> <span class="mi">240</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://gateway</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="45-dns">4.5 DNS</h2>
<p>官方文档：<a href="https://www.consul.io/docs/agent/dns.html" target="_blank">DNS Interface</a>。</p>

<p>使用上应该说是非常简便了，而且基本上对业务没什么侵入性。我之前做的实验项目里没使用这个功能，主要是因为需要改动主机的DNS，比较麻烦。</p>

<h2 id="46-application">4.6 Application</h2>
<p>Consul有不少语言对应的客户端，我的实验项目用过node.js的：<a href="https://www.npmjs.com/package/consul" target="_blank">Consul</a>。</p>

<p>注册服务：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">Consul</span> <span class="nx">from</span> <span class="s2">&quot;consul&quot;</span><span class="p">;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">exitHook</span> <span class="nx">from</span> <span class="s2">&quot;async-exit-hook&quot;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">serviceId</span>: <span class="kt">string</span> <span class="o">=</span> <span class="nx">uniqid</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">consul</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Consul</span><span class="p">({</span>
    <span class="nx">host</span>: <span class="kt">CONSUL_HOST</span><span class="p">,</span> <span class="c1">// fullstack_consul_client2</span>
    <span class="nx">port</span>: <span class="kt">CONSUL_PORT</span><span class="p">,</span> <span class="c1">// 8500</span>
    <span class="nx">promisify</span>: <span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">register</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">serverConf</span> <span class="o">=</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">getRaw</span><span class="p">().</span><span class="nx">server</span><span class="p">;</span>
    <span class="nx">await</span> <span class="nx">consul</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
        <span class="nx">name</span>: <span class="kt">serverConf.serviceName</span><span class="p">,</span> <span class="c1">// server</span>
        <span class="nx">id</span>: <span class="kt">serviceId</span><span class="p">,</span>
        <span class="nx">address</span>: <span class="kt">SERVICE_HOST</span><span class="p">,</span>        <span class="c1">// fullstack_server3</span>
        <span class="nx">port</span>: <span class="kt">serverConf.servicePort</span><span class="p">,</span> <span class="c1">// 50051</span>
        <span class="nx">check</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">http</span><span class="o">:</span> <span class="err">`</span><span class="nx">http</span><span class="o">:</span><span class="c1">//${SERVICE_HOST}:${serverConf.webPort}/health`, // http://fullstack_server3:50052/health</span>
            <span class="nx">interval</span><span class="o">:</span> <span class="s2">&quot;10s&quot;</span><span class="p">,</span>
            <span class="nx">ttl</span><span class="o">:</span> <span class="s2">&quot;15s&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">cleanup</span> <span class="o">=</span> <span class="p">(</span><span class="nx">done</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">consul</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">deregister</span><span class="p">(</span><span class="nx">serviceId</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;cleanup done&quot;</span><span class="p">);</span>
            <span class="nx">done</span><span class="p">();</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="nx">done</span><span class="p">();</span>
        <span class="p">});</span>
<span class="p">};</span>

<span class="c1">// exit</span>
<span class="nx">exitHook</span><span class="p">.</span><span class="nx">forceExitTimeout</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// wait 0.5s before force exit</span>
<span class="nx">exitHook</span><span class="p">((</span><span class="nx">done</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Process::exitHook - Got exit signal&quot;</span><span class="p">);</span>
    <span class="nx">cleanup</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// start</span>
<span class="nx">startServer</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">startWeb</span><span class="p">()).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">register</span><span class="p">()).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span></code></pre></figure>

<p>在服务启动的时候进行注册，并且记得要<code>处理程序退出</code>，退出的时候需要将注册信息删除，否则即便应用程序退出了，在consul里那个服务还是存在的。</p>

<p>客户端获取<code>可用节点</code>：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="nx">consul</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Consul</span><span class="p">({</span>
    <span class="nx">host</span>: <span class="kt">CONSUL_HOST</span><span class="p">,</span>
    <span class="nx">port</span>: <span class="kt">CONSUL_PORT</span><span class="p">,</span>
    <span class="nx">promisify</span>: <span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">servers</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">consul</span><span class="p">.</span><span class="nx">health</span><span class="p">.</span><span class="nx">service</span><span class="p">({</span>
    <span class="nx">service</span>: <span class="kt">CONFIG.getRaw</span><span class="p">().</span><span class="nx">server</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span> <span class="c1">// server</span>
    <span class="nx">passing</span>: <span class="kt">true</span><span class="p">,</span>                               <span class="c1">// get only living nodes</span>
<span class="p">})</span> <span class="kr">as</span> <span class="nx">IResHealthService</span><span class="p">[];</span>

<span class="c1">// ...</span></code></pre></figure>

<h2 id="47-health-check">4.7 Health Check</h2>
<p>官方文档：<a href="https://www.consul.io/docs/agent/checks.html" target="_blank">Checks</a></p>

<p>在4.6的范例里也提到了，在注册服务的时候可以提供当前注册进consul的应用程序的健康检查设置，consul会使用HTTP请求来检查该URL，只要是200返回就表示该服务仍旧存活。</p>

<p><img src="/resources/2019/12/consul-note/living_node.png" alt="" target="_blank" /></p>

<h1 id="appendix">Appendix</h1>
<h2 id="资料">资料</h2>
<ul>
  <li><a href="https://my.oschina.net/qiangmzsx/blog/1634206" target="_blank">consul服务注册与服务发现的巨坑</a></li>
</ul>

<h2 id="ID_APP_AGENT_HELP">consul agent –help</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>docker run -it --rm consul:1.6.1 agent --help
Usage: consul agent <span class="o">[</span>options<span class="o">]</span>

  Starts the Consul agent and runs <span class="k">until</span> an interrupt is received. The
  agent represents a single node in a cluster.

HTTP API Options

  -datacenter<span class="o">=</span>&lt;value&gt;
     Datacenter of the agent.

Command Options

  -advertise<span class="o">=</span>&lt;value&gt;
     Sets the advertise address to use.

  -advertise-wan<span class="o">=</span>&lt;value&gt;
     Sets address to advertise on WAN instead of -advertise address.

  -allow-write-http-from<span class="o">=</span>&lt;value&gt;
     Only allow write endpoint calls from given network. CIDR format,
     can be specified multiple times.

  -alt-domain<span class="o">=</span>&lt;value&gt;
     Alternate domain to use <span class="k">for</span> DNS interface.

  -bind<span class="o">=</span>&lt;value&gt;
     Sets the <span class="nb">bind</span> address <span class="k">for</span> cluster communication.

  -bootstrap
     Sets server to bootstrap mode.

  -bootstrap-expect<span class="o">=</span>&lt;value&gt;
     Sets server to expect bootstrap mode.

  -check_output_max_size<span class="o">=</span>&lt;value&gt;
     Sets the maximum output size <span class="k">for</span> checks on this agent

  -client<span class="o">=</span>&lt;value&gt;
     Sets the address to <span class="nb">bind</span> <span class="k">for</span> client access. This includes RPC, DNS,
     HTTP, HTTPS and gRPC <span class="o">(</span><span class="k">if</span> configured<span class="o">)</span>.

  -config-dir<span class="o">=</span>&lt;value&gt;
     Path to a directory to <span class="nb">read</span> configuration files from. This
     will <span class="nb">read</span> every file ending in <span class="s1">&#39;.json&#39;</span> as configuration in this
     directory in alphabetical order. Can be specified multiple times.

  -config-file<span class="o">=</span>&lt;value&gt;
     Path to a file in JSON or HCL format with a matching file
     extension. Can be specified multiple times.

  -config-format<span class="o">=</span>&lt;value&gt;
     Config files are in this format irrespective of their extension.
     Must be <span class="s1">&#39;hcl&#39;</span> or <span class="s1">&#39;json&#39;</span>

  -data-dir<span class="o">=</span>&lt;value&gt;
     Path to a data directory to store agent state.

  -dev
     Starts the agent in development mode.

  -disable-host-node-id
     Setting this to <span class="nb">true</span> will prevent Consul from using information
     from the host to generate a node ID, and will cause Consul to
     generate a random node ID instead.

  -disable-keyring-file
     Disables the backing up of the keyring to a file.

  -dns-port<span class="o">=</span>&lt;value&gt;
     DNS port to use.

  -domain<span class="o">=</span>&lt;value&gt;
     Domain to use <span class="k">for</span> DNS interface.

  -enable-local-script-checks
     Enables health check scripts from configuration file.

  -enable-script-checks
     Enables health check scripts.

  -encrypt<span class="o">=</span>&lt;value&gt;
     Provides the gossip encryption key.

  -grpc-port<span class="o">=</span>&lt;value&gt;
     Sets the gRPC API port to listen on <span class="o">(</span>currently needed <span class="k">for</span> Envoy xDS
     only<span class="o">)</span>.

  -hcl<span class="o">=</span>&lt;value&gt;
     hcl config fragment. Can be specified multiple times.

  -http-port<span class="o">=</span>&lt;value&gt;
     Sets the HTTP API port to listen on.

  -join<span class="o">=</span>&lt;value&gt;
     Address of an agent to join at start time. Can be specified
     multiple times.

  -join-wan<span class="o">=</span>&lt;value&gt;
     Address of an agent to join -wan at start time. Can be specified
     multiple times.

  -log-file<span class="o">=</span>&lt;value&gt;
     Path to the file the logs get written to

  -log-level<span class="o">=</span>&lt;value&gt;
     Log level of the agent.

  -log-rotate-bytes<span class="o">=</span>&lt;value&gt;
     Maximum number of bytes that should be written to a log file

  -log-rotate-duration<span class="o">=</span>&lt;value&gt;
     Time after which log rotation needs to be performed

  -log-rotate-max-files<span class="o">=</span>&lt;value&gt;
     Maximum number of log file archives to keep

  -node<span class="o">=</span>&lt;value&gt;
     Name of this node. Must be unique in the cluster.

  -node-id<span class="o">=</span>&lt;value&gt;
     A unique ID <span class="k">for</span> this node across space and time. Defaults to a
     randomly-generated ID that persists in the data-dir.

  -node-meta<span class="o">=</span>&lt;key:value&gt;
     An arbitrary metadata key/value pair <span class="k">for</span> this node, of the format
     <span class="sb">`</span>key:value<span class="sb">`</span>. Can be specified multiple times.

  -non-voting-server
     <span class="o">(</span>Enterprise-only<span class="o">)</span> This flag is used to make the server not
     participate in the Raft quorum, and have it only receive the data
     replication stream. This can be used to add <span class="nb">read</span> scalability to
     a cluster in cases where a high volume of reads to servers are
     needed.

  -pid-file<span class="o">=</span>&lt;value&gt;
     Path to file to store agent PID.

  -protocol<span class="o">=</span>&lt;value&gt;
     Sets the protocol version. Defaults to latest.

  -raft-protocol<span class="o">=</span>&lt;value&gt;
     Sets the Raft protocol version. Defaults to latest.

  -recursor<span class="o">=</span>&lt;value&gt;
     Address of an upstream DNS server. Can be specified multiple times.

  -rejoin
     Ignores a previous leave and attempts to rejoin the cluster.

  -retry-interval<span class="o">=</span>&lt;value&gt;
     Time to <span class="nb">wait</span> between join attempts.

  -retry-interval-wan<span class="o">=</span>&lt;value&gt;
     Time to <span class="nb">wait</span> between join -wan attempts.

  -retry-join<span class="o">=</span>&lt;value&gt;
     Address of an agent to join at start <span class="nb">time</span> with retries enabled. Can
     be specified multiple times.

  -retry-join-wan<span class="o">=</span>&lt;value&gt;
     Address of an agent to join -wan at start <span class="nb">time</span> with retries
     enabled. Can be specified multiple times.

  -retry-max<span class="o">=</span>&lt;value&gt;
     Maximum number of join attempts. Defaults to <span class="m">0</span>, which will retry
     indefinitely.

  -retry-max-wan<span class="o">=</span>&lt;value&gt;
     Maximum number of join -wan attempts. Defaults to <span class="m">0</span>, which will
     retry indefinitely.

  -segment<span class="o">=</span>&lt;value&gt;
     <span class="o">(</span>Enterprise-only<span class="o">)</span> Sets the network segment to join.

  -serf-lan-bind<span class="o">=</span>&lt;value&gt;
     Address to <span class="nb">bind</span> Serf LAN listeners to.

  -serf-lan-port<span class="o">=</span>&lt;value&gt;
     Sets the Serf LAN port to listen on.

  -serf-wan-bind<span class="o">=</span>&lt;value&gt;
     Address to <span class="nb">bind</span> Serf WAN listeners to.

  -serf-wan-port<span class="o">=</span>&lt;value&gt;
     Sets the Serf WAN port to listen on.

  -server
     Switches agent to server mode.

  -server-port<span class="o">=</span>&lt;value&gt;
     Sets the server port to listen on.

  -syslog
     Enables logging to syslog.

  -ui
     Enables the built-in static web UI server.

  -ui-content-path<span class="o">=</span>&lt;value&gt;
     Sets the external UI path to a string. Defaults to: /ui/

  -ui-dir<span class="o">=</span>&lt;value&gt;
     Path to directory containing the web UI resources.</code></pre></figure>

<h2 id="consul-help">consul –help</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ docker run -it --rm consul:1.6.1 --help
Usage: consul <span class="o">[</span>--version<span class="o">]</span> <span class="o">[</span>--help<span class="o">]</span> &lt;command&gt; <span class="o">[</span>&lt;args&gt;<span class="o">]</span>

Available commands are:
    acl            Interact with Consul<span class="s1">&#39;s ACLs</span>
<span class="s1">    agent          Runs a Consul agent</span>
<span class="s1">    catalog        Interact with the catalog</span>
<span class="s1">    config         Interact with Consul&#39;</span>s Centralized Configurations
    connect        Interact with Consul Connect
    debug          Records a debugging archive <span class="k">for</span> operators
    event          Fire a new event
    <span class="nb">exec</span>           Executes a <span class="nb">command</span> on Consul nodes
    force-leave    Forces a member of the cluster to enter the <span class="s2">&quot;left&quot;</span> state
    info           Provides debugging information <span class="k">for</span> operators.
    intention      Interact with Connect service intentions
    join           Tell Consul agent to join cluster
    keygen         Generates a new encryption key
    keyring        Manages gossip layer encryption keys
    kv             Interact with the key-value store
    leave          Gracefully leaves the Consul cluster and shuts down
    lock           Execute a <span class="nb">command</span> holding a lock
    login          Login to Consul using an auth method
    <span class="nb">logout</span>         Destroy a Consul token created with login
    maint          Controls node or service maintenance mode
    members        Lists the members of a Consul cluster
    monitor        Stream logs from a Consul agent
    operator       Provides cluster-level tools <span class="k">for</span> Consul operators
    reload         Triggers the agent to reload configuration files
    rtt            Estimates network round trip <span class="nb">time</span> between nodes
    services       Interact with services
    snapshot       Saves, restores and inspects snapshots of Consul server state
    tls            Builtin helpers <span class="k">for</span> creating CAs and certificates
    validate       Validate config files/directories
    version        Prints the Consul version
    watch          Watch <span class="k">for</span> changes in Consul</code></pre></figure>

<blockquote>
  <p>EOF</p>
</blockquote>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2019/12/docker-registry/">Docker Registry 的简单使用</a></li>
    
    <li><a href="/2019/12/gitea-note/">Gitea简单介绍及使用</a></li>
    
    <li><a href="/2019/12/consul-note/">Consul Notes</a></li>
    
    <li><a href="/2019/12/drone-ci/">使用Drone进行CI支持</a></li>
    
    <li><a href="/2019/12/node-in-docker/">在Docker中使用Node</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
      <li><a href="/category/V8Blog">V8Blog</a></li>
    
      <li><a href="/category/Docker">Docker</a></li>
    
      <li><a href="/category/Golang">Golang</a></li>
    
      <li><a href="/category/Career">Career</a></li>
    
      <li><a href="/category/Prometheus">Prometheus</a></li>
    
      <li><a href="/category/Grafana">Grafana</a></li>
    
      <li><a href="/category/Logging">Logging</a></li>
    
      <li><a href="/category/Jaeger">Jaeger</a></li>
    
      <li><a href="/category/Elasticsearch">Elasticsearch</a></li>
    
      <li><a href="/category/MessageQueue">MessageQueue</a></li>
    
      <li><a href="/category/Kafka">Kafka</a></li>
    
      <li><a href="/category/gRPC">gRPC</a></li>
    
      <li><a href="/category/Envoy">Envoy</a></li>
    
      <li><a href="/category/DistributedSystem">DistributedSystem</a></li>
    
      <li><a href="/category/Tor">Tor</a></li>
    
      <li><a href="/category/Node.js">Node.js</a></li>
    
      <li><a href="/category/CI">CI</a></li>
    
      <li><a href="/category/ServiceDiscovery">ServiceDiscovery</a></li>
    
      <li><a href="/category/Git">Git</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2019/12/consul-note/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2019</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
