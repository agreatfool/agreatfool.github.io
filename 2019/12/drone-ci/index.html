<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>使用Drone进行CI支持 | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2019/12/drone-ci/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
  <style>
    /* Enhance table style */
    table {
      border: 2px solid #4F7849;
      background-color: #EEEEEE;
      width: 100%;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table.comicGreen th {
      border: 1px solid #4F7849;
      padding: 3px 5px;
    }
    table tbody td {
      font-size: 14px;
      color: #4F7849;
    }
    table tr:nth-child(even) {
      background: #CEE0CC;
    }
    table thead {
      background: #4F7849;
      border-bottom: 1px solid #444444;
    }
    table thead th {
      font-size: 16px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #D0E4F5;
      padding: 3px 5px;
    }
    table thead th:first-child {
      border-left: none;
    }
    table tfoot td {
      font-size: 21px;
    }

    /* Enhance pre style */
    pre {
      color: #FFFFFF;
      background-color: #000000;
      border-color: #000000;
    }

    /* Image bg color white while dark background */
    img {
      background-color: #FFFFFF;
    }

    /* Keep gist style clean */
    .gist table tr:nth-child(even) {
      background: #FFFFFF;
    }
    .gist td, th {
      border: none;
    }
  </style>
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2019/12/drone-ci/">使用Drone进行CI支持</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>23 Dec 2019</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/Drone">Drone</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/CI">CI</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#1-前言" id="markdown-toc-1-前言">1. 前言</a></li>
  <li><a href="#2-概念" id="markdown-toc-2-概念">2. 概念</a>    <ul>
      <li><a href="#21-pipeline" id="markdown-toc-21-pipeline">2.1 <a href="https://docs.drone.io/configure/pipeline/" target="_blank">pipeline</a></a></li>
      <li><a href="#22-step" id="markdown-toc-22-step">2.2 <a href="https://docker-runner.docs.drone.io/configuration/steps/" target="_blank">step</a></a></li>
      <li><a href="#23-workspace" id="markdown-toc-23-workspace">2.3 <a href="https://docker-runner.docs.drone.io/configuration/workspace/" target="_blank">workspace</a></a></li>
      <li><a href="#24-trigger" id="markdown-toc-24-trigger">2.4 <a href="https://docker-runner.docs.drone.io/configuration/trigger/" target="_blank">trigger</a></a></li>
      <li><a href="#25-condition" id="markdown-toc-25-condition">2.5 <a href="https://docker-runner.docs.drone.io/configuration/conditions/" target="_blank">condition</a></a></li>
    </ul>
  </li>
  <li><a href="#3-架构--multiple-pipeline--parallelism" id="markdown-toc-3-架构--multiple-pipeline--parallelism">3. 架构 &amp; Multiple Pipeline &amp; Parallelism</a>    <ul>
      <li><a href="#31-架构" id="markdown-toc-31-架构">3.1 架构</a></li>
      <li><a href="#32-multiple-pipeline" id="markdown-toc-32-multiple-pipeline">3.2 Multiple Pipeline</a></li>
      <li><a href="#33-parallelism" id="markdown-toc-33-parallelism">3.3 Parallelism</a></li>
    </ul>
  </li>
  <li><a href="#4-使用" id="markdown-toc-4-使用">4. 使用</a>    <ul>
      <li><a href="#41-server安装--运行" id="markdown-toc-41-server安装--运行">4.1 Server：安装 &amp; 运行</a>        <ul>
          <li><a href="#411-oauth2准备" id="markdown-toc-411-oauth2准备">4.1.1 OAuth2准备</a></li>
          <li><a href="#412-启动drone" id="markdown-toc-412-启动drone">4.1.2 启动drone</a></li>
          <li><a href="#413-oauth2授权" id="markdown-toc-413-oauth2授权">4.1.3 OAuth2授权</a></li>
          <li><a href="#414-ui同步--激活代码库" id="markdown-toc-414-ui同步--激活代码库">4.1.4 UI同步 &amp; 激活代码库</a></li>
          <li><a href="#415-api秘钥" id="markdown-toc-415-api秘钥">4.1.5 API秘钥</a></li>
        </ul>
      </li>
      <li><a href="#42-runner安装--运行" id="markdown-toc-42-runner安装--运行">4.2 Runner：安装 &amp; 运行</a>        <ul>
          <li><a href="#421-安装" id="markdown-toc-421-安装">4.2.1 安装</a></li>
          <li><a href="#422-运行" id="markdown-toc-422-运行">4.2.2 运行</a></li>
        </ul>
      </li>
      <li><a href="#43-ui秘钥设置" id="markdown-toc-43-ui秘钥设置">4.3 UI秘钥设置</a></li>
      <li><a href="#44-私有registry" id="markdown-toc-44-私有registry">4.4 私有Registry</a></li>
      <li><a href="#45-部署--多点事件触发" id="markdown-toc-45-部署--多点事件触发">4.5 部署 &amp; 多点事件触发</a>        <ul>
          <li><a href="#451-drone-api--drone-cli" id="markdown-toc-451-drone-api--drone-cli">4.5.1 drone api | drone cli</a></li>
          <li><a href="#452-plugin" id="markdown-toc-452-plugin">4.5.2 plugin</a></li>
          <li><a href="#453-webhook-plugin" id="markdown-toc-453-webhook-plugin">4.5.3 webhook plugin</a></li>
          <li><a href="#454-webhook-fake" id="markdown-toc-454-webhook-fake">4.5.4 webhook fake</a></li>
          <li><a href="#455-waiting-hack" id="markdown-toc-455-waiting-hack">4.5.5 waiting hack</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="1-前言">1. 前言</h1>
<p>Drone是一个Golang技术栈的CI解决方案，功能和Jenkins之类的CI工具类似。</p>

<p>优点：</p>

<ul>
  <li>Golang编写，分发及搭建非常容易（镜像体积很小）</li>
  <li>Golang编写，运行时占用资源极小（特指和Java栈的一系列工具比较）</li>
  <li>构建运行时以镜像优先，保证在不同平台的构建结果一致</li>
  <li>优秀的设计，支持插件化提供强大的功能支持</li>
  <li>现代化的UI，开箱即用，甩开Jenkins之类有历史包袱的工具几条街</li>
</ul>

<p>缺点：</p>

<ul>
  <li>较年轻，文档工作需要强化</li>
  <li>插件的数量和质量，以及插件的文档支持需要强化</li>
  <li>功能尚不能说强大，和Jenkins之类的老牌CI相比差距较大</li>
</ul>

<p>简单选择：</p>

<ul>
  <li>Drone：
    <ul>
      <li>小型团队，对新技术适应能力较强的团队</li>
      <li>对功能的丰富性要求并不是很高，但要求性能强大功能稳定</li>
    </ul>
  </li>
  <li>Jenkins：
    <ul>
      <li>对功能的丰富性要求较高，要求任何情况任何需求都能快速应对</li>
      <li>运维人员对Jenkins非常熟悉可以很快上手使用</li>
    </ul>
  </li>
</ul>

<p>相关资源：</p>

<ul>
  <li>官方站点：<a href="https://drone.io/" target="_blank">drone.io</a></li>
  <li>文档站点：<a href="https://docs.drone.io/" target="_blank">docs.drone.io</a></li>
  <li>官方论坛：<a href="https://discourse.drone.io/" target="_blank">discourse.drone.io</a></li>
</ul>

<h1 id="2-概念">2. 概念</h1>
<h2 id="21-pipeline">2.1 <a href="https://docs.drone.io/configure/pipeline/" target="_blank">pipeline</a></h2>
<ul>
  <li>pipeline是drone的核心概念</li>
  <li>pipeline一般负责完成一个<code>任务</code>：构建、发布、部署，其内部会有多个行为共同组成一个pipeline</li>
  <li>pipeline在drone里是进行分类的，按类型有多种种类，常用的有：
    <ul>
      <li><a href="https://docker-runner.docs.drone.io/configuration/" target="_blank">docker</a>：所有的构建行为都在临时docker容器内进行，跨平台保证行为一致
        <ul>
          <li><a href="https://exec-runner.docs.drone.io/configuration/variables/" target="_blank">Environment Variables</a></li>
        </ul>
      </li>
      <li><a href="https://exec-runner.docs.drone.io/configuration/" target="_blank">exec</a>：所有的构建行为都在runner所在主机上进行，一般用在某些不方便放在容器内运行的工作，e.g xcode项目的构建
        <ul>
          <li><a href="https://docker-runner.docs.drone.io/configuration/environment/variables/" target="_blank">Environment Variables</a></li>
        </ul>
      </li>
      <li><a href="https://ssh-runner.docs.drone.io/configuration/" target="_blank">ssh</a>：构建行为通过ssh执行远程命令进行
        <ul>
          <li><a href="https://ssh-runner.docs.drone.io/configuration/variables/" target="_blank">Environment Variables</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="22-step">2.2 <a href="https://docker-runner.docs.drone.io/configuration/steps/" target="_blank">step</a></h2>
<ul>
  <li>pipeline里的每一个操作被称为<code>step</code></li>
  <li>组织多个<code>step</code>可以完成一个特定的pipeline，e.g
    <ul>
      <li>构建pipeline：clone、安装依赖、单元测试、打包、制作镜像、推送镜像</li>
    </ul>
  </li>
</ul>

<h2 id="23-workspace">2.3 <a href="https://docker-runner.docs.drone.io/configuration/workspace/" target="_blank">workspace</a></h2>
<ul>
  <li>构建运行的工作空间，在不同的环境下其位置会有所不同</li>
  <li>Posix系统（含docker容器），工作空间在：<code>/tmp/drone-${RANDOM}/drone/src</code></li>
  <li>OSX系统，工作空间在：<code>/private/var/folders/...</code></li>
  <li>Win系统，工作空间在：<code>C:\windows\drone-%RANDOM%\drone\src</code></li>
  <li>有一点要强调下，如果在bash脚本中访问当前pipeline的<code>~</code>或<code>$HOME</code>，获得的地址就是workspace的根目录，而<code>不是</code>当前runner的用户home</li>
  <li>此外，workspace是临时的，会在pipeline创建的时候产生，并在完成的时候被销毁</li>
</ul>

<h2 id="24-trigger">2.4 <a href="https://docker-runner.docs.drone.io/configuration/trigger/" target="_blank">trigger</a></h2>
<ul>
  <li>trigger决定当前的<code>pipeline</code>是否要<code>触发</code></li>
  <li>trigger有很多类型：
    <ul>
      <li>根据分支：e.g 是否dev分支</li>
      <li>根据事件：e.g 是否tag事件（注意，tag和分支trigger不能同时存在，因为tag是不区分分支的）</li>
      <li>根据reference：e.g refs/tags/**</li>
      <li>根据代码库：e.g octocat/hello-world</li>
      <li>根据runner实例：e.g drone.instance1.com</li>
      <li>根据状态触发：e.g failure</li>
    </ul>
  </li>
</ul>

<h2 id="25-condition">2.5 <a href="https://docker-runner.docs.drone.io/configuration/conditions/" target="_blank">condition</a></h2>
<ul>
  <li>condition决定当前的<code>step</code>是否要<code>触发</code></li>
  <li>condition有很多类型：
    <ul>
      <li>根据分支：e.g 是否dev分支</li>
      <li>根据事件：e.g 是否tag事件（注意，tag和分支condition不能同时存在，因为tag是不区分分支的）</li>
      <li>根据reference：e.g refs/tags/**</li>
      <li>根据代码库：e.g octocat/hello-world</li>
      <li>根据runner实例：e.g drone.instance1.com</li>
      <li>根据状态触发：e.g failure</li>
    </ul>
  </li>
</ul>

<h1 id="3-架构--multiple-pipeline--parallelism">3. 架构 &amp; Multiple Pipeline &amp; Parallelism</h1>
<h2 id="31-架构">3.1 架构</h2>
<p>Drone这个CI其实很简单，也说不上什么架构。一般Drone会有一个单点Server，在git工具上注册好webhook接收事件，然后启动多个Runner来处理Server上产生的任务。这些Runner可以在同一台主机上，也可以分散在多台不同的主机上，官方文档的指引中要求不要将runner和server放在同一台主机上。</p>

<h2 id="32-multiple-pipeline">3.2 Multiple Pipeline</h2>
<p>官方说明：</p>

<blockquote>
  <p>Drone supports configuring and orchestrating multiple pipelines. This is useful when you need to fan-out and distribute your build tasks across multiple machines to reduce build times, or to execute your build tasks across multiple platforms (e.g. amd64 and arm64).</p>
</blockquote>

<p><strong>用途1：</strong></p>

<p>在处理大型项目任务的时候，将任务拆散，分散到不同的物理机上进行并行处理，加速整个构建进程。如果是不同主机的话，需要用到<code>2.4</code>提到的pipeline trigger，将不同的pipeline设定好自己的运行目标主机。保证同一个repo在不同主机上触发的时候，只有当前主机（runner）应该执行的pipeline得到执行。</p>

<p><strong>用途2：</strong></p>

<p>确定pipeline之间的先后顺序，通过在pipeline一级定义<code>depends_on</code>来申明相互之间的依赖关系。这里特别需要注意的是：pipeline之间是不共享workspace的。所以每一步都需要单独做类似于依赖安装之类的工作，这需要特别小心。</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="c1"># ...</span>

<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">p3</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
  <span class="c1"># ...</span>

<span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">p1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">p2</span></code></pre></figure>

<h2 id="33-parallelism">3.3 Parallelism</h2>
<p>这部分内容与 Multiple Pipeline 的关系，和之前讲过的 trigger 与 condition 的关系一样。Multiple Pipeline 是pipeline级别的，而Parallelism则是step级别的，本质上仍旧是并行运行。</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="c1"># ...</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
<span class="c1"># ...</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">s3</span>
  <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="c1"># ...</span>
  <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">s1</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">s2</span></code></pre></figure>

<h1 id="4-使用">4. 使用</h1>
<h2 id="41-server安装--运行">4.1 Server：安装 &amp; 运行</h2>
<h3 id="411-oauth2准备">4.1.1 OAuth2准备</h3>
<p>需要在git repo软件上申请一个OAuth应用。这里我使用的是Gitea，就拿它来做演示：</p>

<p>点击：<code>右上角头像 &gt; 设置（下拉菜单） &gt; 应用（页面中间）</code>，打开的页面是管理用户级别的<code>Access Tokens</code>和<code>OAuth2应用</code>的。</p>

<p><img src="/resources/2019/12/drone-ci/oauth1.png" alt="" target="_blank" /></p>

<p>找到：<code>创建新的 OAuth2 应用程序</code>这一栏，输入：</p>

<ul>
  <li>应用名称：这名字后面用不到，填可理解的内容即可</li>
  <li><code>重定向 URI</code>：http://<code>${drone_host}:${drone_ip}</code>/login</li>
</ul>

<p><img src="/resources/2019/12/drone-ci/oauth2.png" alt="" target="_blank" /></p>

<p>点击<code>创建应用</code>。</p>

<p>在打开的页面上显示了OAuth2应用的相关信息，这里需要记下：</p>

<ul>
  <li>客户端ID</li>
  <li>客户端秘钥</li>
</ul>

<p><img src="/resources/2019/12/drone-ci/oauth3.png" alt="" target="_blank" /></p>

<h3 id="412-启动drone">4.1.2 启动drone</h3>
<p>Golang应用程序，使用上最容易的方式仍旧是镜像：<a href="https://hub.docker.com/r/drone/drone" target="_blank">drone/drone</a>。</p>

<p>drone服务器启动时的环境变量文档在：<a href="https://docs.drone.io/installation/reference/" target="_blank">Drone Documentation &gt; Installation &gt; Reference</a>。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ docker run -it -d <span class="se">\</span>
    --name drone-server <span class="se">\</span>
    -p <span class="m">18980</span>:80 <span class="se">\</span>
    --log-driver<span class="o">=</span>json-file <span class="se">\</span>
    --log-opt max-size<span class="o">=</span>512m <span class="se">\</span>
    -v /tmp/drone/data:/data <span class="se">\ </span><span class="c1"># sqlite db file</span>
    -e <span class="nv">DRONE_LOGS_DEBUG</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    -e <span class="nv">DRONE_LOGS_COLOR</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    -e <span class="nv">DRONE_LOGS_PRETTY</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    -e <span class="nv">DRONE_LOGS_TRACE</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    -e <span class="nv">DRONE_AGENTS_ENABLED</span><span class="o">=</span><span class="nb">true</span> <span class="se">\ </span>                                             <span class="c1"># drone server running with no agents, start runners manually</span>
    -e <span class="nv">DRONE_GITEA_SKIP_VERIFY</span><span class="o">=</span><span class="nb">true</span> <span class="se">\ </span>                                          <span class="c1"># gitea: use http protocol</span>
    -e <span class="nv">DRONE_GITEA_SERVER</span><span class="o">=</span>http://host.docker.internal:13000 <span class="se">\ </span>                  <span class="c1"># gitea: server address with protocol</span>
    -e <span class="nv">DRONE_GITEA_CLIENT_ID</span><span class="o">=</span>fd023edb-7976-4d50-a92f-b16612683240 <span class="se">\ </span>            <span class="c1"># gitea: oauth client id</span>
    -e <span class="nv">DRONE_GITEA_CLIENT_SECRET</span><span class="o">=</span><span class="nv">S4Q6PktE3dKNHPUzZrTdyNJsTThwal4doUWf6jf4eRA</span><span class="o">=</span> <span class="se">\ </span><span class="c1"># gitea: oauth client secret </span>
    -e <span class="nv">DRONE_RPC_SECRET</span><span class="o">=</span>d9856af41ffe31f5e8025be020e981be <span class="se">\ </span>                     <span class="c1"># drone: runner shall connect server with this secret</span>
    -e <span class="nv">DRONE_SERVER_HOST</span><span class="o">=</span>host.docker.internal:18980 <span class="se">\ </span>                          <span class="c1"># drone: server address without protocol</span>
    -e <span class="nv">DRONE_SERVER_PROTO</span><span class="o">=</span>http <span class="se">\ </span>                                               <span class="c1"># drone: server with http protocol</span>
    drone/drone:1.6.3</code></pre></figure>

<h3 id="413-oauth2授权">4.1.3 OAuth2授权</h3>
<p>访问drone的地址：<code>http://host.docker.internal:18980</code>，会跳转到gitea进行授权，授权完成后会跳转回drone。这时应该就已经以刚才制作OAuth2应用的用户身份登录drone了。</p>

<p>这里说明下，因为gitea和drone都运行在容器内，他们之间相互访问是通过容器名来进行的，而host主机访问这两者都是通过loopback地址，两者之间存在差异，会导致OAuth的过程失败。因此这里统一使用docker MAC desktop版本的<code>host.docker.internal</code>域名来贯通内部和外部。但需要额外修改host主机的<code>/etc/hosts</code>配置，把这个host解析为loopback地址。</p>

<h3 id="414-ui同步--激活代码库">4.1.4 UI同步 &amp; 激活代码库</h3>
<p>刚完成授权的账户是没有任何代码库的，打开drone首页发现是空列表（即便当前通过OAuth2授权的账号在gitea内有代码库）：</p>

<p><img src="/resources/2019/12/drone-ci/drone1.png" alt="" target="_blank" /></p>

<p>点击右上角的<code>SYNC</code>就会开始和gitea同步账户的代码库数据，完成后即可获得所有当前账号在gitea内所拥有的代码库列表：</p>

<p><img src="/resources/2019/12/drone-ci/drone2.png" alt="" target="_blank" /></p>

<p>这时候账号下的drone项目都是<code>未激活</code>状态，需要点击面板上项目右边的<code>ACTIVATE</code>进行激活：</p>

<p><img src="/resources/2019/12/drone-ci/drone3.png" alt="" target="_blank" />
<img src="/resources/2019/12/drone-ci/drone4.png" alt="" target="_blank" /></p>

<p>点击<code>SAVE</code>保存即可。经过这几个操作，drone即激活了对这几个代码库的webhook事件监听。</p>

<p>至此为止drone本体的安装基本上完成了，后续还需要配置下runner。</p>

<h3 id="415-api秘钥">4.1.5 API秘钥</h3>
<p>点击右上角的用户头像，然后点击<code>User settings</code>会打开用户的设置页面。在这个页面上能找到用户的token。如果有需要使用drone API的话（或者是cli命令行工具），这个token是必须的。</p>

<p><img src="/resources/2019/12/drone-ci/drone7.png" alt="" target="_blank" /></p>

<h2 id="42-runner安装--运行">4.2 Runner：安装 &amp; 运行</h2>
<h3 id="421-安装">4.2.1 安装</h3>
<p>服务器设置完成后，如果没有单独安装和运行runner，服务器上所有触发的事件都会是<code>Pending</code>状态，而且没有任何日志。</p>

<p>关于Pending的debug，可以看下官方的一篇帖子：<a href="https://discourse.drone.io/t/builds-are-stuck-in-pending-status/4437" target="_blank">Builds are Stuck in Pending Status</a>。</p>

<p>Runner的安装见官方文档：<a href="https://docs.drone.io/installation/runners/" target="_blank">Drone Documentation &gt; Installation &gt; Runners</a>。Runner也分不同的类型，一般常用的是：</p>

<ul>
  <li><a href="https://docs.drone.io/installation/runners/exec/" target="_blank">Exec Runner</a>：直接运行在主机上的runner</li>
  <li><a href="https://docs.drone.io/installation/runners/docker/" target="_blank">Docker Runner</a>：运行在docker容器内的runner</li>
</ul>

<p>Runner的类型和pipeline的类型并不要求一致，runner只是pipeline的运行者，不管是什么类型的pipeline，都可以在任何类型的runner上运作。举例来说，一个docker类型的pipeline，在exec runner上就会在主机上启动docker容器并运行，而docker runner则是直接在docker容器内运行。</p>

<h3 id="422-运行">4.2.2 运行</h3>
<p><strong>Exec Runner</strong>  <br />
Exec Runner需要手动在<code>~/.drone-runner-exec/config</code>创建一个配置文件：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nv">DRONE_DEBUG</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">DRONE_LOG_FILE</span><span class="o">=</span>/tmp/drone-runner-exec.txt
<span class="nv">DRONE_LOG_FILE_MAX_SIZE</span><span class="o">=</span><span class="m">50</span>
<span class="nv">DRONE_RPC_DUMP_HTTP</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">DRONE_RPC_DUMP_HTTP_BODY</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">DRONE_RPC_PROTO</span><span class="o">=</span>http
<span class="nv">DRONE_RPC_HOST</span><span class="o">=</span>host.docker.internal:18980
<span class="nv">DRONE_RPC_SECRET</span><span class="o">=</span>d9856af41ffe31f5e8025be020e981be
<span class="nv">DRONE_RUNNER_PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.yarn/bin:<span class="nv">$HOME</span>/.config/yarn/global/node_modules/.bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</code></pre></figure>

<p>更多的配置项可以查阅官方文档：<a href="https://exec-runner.docs.drone.io/installation/reference/" target="_blank">Exec Runner &gt; Installation &gt; Configuration Reference</a>。</p>

<p>配置文件里最重要的是<code>DRONE_RPC_HOST</code><code>DRONE_RPC_SECRET</code>这两项。修改完成后记得重启runner：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ drone-runner-exec service stop <span class="o">&amp;&amp;</span> drone-runner-exec service start</code></pre></figure>

<p>Runner在执行pipeline操作时候的用户即是runner启动时的用户，这需要非常小心，否则会搞错用户导致权限错误。此外，在2.3 workspace的时候也提到过了，在runner执行pipeline的时候，<code>~</code>指向的是workspace的根目录，而不是用户的home，这点要非常小心。</p>

<p>举例来说，存放在<code>$HOME/.docker</code>下的凭证在exec runner运行的时候是不可访问的（<code>~</code>会定位到workspace而不是<code>$HOME</code>），这会导致私有registry的访问失败。同样的，pipeline运行时的PATH也不同于用户自身的PATH，需要在配置文件中设置好<code>DRONE_RUNNER_PATH</code>。</p>

<p><strong>Docker Runner</strong>  <br />
这部分就非常简单了，无非就是一个docker容器，直接使用对应的官方镜像即可：<a href="https://hub.docker.com/r/drone/drone-runner-docker" target="_blank">drone/drone-runner-docker</a>。</p>

<p>相关配置项可以查阅官方文档：<a href="https://docker-runner.docs.drone.io/installation/reference/" target="_blank">Docker Runner &gt; Installation &gt; Configuration Reference</a>。</p>

<h2 id="43-ui秘钥设置">4.3 UI秘钥设置</h2>
<p>在执行pipeline的时候不可避免需要访问一些密码秘钥之类的信息，而构建过程中，理论上runner只能访问代码库里的内容。这就造成了问题，因为代码库并不是安全的存放秘钥的地方。针对这样的问题，drone有对应的解决方案。</p>

<p>在drone ui仓库的设置中，有一处：</p>

<p><img src="/resources/2019/12/drone-ci/drone5.png" alt="" target="_blank" /></p>

<p>设置完成后，就会保存在drone系统中：</p>

<p><img src="/resources/2019/12/drone-ci/drone6.png" alt="" target="_blank" /></p>

<p>后续在pipeline可以如下的形式进行访问：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">build</span>
  <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">alpine</span>
  <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">USERNAME</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">from_secret</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">docker_username</span>
    <span class="l l-Scalar l-Scalar-Plain">PASSWORD</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">from_secret</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">docker_password</span></code></pre></figure>

<p>更多关于secret的设置及访问，可以参见官方文档：<a href="https://docs.drone.io/configure/secrets/" target="_blank">Drone Documentation &gt; Configuration &gt; Secrets</a>。在这方面，drone支持得非常全面，甚至外部的加密设施也可以支持访问。</p>

<h2 id="44-私有registry">4.4 私有Registry</h2>
<p>在pipeline应用的过程中，比较常见的问题是对于私有registry的访问。毕竟现在的CI基本上都围绕着镜像打转，抓取镜像进行部署或者构建镜像向上推送都是常见需求。</p>

<p>官方对此也有解决方案：<a href="https://discourse.drone.io/t/how-to-pull-private-images-with-1-0/3155" target="_blank">How to pull private images with 1.0</a>。</p>

<h2 id="45-部署--多点事件触发">4.5 部署 &amp; 多点事件触发</h2>
<p>上述的内容基本上把CI的最基础的应用都讲到了，如果只是简单的<code>提交代码 &gt; 触发webhook &gt; drone pipeline</code>这个流程的话，是没有问题的。</p>

<p>那么接下来就可以考虑下稍微复杂点的需求：</p>

<ul>
  <li>项目的构建和部署需要分开</li>
  <li>构建定义为一个pipeline</li>
  <li>部署定义为一个pipeline</li>
  <li>部署pipeline应该由构建pipeline异步触发</li>
  <li>部署pipeline应该和构建pipeline解耦，两者可能发生在完全隔离的两个物理机的runner上</li>
</ul>

<p>然后我简单说下结论：在当前的版本（drone/drone:1.6.3），这个需求<code>做不到</code>，如果是按官方的API和功能的话。而使用一些非官方的hacking思路，则可以做到<code>基本上一致的效果</code>。</p>

<p>根据一开始说的，如果单独只是一个构建pipeline，很简单就能做到。而如果要实现刚才列出的需求，就需要在构建pipeline完成并退出之前触发一个额外的事件，只要能触发额外的事件，再配合上：trigger &amp; condition，保证代码库的pipeline启动的时候，只有部署pipeline进入工作，且只有正确的runner实例进入工作，那一切就通了。</p>

<p>那么，能不能手动触发一个部署呢？研究了下官方的资料，发现正常途径基本上做不到，只有一些非正常的思路才可以做到。下面说下思路。</p>

<h3 id="451-drone-api--drone-cli">4.5.1 drone api | drone cli</h3>
<p>首先想到的是看看官方的API中有没有可用的命令（cli实际上就是官方API的封装）：<a href="https://docs.drone.io/api/overview/" target="_blank">API文档</a>、<a href="https://docs.drone.io/cli/install/" target="_blank">CLI文档</a>。</p>

<p>发现官方有一个命令：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ drone build promote --help
  NAME:
     drone build promote - promote a build
  
  USAGE:
     drone build promote <span class="o">[</span><span class="nb">command</span> options<span class="o">]</span> &lt;repo/name&gt; &lt;build&gt; &lt;environment&gt;
  
  OPTIONS:
     --param value, -p value  custom parameters to be injected into the job environment. Format: <span class="nv">KEY</span><span class="o">=</span>value
     --format value           format output <span class="o">(</span>default: <span class="s2">&quot;...&quot;</span><span class="o">)</span></code></pre></figure>

<p>结合<code>.drone.yml</code>使用：</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exec</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="l l-Scalar l-Scalar-Plain">platform</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">os</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">darwin</span>
  <span class="l l-Scalar l-Scalar-Plain">arch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">amd64</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
    <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">echo &quot;tested&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">event</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag</span>

<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exec</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">build</span>

<span class="l l-Scalar l-Scalar-Plain">platform</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">os</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">darwin</span>
  <span class="l l-Scalar l-Scalar-Plain">arch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">amd64</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">build</span>
    <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">echo &quot;built&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">event</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag</span>

<span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">test</span>

<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exec</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>

<span class="l l-Scalar l-Scalar-Plain">platform</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">os</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">darwin</span>
  <span class="l l-Scalar l-Scalar-Plain">arch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">amd64</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
    <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">drone build promote fullstack/gateway 100 production</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">DRONE_SERVER</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://host.docker.internal:18980</span>
      <span class="l l-Scalar l-Scalar-Plain">DRONE_TOKEN</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">K5i8g6PMlLM3tWaPDRagigPkBrl1YKGu</span>
    <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">event</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag</span>

<span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">build</span>

<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline</span>
<span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exec</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy</span>

<span class="l l-Scalar l-Scalar-Plain">platform</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">os</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">darwin</span>
  <span class="l l-Scalar l-Scalar-Plain">arch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">amd64</span>

<span class="l l-Scalar l-Scalar-Plain">steps</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy</span>
    <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">echo &quot;deployed&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">event</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">promote</span>
      <span class="l l-Scalar l-Scalar-Plain">target</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">production</span></code></pre></figure>

<p>测试后发现，如果<code>build</code>参数给的是已经存在的构建的话，则会重复之前的构建流程；而如果给的是一个很大的不存在该build的值（比如上面举例的100），则构建在notify这一步失败，并报错：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>+ drone build promote fullstack/gateway <span class="m">100</span> production
client error <span class="m">404</span>: <span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;sql: no rows in result set&quot;</span><span class="o">}</span></code></pre></figure>

<p>查找了下相关资料，并没有找到官方文档，仅在论坛中找到几篇讨论：</p>

<ul>
  <li><a href="https://discourse.drone.io/t/manually-trigger-a-build/874/8" target="_blank">Manually trigger a build</a></li>
  <li><a href="https://discourse.drone.io/t/promoting-a-build-by-branch/4755" target="_blank">Promoting a build by branch</a></li>
  <li><a href="https://github.com/drone/drone/issues/2679#issue-435262568" target="_blank">Trigger build for Branch, Commit</a></li>
</ul>

<p>根据官方人员的解释：</p>

<blockquote>
  <p>When you deploy, you are essentially “promoting” a build, which means you need to provide the build number you are promoting, and the environment you are promoting to. For example:</p>
</blockquote>

<blockquote>
  <p>drone deploy octocat/hello-world 42 production</p>
</blockquote>

<blockquote>
  <p>In the above example, you are promoting build 42 to production. This will execute a deployment event in the system with environment name production.</p>
</blockquote>

<p>也就是说你只能对<code>已经存在</code>的build进行触发让这个<code>已经测试构建完成的</code>build进行部署，而不能从头创建一个新的build。也就是说，上述的工具能大致满足上面提出的那串需求，但本质上还是不同的：</p>

<ul>
  <li>测试构建等必须是一个单独的行为，需要先行做完，并形成一个完成的build</li>
  <li>需要手动触发（因为你需要确认build号，所以这个行为必然是手动的，不可能自动化）这个完成的build，让yaml中配置为promote的event触发，进行部署</li>
</ul>

<h3 id="452-plugin">4.5.2 plugin</h3>
<p>官方有一个插件叫：<a href="http://plugins.drone.io/drone-plugins/drone-downstream/" target="_blank">Downstream Build</a>。乍看之下貌似是满足需求的，但我实际扒了下源码，发现这个插件的本质其实就是封装了下官方的API。所以实际上和4.5.1一样，不行。</p>

<h3 id="453-webhook-plugin">4.5.3 webhook plugin</h3>
<p>后续的思路是尝试使用webhook插件，在构建pipeline完成之后用webhook触发一个构建：<a href="http://plugins.drone.io/drone-plugins/drone-webhook/" target="_blank">Webhook</a>。</p>

<p>文档工作总是半吊子，参数有几个根本不知道具体应该填什么，只能随便尝试下：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ docker run --rm <span class="se">\</span>
          -e <span class="nv">PLUGIN_URLS</span><span class="o">=</span>http://host.docker.internal:18980/hook <span class="se">\</span>
          -e <span class="nv">PLUGIN_USERNAME</span><span class="o">=</span>root <span class="se">\</span>
          -e <span class="nv">PLUGIN_PASSWORD</span><span class="o">=</span>Abcd1234_ <span class="se">\</span>
          -e <span class="nv">PLUGIN_DEBUG</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
          -e <span class="nv">PLUGIN_SKIP_VERIFY</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
          -e <span class="nv">DRONE_REPO_OWNER</span><span class="o">=</span>fullstack <span class="se">\</span>
          -e <span class="nv">DRONE_REPO_NAME</span><span class="o">=</span>gateway <span class="se">\</span>
          -e <span class="nv">DRONE_COMMIT_SHA</span><span class="o">=</span>2087d78f48 <span class="se">\</span>
          -e <span class="nv">DRONE_COMMIT_BRANCH</span><span class="o">=</span>master <span class="se">\</span>
          -e <span class="nv">DRONE_BUILD_EVENT</span><span class="o">=</span>deployment <span class="se">\</span>
          plugins/webhook:latest
Webhook <span class="m">1</span>
  URL: http://host.docker.internal:18980/hook
  METHOD: POST
  HEADERS: map<span class="o">[</span>Authorization:<span class="o">[</span>Basic <span class="nv">cm9vdDpBYmNkMTIzNF8</span><span class="o">=]</span> Content-Type:<span class="o">[</span>application/json<span class="o">]]</span>
  REQUEST BODY: <span class="o">{</span><span class="s2">&quot;repo&quot;</span>:<span class="o">{</span><span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;fullstack&quot;</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;gateway&quot;</span><span class="o">}</span>,<span class="s2">&quot;build&quot;</span>:<span class="o">{</span><span class="s2">&quot;tag&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;event&quot;</span>:<span class="s2">&quot;deployment&quot;</span>,<span class="s2">&quot;number&quot;</span>:0,<span class="s2">&quot;commit&quot;</span>:<span class="s2">&quot;2087d78f48&quot;</span>,<span class="s2">&quot;ref&quot;</span>:<span class="s2">&quot;refs/heads/master&quot;</span>,<span class="s2">&quot;branch&quot;</span>:<span class="s2">&quot;master&quot;</span>,<span class="s2">&quot;author&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;success&quot;</span>,<span class="s2">&quot;link&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;started&quot;</span>:0,<span class="s2">&quot;created&quot;</span>:0<span class="o">}}</span>

  RESPONSE STATUS: <span class="m">200</span> OK
  RESPONSE BODY:</code></pre></figure>

<p>返回结果是200，正常，但结果本身为<code>空</code>。查看drone的UI发现实际上没有任何build被触发。这就很无奈了，这里的问题可能出在：</p>

<ul>
  <li>操作者：给的参数不正确</li>
  <li>webhook插件：没有发送正确的webhook请求</li>
  <li>drone服务器：忽略了不正确的webhook请求</li>
</ul>

<p>无论如何，后续如果要继续的话就需要看源码了，插件的以及服务器的源码。</p>

<h3 id="454-webhook-fake">4.5.4 webhook fake</h3>
<p>到这里就是非正常思路了。</p>

<p>因为gitea可以正常触发drone的webhook，思路就是使用curl仿造gitea的请求，发送到drone。其实drone官方也有对webhook的描述：<a href="https://discourse.drone.io/t/how-to-use-global-webhooks/3755" target="_blank">How to use Global Webhooks</a>，但实在是没什么正式的支持，API之类的易用性的工具都没有，只有这篇文章。</p>

<p>gitea官方有webhook相关的文档：<a href="https://docs.gitea.io/en-us/webhooks/" target="_blank">Webhooks</a>。</p>

<p>gitea的钩子可以在这里找到，点击下面的链接可以查看请求细节：</p>

<p><img src="/resources/2019/12/drone-ci/gitea1.png" alt="" target="_blank" />
<img src="/resources/2019/12/drone-ci/gitea2.png" alt="" target="_blank" />
<img src="/resources/2019/12/drone-ci/gitea3.png" alt="" target="_blank" /></p>

<p>当然这也非常麻烦，而且gitea发送出去的webhook请求里有非常多repo详细信息，如果要做到自动化的话，这块的获取也是很麻烦的一件事情。</p>

<h3 id="455-waiting-hack">4.5.5 waiting hack</h3>
<p>另一个非正常思路就是定义一个pipeline，仅在指定的runner上运行，然后命令中执行脚本，查询私有registry，看目标仓库（镜像）的目标tag是否存在，存在的话就进行部署。而在其他的runner上进行构建和镜像推送操作。</p>

<p>这样就能做到一开始提的需求，虽然恶心了点。</p>

<blockquote>
  <p>EOF</p>
</blockquote>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2019/12/drone-ci/">使用Drone进行CI支持</a></li>
    
    <li><a href="/2019/12/node-in-docker/">在Docker中使用Node</a></li>
    
    <li><a href="/2019/09/virtualbox-tor/">在VirtualBox中安装Tor</a></li>
    
    <li><a href="/2019/07/dist-system-practice/">分布式系统实战</a></li>
    
    <li><a href="/2019/05/memcached-note/">Memcached Notes</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
      <li><a href="/category/V8Blog">V8Blog</a></li>
    
      <li><a href="/category/Docker">Docker</a></li>
    
      <li><a href="/category/Golang">Golang</a></li>
    
      <li><a href="/category/Career">Career</a></li>
    
      <li><a href="/category/Prometheus">Prometheus</a></li>
    
      <li><a href="/category/Grafana">Grafana</a></li>
    
      <li><a href="/category/Logging">Logging</a></li>
    
      <li><a href="/category/Jaeger">Jaeger</a></li>
    
      <li><a href="/category/Elasticsearch">Elasticsearch</a></li>
    
      <li><a href="/category/MessageQueue">MessageQueue</a></li>
    
      <li><a href="/category/Kafka">Kafka</a></li>
    
      <li><a href="/category/gRPC">gRPC</a></li>
    
      <li><a href="/category/Envoy">Envoy</a></li>
    
      <li><a href="/category/DistributedSystem">DistributedSystem</a></li>
    
      <li><a href="/category/Tor">Tor</a></li>
    
      <li><a href="/category/Node.js">Node.js</a></li>
    
      <li><a href="/category/CI">CI</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2019/12/drone-ci/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2019</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
