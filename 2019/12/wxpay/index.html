<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>微信支付接入 | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2019/12/wxpay/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
  <style>
    /* Enhance table style */
    table {
      border: 2px solid #4F7849;
      background-color: #EEEEEE;
      width: 100%;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table.comicGreen th {
      border: 1px solid #4F7849;
      padding: 3px 5px;
    }
    table tbody td {
      font-size: 14px;
      color: #4F7849;
    }
    table tr:nth-child(even) {
      background: #CEE0CC;
    }
    table thead {
      background: #4F7849;
      border-bottom: 1px solid #444444;
    }
    table thead th {
      font-size: 16px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #D0E4F5;
      padding: 3px 5px;
    }
    table thead th:first-child {
      border-left: none;
    }
    table tfoot td {
      font-size: 21px;
    }

    /* Enhance pre style */
    pre {
      color: #FFFFFF;
      background-color: #000000;
      border-color: #000000;
    }

    /* Image bg color white while dark background */
    img {
      background-color: #FFFFFF;
    }

    /* Keep gist style clean */
    .gist table tr:nth-child(even) {
      background: #FFFFFF;
    }
    .gist td, th {
      border: none;
    }
  </style>
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2019/12/wxpay/">微信支付接入</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>27 Dec 2019</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/Payment">Payment</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Wxpay">Wxpay</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#1-前言" id="markdown-toc-1-前言">1. 前言</a></li>
  <li><a href="#2-支付流程" id="markdown-toc-2-支付流程">2. 支付流程</a>    <ul>
      <li><a href="#21-网页端" id="markdown-toc-21-网页端">2.1 网页端</a></li>
      <li><a href="#22-移动原生" id="markdown-toc-22-移动原生">2.2 移动原生</a></li>
    </ul>
  </li>
  <li><a href="#3-准备工作" id="markdown-toc-3-准备工作">3. 准备工作</a></li>
  <li><a href="#4-api--sdk" id="markdown-toc-4-api--sdk">4. API &amp; SDK</a>    <ul>
      <li><a href="#41-sdk选择" id="markdown-toc-41-sdk选择">4.1 SDK选择</a></li>
      <li><a href="#42-api使用基础" id="markdown-toc-42-api使用基础">4.2 API使用基础</a>        <ul>
          <li><a href="#421-网页端" id="markdown-toc-421-网页端">4.2.1 网页端</a></li>
          <li><a href="#422-移动原生" id="markdown-toc-422-移动原生">4.2.2 移动原生</a></li>
        </ul>
      </li>
      <li><a href="#43-常用接口" id="markdown-toc-43-常用接口">4.3 常用接口</a>        <ul>
          <li><a href="#431-统一下单接口" id="markdown-toc-431-统一下单接口">4.3.1 统一下单接口</a></li>
          <li><a href="#432-订单查询接口" id="markdown-toc-432-订单查询接口">4.3.2 订单查询接口</a></li>
        </ul>
      </li>
      <li><a href="#44-金额问题" id="markdown-toc-44-金额问题">4.4 金额问题</a></li>
      <li><a href="#45-回调处理" id="markdown-toc-45-回调处理">4.5 回调处理</a></li>
    </ul>
  </li>
  <li><a href="#5-沙箱使用" id="markdown-toc-5-沙箱使用">5. 沙箱使用</a>    <ul>
      <li><a href="#51-沙箱申请" id="markdown-toc-51-沙箱申请">5.1 沙箱申请</a></li>
      <li><a href="#52-沙箱使用" id="markdown-toc-52-沙箱使用">5.2 沙箱使用</a></li>
      <li><a href="#53-沙箱问题" id="markdown-toc-53-沙箱问题">5.3 沙箱问题</a></li>
    </ul>
  </li>
  <li><a href="#6-错误处理" id="markdown-toc-6-错误处理">6. 错误处理</a>    <ul>
      <li><a href="#61-回调处理" id="markdown-toc-61-回调处理">6.1 回调处理</a></li>
      <li><a href="#62-修复订单" id="markdown-toc-62-修复订单">6.2 修复订单</a></li>
    </ul>
  </li>
  <li><a href="#7-上线生效" id="markdown-toc-7-上线生效">7. 上线生效</a></li>
  <li><a href="#appendix" id="markdown-toc-appendix">Appendix</a>    <ul>
      <li><a href="#链接" id="markdown-toc-链接">链接</a></li>
    </ul>
  </li>
</ul>

<h1 id="1-前言">1. 前言</h1>
<p>微信支付的接入，权当笔记。</p>

<h1 id="2-支付流程">2. 支付流程</h1>
<h3 id="21-网页端">2.1 网页端</h3>
<p>官方文档：<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_5" target="_blank">扫码支付 &gt; 模式二</a>。</p>

<p>官方配图：</p>

<p><img src="/resources/2019/12/wxpay/wxpay_pc.png" alt="" target="_blank" /></p>

<p>流程涉及到几个角色：</p>

<ul>
  <li>PC网站网页</li>
  <li>PC网站后台</li>
  <li>微信支付系统</li>
</ul>

<p>支付流程如下：</p>

<ul>
  <li><code>用户</code>打开PC网站网页的商品页</li>
  <li><code>用户</code>对商品进行下单</li>
  <li><code>PC网站网页</code>发送下单请求到PC网站后台</li>
  <li><code>PC网站后台</code>在自身系统内生成订单（生成内部订单号），并返回给网页</li>
  <li><code>PC网站网页</code>获得内部订单信息，并将用户导向到支付页面</li>
  <li><code>用户</code>确认订单内容，并开始付款流程</li>
  <li><code>PC网站网页</code>发起支付请求到PC网站后台</li>
  <li><code>PC网站后台</code>向微信支付系统发起下单请求，并将返回的信息交付给PC网站网页</li>
  <li><code>PC网站网页</code>收到微信支付返回信息，将其中的QRCode渲染到页面</li>
  <li><code>用户</code>打开微信，使用扫码的方式完成支付</li>
  <li><code>微信支付系统</code>确认支付完成，向notify_url发送回调信息</li>
  <li><code>PC网站后台</code>验证微信支付回调完成，标记订单状态为已支付</li>
</ul>

<h3 id="22-移动原生">2.2 移动原生</h3>
<p>官方文档：<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3" target="_blank">APP支付 &gt; 业务流程</a>。</p>

<p>官方配图：</p>

<p><img src="/resources/2019/12/wxpay/wxpay_app.png" alt="" target="_blank" /></p>

<p>流程涉及到几个角色：</p>

<ul>
  <li>PC网站网页</li>
  <li>PC网站后台</li>
  <li>微信支付系统</li>
</ul>

<p>支付流程如下：</p>

<ul>
  <li><code>用户</code>打开PC网站网页的商品页</li>
  <li><code>用户</code>对商品进行下单</li>
  <li><code>PC网站网页</code>发送下单请求到PC网站后台</li>
  <li><code>PC网站后台</code>在自身系统内生成订单（生成内部订单号），并返回给网页</li>
  <li><code>PC网站网页</code>获得内部订单信息，并将用户导向到支付页面</li>
  <li><code>用户</code>确认订单内容，并开始付款流程</li>
  <li><code>PC网站网页</code>发起支付请求到PC网站后台</li>
  <li><code>PC网站后台</code>向微信支付系统发起下单请求，并将返回的信息交付给PC网站网页</li>
  <li><code>PC网站网页</code>收到微信支付返回信息，使用其中的参数唤起微信APP</li>
  <li><code>用户</code>在微信APP中完成支付</li>
  <li><code>微信支付系统</code>确认支付完成，向notify_url发送回调信息</li>
  <li><code>PC网站后台</code>验证微信支付回调完成，标记订单状态为已支付</li>
</ul>

<h1 id="3-准备工作">3. 准备工作</h1>
<p>微信的权限系统非常有问题，没有分级的子账号，只有一个申请人所拥有的主账号。这导致了后续的一系列操作全部都必须主账号持有人来完成（对，你没有看错，必须你的老板来操作，别人不能代劳）。</p>

<p>申请人必须操作：</p>

<ul>
  <li>申请公司账号</li>
  <li>申请支付应用</li>
</ul>

<p>申请完成之后，必须获得以下几个信息，程序才可以对接：</p>

<ul>
  <li>APPID：支付应用的ID</li>
  <li>商户号：商户的ID</li>
  <li>商户的API秘钥：这里切记是<code>商户秘钥</code>；微信整个生态中应用非常繁多，因此各种秘钥也多，特别是去生成秘钥的又是老板，一般没有技术经验，所以这步非常非常容易出错，会导致后面验证签名无论如何都不正确，所以一定要当心，必须是商户秘钥</li>
</ul>

<p>微信支付也有证书，但这并不是必须项，大部分支付API是不需要证书的，只有部分才需要。证书也是在商户部分申请，申请完之后可以打包下载，里面含文件：</p>

<ul>
  <li>apiclient_cert.p12：证书pkcs12格式</li>
  <li>apiclient_cert.pem：证书</li>
  <li>apiclient_key.pem：私钥</li>
</ul>

<p>申请及配置的相关操作可以看这篇：<a href="https://www.leapcloud.cn/website/docs/doc_config/wxwangyezf/wxwangyezhifu.html" target="_blank">微信公众号支付配置</a>，以及<a href="https://www.leapcloud.cn/website/docs/doc_config/wxappzf/weixinapp.html" target="_blank">微信APP支付配置</a>。</p>

<p>移动端还会遇到制作应用签名的问题：<a href="https://www.leapcloud.cn/website/docs/doc_config/keystorecreate/keystorecreate.html" target="_blank">Android App 签名生成教程</a>。</p>

<h1 id="4-api--sdk">4. API &amp; SDK</h1>
<h2 id="41-sdk选择">4.1 SDK选择</h2>
<p>npm上可用的SDK包基本上只有：<a href="https://www.npmjs.com/package/tenpay" target="_blank">tenpay</a>。</p>

<p>SDK的使用：</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kr">const</span> <span class="nx">tenpay</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tenpay&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">appid</span><span class="o">:</span> <span class="s1">&#39;公众号ID&#39;</span><span class="p">,</span>
  <span class="nx">mchid</span><span class="o">:</span> <span class="s1">&#39;微信商户号&#39;</span><span class="p">,</span>
  <span class="nx">partnerKey</span><span class="o">:</span> <span class="s1">&#39;微信支付安全密钥&#39;</span><span class="p">,</span>
  <span class="nx">pfx</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">).</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;证书文件路径&#39;</span><span class="p">),</span>
  <span class="nx">notify_url</span><span class="o">:</span> <span class="s1">&#39;支付回调网址&#39;</span><span class="p">,</span>
  <span class="nx">spbill_create_ip</span><span class="o">:</span> <span class="s1">&#39;IP地址&#39;</span>
<span class="p">};</span>
<span class="c1">// 方式一</span>
<span class="kr">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tenpay</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
<span class="c1">// 方式二</span>
<span class="kr">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">tenpay</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
 
<span class="c1">// 调试模式(传入第二个参数为true, 可在控制台输出数据)</span>
<span class="kr">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tenpay</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
 
<span class="c1">// 沙盒模式(用于微信支付验收)</span>
<span class="kr">const</span> <span class="nx">sandboxAPI</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">tenpay</span><span class="p">.</span><span class="nx">sandbox</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span></code></pre></figure>

<p>config说明:</p>

<ul>
  <li>appid - 公众号ID(必填)</li>
  <li>mchid - 微信商户号(必填)</li>
  <li>partnerKey - 微信支付安全密钥(必填, 在微信商户管理界面获取)</li>
  <li>pfx - 证书文件(选填, 在微信商户管理界面获取)
    <ul>
      <li>当不需要调用依赖证书的API时可不填此参数</li>
      <li>若业务流程中使用了依赖证书的API则需要在初始化时传入此参数</li>
    </ul>
  </li>
  <li>notify_url - 支付结果通知回调地址(选填)
    <ul>
      <li>可以在初始化的时候传入设为默认值, 不传则需在调用相关API时传入</li>
      <li>调用相关API时传入新值则使用新值</li>
    </ul>
  </li>
  <li>refund_url - 退款结果通知回调地址(选填)
    <ul>
      <li>可以在初始化的时候传入设为默认值, 不传则使用微信商户后台配置</li>
      <li>调用相关API时传入新值则使用新值</li>
    </ul>
  </li>
  <li>spbill_create_ip - IP地址(选填)
    <ul>
      <li>可以在初始化的时候传入设为默认值, 不传则默认值为127.0.0.1</li>
      <li>调用相关API时传入新值则使用新值</li>
    </ul>
  </li>
</ul>

<p>证书相关可以查阅：<a href="https://kf.qq.com/faq/161222NneAJf161222U7fARv.html" target="_blank">什么是API证书？如何获取API证书？</a>。</p>

<p>如果在接入的时候遇到签名问题，可以使用：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1" target="_blank">微信支付接口签名校验工具</a>或<a href="https://pay.weixin.qq.com/wiki/tools/signverify/" target="_blank">微信公众平台支付接口调试工具</a>进行调试。</p>

<h2 id="42-api使用基础">4.2 API使用基础</h2>
<h3 id="421-网页端">4.2.1 网页端</h3>
<p>API接入手册：<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=4_1" target="_blank">扫码支付 &gt; 接口规则 &gt; 协议规则</a>。API列表：<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1" target="_blank">扫码支付 &gt; API列表 &gt; 统一下单</a>。</p>

<h3 id="422-移动原生">4.2.2 移动原生</h3>
<p>API接入手册：<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=4_1" target="_blank">APP支付 &gt; 接口规则 &gt; 协议规则</a>。API列表：<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1" target="_blank">APP支付 &gt; API列表 &gt; 统一下单</a>。</p>

<h2 id="43-常用接口">4.3 常用接口</h2>
<h3 id="431-统一下单接口">4.3.1 统一下单接口</h3>
<p>范例代码：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="p">{</span><span class="nx">prepay_id</span><span class="p">,</span> <span class="nx">code_url</span><span class="p">}</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">wxpay</span><span class="p">.</span><span class="nx">unifiedOrder</span><span class="p">({</span>
    <span class="nx">out_trade_no</span>: <span class="kt">orderId.toString</span><span class="p">(),</span>
    <span class="nx">body</span>: <span class="kt">name</span><span class="p">,</span>
    <span class="c1">// 微信支付的金额是不带小数位的，所有的小数金额都必须*100转为正整数</span>
    <span class="c1">// 数值先会被小数点后2位截断或补足，然后转为整数字符串</span>
    <span class="c1">// 8.8     =&gt; 8.80 =&gt; 880</span>
    <span class="c1">// 9.24678 =&gt; 9.25 =&gt; 925</span>
    <span class="nx">total_fee</span><span class="o">:</span> <span class="p">(</span><span class="nx">price</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="nx">trade_type</span>: <span class="kt">type</span><span class="p">,</span> <span class="c1">// NATIVE：扫码支付 | APP：原生支付</span>
    <span class="nx">product_id</span>: <span class="kt">productId</span><span class="p">,</span>
<span class="p">});</span>

<span class="k">return</span> <span class="p">{</span>
    <span class="nx">prepayId</span>: <span class="kt">prepay_id</span><span class="p">,</span>
    <span class="nx">codeUrl</span>: <span class="kt">code_url</span><span class="p">,</span>
<span class="p">};</span></code></pre></figure>

<p>拿到返回值之后，后续根据支付类型不同，处理方式也不一样：</p>

<p><strong>扫码支付</strong>  <br />
需要将code_url的值，转换为QRCode，后续前端才可以将其渲染到HTML页面上（当然也可以直接将url传给前端，让前端渲染）。这里比较好用的是：<a href="https://www.npmjs.com/package/qrcode" target="_blank">qrcode</a>。</p>

<p>后端代码：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="nx">QRCode</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;qrcode&quot;</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="kr">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">await</span> <span class="p">(</span><span class="nx">QRCode</span> <span class="kr">as</span> <span class="nx">any</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">codeUrl</span><span class="p">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;svg&quot;</span><span class="p">});</span></code></pre></figure>

<p>HTML页面：</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;qrcode&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;width: 200px; height: 200px;&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span></code></pre></figure>

<p>前端代码：</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">renderXml</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">xmlString</span><span class="p">){</span> <span class="c1">// xmlString: svg content</span>
  <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMParser</span><span class="p">().</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">xmlString</span><span class="p">,</span> <span class="s2">&quot;application/xml&quot;</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="nx">el</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">importNode</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">renderXml</span><span class="p">(</span><span class="s2">&quot;qrcode&quot;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">codeUrl</span><span class="p">);</span></code></pre></figure>

<p><strong>原生支付</strong>  <br />
在统一下单接口完成之后，还需要根据prepay_id来申请唤起微信的参数：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">wxpay</span><span class="p">.</span><span class="nx">getAppParamsByPrepay</span><span class="p">({</span><span class="nx">prepay_id</span>: <span class="kt">prepayId</span><span class="p">});</span></code></pre></figure>

<h3 id="432-订单查询接口">4.3.2 订单查询接口</h3>
<p>范例代码：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">wxpay</span><span class="p">.</span><span class="nx">orderQuery</span><span class="p">({</span><span class="nx">out_trade_no</span>: <span class="kt">orderId.toString</span><span class="p">()});</span></code></pre></figure>

<h2 id="44-金额问题">4.4 金额问题</h2>
<p>在刚才<code>4.3.1</code>的例子中，代码里其实已经体现出来了。微信支付的金额和支付宝是不一样的，支付宝的金额就是自然的数额，带小数点后两位。而微信的做法不同，微信要求调用接口下单的时候的支付金额必须不带小数位，所有的金额都是小数点后两位的数字<code>*100转化为整数</code>的数额。也就是说下单接口金额为<code>1</code>的情况，实际支付的是<code>0.01</code>。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="c1">// 微信支付的金额是不带小数位的，所有的小数金额都必须*100转为正整数</span>
<span class="c1">// 数值先会被小数点后2位截断或补足，然后转为整数字符串</span>
<span class="c1">// 8.8     =&gt; 8.80 =&gt; 880</span>
<span class="c1">// 9.24678 =&gt; 9.25 =&gt; 925</span>
<span class="nx">total_fee</span><span class="o">:</span> <span class="p">(</span><span class="nx">price</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></code></pre></figure>

<h2 id="45-回调处理">4.5 回调处理</h2>
<p>微信的所有API都是使用XML作为输入和输出，因此获得的回调信息也是XML。因为之前的API调用中都有SDK处理完了，所以这里就有点恶心，需要自己处理。</p>

<p>回调结构：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">IResOrderPayed</span> <span class="p">{</span>
    <span class="nx">return_code</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// SUCCESS</span>
    <span class="nx">return_msg</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// OK</span>
    <span class="nx">appid</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// wx3...</span>
    <span class="nx">mch_id</span>: <span class="kt">number</span><span class="p">;</span> <span class="c1">// 156..</span>
    <span class="nx">nonce_str</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// cwGl...</span>
    <span class="nx">sign</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// C51A...</span>
    <span class="nx">result_code</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// SUCCESS</span>
    <span class="nx">openid</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// oqvcFj-Uf...</span>
    <span class="nx">is_subscribe</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// N</span>
    <span class="nx">trade_type</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// NATIVE</span>
    <span class="nx">bank_type</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// OTHERS</span>
    <span class="nx">total_fee</span>: <span class="kt">number</span><span class="p">;</span> <span class="c1">// 1，需要 / 100</span>
    <span class="nx">fee_type</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// CNY</span>
    <span class="nx">transaction_id</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// 42000004...</span>
    <span class="nx">out_trade_no</span>: <span class="kt">number</span><span class="p">;</span>
    <span class="nx">attach</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// &quot;&quot;</span>
    <span class="nx">time_end</span>: <span class="kt">number</span><span class="p">;</span> <span class="c1">// 2019XXXX144155</span>
    <span class="nx">trade_state</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// SUCCESS</span>
    <span class="nx">cash_fee</span>: <span class="kt">number</span><span class="p">;</span> <span class="c1">// 1，需要 / 100</span>
    <span class="nx">trade_state_desc</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// 支付成功</span>
    <span class="nx">cash_fee_type</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// CNY</span>
<span class="p">}</span></code></pre></figure>

<h1 id="5-沙箱使用">5. 沙箱使用</h1>
<p>微信支付的沙箱和支付宝有点不同，支付宝是完全隔离，从环境、访问地址到账号，支付的支付宝APP全部都是单独分离的。微信则不同，账号、测试用APP都还是原来的微信商户号以及用户真实的微信APP，但访问地址是隔离的，在原来的API地址中间插入<code>/sandboxnew/</code>。</p>

<p>虽然易用性上看起来是微信占优，但实际使用上微信的沙箱有相当多的问题，甚至我研发到最后完成，都完全没使用过沙箱，都是使用0.01的金额进行下单测试。</p>

<h2 id="51-沙箱申请">5.1 沙箱申请</h2>
<p>和支付宝一样，微信支付的沙箱使用不需要额外申请。</p>

<h2 id="52-沙箱使用">5.2 沙箱使用</h2>
<p>使用方面，可以看一篇第三方的教程：<a href="https://juejin.im/post/5bea7c1d6fb9a04a053f36c3" target="_blank">浅析微信支付：如何使用沙箱环境测试</a>。</p>

<p>在使用刚才说的SDK的情况下，只需要在SDK初始化的地方做点调整即可：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">appid</span>: <span class="kt">vendorConfig.appId</span><span class="p">,</span>
    <span class="nx">mchid</span>: <span class="kt">vendorConfig.mchId</span><span class="p">,</span>
    <span class="nx">partnerKey</span>: <span class="kt">vendorConfig.appSecret</span><span class="p">,</span>
    <span class="nx">pfx</span>: <span class="kt">LibFs.readFileSync</span><span class="p">(</span><span class="nx">LibPath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s2">&quot;../../../pem/wxpay/apiclient_key.pem&quot;</span><span class="p">)).</span><span class="nx">toString</span><span class="p">(),</span>
    <span class="nx">notify_url</span>: <span class="kt">vendorConfig.callbackUrl</span><span class="p">,</span>
    <span class="nx">spbill_create_ip</span>: <span class="kt">vendorConfig.allowedIp</span><span class="p">,</span>
<span class="p">}</span> <span class="kr">as</span> <span class="nx">Tenpay</span><span class="p">.</span><span class="nx">IConfig</span><span class="p">;</span>

<span class="c1">// wxpay</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">isSandbox</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tenpay</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">isTest</span><span class="p">).</span><span class="nx">getSignkey</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sandbox_signkey</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">wxpay</span> <span class="o">=</span> <span class="nx">tenpay</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="p">{</span><span class="nx">partnerKey</span>: <span class="kt">key</span><span class="p">,</span> <span class="nx">sandbox</span>: <span class="kt">true</span><span class="p">}),</span> <span class="nx">isTest</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">wxpay</span> <span class="o">=</span> <span class="nx">tenpay</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">isTest</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>沙箱每次使用的秘钥（商户的API秘钥）和正式环境不一样，正式环境是配置死的，直接拿下来用即可。而沙箱则需要先使用正式环境的商户秘钥去调用<code>getSignkey</code>获取沙箱使用的临时商户秘钥，才可以后续继续调用API。</p>

<h2 id="53-沙箱问题">5.3 沙箱问题</h2>
<p>理解了沙箱的隔离以及如何初始化沙箱SDK之后，如果直接实际调用的话，还是会遇到问题：</p>

<blockquote>
  <p>沙箱支付金额(1)无效，请检查需要验收的case</p>
</blockquote>

<p>参见：<a href="https://github.com/Wechat-Group/WxJava/issues/668" target="_blank">微信支付的沙箱环境能否使用？#668</a>。</p>

<p>这里还需要额外做一个操作：在<code>微信支付商户接入验收助手</code>这个公众号申请你的验收case，写入验收金额作为use case。后续在沙箱环境做测试的时候，金额必须完全符合之前申请的验收case，否则报错。</p>

<h1 id="6-错误处理">6. 错误处理</h1>
<h2 id="61-回调处理">6.1 回调处理</h2>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="k">try</span> <span class="p">{</span>
    <span class="c1">// 业务处理</span>
    
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;application/xml&quot;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span>
<span class="err">`</span><span class="o">&lt;</span><span class="nx">xml</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">return_code</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">SUCCESS</span><span class="p">]]</span><span class="o">&gt;&lt;</span><span class="err">/return_code&gt;</span>
<span class="o">&lt;</span><span class="nx">return_msg</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">OK</span><span class="p">]]</span><span class="o">&gt;&lt;</span><span class="err">/return_msg&gt;</span>
<span class="o">&lt;</span><span class="err">/xml&gt;`;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;application/xml&quot;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span>
<span class="err">`</span><span class="o">&lt;</span><span class="nx">xml</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">return_code</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">FAIL</span><span class="p">]]</span><span class="o">&gt;&lt;</span><span class="err">/return_code&gt;</span>
<span class="o">&lt;</span><span class="nx">return_msg</span><span class="o">&gt;&lt;!</span><span class="p">[</span><span class="nx">CDATA</span><span class="p">[</span><span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">}]]</span><span class="o">&gt;&lt;</span><span class="err">/return_msg&gt;</span>
<span class="o">&lt;</span><span class="err">/xml&gt;`;</span>
<span class="p">}</span></code></pre></figure>

<h2 id="62-修复订单">6.2 修复订单</h2>
<p>在某些情况下，回调可能没有收到，或者一直报错导致回调没有正常处理。表现在用户视角，就是支付完成后订单状态无法正常改为支付完成（也就不会发货）。这是很糟糕的，因此需要制作修复订单功能。</p>

<p>客户端在检查到订单状态为等待支付之后，可以提供一个入口给用户，用户点击之后，应用后端应该向支付宝查询订单信息，如果在支付宝这里已经是<code>已支付</code>而在应用这边还是<code>等待支付</code>的话，就立即将业务订单改为已支付，并向用户发货。</p>

<h1 id="7-上线生效">7. 上线生效</h1>
<p>微信支付应该是在应用申请审核通过的时候就直接上线了，不需要额外操作。</p>

<h1 id="appendix">Appendix</h1>
<h2 id="链接">链接</h2>
<ul>
  <li><a href="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_Pay/Vendor_Service_Center.html" target="_blank">微信APP支付接入商户服务中心</a></li>
  <li><a href="https://www.jianshu.com/p/753393a0514a" target="_blank">微信APP支付接入</a></li>
  <li><a href="https://juejin.im/post/59c4bc7df265da06434b8c2b" target="_blank">微信App支付全解析</a></li>
  <li><a href="https://www.leapcloud.cn/website/docs/doc_config/wxwangyezf/wxwangyezhifu.html" target="_blank">微信公众号支付配置</a></li>
  <li><a href="https://www.leapcloud.cn/website/docs/doc_config/wxappzf/weixinapp.html" target="_blank">微信APP支付配置</a></li>
  <li><a href="https://www.leapcloud.cn/website/docs/doc_config/keystorecreate/keystorecreate.html" target="_blank">Android App 签名生成教程</a></li>
  <li><a href="https://kf.qq.com/faq/161222NneAJf161222U7fARv.html" target="_blank">什么是API证书？如何获取API证书？</a></li>
  <li><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" target="_blank">微信网页开发 &gt; 网页授权</a></li>
  <li><a href="https://juejin.im/post/5bea7c1d6fb9a04a053f36c3" target="_blank">浅析微信支付：如何使用沙箱环境测试</a></li>
  <li><a href="https://github.com/Wechat-Group/WxJava/issues/668" target="_blank">微信支付的沙箱环境能否使用？#668</a></li>
  <li><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1" target="_blank">微信支付接口签名校验工具</a></li>
  <li><a href="https://pay.weixin.qq.com/wiki/tools/signverify/" target="_blank">微信公众平台支付接口调试工具</a></li>
  <li><a href="https://blog.51cto.com/xihan/2096880" target="_blank">微信支付接口返回“签名错误”的排查方法</a></li>
  <li><a href="https://blog.csdn.net/yhm_brave/article/details/70240935" target="_blank">微信支付统一下单，签名错误</a></li>
  <li><a href="https://blog.csdn.net/qq_35624642/article/details/53667679" target="_blank">微信支付统一下单，签名错误（生成的签名和测试工具生成的一样还报错）解决方法</a></li>
</ul>

<blockquote>
  <p>EOF</p>
</blockquote>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2020/05/youtube-dl/">youtube-dl 及 ffmpeg 相关</a></li>
    
    <li><a href="/2020/05/golang-concurrency/">Golang Concurrency</a></li>
    
    <li><a href="/2020/04/grpc-js-support/">grpc_tools_node_protoc_ts 对 @grpc/grpc-js 的支持</a></li>
    
    <li><a href="/2020/04/grpc-tools/">grpc-tools@1.8.1 安装问题</a></li>
    
    <li><a href="/2020/03/japanese/">日语自学笔记</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
      <li><a href="/category/V8Blog">V8Blog</a></li>
    
      <li><a href="/category/Docker">Docker</a></li>
    
      <li><a href="/category/Golang">Golang</a></li>
    
      <li><a href="/category/Career">Career</a></li>
    
      <li><a href="/category/Prometheus">Prometheus</a></li>
    
      <li><a href="/category/Grafana">Grafana</a></li>
    
      <li><a href="/category/Logging">Logging</a></li>
    
      <li><a href="/category/Jaeger">Jaeger</a></li>
    
      <li><a href="/category/Elasticsearch">Elasticsearch</a></li>
    
      <li><a href="/category/MessageQueue">MessageQueue</a></li>
    
      <li><a href="/category/Kafka">Kafka</a></li>
    
      <li><a href="/category/gRPC">gRPC</a></li>
    
      <li><a href="/category/Envoy">Envoy</a></li>
    
      <li><a href="/category/DistributedSystem">DistributedSystem</a></li>
    
      <li><a href="/category/Tor">Tor</a></li>
    
      <li><a href="/category/Node.js">Node.js</a></li>
    
      <li><a href="/category/CI">CI</a></li>
    
      <li><a href="/category/ServiceDiscovery">ServiceDiscovery</a></li>
    
      <li><a href="/category/Git">Git</a></li>
    
      <li><a href="/category/Payment">Payment</a></li>
    
      <li><a href="/category/Japanese">Japanese</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2019/12/wxpay/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2019</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
