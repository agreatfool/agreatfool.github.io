<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Next.js Notes | Xenojoshua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://xenojoshua.com/js/jquery.min.js"></script>
  <script src="https://xenojoshua.com/js/bootstrap.min.js"></script>
  <script src="https://xenojoshua.com/js/header.js"></script>
  <script src="https://xenojoshua.com/js/toc.js"></script>
  <link href="https://xenojoshua.com//2020/06/nextjs-note/" rel="canonical" />
  <link href="https://xenojoshua.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/theme.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/syntax.css" rel="stylesheet">
  <link href="https://xenojoshua.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://xenojoshua.com/favicon.ico?" type="image/x-icon" rel="shortcut icon">
  <style>
    /* Enhance table style */
    table {
      border: 2px solid #4F7849;
      background-color: #EEEEEE;
      width: 100%;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table.comicGreen th {
      border: 1px solid #4F7849;
      padding: 3px 5px;
    }
    table tbody td {
      font-size: 14px;
      color: #4F7849;
    }
    table tr:nth-child(even) {
      background: #CEE0CC;
    }
    table thead {
      background: #4F7849;
      border-bottom: 1px solid #444444;
    }
    table thead th {
      font-size: 16px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #D0E4F5;
      padding: 3px 5px;
    }
    table thead th:first-child {
      border-left: none;
    }
    table tfoot td {
      font-size: 21px;
    }

    /* Enhance pre style */
    pre {
      color: #FFFFFF;
      background-color: #000000;
      border-color: #000000;
    }

    /* Image bg color white while dark background */
    img {
      background-color: #FFFFFF;
    }

    /* Keep gist style clean */
    .gist table tr:nth-child(even) {
      background: #FFFFFF;
    }
    .gist td, th {
      border: none;
    }
  </style>
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11349149-4']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  

 <script type="text/javascript">
   var host = "xenojoshua.com";
   if ((host == window.location.host) && (window.location.protocol != "https:"))
     window.location.protocol = "https";
 </script>
 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://xenojoshua.com/">Xenojoshua</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://xenojoshua.com/">/home</a></li>
          <li><a href="https://xenojoshua.com/archive/">/archive</a></li>
          <li><a href="https://xenojoshua.com/categories/">/categories</a></li>
          <li><a href="https://xenojoshua.com/tags/">/tags</a></li>
          <li><a href="https://xenojoshua.com/feed.xml" target="_blank">/rss</a></li>
          <li><a href="https://xenojoshua.com/about/">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://xenojoshua.com/2020/06/nextjs-note/">Next.js Notes</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>09 Jun 2020</time>
                </div>
                <ul>
                  
                    <li><a href="https://xenojoshua.com/tag/ReactJs">ReactJs</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/React">React</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/NextJs">NextJs</a></li>
                  
                    <li><a href="https://xenojoshua.com/tag/Node.js">Node.js</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <h4>Table of Contents</h4>
<ul id="markdown-toc">
  <li><a href="#0-前言" id="markdown-toc-0-前言">0. 前言</a></li>
  <li><a href="#1-文件结构" id="markdown-toc-1-文件结构">1. 文件结构</a></li>
  <li><a href="#2-路由" id="markdown-toc-2-路由">2. 路由</a></li>
  <li><a href="#4-ssr-csr-static" id="markdown-toc-4-ssr-csr-static">4. SSR CSR Static</a></li>
  <li><a href="#5-nextjs的其他知识点" id="markdown-toc-5-nextjs的其他知识点">5. Next.js的其他知识点</a>    <ul>
      <li><a href="#51-css相关" id="markdown-toc-51-css相关">5.1 CSS相关</a></li>
      <li><a href="#52-变量配置" id="markdown-toc-52-变量配置">5.2 变量配置</a></li>
      <li><a href="#53-api后端" id="markdown-toc-53-api后端">5.3 API后端</a></li>
      <li><a href="#54-自定义app" id="markdown-toc-54-自定义app">5.4 自定义App</a></li>
      <li><a href="#55-自定义document" id="markdown-toc-55-自定义document">5.5 自定义Document</a></li>
    </ul>
  </li>
  <li><a href="#6-react相关概念" id="markdown-toc-6-react相关概念">6. React相关概念</a>    <ul>
      <li><a href="#61-state" id="markdown-toc-61-state">6.1 state</a></li>
      <li><a href="#62-effect" id="markdown-toc-62-effect">6.2 effect</a></li>
    </ul>
  </li>
  <li><a href="#7-自定义服务器" id="markdown-toc-7-自定义服务器">7. 自定义服务器</a></li>
  <li><a href="#8-问题及解决" id="markdown-toc-8-问题及解决">8. 问题及解决</a>    <ul>
      <li><a href="#81-typeorm" id="markdown-toc-81-typeorm">8.1 TypeORM</a></li>
    </ul>
  </li>
  <li><a href="#资料" id="markdown-toc-资料">资料</a></li>
</ul>

<h2 id="0-前言">0. 前言</h2>
<p>最近在尝试使用<a href="https://nextjs.org/" target="_blank">Next.js</a>，虽说比直接裸用react简单不少，但还是有不少自有的特殊概念，因此这里开篇笔记，做下记录。</p>

<p>入门Next.js可以阅读官方的教程：<a href="https://nextjs.org/learn/basics/create-nextjs-app" target="_blank">Create a Next.js App</a>。关于Next.js的优势，为什么要使用Next.js以及很多关于Next.js的细节等，可以查看这篇博文：<a href="https://www.freecodecamp.org/news/the-next-js-handbook/" target="_blank">The Next.js Handbook</a>。</p>

<p>version<code>9.4.4</code>已知问题（会列一些对使用有影响的）：</p>
<ul>
  <li><a href="https://github.com/vercel/next.js/issues/5214" target="_blank">trailing slash in link … 404 … #5214</a></li>
</ul>

<h2 id="1-文件结构">1. 文件结构</h2>
<p>默认被占用的路径只有两个：</p>

<ul>
  <li><code>project_root/pages</code>：用来作为页面路由使用</li>
  <li><code>project_root/public</code>：用来进行静态文件输出</li>
</ul>

<h2 id="2-路由">2. 路由</h2>
<p>路由部分Next.js做了简化，默认是使用文件夹的形式，在<code>project_root/pages/name.js|tsx</code>下的文件，会映射为<code>your_site/name</code>这个路径，见官方文档：<a href="https://nextjs.org/docs/basic-features/pages" target="_blank">Pages</a>。这样使用上非常简便，正常使用的话，就完全不需要引入第三方的类库（类似于<code>react-router</code>），也不需要使用编程的方式在代码中定义路由。更多细节：<a href="https://nextjs.org/docs/routing/introduction" target="_blank">Routing</a></p>

<p>但上述的路由不能很好支持<code>your_site/user/:user_id</code>这样的需求。类似这样的需求在Next.js中也有解决方案，被称为<code>dynamic route</code>。官方文档在：<a href="https://nextjs.org/docs/routing/dynamic-routes" target="_blank">Dynamic Routes</a>。只需要把page文件的名字定义为：<code>pages/post/[pid].js</code>就OK。多参数的路径，类似：<code>pages/post/[pid]/[comment].js</code>，也是一样处理，这种路径在query参数中获取到的object就会含有多个键。</p>

<p>如果需要编程的方式来进行route操作的话，见文档：<a href="https://nextjs.org/docs/api-reference/next/router" target="_blank">next/router</a>。如果官方以文件夹形式管理的自动化route无法满足需求的话，还有功能强大的插件形式的route可以使用：<a href="https://github.com/fridays/next-routes" target="_blank">Dynamic Routes for Next.js</a>。</p>

<h2 id="4-ssr-csr-static">4. SSR CSR Static</h2>
<p>Next.js默认支持了服务端渲染等提升前端获取速度和渲染性能的功能，但这也要求开发者必须谨慎对待组件的初始化和生命周期，因为显然运行在服务端和客户端的代码在获取组件初始化需要的数据时的方法是不一样的。</p>

<p>这部分的文档在：<a href="https://nextjs.org/docs/basic-features/data-fetching" target="_blank">Data fetching</a>，以及<a href="https://nextjs.org/docs/advanced-features/automatic-static-optimization" target="_blank">Automatic Static Optimization</a>。</p>

<p>如果一个Page里<code>getServerSideProps</code>或<code>getInitialProps</code>存在的话，该Page就会被识别为服务端渲染（SSR），会在每次请求的时候进行渲染。而如果这两者皆不存在的话，该页面就会在服务器启动并构建的时候生成静态页面，后续每次请求的时候都会直接返回该静态页面。此外，在DEV模式的情况下，即便是静态渲染的Page也会在每次请求的时候触发渲染，需要注意。</p>

<p>主要方法有以下几个：</p>

<p><strong><a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation" target="_blank">getStaticPaths</a></strong></p>

<p>这个方法一般是配合<code>dynamic route</code>进行使用，会在Next.js服务器启动，并进行服务器静态构建的时候运行。其作用是告诉后续的<code>getStaticProps</code>某个动态路径的可能项。如果这个page你不需要静态构建，或者这个page也不是dynamic route，那就不需要实现这个函数。</p>

<p>举例来说<code>pages/user/[id].js</code>代码中的<code>getStaticProps</code>就需要返回：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">getStaticPaths() {</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">paths</span><span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nx">params</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;1&#39;</span> <span class="p">}</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nx">params</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;2&#39;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">],</span>
    <span class="nx">fallback</span>: <span class="kt">true</span> <span class="nx">or</span> <span class="kc">false</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></figure>

<p>paths和fallback都是必须的键。fallback的意思是，当遇到客户端访问到一个并不存在于启动构建时制作的paths列表里的路径，Next.js应该允许客户端继续访问，还是直接返回一个404。这里要注意，如果fallback为true，也就是允许客户端继续访问的话，page代码一定要做好容错性，否则很容易导致页面报错。</p>

<p><strong><a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation" target="_blank">getStaticProps</a></strong></p>

<p>这个方法也是在Next.js服务器启动的时候，进行服务器静态构建的时候运行。其作用是用来给静态生成的页面提供props。同样的，如果这个page你不需要静态构建，那就不需要实现这个函数。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">getStaticProps</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{},</span> <span class="c1">// will be passed to the page component as props</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>如果是<code>dynamic route</code>的情况，该函数的context会包含<code>getStaticPaths</code>提供的路径信息：<code>context.params = { id: '1' }</code>。</p>

<p><strong><a href="https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering" target="_blank">getServerSideProps</a></strong></p>

<p>同样是运行在服务器端，但并不是在Next.js构建时候运行，而是在每一次单独的请求到达的时候触发。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">getServerSideProps</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">props</span><span class="o">:</span> <span class="p">{},</span> <span class="c1">// will be passed to the page component as props</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><strong><a href="https://nextjs.org/docs/api-reference/data-fetching/getInitialProps" target="_blank">getInitialProps</a></strong></p>

<p>基本上已弃用，如果是静态生成页面的话，使用<code>getStaticProps</code>；如果是服务端渲染的话，使用<code>getServerSideProps</code>。如果仅只是客户端渲染的页面，则使用React的effect就可以了。</p>

<h2 id="5-nextjs的其他知识点">5. Next.js的其他知识点</h2>
<h3 id="51-css相关">5.1 CSS相关</h3>
<p>官方文档：<a href="https://nextjs.org/docs/basic-features/built-in-css-support" target="_blank">Built-In CSS Support</a>。</p>

<p>Next.js的CSS有很多细节，最主要的是命名后缀的问题，使用<code>*.module.css</code>的话，生成出来的页面上的CSS是会附带随机后缀的，就不会造成冲突。而如果需要引入global的css的话，则需要创建<code>pages/_app.js</code>文件，在这里修改。</p>

<p>jsx支持相关可以查阅这篇文档：<a href="https://github.com/vercel/styled-jsx" target="_blank">styled-jsx</a>。</p>

<h3 id="52-变量配置">5.2 变量配置</h3>
<p>环境变量的官方文档：<a href="https://nextjs.org/docs/basic-features/environment-variables" target="_blank">Environment Variables</a>。</p>

<p>Next.js默认直接支持环境变量配置。基本上有配置相关需求就直接使用这个解决方案就OK了。</p>

<h3 id="53-api后端">5.3 API后端</h3>
<p>之前提到的route都是pages下的页面，一般来说还需要前后端交互使用的<code>/api/*</code>，这个在Next.js中被称为：<a href="https://nextjs.org/docs/api-routes/introduction" target="_blank">API Routes</a>。</p>

<h3 id="54-自定义app">5.4 自定义App</h3>
<p>创建<code>pages/_app.js</code>代码文件，就可以在里面进行一些应用级别的初始化工作。官方文档：<a href="https://nextjs.org/docs/advanced-features/custom-app" target="_blank">Custom App</a>。自定义App的可能需求为：</p>

<ul>
  <li>Persisting layout between page changes</li>
  <li>Keeping state when navigating pages</li>
  <li>Custom error handling using componentDidCatch</li>
  <li>Inject additional data into pages</li>
  <li>Add global CSS</li>
</ul>

<h3 id="55-自定义document">5.5 自定义Document</h3>
<p>创建<code>pages/_document.js</code>代码文件，就可以在里面改动全局的<code>&lt;html&gt;</code>和<code>&lt;body&gt;</code>。官方文档：<a href="https://nextjs.org/docs/advanced-features/custom-document" target="_blank">Custom Document</a>。</p>

<blockquote>
  <p>Document is only rendered in the server.</p>
</blockquote>

<h2 id="6-react相关概念">6. React相关概念</h2>
<p>Next.js和React的关系还是比较简单的。React本身的功能其实很简单，它就只是一个渲染引擎，而用来做应用的时候，你除了渲染之外还需要很多东西，而这些，React是给不了你的，必须你自己去组织。比如说最基本的请求路由，比如说打包用的webpack，比如说js transformation的babel，以及提升整体性能的服务端渲染和静态生成等等等等。</p>

<p>Next.js实际上就是在React的基础上，提供这些做应用必须的组件和功能之后的框架库。所以在使用Next.js进行开发的时候，React的知识也是必须的，否则就无法正确处理渲染相关的问题了。作为基本的使用者，React其实只有3大组的概念是必须要厘清楚的。</p>

<h3 id="61-state">6.1 state</h3>
<p>React的官方文档在：<a href="https://reactjs.org/docs/hooks-state.html" target="_blank">Using the State Hook</a>。主要代码其实就只有一句：</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><code>useState</code>函数接受一个状态的默认值，然后返回一个数组，数组的0位是state变量，1位是改变这个state变量的方法，名字可以自己命名。</p>

<h3 id="62-effect">6.2 effect</h3>
<p>React的官方文档在：<a href="https://reactjs.org/docs/hooks-effect.html" target="_blank">Using the Effect Hook - React</a>。只要是涉及到状态变化的，都属于effect的范畴。一个React组件里可以使用<code>useEffect</code>函数注册多个effect事件。第二个参数的指定可以决定该effect事件应该在什么时候触发。</p>

<p><code>[]</code>，效果同<code>componentDidMount</code>，仅只在组件mount的时候触发一次。同时，在这种effect中提供一个回调函数返回，则等同于<code>componentWillUnmount</code>，这个回调函数会在组件被unmount的时候被触发，用来做析构。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// your effect here</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{};</span> <span class="c1">// unmount</span>
<span class="p">},</span> <span class="p">[]);</span></code></pre></figure>

<p><code>无参数</code>，效果同<code>componentDidUpdate</code>，每次组件re-render都会触发。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// your effect here</span>
<span class="p">});</span> <span class="c1">// no optional argument</span></code></pre></figure>

<p><code>[foo]</code>，在数组中放入prop或state，则该effect只会在这个prop或state发生变化的时候触发。这个数组里可以放入复数的变量，表示监听多个变量的变化，任何一个发生变化都会触发该effect。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// your effect here</span>
<span class="p">},</span> <span class="p">[</span><span class="nx">foo</span><span class="p">]);</span></code></pre></figure>

<h2 id="7-自定义服务器">7. 自定义服务器</h2>
<p>在大部分情况下，使用<code>next [start]</code>命令启动的服务器就已经足够满足需求了，但某些时候，我们仍旧有需求需要自定义一些服务端的功能，这时候就需要改造Next.js自带的服务端功能了。</p>

<p>官方文档在：<a href="https://nextjs.org/docs/advanced-features/custom-server" target="_blank">Custom Server</a>。koa的例子可以在官方范例代码库中进行查看：<a href="https://github.com/vercel/next.js/tree/master/examples/custom-server-koa" target="_blank">Custom Koa Server example</a>。此外，还有一篇博客讲得不错：<a href="https://cloudreports.net/nextjs-koajs-create-custom-nextjs-server-with-koajs/" target="_blank">NextJs + KoaJs Create custom NextJs server with KoaJs</a>。以及，另一个例子可以参考：<a href="https://github.com/fridays/next-routes#on-the-server" target="_blank">fridays/next-routes#on-the-server</a>。</p>

<p>不过官方的文档给出的信息其实也相当有限，没有任何对于<code>next</code>命令的细致解释，如果想要知道官方启动命令实际上做了什么，就只能去阅读源码了。简单看了下，除了启动服务器之外，next命令还是做了不少事情的，如果想要在保证这些功能的情况下兼容koa的话，是相当困难的。</p>

<p>这里更建议的做法是启一个纯粹的koa后端作为API的服务器，而将基本的前端页面和pages交给Next.js来进行服务。这样就可以绕开必须改动或者无法使用next命令的情况。</p>

<h2 id="8-问题及解决">8. 问题及解决</h2>
<h3 id="81-typeorm">8.1 TypeORM</h3>
<p>初始Versions</p>

<pre><code>next: 9.4.4
typeorm: 0.0.25
</code></pre>

<p>在添加一系列typeorm相关代码之后，next.js的编译会遇到报错（无法正常build）：</p>

<pre><code>Syntax error: Support for the experimental syntax 'decorators-legacy' isn't currently enabled
</code></pre>

<p>解决方法见：<a href="https://stackoverflow.com/a/52765213" target="_blank">Syntax error - Support for the experimental syntax ‘decorators-legacy’ isn’t currently enabled</a>，需要在项目根目录添加文件<code>.babelrc</code>，并添加内容（关于babel的客制化，官方文档见：<a href="https://nextjs.org/docs/advanced-features/customizing-babel-config" target="_blank">Customizing Babel Config</a>）：</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span></span><span class="p">{</span>
  <span class="nt">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">[</span>
      <span class="s2">&quot;@babel/plugin-proposal-decorators&quot;</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="nt">&quot;legacy&quot;</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">],</span>
  <span class="nt">&quot;presets&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;next/babel&quot;</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>当然还需要安装扩展：<code>yarn add @babel/plugin-proposal-decorators -D</code>。</p>

<p>接下来会遇到第二个报错：</p>

<pre><code>error - ./node_modules/typeorm/browser/driver/DriverFactory.js
Attempted import error: 'AuroraDataApiPostgresDriver' is not exported from './postgres/PostgresDriver'.
</code></pre>

<p>解决方法见：<a href="https://github.com/typeorm/typeorm/issues/6110" target="_blank">Typeorm/browser cannot be compiled since version 0.2.25 #6110</a>，解决方案简单粗暴，将typeorm的版本降到<code>0.2.24</code>即可。</p>

<p>然后会遇到第三个报错：</p>

<pre><code>warn  - ./node_modules/typeorm/browser/driver/react-native/ReactNativeDriver.js
Module not found: Can't resolve 'react-native-sqlite-storage' in './node_modules/typeorm/browser/driver/react-native'
</code></pre>

<p>解决方法见：<a href="https://github.com/typeorm/typeorm/issues/2158#issuecomment-626984473" target="_blank">browser: Can’t resolve ‘react-native-sqlite-storage’ #2158</a>。创建一个假的stub package即可。</p>

<p>然后就可以在<code>_app.tsx:MyApp.getInitialProps</code>进行数据库连接的初始化。</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="k">try</span> <span class="p">{</span>
  <span class="nx">getConnection</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="k">instanceof</span> <span class="nx">ConnectionNotFoundError</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">createConnection</span><span class="p">(</span><span class="nx">Database</span><span class="p">.</span><span class="nx">getConnectionOptions</span><span class="p">());</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="资料">资料</h2>
<ul>
  <li><a href="https://nextjs.org/" target="_blank">Next.js</a></li>
  <li><a href="https://nextjs.org/learn/basics/create-nextjs-app" target="_blank">Create a Next.js App</a></li>
  <li><a href="https://www.freecodecamp.org/news/the-next-js-handbook/" target="_blank">The Next.js Handbook</a></li>
  <li><a href="https://learnku.com/articles/40668" target="_blank">Next.js 入门超详解教程</a></li>
  <li><a href="https://github.com/vercel/next.js/issues/7607" target="_blank">[RFC] Dynamic Routes</a></li>
  <li><a href="https://github.com/fridays/next-routes" target="_blank">fridays/next-routes</a>
    <ul>
      <li><a href="https://github.com/fridays/next-routes/issues/19" target="_blank">Koa usage #19</a></li>
    </ul>
  </li>
  <li><a href="https://web.dev/route-prefetching-in-nextjs/" target="_blank">Route prefetching in Next.js</a></li>
  <li><a href="https://reactjs.org/docs/hooks-state.html" target="_blank">Using the State Hook - React</a></li>
  <li><a href="https://reactjs.org/docs/hooks-effect.html" target="_blank">Using the Effect Hook - React</a></li>
  <li><a href="https://www.robinwieruch.de/react-hooks-fetch-data" target="_blank">How to fetch data with React Hooks?</a></li>
  <li><a href="https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/" target="_blank">useEffect 完整指南</a></li>
  <li><a href="https://blog.carbonfive.com/replacing-component-lifecycle-methods-with-react-hooks/" target="_blank">Replacing Component Lifecycle Methods with React Hooks</a></li>
  <li><a href="https://stackoverflow.com/a/54004148" target="_blank">Should I use one or many useEffect in component?</a></li>
  <li><a href="https://github.com/vercel/next.js/issues/2252" target="_blank">Where to store persistent/global data? #2252</a></li>
  <li><a href="https://juejin.im/post/5d8ad2c7518825091471fd26" target="_blank">Next.js实践总结 - 登录授权验证最佳方案</a></li>
  <li><a href="https://juejin.im/post/5c07a0bbf265da613438308c" target="_blank">Next.js脚手架进阶 — 封装fetch &amp;&amp; 增加中间件</a></li>
  <li><a href="https://juejin.im/post/5b868b45e51d4538ae4db7ca" target="_blank">Next.js踩坑入门系列（三）— 目录重构&amp;&amp;再谈路由</a></li>
  <li><a href="https://cloudreports.net/nextjs-koajs-create-custom-nextjs-server-with-koajs/" target="_blank">NextJs + KoaJs Create custom NextJs server with KoaJs</a></li>
</ul>

<blockquote>
  <p>EOF</p>
</blockquote>

              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2020/06/material-ui/">MaterialUI Notes</a></li>
    
    <li><a href="/2020/06/nextjs-note/">Next.js Notes</a></li>
    
    <li><a href="/2020/05/youtube-dl/">youtube-dl 及 ffmpeg 相关</a></li>
    
    <li><a href="/2020/05/golang-concurrency/">Golang Concurrency</a></li>
    
    <li><a href="/2020/04/grpc-js-support/">grpc_tools_node_protoc_ts 对 @grpc/grpc-js 的支持</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Categories</h2>
  <ul>
    
      <li><a href="/category/Linux">Linux</a></li>
    
      <li><a href="/category/Stress & Scaling">Stress & Scaling</a></li>
    
      <li><a href="/category/PHP">PHP</a></li>
    
      <li><a href="/category/IDE">IDE</a></li>
    
      <li><a href="/category/Wordpress">Wordpress</a></li>
    
      <li><a href="/category/SEO">SEO</a></li>
    
      <li><a href="/category/Version Control">Version Control</a></li>
    
      <li><a href="/category/HTML & CSS">HTML & CSS</a></li>
    
      <li><a href="/category/Trash">Trash</a></li>
    
      <li><a href="/category/Apache">Apache</a></li>
    
      <li><a href="/category/Memcache">Memcache</a></li>
    
      <li><a href="/category/Net Services">Net Services</a></li>
    
      <li><a href="/category/Java">Java</a></li>
    
      <li><a href="/category/MicroBlog">MicroBlog</a></li>
    
      <li><a href="/category/JavaScript">JavaScript</a></li>
    
      <li><a href="/category/DB">DB</a></li>
    
      <li><a href="/category/Something">Something</a></li>
    
      <li><a href="/category/Methodology & Thinking">Methodology & Thinking</a></li>
    
      <li><a href="/category/Redis">Redis</a></li>
    
      <li><a href="/category/Flash">Flash</a></li>
    
      <li><a href="/category/Thinking">Thinking</a></li>
    
      <li><a href="/category/Platform">Platform</a></li>
    
      <li><a href="/category/C _ C++">C / C++</a></li>
    
      <li><a href="/category/Dart">Dart</a></li>
    
      <li><a href="/category/Mobile">Mobile</a></li>
    
      <li><a href="/category/Video">Video</a></li>
    
      <li><a href="/category/Blog">Blog</a></li>
    
      <li><a href="/category/Politics">Politics</a></li>
    
      <li><a href="/category/V8Blog">V8Blog</a></li>
    
      <li><a href="/category/Docker">Docker</a></li>
    
      <li><a href="/category/Golang">Golang</a></li>
    
      <li><a href="/category/Career">Career</a></li>
    
      <li><a href="/category/Prometheus">Prometheus</a></li>
    
      <li><a href="/category/Grafana">Grafana</a></li>
    
      <li><a href="/category/Logging">Logging</a></li>
    
      <li><a href="/category/Jaeger">Jaeger</a></li>
    
      <li><a href="/category/Elasticsearch">Elasticsearch</a></li>
    
      <li><a href="/category/MessageQueue">MessageQueue</a></li>
    
      <li><a href="/category/Kafka">Kafka</a></li>
    
      <li><a href="/category/gRPC">gRPC</a></li>
    
      <li><a href="/category/Envoy">Envoy</a></li>
    
      <li><a href="/category/DistributedSystem">DistributedSystem</a></li>
    
      <li><a href="/category/Tor">Tor</a></li>
    
      <li><a href="/category/Node.js">Node.js</a></li>
    
      <li><a href="/category/CI">CI</a></li>
    
      <li><a href="/category/ServiceDiscovery">ServiceDiscovery</a></li>
    
      <li><a href="/category/Git">Git</a></li>
    
      <li><a href="/category/Payment">Payment</a></li>
    
      <li><a href="/category/Japanese">Japanese</a></li>
    
      <li><a href="/category/ReactJs">ReactJs</a></li>
    
      <li><a href="/category/CSS">CSS</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = "xenojoshua"; // required: replace example with your forum shortname
  var disqus_identifier = "/2020/06/nextjs-note/";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Jonathan Dai &copy; 2019</p>
          <h6>Theme by <a href="https://github.com/streetturtle/jekyll-clean-dark" target="_blank">Pavel Makhov</a></h6>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="agreatfool on Github" href="https://github.com/agreatfool" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="https://xenojoshua.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
