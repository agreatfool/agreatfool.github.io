{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2018/02/node-profile-practice","result":{"data":{"markdownRemark":{"id":"c7962849-f982-522e-9a33-704bc2bc23e7","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%E5%89%8D%E8%A8%80\">1. 前言</a></li>\n<li><a href=\"#2-%E4%BB%8B%E7%BB%8D\">2. 介绍</a></li>\n<li>\n<p><a href=\"#3-node%E5%8E%9F%E7%94%9F%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8Cprofile\">3. Node原生工具进行Profile</a></p>\n<ul>\n<li><a href=\"#31-node%E5%AE%98%E6%96%B9guide\">3.1 Node官方Guide</a></li>\n<li><a href=\"#32-%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82\">3.2 版本要求</a></li>\n<li><a href=\"#33-profile%E8%8C%83%E4%BE%8B\">3.3 Profile范例</a></li>\n<li><a href=\"#34-%E8%A7%A3%E6%9E%90profile%E6%97%A5%E5%BF%97\">3.4 解析Profile日志</a></li>\n<li>\n<p><a href=\"#35-%E7%90%86%E8%A7%A3profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9\">3.5 理解Profile日志内容</a></p>\n<ul>\n<li><a href=\"#351-shared-libraries\">3.5.1 Shared libraries</a></li>\n<li>\n<p><a href=\"#352-javascript%E3%80%81c%E3%80%81summary\">3.5.2 JavaScript、C++、Summary</a></p>\n<ul>\n<li><a href=\"#javascript\">JavaScript</a></li>\n<li><a href=\"#c\">C++</a></li>\n<li><a href=\"#summary\">Summary</a></li>\n<li><a href=\"#%E5%88%97%E5%90%AB%E4%B9%89\">列含义</a></li>\n</ul>\n</li>\n<li><a href=\"#353-c-entry-points\">3.5.3 C++ entry points</a></li>\n<li><a href=\"#354-bottom-up-heavy-profile\">3.5.4 Bottom up (heavy) profile</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#4-%E8%B5%84%E6%96%99\">4. 资料</a></p>\n<ul>\n<li><a href=\"#41-%E7%81%AB%E7%84%B0%E5%9B%BE%E7%9B%B8%E5%85%B3\">4.1 火焰图相关</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#5-%E9%99%84%E5%BD%95\">5. 附录</a></p>\n<ul>\n<li><a href=\"#51-%E8%A7%A3%E6%9E%90%E5%AE%8C%E6%88%90%E7%9A%84profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9-id51\">5.1 解析完成的Profile日志内容 {#ID51}</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>本文是系列文章<a href=\"/2018/01/node-profile/\">Node.JS Profile</a>的一部分，完整的文章列表请去总章查看。</p>\n<p>本文主要负责介绍Node的命令行Profile知识及实践操作。</p>\n<h1 id=\"2-介绍\" style=\"position:relative;\"><a href=\"#2-%E4%BB%8B%E7%BB%8D\" aria-label=\"2 介绍 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 介绍</h1>\n<p>在系列文章的前几节里，基本上已经把Node应用程序最关键的几个性能指标项目都过了一遍，这几节的主要目的都是为了Profile进行知识储备，并打好对某一方面进行针对性查错的基础。</p>\n<p>在掌握了前几节的内容之后，就可以回过头来回到当前这个系列文章的主题<code class=\"language-text\">Profile</code>来了，当然我们这里说的是<code class=\"language-text\">狭义上的Profile（时间消耗）</code>，即观察，并了解Node进程具体在做什么，每一步都花了多少时间，以便有针对性地进行查错和调优。</p>\n<p>狭义上的Profile（时间消耗）是非常重要的。一个应用程序如果需要顺利运行需要很多资源，包括且不限于：CPU、内存、磁盘、网络，很多情况下应用程序都会去申请、消耗这些资源以完成自身的工作任务，而Profile让应用程序研发者详细了解应用程序是如何申请、消耗这些资源并完成任务的。只有了解了这些信息之后，研发者才能知道哪里出了问题，哪里还有提升空间。</p>\n<p>Note：</p>\n<p>本文的版本时效性可能比较敏感，关于行文及范例中使用的Node版本，请查看<a href=\"/2018/01/node-profile/\">总章</a>进行了解。</p>\n<h1 id=\"3-node原生工具进行profile\" style=\"position:relative;\"><a href=\"#3-node%E5%8E%9F%E7%94%9F%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8Cprofile\" aria-label=\"3 node原生工具进行profile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Node原生工具进行Profile</h1>\n<h2 id=\"31-node官方guide\" style=\"position:relative;\"><a href=\"#31-node%E5%AE%98%E6%96%B9guide\" aria-label=\"31 node官方guide permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 Node官方Guide</h2>\n<p>Node官方文档有一篇<a href=\"https://nodejs.org/en/docs/guides/simple-profiling/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Guide</a>，详细介绍了如何进行profile。本文下面主要就是对该Guide进行翻译及针对实际操作进行总结。</p>\n<p>Node的内置Profiler来自V8，V8官方的Profiler介绍可以查看：<a href=\"https://github.com/v8/v8/wiki/Using%20V8%E2%80%99s%20internal%20profiler\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Using V8’s internal profiler</a>，其实和Node的Guide比起来差的不多，但更针对性地对浏览器进行了操作介绍。</p>\n<h2 id=\"32-版本要求\" style=\"position:relative;\"><a href=\"#32-%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82\" aria-label=\"32 版本要求 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 版本要求</h2>\n<p>Node官方的Profiler内嵌自版本4.4.0，所以请至少使用这个及以上的版本：</p>\n<blockquote>\n<p>Luckily, tools have recently been introduced into Node.js 4.4.0 that facilitate the consumption of this information without separately building V8 from source.</p>\n</blockquote>\n<h2 id=\"33-profile范例\" style=\"position:relative;\"><a href=\"#33-profile%E8%8C%83%E4%BE%8B\" aria-label=\"33 profile范例 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 Profile范例</h2>\n<p>调优前的范例代码如下，注意运行前请预先装好<a href=\"https://httpd.apache.org/docs/2.4/programs/ab.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ApacheBench</a>：</p>\n<script src=\"https://gist.github.com/agreatfool/a55f5cbdd66d097ba4855e47d42338e5.js\"> </script>\n<p>文件夹结构：</p>\n<ul>\n<li>bash/profile-ab.sh</li>\n<li>bash/profile-server.sh</li>\n<li>profile/package.json</li>\n<li>profile/server.js</li>\n</ul>\n<p>执行步骤：</p>\n<ul>\n<li>cd profile</li>\n<li>npm install</li>\n<li>cd ..</li>\n<li>chmod +x bash/profile-ab.sh</li>\n<li>chmod +x bash/profile-server.sh</li>\n<li>./bash/profile-server.sh：保证服务器进程运行中</li>\n<li>./bash/profile-ab.sh</li>\n<li>查看结果</li>\n</ul>\n<p>执行结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Benchmarking localhost (be patient)\nCompleted 100 requests\nCompleted 200 requests\nFinished 250 requests\n\n\nServer Software:        \nServer Hostname:        localhost\nServer Port:            5000\n\nDocument Path:          /auth?username=matt&amp;password=password\nDocument Length:        2 bytes\n\nConcurrency Level:      20\nTime taken for tests:   24.817 seconds\nComplete requests:      250\nFailed requests:        0\nKeep-Alive requests:    250\nTotal transferred:      51500 bytes\nHTML transferred:       500 bytes\nRequests per second:    10.07 [#/sec] (mean)\nTime per request:       1985.384 [ms] (mean)\nTime per request:       99.269 [ms] (mean, across all concurrent requests)\nTransfer rate:          2.03 [Kbytes/sec] received\n\nConnection Times (ms)</code></pre></div>\n<p> \t             min  mean[+/-sd] median   max\nConnect:        0    0   0.1      0       1\nProcessing:    99 1909 305.1   1985    2019\nWaiting:       99 1909 305.1   1985    2019\nTotal:        100 1909 304.9   1985    2019\n\nPercentage of the requests served within a certain time (ms)\n50%   1985\n66%   1991\n75%   1995\n80%   1997\n90%   2002\n95%   2005\n98%   2011\n99%   2014\n100%   2019 (longest request)</p>\n<p>结论：</p>\n<ul>\n<li><code class=\"language-text\">20</code>个并发，完成<code class=\"language-text\">250</code>个请求，耗时<code class=\"language-text\">24.817</code>秒</li>\n<li>平均每秒只能处理<code class=\"language-text\">10.07</code>个请求</li>\n<li>很糟糕</li>\n</ul>\n<h2 id=\"34-解析profile日志\" style=\"position:relative;\"><a href=\"#34-%E8%A7%A3%E6%9E%90profile%E6%97%A5%E5%BF%97\" aria-label=\"34 解析profile日志 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4 解析Profile日志</h2>\n<p>在刚才运行<code class=\"language-text\">profile-ab.sh</code>脚本的路径下，会产生一个文件名类似<code class=\"language-text\">isolate-0x103000000-v8.log</code>这样的文件。该文件比较大，就不放gist了，请自行实验获取范例。</p>\n<p>然后使用以下命令将该日志解析生成可读的内容：</p>\n<blockquote>\n<p>node --prof-process isolate-0x103000000-v8.log > processed.txt</p>\n</blockquote>\n<h2 id=\"35-理解profile日志内容\" style=\"position:relative;\"><a href=\"#35-%E7%90%86%E8%A7%A3profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9\" aria-label=\"35 理解profile日志内容 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5 理解Profile日志内容</h2>\n<p>解析出来的日志文件内容有点多，原文放在附录部分，点击<a href=\"#ID51\">这里</a>查看。</p>\n<p>从上到下主要分为几个耗时分类，一个个细说。</p>\n<h3 id=\"351-shared-libraries\" style=\"position:relative;\"><a href=\"#351-shared-libraries\" aria-label=\"351 shared libraries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5.1 Shared libraries</h3>\n<p>Node进程使用到的系统级动态链接库部分的时间消耗，会显示在这个分类下。</p>\n<p>该分类的几列：</p>\n<ul>\n<li>ticks：每个库所占用的ticks数量</li>\n<li>total：每个库占用的ticks总量百分比</li>\n<li>nonlib：这列在当前分类不适用，因为本来这里列的就都是类库时间消耗，nonlib当然没有数据</li>\n<li>name：动态链接库的文件位置</li>\n</ul>\n<h3 id=\"352-javascript、c、summary\" style=\"position:relative;\"><a href=\"#352-javascript%E3%80%81c%E3%80%81summary\" aria-label=\"352 javascript、c、summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5.2 JavaScript、C++、Summary</h3>\n<p>这几个分类放一起说，因为他们的列数据含义相同。</p>\n<h4 id=\"javascript\" style=\"position:relative;\"><a href=\"#javascript\" aria-label=\"javascript permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JavaScript</h4>\n<p>JavaScript代码部分的时间消耗，包括了当前项目源代码部分的时间消耗和第三方node_modules的时间消耗。</p>\n<h4 id=\"c\" style=\"position:relative;\"><a href=\"#c\" aria-label=\"c permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>C++</h4>\n<p>Node进程在C++代码里的时间消耗，Node本身是构建在V8引擎之上的，所以一些Node标准库里的API，基本上都是C++时间消耗。当然这个分类也包含了一些作为第三方addon加载的插件的时间消耗。</p>\n<h4 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h4>\n<p>这个分类应该是当前报表中最重要的部分，没有细节，就仅仅只是将所有的分类的时间消耗总量都放在一起，形成一个直观的结果。一般来说看Profile结论报表，第一个要看的就是Summary，有一个最直观的结论之后再去找对应部分的细节。</p>\n<p>这里需要注意的有两处：</p>\n<ul>\n<li>GC：整个报表中唯一只在这个Summary中能找到<code class=\"language-text\">内存回收（GC）</code>相关的时间消耗数据</li>\n<li>Unaccounted：偶尔，Profiler会无法当前执行的内容到底是什么，这类的ticks就会被归类到<code class=\"language-text\">Unaccounted</code>这个分类下</li>\n</ul>\n<h4 id=\"列含义\" style=\"position:relative;\"><a href=\"#%E5%88%97%E5%90%AB%E4%B9%89\" aria-label=\"列含义 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>列含义</h4>\n<ul>\n<li>ticks：占用的ticks数量</li>\n<li>total：占用的ticks总量百分比</li>\n<li>\n<p><code class=\"language-text\">nonlib</code>：</p>\n<ul>\n<li>这列描述的是将<code class=\"language-text\">Shared libraries</code>所产生的时间消耗忽略之后，当前条目自身产生的时间消耗（ticks）所占的百分比</li>\n<li>举例来说：你写的JS代码中new了一个对象，然后内存分配器会问系统去要内存，这里可能就会产生<code class=\"language-text\">/usr/lib/system/libsystem_malloc.dylib</code>的时间消耗了，<code class=\"language-text\">nonlib</code>列给的百分比就是去掉这个<code class=\"language-text\">libsystem_malloc.dylib</code>库产生的时间消耗之后，你代码中new对象所产生的时间消耗所占的百分比</li>\n</ul>\n</li>\n<li>\n<p>name：</p>\n<ul>\n<li>JavaScript：函数名，以及其在源代码中的位置</li>\n<li>C++：函数名，一般都是Node运行时和V8相关的函数</li>\n<li>Summary：分类名</li>\n</ul>\n</li>\n</ul>\n<p>关于JavaScript的name列，还有一些细节可以说一下：</p>\n<p>每个name列实际函数名之前一般会有一个<code class=\"language-text\">*</code>或<code class=\"language-text\">~</code>，星号表示该函数得到了优化，而波浪号则表示没有。<a href=\"#ID51\">这个例子</a>里只有未优化的范例，下面放一个有优化的例子：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ticks parent  name\n3567   16.9%  Builtin: StringEqual\n3567  100.0%    LazyCompile: *&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:43:54\n3567  100.0%      LazyCompile: *InnerArrayFind native array.js:843:24\n3441   96.5%        LazyCompile: *find native array.js:855:19\n3278   95.3%          LazyCompile: *&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37\n3278  100.0%            Builtin: ArrayForEach\n 163    4.7%          Function: ~&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37\n 163  100.0%            Builtin: ArrayForEach\n 126    3.5%        Function: ~find native array.js:855:19\n 114   90.5%          LazyCompile: *&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37\n 114  100.0%            Builtin: ArrayForEach\n  12    9.5%          Function: ~&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37\n  12  100.0%            Builtin: ArrayForEach</code></pre></div>\n<p>此外，函数名之前都会有一个前缀，例如：<code class=\"language-text\">LazyCompile</code>，他们都有各自的意义，这里罗列下一般常见的（不保证全）：</p>\n<ul>\n<li>Function：普通的JS函数</li>\n<li>LazyCompile：懒编译的JS函数</li>\n<li>RegExp：正则表达式引擎</li>\n<li>Builtin：Node运行时内建的JS函数</li>\n<li>Stub：Node运行时内建的C函数</li>\n</ul>\n<h3 id=\"353-c-entry-points\" style=\"position:relative;\"><a href=\"#353-c-entry-points\" aria-label=\"353 c entry points permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5.3 C++ entry points</h3>\n<p>这部分描述的是当逻辑从JS代码跨界到C++代码运行时，其中消耗的时间。</p>\n<p>这部分的意义不是很大，毕竟如果真的有大量和C++相关的时间消耗的话，直接看C++相关的部分即可。只有一种情况是需要仔细查看这部分的，就是从JS到C++之间的交换出了问题，JS本身没有很大的性能问题，且C++也没有，而是在两者之间做数据和消息交换的时候出了问题。</p>\n<p>范例直接看<a href=\"#ID51\">本文附带的例子</a>即可，里面C++占了绝大部分的时间消耗，而同样的在C++ entry points也有对应的巨量时间消耗占比。</p>\n<h3 id=\"354-bottom-up-heavy-profile\" style=\"position:relative;\"><a href=\"#354-bottom-up-heavy-profile\" aria-label=\"354 bottom up heavy profile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5.4 Bottom up (heavy) profile</h3>\n<p>这部分是性能问题的暴露部分，一般看完Summery不想了解其细节就直接来看这部分是解决问题的最快方案。</p>\n<p>和之前其他分类耗时部分不同的是，在这部分里按空行分隔的不同段落都是一个个单独的性能瓶颈点，每个段落的多行表示的是一个调用栈。</p>\n<p>此外，这个部分的列内容也和之前的略有不同（主要是parent字段），<code class=\"language-text\">parent</code>列的百分比意味着：当前行有<code class=\"language-text\">X%</code>的统计结果会调用当前行的上一行里的函数。</p>\n<blockquote>\n<p>Within each of the “call stacks” above, the percentage in the parent column tells you the percentage of samples for which the function in the row above was called by the function in the current row. </p>\n</blockquote>\n<p>一般情况下，看完Profile报表中的这部分，性能问题都能找到原因。</p>\n<h1 id=\"4-资料\" style=\"position:relative;\"><a href=\"#4-%E8%B5%84%E6%96%99\" aria-label=\"4 资料 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 资料</h1>\n<ul>\n<li><a href=\"https://httpd.apache.org/docs/2.4/programs/ab.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ApacheBench</a></li>\n<li><a href=\"https://nodejs.org/en/docs/guides/simple-profiling/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Easy profiling for Node.js Applications</a>：如何在命令行下进行Profile的官方指引</li>\n<li><a href=\"https://github.com/v8/v8/wiki/Using%20V8%E2%80%99s%20internal%20profiler\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Using V8’s internal profiler</a>：V8官方wiki的一篇教程</li>\n<li><a href=\"https://blog.continuation.io/node-js-profiling-using-the-v8-tick-profiler/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node.js Profiling Using the V8 Tick Profiler</a>：细节相当多的博文，唯一找到的一篇对profile分析文本的每个段落都有细节解释的文章</li>\n<li><a href=\"https://stackoverflow.com/questions/23934451/how-to-read-nodejs-internal-profiler-tick-processor-output\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to read nodejs internal profiler tick-processor output</a>：stackoverflow的一个帖子</li>\n<li><a href=\"https://groups.google.com/forum/#!topic/nodejs/oRbX5eZvOPg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Understanding the v8-profiler output</a>：google论坛上的一个帖子，细节蛮多的</li>\n<li><a href=\"https://www.jetbrains.com/help/webstorm/v8-cpu-and-memory-profiling.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">V8 CPU and Memory Profiling</a>：WebStorm官方的一个教程贴，当然教的是他们的整合工具，但底层本质仍旧是V8的Profiler</li>\n<li><a href=\"https://mrale.ph/blog/2011/12/18/v8-optimization-checklist.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">I-want-to-optimize-my-JS-application-on-V8 checklist</a>：这篇有点老了</li>\n</ul>\n<h2 id=\"41-火焰图相关\" style=\"position:relative;\"><a href=\"#41-%E7%81%AB%E7%84%B0%E5%9B%BE%E7%9B%B8%E5%85%B3\" aria-label=\"41 火焰图相关 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 火焰图相关</h2>\n<p>MAC下的简单生成步骤：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> stackvis -g\n\n$ <span class=\"token assign-left variable\">NODE_ENV</span><span class=\"token operator\">=</span>production node profile/server.js\nServer started, listening on port <span class=\"token number\">5000</span> <span class=\"token punctuation\">..</span>.\n\n$ <span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> node <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">grep</span>\nXXX         <span class=\"token number\">69941</span>   <span class=\"token number\">0.0</span>  <span class=\"token number\">0.2</span>  <span class=\"token number\">4920704</span>  <span class=\"token number\">34256</span> s003  S+    <span class=\"token number\">2</span>:45Pm   <span class=\"token number\">0</span>:00.43 node profile/server.js\n\n$ <span class=\"token function\">sudo</span> dtrace -n <span class=\"token string\">'profile-99 /pid == 69941 &amp;&amp; arg1/ { @[ustack()] = count(); }'</span> <span class=\"token operator\">></span> stacks.out\n\n$ ./bash/profile-ab.sh\n\n$ stackvis dtrace flamegraph-svg <span class=\"token operator\">&lt;</span> stacks.out <span class=\"token operator\">></span> stacks.svg\n\n<span class=\"token comment\"># 在浏览器中打开 stacks.svg</span></code></pre></div>\n<p>资料：</p>\n<ul>\n<li><a href=\"https://nodejs.org/en/blog/uncategorized/profiling-node-js/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Profiling Node.js</a>：使用dtrace获取数据，并制作火焰图</li>\n<li><a href=\"http://cn.windyland.me/2015/11/28/profiling-with-dtrace/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Dtrace on Mac OS X</a></li>\n<li><a href=\"http://carol-nichols.com/2017/04/20/rust-profiling-with-dtrace-on-osx/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Rust Profiling with DTrace and FlameGraph on OSX</a></li>\n<li><a href=\"https://github.com/brendangregg/FlameGraph\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">brendangregg/FlameGraph</a>：虽然是个工具库，但README里有不少如何采集数据的指引</li>\n<li><a href=\"https://xizhibei.github.io/2017/09/09/node-js-profiling-tool-flamegraph/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node.js 性能分析之火焰图</a></li>\n</ul>\n<h1 id=\"5-附录\" style=\"position:relative;\"><a href=\"#5-%E9%99%84%E5%BD%95\" aria-label=\"5 附录 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 附录</h1>\n<h2 id=\"51-解析完成的profile日志内容-id51\" style=\"position:relative;\"><a href=\"#51-%E8%A7%A3%E6%9E%90%E5%AE%8C%E6%88%90%E7%9A%84profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9-id51\" aria-label=\"51 解析完成的profile日志内容 id51 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1 解析完成的Profile日志内容 {#ID51}</h2>\n<script src=\"https://gist.github.com/agreatfool/0a77653e033db0779e55993f97ed65ca.js\"> </script>","fields":{"slug":"/posts/2018/02/node-profile-practice","tagSlugs":["/tag/java-script/","/tag/performance/","/tag/profile/","/tag/cpu/","/tag/memory/"]},"frontmatter":{"date":"2018-02-27T02:01:22.000Z","description":"","tags":["JavaScript","Performance","Profile","CPU","Memory"],"title":"Node.JS Profile 4.1 Profile实践","socialImage":{"publicURL":"/static/7e722e026a41a08a8f9a1cc76782dd27/default-social-image.jpg"}}}},"pageContext":{"slug":"/posts/2018/02/node-profile-practice"}},"staticQueryHashes":["251939775","401334301","825871152"]}