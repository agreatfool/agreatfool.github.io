{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2018/02/protobuf-options","result":{"data":{"markdownRemark":{"id":"3be33d35-4e57-5359-b4c2-9cfb9905d97a","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%E5%89%8D%E8%A8%80\">1. 前言</a></li>\n<li>\n<p><a href=\"#2-%E9%87%8A%E4%B9%89\">2. 释义</a></p>\n<ul>\n<li><a href=\"#21-deprecated\">2.1 deprecated</a></li>\n<li><a href=\"#22-jstype\">2.2 jstype</a></li>\n</ul>\n</li>\n<li><a href=\"#3-%E5%8A%9F%E8%83%BD%E5%85%A8%E9%9B%86\">3. 功能全集</a></li>\n<li><a href=\"#4-%E8%87%AA%E5%AE%9A%E4%B9%89option\">4. 自定义Option</a></li>\n</ul>\n</div>\n<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>之前的工作中使用<a href=\"https://developers.google.com/protocol-buffers/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Protobuf</a>基本上都只用到了最简单的部分，最近做的基于<a href=\"https://grpc.io/docs/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">gRPC</a>的框架<a href=\"https://github.com/agreatfool/SASDN\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SASDN</a>虽然重度使用了Protobuf，但其实还只是基础功能的使用。</p>\n<p>直到最近的一个<a href=\"https://github.com/agreatfool/grpc_tools_node_protoc_ts/issues/10\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Issue</a>之前，我都没关注过Protobuf的Options功能。后面简单了解了下这个功能，这里做下笔记。本文仅粗浅介绍该功能，并不会有很深入的探讨。</p>\n<h1 id=\"2-释义\" style=\"position:relative;\"><a href=\"#2-%E9%87%8A%E4%B9%89\" aria-label=\"2 释义 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 释义</h1>\n<p><a href=\"https://developers.google.com/protocol-buffers/docs/proto3#options\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方文档</a>上，关于Options的介绍如下：</p>\n<blockquote>\n<p>Individual declarations in a .proto file can be annotated with a number of options. Options do not change the overall meaning of a declaration, but may affect the way it is handled in a particular context. The complete list of available options is defined in <code class=\"language-text\">google/protobuf/descriptor.proto</code>.</p>\n</blockquote>\n<p>简单来说，这个Options功能是为了让一份proto文件能使用在多种语言背景中而提供的一些简单选项。举两个例子就很容易理解了：</p>\n<h2 id=\"21-deprecated\" style=\"position:relative;\"><a href=\"#21-deprecated\" aria-label=\"21 deprecated permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 deprecated</h2>\n<p>官方解释说明：</p>\n<blockquote>\n<p>If set to true, indicates that the field is deprecated and should not be used by new code. In most languages this has no actual effect. In Java, this becomes a @Deprecated annotation. In the future, other language-specific code generators may generate deprecation annotations on the field’s accessors, which will in turn cause a warning to be emitted when compiling code which attempts to use the field.</p>\n</blockquote>\n<p>范例代码：</p>\n<blockquote>\n<p>int32 old_field = 6 [deprecated=true];</p>\n</blockquote>\n<p>在field定义后面添加这样一点代码就能在Java里生成一段<code class=\"language-text\">@Deprecated</code> annotation。根据语言的不同，从这个option而产生的编译反应可能各不相同，这就是option的作用。</p>\n<h2 id=\"22-jstype\" style=\"position:relative;\"><a href=\"#22-jstype\" aria-label=\"22 jstype permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 jstype</h2>\n<p>官方解释说明：<a href=\"https://github.com/google/protobuf/blob/cefa9d73e3ce62b080fda0b306bbeb67a6fc2efa/src/google/protobuf/descriptor.proto#L494\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">descriptor.proto@3.4.x#L494</a></p>\n<blockquote>\n<p>The jstype option determines the JavaScript type used for values of the field.  The option is permitted only for 64 bit integral and fixed types(int64, uint64, sint64, fixed64, sfixed64).  A field with jstype JS_STRING is represented as JavaScript string, which avoids loss of precision that can happen when a large value is converted to a floating point JavaScript. Specifying JS_NUMBER for the jstype causes the generated JavaScript code to use the JavaScript “number” type.  The behavior of the default option JS_NORMAL is implementation dependent.</p>\n</blockquote>\n<p>范例代码：</p>\n<blockquote>\n<p>int64 isbn = 1 [jstype=JS_STRING];</p>\n</blockquote>\n<p>这个option帮助proto确定在生成代码的时候当前字段应该使用JS代码中的什么类型。在int64这种超长数字类型转换成JS代码的时候很有用，如果按数字类型定义直接把int64转换成原生JS代码中的number就会发生精度丢失。很多时候我们可以选择把int64转成字符串来保留内容。</p>\n<h1 id=\"3-功能全集\" style=\"position:relative;\"><a href=\"#3-%E5%8A%9F%E8%83%BD%E5%85%A8%E9%9B%86\" aria-label=\"3 功能全集 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 功能全集</h1>\n<p>Options的全集在文档里是没有完整描述的，需要查看的时候请查看对应的代码：<a href=\"https://github.com/google/protobuf/blob/3.4.x/src/google/protobuf/descriptor.proto\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">descriptor.proto</a></p>\n<blockquote>\n<p>The complete list of available options is defined in <code class=\"language-text\">google/protobuf/descriptor.proto</code>.</p>\n</blockquote>\n<h1 id=\"4-自定义option\" style=\"position:relative;\"><a href=\"#4-%E8%87%AA%E5%AE%9A%E4%B9%89option\" aria-label=\"4 自定义option permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 自定义Option</h1>\n<p>当官方的Options不能满足需求的时候，还可以制作自定义的Option，官方文档描述如下：</p>\n<blockquote>\n<p>Protocol Buffers also allows you to define and use your own options. This is an <code class=\"language-text\">advanced feature</code> which most people don’t need. If you do think you need to create your own options, see the <a href=\"https://developers.google.com/protocol-buffers/docs/proto#customoptions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Proto2 Language Guide</a> for details. Note that creating custom options uses <a href=\"https://developers.google.com/protocol-buffers/docs/proto#extensions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">extensions</a>, which are permitted only for custom options in proto3.</p>\n</blockquote>\n<blockquote>\n<p>EOF</p>\n</blockquote>","fields":{"slug":"/posts/2018/02/protobuf-options","tagSlugs":["/tag/java-script/","/tag/protobuf/"]},"frontmatter":{"date":"2018-02-05T02:01:22.000Z","description":"","tags":["JavaScript","Protobuf"],"title":"Protobuf中的Options功能","socialImage":{"publicURL":"/static/7e722e026a41a08a8f9a1cc76782dd27/default-social-image.jpg"}}},"allFile":{"totalCount":0,"nodes":[]}},"pageContext":{"slug":"/posts/2018/02/protobuf-options","gallery":"media/posts/2018/02/protobuf-options/gallery"}},"staticQueryHashes":["251939775","401334301","825871152"]}