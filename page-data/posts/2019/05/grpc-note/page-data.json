{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2019/05/grpc-note","result":{"data":{"markdownRemark":{"id":"652dd42f-e7da-5c02-a3d5-ab0c0e9ca84a","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%E5%89%8D%E8%A8%80\">1. 前言</a></li>\n<li>\n<p><a href=\"#2-%E5%9F%BA%E6%9C%AC%E8%B5%84%E6%96%99%E5%8F%8A%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98\">2. 基本资料及网络问题</a></p>\n<ul>\n<li><a href=\"#21-go-support-for-protocol-buffers\">2.1 Go support for Protocol Buffers</a></li>\n<li><a href=\"#22-grpc-basics-go\">2.2 gRPC Basics: Go</a></li>\n<li><a href=\"#23-grpc-enhanced-example\">2.3 gRPC enhanced example</a></li>\n<li><a href=\"#24-%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98\">2.4 网络问题</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B\">3. 并发编程</a></p>\n<ul>\n<li><a href=\"#31-go%E8%AF%AD%E8%A8%80%E7%9A%84grpc%E5%B9%B6%E5%8F%91\">3.1 Go语言的gRPC并发</a></li>\n<li>\n<p><a href=\"#32-%E5%B9%B6%E5%8F%91%E7%9B%B8%E5%85%B3%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3-id_concurrency_doc\">3.2 并发相关官方文档 {#ID_CONCURRENCY_DOC}</a></p>\n<ul>\n<li>\n<p><a href=\"#concurrency\">Concurrency</a></p>\n<ul>\n<li><a href=\"#clients\">Clients</a></li>\n<li><a href=\"#streams\">Streams</a></li>\n<li><a href=\"#servers\">Servers</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#33-%E5%B9%B6%E5%8F%91%E8%8C%83%E4%BE%8B\">3.3 并发范例</a></p>\n<ul>\n<li><a href=\"#331-%E4%BB%A3%E7%A0%81%E5%B7%AE%E5%BC%82\">3.3.1 代码差异</a></li>\n<li><a href=\"#332-%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C\">3.3.2 顺序执行</a></li>\n<li><a href=\"#333-%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C\">3.3.3 并发执行</a></li>\n</ul>\n</li>\n<li><a href=\"#34-%E8%BF%9E%E6%8E%A5%E6%B1%A0\">3.4 连接池</a></li>\n<li>\n<p><a href=\"#35-benchmark\">3.5 Benchmark</a></p>\n<ul>\n<li><a href=\"#%E6%B5%8B%E8%AF%95%E7%A1%AC%E4%BB%B6\">测试硬件</a></li>\n<li><a href=\"#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%8A%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4\">客户端及服务器启动命令</a></li>\n<li><a href=\"#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C\">测试结果</a></li>\n<li><a href=\"#%E7%BB%93%E8%AE%BA\">结论</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1\">4. 负载均衡</a></li>\n<li><a href=\"#5-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5\">5. 状态检查</a></li>\n<li><a href=\"#6-interceptor\">6. Interceptor</a></li>\n<li><a href=\"#7-debug\">7. Debug</a></li>\n<li><a href=\"#8-%E7%9B%91%E6%8E%A7\">8. 监控</a></li>\n<li>\n<p><a href=\"#%E8%B5%84%E6%96%99\">资料</a></p>\n<ul>\n<li><a href=\"#%E9%93%BE%E6%8E%A5\">链接</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>首先需要申明本文并不是通泛的对gRPC的讲解，而是以Golang为基础的一篇gRPC偏应用方向的博文。因此后面的所有技术点和使用范例都会以Go语言为基础。此外，本文中对gRPC偏基础方面的内容不会涉猎过多，而是更多讲解gRPC偏设计方向的技术点。</p>\n<h1 id=\"2-基本资料及网络问题\" style=\"position:relative;\"><a href=\"#2-%E5%9F%BA%E6%9C%AC%E8%B5%84%E6%96%99%E5%8F%8A%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98\" aria-label=\"2 基本资料及网络问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 基本资料及网络问题</h1>\n<h2 id=\"21-go-support-for-protocol-buffers\" style=\"position:relative;\"><a href=\"#21-go-support-for-protocol-buffers\" aria-label=\"21 go support for protocol buffers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Go support for Protocol Buffers</h2>\n<p>关于使用Go语言的情况下的一系列protobuf相关技术点，可以参阅：<a href=\"https://github.com/golang/protobuf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">golang/protobuf</a>。</p>\n<p>主要需要关注的点有几个：</p>\n<ul>\n<li>安装：除了标准的protobuf（protoc）之外，还需要安装go的插件：<code class=\"language-text\">protoc-gen-go</code></li>\n<li>插件：protoc如果要使用go的插件，且需要生成service相关代码的话，需要在<code class=\"language-text\">go_out</code>中附带上<code class=\"language-text\">plugins=grpc:</code>字符串，e.g：<code class=\"language-text\">--go_out=plugins=grpc:${OUTPUT_PATH}</code></li>\n<li>\n<p>包管理：protobuf的包定义和go语言的习惯用法有不少差异，使用前建议阅读：<a href=\"https://github.com/golang/protobuf#packages-and-input-paths\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Packages and input paths</a></p>\n<ul>\n<li>默认的包名不会转换成相对文件夹，e.g：<code class=\"language-text\">package com.book</code>会生成<code class=\"language-text\">com_book</code>文件夹，而不是<code class=\"language-text\">com/book</code>这样的嵌套文件夹</li>\n<li>go的包路径可以使用：<code class=\"language-text\">option go_package = ...</code>来设定</li>\n<li>在某些全局编译的情况下，可以：<code class=\"language-text\">--go_out=$GOPATH</code>，直接输出到GOPATH</li>\n</ul>\n</li>\n<li>生成出来的代码相关规范：<a href=\"https://github.com/golang/protobuf#generated-code\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Generated code</a></li>\n<li>protoc插件的额外参数：<a href=\"https://github.com/golang/protobuf#parameters\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Parameters</a></li>\n</ul>\n<h2 id=\"22-grpc-basics-go\" style=\"position:relative;\"><a href=\"#22-grpc-basics-go\" aria-label=\"22 grpc basics go permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 gRPC Basics: Go</h2>\n<p>初次使用Go语言来编写gRPC代码，请阅读文档：<a href=\"https://github.com/grpc/grpc-go/blob/master/examples/gotutorial.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">grpc-go/examples/gotutorial.md</a>。</p>\n<p>对于gRPC非常熟悉的程序员可以跳过这个文档，基本上这个文档是面向新手的指引，但是范例代码都使用的是Go语言。</p>\n<h2 id=\"23-grpc-enhanced-example\" style=\"position:relative;\"><a href=\"#23-grpc-enhanced-example\" aria-label=\"23 grpc enhanced example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 gRPC enhanced example</h2>\n<p>进阶的Go语言gRPC代码可以阅读范例：<a href=\"https://github.com/grpc/grpc-go/tree/master/examples/route_guide\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">grpc-go/examples/route_guide/</a>。这个范例代码里加入了单向和双向流的范例，算是比较进阶和完整的范例代码了。</p>\n<p>我的实验项目中也有比较完整的应用范例代码，相对官方的范例来说少了点不伦不类的业务逻辑，对于只需要了解技术的读者来说更友好：<a href=\"https://github.com/agreatfool/dist-system-practice/tree/master/golang/src/experiment/grpc/samples/book\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dist-system-practice/golang/src/experiment/grpc/samples/book/</a>。</p>\n<h2 id=\"24-网络问题\" style=\"position:relative;\"><a href=\"#24-%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98\" aria-label=\"24 网络问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 网络问题</h2>\n<p>因国情原因，Go的包安装会遇到一些网络问题：</p>\n<ul>\n<li><a href=\"https://github.com/grpc/grpc-go/issues/1959\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">go get not working unrecognized import path “google.golang.org/grpc” #1959</a></li>\n<li><a href=\"https://github.com/grpc/grpc-go/issues/1780\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">go get -u google.golang.org/grpc i/o timeout #1780</a></li>\n</ul>\n<p>这种情况的最佳对应方法是在命令行下设置HTTP和HTTPS代理：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">http_proxy</span><span class=\"token operator\">=</span>http://127.0.0.1:6152\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">https_proxy</span><span class=\"token operator\">=</span>http://127.0.0.1:6152\ngo get -u <span class=\"token punctuation\">..</span>.</code></pre></div>\n<h1 id=\"3-并发编程\" style=\"position:relative;\"><a href=\"#3-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B\" aria-label=\"3 并发编程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 并发编程</h1>\n<h2 id=\"31-go语言的grpc并发\" style=\"position:relative;\"><a href=\"#31-go%E8%AF%AD%E8%A8%80%E7%9A%84grpc%E5%B9%B6%E5%8F%91\" aria-label=\"31 go语言的grpc并发 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 Go语言的gRPC并发</h2>\n<p>关于在Go语言中使用gRPC的并发问题在官方的issues中已经有很多了：</p>\n<ul>\n<li><a href=\"https://github.com/grpc/grpc-go/issues/682\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Best practices for reusing connections, concurrency #682</a></li>\n<li><a href=\"https://github.com/grpc/grpc-go/issues/85\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Concurrency #85</a></li>\n<li><a href=\"https://github.com/grpc/grpc-go/issues/1345\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Add section on concurrency to documentation #1345</a></li>\n</ul>\n<p>上述的三个issues都可以仔细阅读下，提出的问题都非常有代表性。从一系列的问题中可以看出，官方对于gRPC的并发其实是有一些指导意见的，但并没有很好的文档化（至少之前如此）。而目前对这些问题已经有部分解答了，请继续阅读下去。</p>\n<h2 id=\"32-并发相关官方文档-id_concurrency_doc\" style=\"position:relative;\"><a href=\"#32-%E5%B9%B6%E5%8F%91%E7%9B%B8%E5%85%B3%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3-id_concurrency_doc\" aria-label=\"32 并发相关官方文档 id_concurrency_doc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 并发相关官方文档 {#ID_CONCURRENCY_DOC}</h2>\n<p>在<a href=\"https://github.com/grpc/grpc-go/pull/2034/files\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">这个提交</a>中，官方添加了对于并发相关的官方指引。正式的文档地址是在：<a href=\"https://github.com/grpc/grpc-go/blob/master/Documentation/concurrency.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">grpc-go/Documentation/concurrency.md</a>。</p>\n<p>这里做下简单翻译：</p>\n<h3 id=\"concurrency\" style=\"position:relative;\"><a href=\"#concurrency\" aria-label=\"concurrency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Concurrency</h3>\n<p>一般来说，gRPC-go提供了对并发友好的API。下文是一些指引。</p>\n<h4 id=\"clients\" style=\"position:relative;\"><a href=\"#clients\" aria-label=\"clients permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Clients</h4>\n<p>一个<a href=\"https://godoc.org/google.golang.org/grpc#ClientConn\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ClientConn</a>可以被安全地并发访问。以<a href=\"https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_client/main.go#L43\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">helloworld</a>作为范例，程序员可以在多个goroutine之间共享一个ClientConn来创建多个GreeterClient客户端类型。在这种使用情况下，RPCs会并行传输。</p>\n<h4 id=\"streams\" style=\"position:relative;\"><a href=\"#streams\" aria-label=\"streams permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Streams</h4>\n<p>当使用<a href=\"https://godoc.org/google.golang.org/grpc#Stream\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Stream</a>的时候，程序员必须小心避免从不同的goroutine向同一个stream发送多次<code class=\"language-text\">SendMsg</code>或<code class=\"language-text\">RecvMsg</code>请求。换句话来说，如果有一个goroutine向stream中发送SendMsg，然后在同一时间有另一个goroutine向stream中发送RecvMsg，这样做是安全的。但在不同的goroutine中同时向同一个stream发送SendMsg，或是RecvMsg则是不安全的。</p>\n<h4 id=\"servers\" style=\"position:relative;\"><a href=\"#servers\" aria-label=\"servers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Servers</h4>\n<p>每个被附到已注册服务器上的RPC处理器都会在其自身的goroutine中运作。举例来说，<a href=\"https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go#L41\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SayHello</a>会在其自身的goroutine中被调用到。同样的，streaming RPC也是一样，route guide例子可以在<a href=\"https://github.com/grpc/grpc-go/blob/master/examples/route_guide/server/server.go#L126\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">这里</a>看得到。</p>\n<h2 id=\"33-并发范例\" style=\"position:relative;\"><a href=\"#33-%E5%B9%B6%E5%8F%91%E8%8C%83%E4%BE%8B\" aria-label=\"33 并发范例 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 并发范例</h2>\n<p>我在实验项目中做了点并发的范例，可以看下：<a href=\"https://github.com/agreatfool/dist-system-practice/tree/master/golang/src/experiment/grpc/samples/concurrency\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dist-system-practice/golang/src/experiment/grpc/samples/concurrency/</a>。</p>\n<h3 id=\"331-代码差异\" style=\"position:relative;\"><a href=\"#331-%E4%BB%A3%E7%A0%81%E5%B7%AE%E5%BC%82\" aria-label=\"331 代码差异 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3.1 代码差异</h3>\n<p>服务端代码是一致的，根据<a href=\"#ID_CONCURRENCY_DOC\">3.2 并发相关官方文档</a>，服务端的所有请求都是自然并发的，无需代码特殊处理。但客户端则需要自行编码处理。</p>\n<p>顺序执行：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n    start <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">Echo</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pb<span class=\"token punctuation\">.</span>EchoRequest<span class=\"token punctuation\">{</span>Id<span class=\"token punctuation\">:</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[Client] singleConnSequence: err: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        end <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        elapsed <span class=\"token operator\">:=</span> end<span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">)</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[Client] singleConnSequence: response: %v, consumed: %v\"</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> elapsed<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>并发执行：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> waitgroup sync<span class=\"token punctuation\">.</span>WaitGroup\n\n<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span>\n    waitgroup<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>id <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        start <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">Echo</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pb<span class=\"token punctuation\">.</span>EchoRequest<span class=\"token punctuation\">{</span>Id<span class=\"token punctuation\">:</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[Client] singleConnConcurrency: err: %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            end <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            elapsed <span class=\"token operator\">:=</span> end<span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">)</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[Client] singleConnConcurrency: response: %v, consumed: %v\"</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> elapsed<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        waitgroup<span class=\"token punctuation\">.</span><span class=\"token function\">Done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\nwaitgroup<span class=\"token punctuation\">.</span><span class=\"token function\">Wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"332-顺序执行\" style=\"position:relative;\"><a href=\"#332-%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C\" aria-label=\"332 顺序执行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3.2 顺序执行</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 启动服务器\nDELAY_NO_5=true go run server.go\n\n# 启动客户端，发送请求\nMODE=CONN_ONE_SEQUENCE go run client.go</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 客户端输出\n2019/05/03 13:58:23 [Client] singleConnSequence: response: id:1 , consumed: 4.284231ms\n2019/05/03 13:58:23 [Client] singleConnSequence: response: id:2 , consumed: 381.818µs\n2019/05/03 13:58:23 [Client] singleConnSequence: response: id:3 , consumed: 361.608µs\n2019/05/03 13:58:23 [Client] singleConnSequence: response: id:4 , consumed: 332.662µs\n2019/05/03 13:58:24 [Client] singleConnSequence: response: id:5 , consumed: 1.004485058s\n2019/05/03 13:58:24 [Client] singleConnSequence: response: id:6 , consumed: 470.532µs\n2019/05/03 13:58:24 [Client] singleConnSequence: response: id:7 , consumed: 468.148µs\n2019/05/03 13:58:24 [Client] singleConnSequence: response: id:8 , consumed: 389.214µs\n2019/05/03 13:58:24 [Client] singleConnSequence: response: id:9 , consumed: 418.01µs\n2019/05/03 13:58:25 [Client] singleConnSequence: response: id:10 , consumed: 1.003602442s\n\n# 服务器输出\n2019/05/03 13:58:23 [Server] Echo: request: id:1\n2019/05/03 13:58:23 [Server] Echo: response: id:1\n2019/05/03 13:58:23 [Server] Echo: request: id:2\n2019/05/03 13:58:23 [Server] Echo: response: id:2\n2019/05/03 13:58:23 [Server] Echo: request: id:3\n2019/05/03 13:58:23 [Server] Echo: response: id:3\n2019/05/03 13:58:23 [Server] Echo: request: id:4\n2019/05/03 13:58:23 [Server] Echo: response: id:4\n2019/05/03 13:58:23 [Server] Echo: request: id:5\n2019/05/03 13:58:24 [Server] Echo: response: id:5\n2019/05/03 13:58:24 [Server] Echo: request: id:6\n2019/05/03 13:58:24 [Server] Echo: response: id:6\n2019/05/03 13:58:24 [Server] Echo: request: id:7\n2019/05/03 13:58:24 [Server] Echo: response: id:7\n2019/05/03 13:58:24 [Server] Echo: request: id:8\n2019/05/03 13:58:24 [Server] Echo: response: id:8\n2019/05/03 13:58:24 [Server] Echo: request: id:9\n2019/05/03 13:58:24 [Server] Echo: response: id:9\n2019/05/03 13:58:24 [Server] Echo: request: id:10\n2019/05/03 13:58:25 [Server] Echo: response: id:10</code></pre></div>\n<h3 id=\"333-并发执行\" style=\"position:relative;\"><a href=\"#333-%E5%B9%B6%E5%8F%91%E6%89%A7%E8%A1%8C\" aria-label=\"333 并发执行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3.3 并发执行</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 启动服务器\nDELAY_NO_5=true go run server.go\n\n# 启动客户端，发送请求\nMODE=CONN_ONE_CONCURRENCY go run client.go</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 客户端输出\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:9 , consumed: 5.651184ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:6 , consumed: 5.595945ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:2 , consumed: 5.693124ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:4 , consumed: 5.637734ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:1 , consumed: 5.592096ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:3 , consumed: 5.58596ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:7 , consumed: 5.652258ms\n2019/05/03 13:54:41 [Client] singleConnConcurrency: response: id:8 , consumed: 5.658945ms\n2019/05/03 13:54:42 [Client] singleConnConcurrency: response: id:10 , consumed: 1.008472004s\n2019/05/03 13:54:42 [Client] singleConnConcurrency: response: id:5 , consumed: 1.008440948s\n\n# 服务器输出\n2019/05/03 13:54:41 [Server] Echo: request: id:3\n2019/05/03 13:54:41 [Server] Echo: response: id:3\n2019/05/03 13:54:41 [Server] Echo: request: id:1\n2019/05/03 13:54:41 [Server] Echo: response: id:1\n2019/05/03 13:54:41 [Server] Echo: request: id:6\n2019/05/03 13:54:41 [Server] Echo: response: id:6\n2019/05/03 13:54:41 [Server] Echo: request: id:10\n2019/05/03 13:54:41 [Server] Echo: request: id:8\n2019/05/03 13:54:41 [Server] Echo: response: id:8\n2019/05/03 13:54:41 [Server] Echo: request: id:9\n2019/05/03 13:54:41 [Server] Echo: response: id:9\n2019/05/03 13:54:41 [Server] Echo: request: id:5\n2019/05/03 13:54:41 [Server] Echo: request: id:2\n2019/05/03 13:54:41 [Server] Echo: response: id:2\n2019/05/03 13:54:41 [Server] Echo: request: id:4\n2019/05/03 13:54:41 [Server] Echo: response: id:4\n2019/05/03 13:54:41 [Server] Echo: request: id:7\n2019/05/03 13:54:41 [Server] Echo: response: id:7\n2019/05/03 13:54:42 [Server] Echo: response: id:10\n2019/05/03 13:54:42 [Server] Echo: response: id:5</code></pre></div>\n<p>服务端对ID逢5的请求sleep 1秒进行反馈，因此并发的客户端请求中，5和10就是最后返回打印出来的，耗时也是1秒多。</p>\n<h2 id=\"34-连接池\" style=\"position:relative;\"><a href=\"#34-%E8%BF%9E%E6%8E%A5%E6%B1%A0\" aria-label=\"34 连接池 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4 连接池</h2>\n<p>虽然单连接也是可以进行并发编程的，但在某些极端情况下，数据包可能达到网络吞吐的极限。众所周知Go语言天生对并发编程友好，因此CPU的利用必然是非常充分的，如果RPC服务的类型是低CPU消耗而高网络消耗的情况就有可能出现之前提到的问题。这种情况就需要创建多个连接了。</p>\n<p>在多连接管理方面，官方的类库并没有连接池的功能，第三方倒是有：<a href=\"https://github.com/processout/grpc-go-pool/blob/master/pool_test.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">grpc-go-pool/pool_test.go</a>。</p>\n<p>此外，可以拓展阅读：<a href=\"https://mycodesmells.com/post/pooling-grpc-connections\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pooling gRPC Connections</a>。</p>\n<p>范例可以看：<a href=\"https://github.com/agreatfool/dist-system-practice/tree/master/golang/src/experiment/grpc/samples/pool\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dist-system-practice/golang/src/experiment/grpc/samples/pool/</a>。</p>\n<h2 id=\"35-benchmark\" style=\"position:relative;\"><a href=\"#35-benchmark\" aria-label=\"35 benchmark permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5 Benchmark</h2>\n<p>范例代码在：<a href=\"https://github.com/agreatfool/dist-system-practice/tree/master/golang/src/experiment/grpc/samples/throughput\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dist-system-practice/golang/src/experiment/grpc/samples/throughput/</a>。</p>\n<h3 id=\"测试硬件\" style=\"position:relative;\"><a href=\"#%E6%B5%8B%E8%AF%95%E7%A1%AC%E4%BB%B6\" aria-label=\"测试硬件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>测试硬件</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">rMBP 2014 mid\nCPU：2.5GHz 四核 Intel Core i7 处理器 (Turbo Boost 3.7GHz)</code></pre></div>\n<p>测试的时候一些在系统使用中的软件我并没有清空，因此可能有稍许干扰，但总体问题不大。</p>\n<h3 id=\"客户端及服务器启动命令\" style=\"position:relative;\"><a href=\"#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%8A%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4\" aria-label=\"客户端及服务器启动命令 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>客户端及服务器启动命令</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">CORE_NUM=3 go run server.go\nCORE_NUM=4 ROUTINES_PER_CORE=50 go run client.go</code></pre></div>\n<p>使用<code class=\"language-text\">CORE_NUM</code>来控制使用到的物理核心数量，客户端使用<code class=\"language-text\">ROUTINES_PER_CORE</code>来决定启动的routine总量：<code class=\"language-text\">CORE_NUM * ROUTINES_PER_CORE</code>。</p>\n<h3 id=\"测试结果\" style=\"position:relative;\"><a href=\"#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C\" aria-label=\"测试结果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>测试结果</h3>\n<p>请求数量/s：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2019/05/04 14:19:33 [Client] 73065 requests in 1s\n2019/05/04 14:19:34 [Client] 68826 requests in 1s\n2019/05/04 14:19:35 [Client] 73655 requests in 1s\n2019/05/04 14:19:36 [Client] 70973 requests in 1s\n2019/05/04 14:19:37 [Client] 73645 requests in 1s\n2019/05/04 14:19:38 [Client] 70616 requests in 1s\n2019/05/04 14:19:39 [Client] 72252 requests in 1s\n2019/05/04 14:19:40 [Client] 69342 requests in 1s\n2019/05/04 14:19:41 [Client] 69745 requests in 1s\n2019/05/04 14:19:42 [Client] 62251 requests in 1s\n2019/05/04 14:19:43 [Client] 58043 requests in 1s\n2019/05/04 14:19:44 [Client] 69316 requests in 1s\n2019/05/04 14:19:45 [Client] 69796 requests in 1s\n2019/05/04 14:19:46 [Client] 57246 requests in 1s\n2019/05/04 14:19:47 [Client] 72265 requests in 1s\n2019/05/04 14:19:48 [Client] 72940 requests in 1s\n2019/05/04 14:19:49 [Client] 70237 requests in 1s</code></pre></div>\n<p>CPU：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 847px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b36bf5dd1f9a38efa7a1c9654364aa74/696ad/cpu.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.416666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAcygkgv/xAAWEAEBAQAAAAAAAAAAAAAAAAAAIUH/2gAIAQEAAQUC2q//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAAEGH/2gAIAQEABj8CIv/EABkQAAIDAQAAAAAAAAAAAAAAAAABESExcf/aAAgBAQABPyGW9F5sdH//2gAMAwEAAgADAAAAEIwv/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/EFyf/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8QCf/EABkQAQADAQEAAAAAAAAAAAAAAAEAEVExof/aAAgBAQABPxBGRO2y2slGxB31P//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b36bf5dd1f9a38efa7a1c9654364aa74/8ac56/cpu.webp 240w,\n/static/b36bf5dd1f9a38efa7a1c9654364aa74/d3be9/cpu.webp 480w,\n/static/b36bf5dd1f9a38efa7a1c9654364aa74/8a8c4/cpu.webp 847w\"\n              sizes=\"(max-width: 847px) 100vw, 847px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b36bf5dd1f9a38efa7a1c9654364aa74/09b79/cpu.jpg 240w,\n/static/b36bf5dd1f9a38efa7a1c9654364aa74/7cc5e/cpu.jpg 480w,\n/static/b36bf5dd1f9a38efa7a1c9654364aa74/696ad/cpu.jpg 847w\"\n            sizes=\"(max-width: 847px) 100vw, 847px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b36bf5dd1f9a38efa7a1c9654364aa74/696ad/cpu.jpg\"\n            alt=\"cpu\"\n            title=\"cpu\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Network：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 809px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/215174302d5ed311a479d9be59720326/da104/network-low.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.750000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAc2wIA//xAAXEAADAQAAAAAAAAAAAAAAAAAAAREx/9oACAEBAAEFAltIf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAAMAAAAAAAAAAAAAAAAAAAAQMf/aAAgBAQAGPwIq/8QAGBABAQEBAQAAAAAAAAAAAAAAAQAhUWH/2gAIAQEAAT8h1pY9JHW//9oADAMBAAIAAwAAABCL7//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/ECf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAEAAwEBAAAAAAAAAAAAAAABABEhUWH/2gAIAQEAAT8QTYjH2JxHKgFCf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/215174302d5ed311a479d9be59720326/8ac56/network-low.webp 240w,\n/static/215174302d5ed311a479d9be59720326/d3be9/network-low.webp 480w,\n/static/215174302d5ed311a479d9be59720326/f996b/network-low.webp 809w\"\n              sizes=\"(max-width: 809px) 100vw, 809px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/215174302d5ed311a479d9be59720326/09b79/network-low.jpg 240w,\n/static/215174302d5ed311a479d9be59720326/7cc5e/network-low.jpg 480w,\n/static/215174302d5ed311a479d9be59720326/da104/network-low.jpg 809w\"\n            sizes=\"(max-width: 809px) 100vw, 809px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/215174302d5ed311a479d9be59720326/da104/network-low.jpg\"\n            alt=\"network low\"\n            title=\"network low\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 832px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/43de6b91684c632a84e76e82c4d88f72/c2601/network-high.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.083333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABzqBMH//EABYQAQEBAAAAAAAAAAAAAAAAAAEAIf/aAAgBAQABBQI1JL//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwEn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERMVH/2gAIAQEAAT8hpNZXWQes/9oADAMBAAIAAwAAABAH7//EABYRAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPxAKv//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQEBAAMBAAAAAAAAAAAAAAERACFRYZH/2gAIAQEAAT8QVIa96gEh4S4pn093/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/43de6b91684c632a84e76e82c4d88f72/8ac56/network-high.webp 240w,\n/static/43de6b91684c632a84e76e82c4d88f72/d3be9/network-high.webp 480w,\n/static/43de6b91684c632a84e76e82c4d88f72/de44a/network-high.webp 832w\"\n              sizes=\"(max-width: 832px) 100vw, 832px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/43de6b91684c632a84e76e82c4d88f72/09b79/network-high.jpg 240w,\n/static/43de6b91684c632a84e76e82c4d88f72/7cc5e/network-high.jpg 480w,\n/static/43de6b91684c632a84e76e82c4d88f72/c2601/network-high.jpg 832w\"\n            sizes=\"(max-width: 832px) 100vw, 832px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/43de6b91684c632a84e76e82c4d88f72/c2601/network-high.jpg\"\n            alt=\"network high\"\n            title=\"network high\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"结论\" style=\"position:relative;\"><a href=\"#%E7%BB%93%E8%AE%BA\" aria-label=\"结论 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结论</h3>\n<p>因硬件环境的限制，没有使用通过网卡的测试方案，而是使用了127.0.0.1的环回请求方案。此外，测试期间MAC上的一些软件进程也并没有进行清理，因此可能有部分干扰。结论就不做了，这样简单且限制资源的benchmark实际意义不大，列几点可以观测到的状态：</p>\n<ul>\n<li><code class=\"language-text\">请求数量/s</code>符合预期</li>\n<li>CPU占用基本满</li>\n<li>提升核心使用数量，提升routine数量，能观察到rps提升</li>\n</ul>\n<h1 id=\"4-负载均衡\" style=\"position:relative;\"><a href=\"#4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1\" aria-label=\"4 负载均衡 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 负载均衡</h1>\n<p>官方有一篇关于负载均衡设计的文档，可以读下：<a href=\"https://github.com/grpc/grpc/blob/master/doc/load-balancing.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Load Balancing in gRPC</a>。</p>\n<p>意义不大，可以了解一些简单的负载均衡概念，以及一些设计上的思路。</p>\n<h1 id=\"5-状态检查\" style=\"position:relative;\"><a href=\"#5-%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5\" aria-label=\"5 状态检查 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 状态检查</h1>\n<p>官方对于如何设计及暴露服务端状态检查接口的一份文档：<a href=\"https://github.com/grpc/grpc/blob/master/doc/health-checking.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GRPC Health Checking Protocol</a>。可以说是一份guideline。同样意义不大。</p>\n<h1 id=\"6-interceptor\" style=\"position:relative;\"><a href=\"#6-interceptor\" aria-label=\"6 interceptor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. Interceptor</h1>\n<p>所谓的interceptor，写过gin或者koa的可以直接理解为gRPC里的<code class=\"language-text\">middleware</code>。官方文档：<a href=\"https://github.com/grpc/grpc-go/tree/master/examples/features/interceptor\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Interceptor</a>。</p>\n<p>虽然gRPC本身的rpc调用分为多种不同的可能：</p>\n<ul>\n<li>请求响应皆为unary</li>\n<li>请求unary响应stream</li>\n<li>请求stream响应unary</li>\n<li>请求响应皆为stream</li>\n</ul>\n<p>但interceptor的签名则只有<code class=\"language-text\">unary</code>和<code class=\"language-text\">stream</code>这两种。</p>\n<p>范例代码可以查看官方的：</p>\n<ul>\n<li><a href=\"https://github.com/grpc/grpc-go/blob/master/examples/features/interceptor/client/main.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">client/main.go</a></li>\n<li><a href=\"https://github.com/grpc/grpc-go/blob/master/examples/features/interceptor/server/main.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">server/main.go</a></li>\n</ul>\n<p>在使用中可能会遇到多个Interceptor同时存在的情况，在编码的时候就需要使用工具对其进行组合：<a href=\"https://github.com/grpc-ecosystem/go-grpc-middleware/blob/master/chain.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">go-grpc-middleware/chain.go</a>：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">s <span class=\"token operator\">:=</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">NewServer</span><span class=\"token punctuation\">(</span>\n\tgrpc_middleware<span class=\"token punctuation\">.</span><span class=\"token function\">WithUnaryServerChain</span><span class=\"token punctuation\">(</span>\n\t\tgrpc_opentracing<span class=\"token punctuation\">.</span><span class=\"token function\">UnaryServerInterceptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\tgrpc_prometheus<span class=\"token punctuation\">.</span>UnaryServerInterceptor<span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\tgrpc<span class=\"token punctuation\">.</span><span class=\"token function\">StreamInterceptor</span><span class=\"token punctuation\">(</span>grpc_prometheus<span class=\"token punctuation\">.</span>StreamServerInterceptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h1 id=\"7-debug\" style=\"position:relative;\"><a href=\"#7-debug\" aria-label=\"7 debug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. Debug</h1>\n<p>官方的指引：<a href=\"https://github.com/grpc/grpc-go/tree/master/examples/features/debugging\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Debugging</a>，包括了一份范例代码：</p>\n<ul>\n<li><a href=\"https://github.com/grpc/grpc-go/blob/master/examples/features/debugging/client/main.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">client/main.go</a></li>\n<li><a href=\"https://github.com/grpc/grpc-go/blob/master/examples/features/debugging/server/main.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">server/main.go</a></li>\n</ul>\n<p>也可以使用go的trace包，做简单的观察：<a href=\"https://segmentfault.com/a/1190000008087436\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Golang gRPC实践 连载六 内置Trace</a>。</p>\n<p>几个环境变量可以大量输出程序执行的细节：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GODEBUG=http2debug=1 \\\nGODEBUG=http2debug=2 \\\nGRPC_GO_LOG_VERBOSITY_LEVEL=99 \\\nGRPC_GO_LOG_SEVERITY_LEVEL=info \\\nyourapp</code></pre></div>\n<h1 id=\"8-监控\" style=\"position:relative;\"><a href=\"#8-%E7%9B%91%E6%8E%A7\" aria-label=\"8 监控 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>8. 监控</h1>\n<p>Grpc go自身也有监控用的Interceptor：<a href=\"https://github.com/grpc-ecosystem/go-grpc-prometheus\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">grpc-ecosystem/go-grpc-prometheus</a>，和HTTP服务器无关，主要是grpc自身的指标。</p>\n<p>范例代码可以参见README中的说明，服务端和客户端代码都有提供。</p>\n<h1 id=\"资料\" style=\"position:relative;\"><a href=\"#%E8%B5%84%E6%96%99\" aria-label=\"资料 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>资料</h1>\n<h2 id=\"链接\" style=\"position:relative;\"><a href=\"#%E9%93%BE%E6%8E%A5\" aria-label=\"链接 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>链接</h2>\n<ul>\n<li><a href=\"https://github.com/processout/grpc-go-pool/blob/master/pool_test.go\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">grpc-go-pool/pool_test.go</a></li>\n<li><a href=\"https://mycodesmells.com/post/pooling-grpc-connections\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pooling gRPC Connections</a></li>\n</ul>\n<blockquote>\n<p>EOF</p>\n</blockquote>","fields":{"slug":"/posts/2019/05/grpc-note","tagSlugs":["/tag/g-rpc/","/tag/golang/","/tag/protobuf/","/tag/concurrency/","/tag/benchmark/","/tag/keynote/"]},"frontmatter":{"date":"2019-05-06T02:01:22.000Z","description":"","tags":["gRPC","Golang","Protobuf","Concurrency","Benchmark","Keynote"],"title":"gRPC Notes","socialImage":{"publicURL":"/static/7e722e026a41a08a8f9a1cc76782dd27/default-social-image.jpg"}}},"allFile":{"totalCount":0,"nodes":[]}},"pageContext":{"slug":"/posts/2019/05/grpc-note","gallery":"media/posts/2019/05/grpc-note/gallery"}},"staticQueryHashes":["251939775","401334301","825871152"]}