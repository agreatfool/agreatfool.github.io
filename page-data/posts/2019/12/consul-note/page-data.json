{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2019/12/consul-note","result":{"data":{"markdownRemark":{"id":"5b29ca02-105b-56aa-9f5a-aab77fc3266b","html":"<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>Consul一般用来作为服务注册和服务发现软件。<a href=\"https://www.consul.io/intro/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">官方介绍</a>如下：</p>\n<blockquote>\n<p>Consul is a service mesh solution providing a full featured control plane with service discovery, configuration, and segmentation functionality. Each of these features can be used individually as needed, or they can be used together to build a full service mesh. Consul requires a data plane and supports both a proxy and native integration model. Consul ships with a simple built-in proxy so that everything works out of the box, but also supports 3rd party proxy integrations such as Envoy.</p>\n</blockquote>\n<p>文档资料：</p>\n<ul>\n<li><a href=\"https://www.consul.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">consul.io</a></li>\n<li><a href=\"https://www.consul.io/docs/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Consul Documentation</a></li>\n<li><a href=\"https://www.consul.io/docs/internals/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Consul Internals</a></li>\n<li><a href=\"https://www.consul.io/api/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API Introduction</a></li>\n</ul>\n<h1 id=\"2-选型\" style=\"position:relative;\"><a href=\"#2-%E9%80%89%E5%9E%8B\" aria-label=\"2 选型 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 选型</h1>\n<p>市面上常用的开源服务发现软件主要有：<a href=\"https://github.com/hashicorp/consul\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">consul</a>、<a href=\"https://github.com/etcd-io/etcd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">etcd</a>、<a href=\"https://github.com/apache/zookeeper\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">zookeeper</a>。前两者都是用golang研发的，而zookeeper则是java研发的（你懂我意思吧）。</p>\n<p>这里就有选型的问题了，不过了解下来相互之间的差异不能说很大，基本上都在可接受范围内。特别是consul和etcd都使用raft作为分布式一致性协议，可以说非常趋同了。etcd关注度更高（特别是K8S官方使用了它），功能简单，主要在大型系统中作为分布式K/V存储使用；而consul的功能更强大（完整、开箱即用）且易用性更高。</p>\n<p>相关资料：</p>\n<ul>\n<li><a href=\"https://www.consul.io/intro/vs/zookeeper.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Consul vs. ZooKeeper, doozerd, etcd</a>：这篇是consul官方的，不过我觉得讲得其实不多，没什么价值</li>\n<li><a href=\"https://gist.github.com/yurishkuro/10cb2dc42f42a007a8ce0e055ed0d171\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">etcd vs consul vs ???</a>：文章的作者居然是Jaeger的作者，看完我才刚发现；写得很好，基本上主要的点都比对出来了，价值极高</li>\n<li><a href=\"https://www.servercoder.com/2018/03/30/consul-vs-zookeeper-etcd/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">服务发现框架选型，Consul还是Zookeeper还是etcd</a>：中文，带表格比对，简单易理解</li>\n<li><a href=\"https://matthewpalmer.net/kubernetes-app-developer/articles/how-does-kubernetes-use-etcd.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How Does Kubernetes Use etcd?</a>：主要说明了K8S为什么以及如何使用etcd，主要还是作为存储系统</li>\n</ul>\n<h1 id=\"3-架构\" style=\"position:relative;\"><a href=\"#3-%E6%9E%B6%E6%9E%84\" aria-label=\"3 架构 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 架构</h1>\n<p>官方的架构介绍在：<a href=\"https://www.consul.io/docs/internals/architecture.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Consul Architecture</a>。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/70263786e0b197a268324b81028ca38e/f9b5f/consul-arch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD10lEQVQ4y5VUS28bVRSeP1JRFQWygGAQDa3SpBCgalERoELEo61YhEWVKgSkRGkrHoJNFaWoUhbIEgSqhiZACIoKgkUIsqndpo6f45nEiZ9jxvZ4xmPP+3lnODMugYoVn+7C99zzHZ/7ne8OFgwGJyYmrnw2q2ma67oI2QCEkOs6rg/HcWwfexE/zQMWiURWln/8afWXOs3yrKBpOkRN0+Q5kWXasDptya9nCx2ZZTqw4EhVVVmWMSgTWy9fOrP80ej3F88u5bdoplnjWP7K5M/Tpxcn3/jmy8vrfJvjWs3rV8OTry9cOLt4+d1VTTF1Q/fIayuZ0eeC06dvvHdqgUgWK9USVfnz03Mr4698PXZy/urFm2yLqTfozz/59fyLX73/2vWPR5dV2TCAbNuW2NGKO61MvJyKFQzD7t6TrnQK21wxx9WqAl2jFUXmWXWHqKc3S1s45TiupqkYXM9TApmQ1WZqqqKQJMk2WRDFMTXHNly9zXNNHM+apmYoYrtBCxwD5VVNw0BW7sa3qcCh7DPHc08fpyLR0MYdMpXKv/l2+tDRTP/Q7vgoyzcbnU5h+oP0k0fwgWd3X33LFiXNMDxyI/jF5gMPZ48eS/Y8ym7EqhzbqtXI4ROpwFPJ3sdyZ96hWJZimPy58WRvIHNwEB8YtjuCZpqYCYOp1YXfw+KtqBy906k3GI51EBLvxsVwRPkjqhIkqCBIkoATYuiWEI7Isbhj2V7bmqrqlmW4ruG4cHtZVUmCLJZKQBB1jRUEw7ZomqYoSke2l+ZlOuAoGDWGHM9UyLq3un6Cs9/W1oYGBx88cIAkCLtrqH+lwQ4yMfd+QKj7IxAIYD6mpqZga1mW+x9gUAMOfOv+A5jf0tLS7OzszMxMKBSC7V7R+8hzc3MjIyPnx8Ya9TrswbG5XI5l2b0uoC50Xi6X7/UO/2RZyH88WLVaparVGt/SbE8PiqYr5YoOl7YtxUGKL5Km61kcjyUSgq7bvmYwZFEUMcOyHEU14kkhcptZW9eZ5lZuu1Aq6cUSDE+K3pViYaTx0AJfLBZXbyobMen2BpIVzyRQRk6mNvf1ZAaGE/t7qflryS2SKBTyYxOJnkdSjx/OHhmi8GSJ4+j5a4l9D0FafH+vnEwD0SMreDbV10++8HKq7yDz3Q9gpka7XbnwYfqJw/jQ89snT9V2dvONOr2wmO7rJ068BM5TcMIjg1Hgu+DIChIlJMnu37I7hoEkCYmi431hfKlBJEn2IooCFM9hIC+oAybrLriJ6kOH99oNwmvy/QSydSOqYSiqKkkSBvNA/xNQC8gw/L8Ax9Eq/p1ARbwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/70263786e0b197a268324b81028ca38e/8ac56/consul-arch.webp 240w,\n/static/70263786e0b197a268324b81028ca38e/d3be9/consul-arch.webp 480w,\n/static/70263786e0b197a268324b81028ca38e/e46b2/consul-arch.webp 960w,\n/static/70263786e0b197a268324b81028ca38e/f992d/consul-arch.webp 1440w,\n/static/70263786e0b197a268324b81028ca38e/882b9/consul-arch.webp 1920w,\n/static/70263786e0b197a268324b81028ca38e/3f455/consul-arch.webp 2315w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/70263786e0b197a268324b81028ca38e/8ff5a/consul-arch.png 240w,\n/static/70263786e0b197a268324b81028ca38e/e85cb/consul-arch.png 480w,\n/static/70263786e0b197a268324b81028ca38e/d9199/consul-arch.png 960w,\n/static/70263786e0b197a268324b81028ca38e/07a9c/consul-arch.png 1440w,\n/static/70263786e0b197a268324b81028ca38e/29114/consul-arch.png 1920w,\n/static/70263786e0b197a268324b81028ca38e/f9b5f/consul-arch.png 2315w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/70263786e0b197a268324b81028ca38e/d9199/consul-arch.png\"\n            alt=\"consul arch\"\n            title=\"consul arch\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>简单来说：</p>\n<ul>\n<li>节点分为<code class=\"language-text\">client</code>和<code class=\"language-text\">server</code></li>\n<li>server负责存储数据，并形成集群，使用raft保证集群一致性</li>\n<li>client负责直接和业务对象连接，并将数据同步到server上</li>\n<li>所有的节点都是通过gossip连接起来的</li>\n</ul>\n<h1 id=\"4-使用\" style=\"position:relative;\"><a href=\"#4-%E4%BD%BF%E7%94%A8\" aria-label=\"4 使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 使用</h1>\n<h2 id=\"41-启动\" style=\"position:relative;\"><a href=\"#41-%E5%90%AF%E5%8A%A8\" aria-label=\"41 启动 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 启动</h2>\n<p>一般直接使用docker镜像：<a href=\"https://hub.docker.com/_/consul\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">consul</a>。</p>\n<p>启动方面非常简单，全部都是用<code class=\"language-text\">agent</code>命令，参数细节放在后面的附录部分，太长了：<a href=\"#ID_APP_AGENT_HELP\">consul agent —help</a>。</p>\n<p>常用参数：</p>\n<ul>\n<li><code class=\"language-text\">--node=$name</code>指定节点名称</li>\n<li><code class=\"language-text\">--server</code>表示节点是server节点</li>\n<li><code class=\"language-text\">--bootstrap</code>表示节点以bootstrap模式启动</li>\n<li><code class=\"language-text\">--ui</code>表示当前节点会提供管理UI界面</li>\n<li><code class=\"language-text\">--client=0.0.0.0</code>指定监听地址</li>\n<li><code class=\"language-text\">--join=$host</code>指定启动时尝试加入集群时连接的目标节点</li>\n</ul>\n<p>下面给个例子，集群3个server节点，2个client节点：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">fullstack_consul_server1</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> consul<span class=\"token punctuation\">:</span>1.6.1\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> fullstack_consul_server1\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> fullstack_consul_server1\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 18500<span class=\"token punctuation\">:</span><span class=\"token number\">8500</span>\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8600</span> <span class=\"token comment\"># DNS</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8500</span> <span class=\"token comment\"># HTTP API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8501</span> <span class=\"token comment\"># HTTPS API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8502</span> <span class=\"token comment\"># gRPC API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8301</span> <span class=\"token comment\"># LAN Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8302</span> <span class=\"token comment\"># Wan Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8300</span> <span class=\"token comment\"># Server RPC address</span>\n    <span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> json<span class=\"token punctuation\">-</span>file\n      <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-size</span><span class=\"token punctuation\">:</span> 512m\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> wget http<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>8500/v1/health/node/consul<span class=\"token punctuation\">-</span>server1 <span class=\"token punctuation\">-</span>q <span class=\"token punctuation\">-</span>O <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">></span> /dev/null 2<span class=\"token punctuation\">></span><span class=\"token important\">&amp;1</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 20s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> consul_server1_data<span class=\"token punctuation\">:</span>/consul/data\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> CONSUL_BIND_INTERFACE=eth0\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      agent<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>node=consul<span class=\"token punctuation\">-</span>server1<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>bootstrap<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>client=0.0.0.0<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>ui\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">fullstack_consul_server2</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> consul<span class=\"token punctuation\">:</span>1.6.1\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> fullstack_consul_server2\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> fullstack_consul_server2\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8600</span> <span class=\"token comment\"># DNS</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8500</span> <span class=\"token comment\"># HTTP API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8501</span> <span class=\"token comment\"># HTTPS API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8502</span> <span class=\"token comment\"># gRPC API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8301</span> <span class=\"token comment\"># LAN Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8302</span> <span class=\"token comment\"># Wan Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8300</span> <span class=\"token comment\"># Server RPC address</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">fullstack_consul_server1</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n    <span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> json<span class=\"token punctuation\">-</span>file\n      <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-size</span><span class=\"token punctuation\">:</span> 512m\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> wget http<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>8500/v1/health/node/consul<span class=\"token punctuation\">-</span>server2 <span class=\"token punctuation\">-</span>q <span class=\"token punctuation\">-</span>O <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">></span> /dev/null 2<span class=\"token punctuation\">></span><span class=\"token important\">&amp;1</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 20s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> consul_server2_data<span class=\"token punctuation\">:</span>/consul/data\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> CONSUL_BIND_INTERFACE=eth0\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      agent<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>node=consul<span class=\"token punctuation\">-</span>server2<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>client=0.0.0.0<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>join=fullstack_consul_server1\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">fullstack_consul_server3</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> consul<span class=\"token punctuation\">:</span>1.6.1\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> fullstack_consul_server3\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> fullstack_consul_server3\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8600</span> <span class=\"token comment\"># DNS</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8500</span> <span class=\"token comment\"># HTTP API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8501</span> <span class=\"token comment\"># HTTPS API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8502</span> <span class=\"token comment\"># gRPC API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8301</span> <span class=\"token comment\"># LAN Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8302</span> <span class=\"token comment\"># Wan Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8300</span> <span class=\"token comment\"># Server RPC address</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">fullstack_consul_server1</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n    <span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> json<span class=\"token punctuation\">-</span>file\n      <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-size</span><span class=\"token punctuation\">:</span> 512m\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> wget http<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>8500/v1/health/node/consul<span class=\"token punctuation\">-</span>server3 <span class=\"token punctuation\">-</span>q <span class=\"token punctuation\">-</span>O <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">></span> /dev/null 2<span class=\"token punctuation\">></span><span class=\"token important\">&amp;1</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 20s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> consul_server3_data<span class=\"token punctuation\">:</span>/consul/data\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> CONSUL_BIND_INTERFACE=eth0\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      agent<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>node=consul<span class=\"token punctuation\">-</span>server3<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>client=0.0.0.0<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>join=fullstack_consul_server1\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">fullstack_consul_client1</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> consul<span class=\"token punctuation\">:</span>1.6.1\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> fullstack_consul_client1\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> fullstack_consul_client1\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8600</span> <span class=\"token comment\"># DNS</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8500</span> <span class=\"token comment\"># HTTP API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8501</span> <span class=\"token comment\"># HTTPS API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8502</span> <span class=\"token comment\"># gRPC API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8301</span> <span class=\"token comment\"># LAN Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8302</span> <span class=\"token comment\"># Wan Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8300</span> <span class=\"token comment\"># Server RPC address</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">fullstack_consul_server1</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n      <span class=\"token key atrule\">fullstack_consul_server2</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n      <span class=\"token key atrule\">fullstack_consul_server3</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n    <span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> json<span class=\"token punctuation\">-</span>file\n      <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-size</span><span class=\"token punctuation\">:</span> 512m\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> wget http<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>8500/v1/health/node/consul<span class=\"token punctuation\">-</span>client <span class=\"token punctuation\">-</span>q <span class=\"token punctuation\">-</span>O <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">></span> /dev/null 2<span class=\"token punctuation\">></span><span class=\"token important\">&amp;1</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 20s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> consul_client1_data<span class=\"token punctuation\">:</span>/consul/data\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> CONSUL_BIND_INTERFACE=eth0\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      agent<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>node=consul<span class=\"token punctuation\">-</span>client1<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>client=0.0.0.0<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>join=fullstack_consul_server1\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">fullstack_consul_client2</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> consul<span class=\"token punctuation\">:</span>1.6.1\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> fullstack_consul_client2\n    <span class=\"token key atrule\">hostname</span><span class=\"token punctuation\">:</span> fullstack_consul_client2\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8600</span> <span class=\"token comment\"># DNS</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8500</span> <span class=\"token comment\"># HTTP API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8501</span> <span class=\"token comment\"># HTTPS API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8502</span> <span class=\"token comment\"># gRPC API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8301</span> <span class=\"token comment\"># LAN Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8302</span> <span class=\"token comment\"># Wan Serf</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8300</span> <span class=\"token comment\"># Server RPC address</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">fullstack_consul_server1</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n      <span class=\"token key atrule\">fullstack_consul_server2</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n      <span class=\"token key atrule\">fullstack_consul_server3</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> service_healthy\n    <span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> json<span class=\"token punctuation\">-</span>file\n      <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">max-size</span><span class=\"token punctuation\">:</span> 512m\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> wget http<span class=\"token punctuation\">:</span>//127.0.0.1<span class=\"token punctuation\">:</span>8500/v1/health/node/consul<span class=\"token punctuation\">-</span>client <span class=\"token punctuation\">-</span>q <span class=\"token punctuation\">-</span>O <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">></span> /dev/null 2<span class=\"token punctuation\">></span><span class=\"token important\">&amp;1</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 20s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> consul_client2_data<span class=\"token punctuation\">:</span>/consul/data\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> CONSUL_BIND_INTERFACE=eth0\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      agent<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>node=consul<span class=\"token punctuation\">-</span>client2<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>client=0.0.0.0<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>join=fullstack_consul_server1\n    <span class=\"token punctuation\">]</span></code></pre></div>\n<p>部署完成后节点如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b242cf42105e5f6fffb8ed6afb079942/92bb4/nodes.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAZ0lEQVQI15WOwQ7DMAhD8//fW0LAQGaaradeZr1I2AHEmHOtZUq0MYcjHoB8tWjFuGQiGMGIOYcj8tAh38+yast/1hE9bGZ776pCQlV5xrFZuWzJJVlfsUFE3HEsFw6uylsene5/9AEYaOwEX+VdzgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b242cf42105e5f6fffb8ed6afb079942/8ac56/nodes.webp 240w,\n/static/b242cf42105e5f6fffb8ed6afb079942/d3be9/nodes.webp 480w,\n/static/b242cf42105e5f6fffb8ed6afb079942/e46b2/nodes.webp 960w,\n/static/b242cf42105e5f6fffb8ed6afb079942/f992d/nodes.webp 1440w,\n/static/b242cf42105e5f6fffb8ed6afb079942/a6abc/nodes.webp 1824w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b242cf42105e5f6fffb8ed6afb079942/8ff5a/nodes.png 240w,\n/static/b242cf42105e5f6fffb8ed6afb079942/e85cb/nodes.png 480w,\n/static/b242cf42105e5f6fffb8ed6afb079942/d9199/nodes.png 960w,\n/static/b242cf42105e5f6fffb8ed6afb079942/07a9c/nodes.png 1440w,\n/static/b242cf42105e5f6fffb8ed6afb079942/92bb4/nodes.png 1824w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b242cf42105e5f6fffb8ed6afb079942/d9199/nodes.png\"\n            alt=\"nodes\"\n            title=\"nodes\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"42-api\" style=\"position:relative;\"><a href=\"#42-api\" aria-label=\"42 api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 API</h2>\n<p>官方API文档在：<a href=\"https://www.consul.io/api/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API Introduction</a>。Consul使用RESTful的HTTP请求来提供服务，所有的客户端或命令行工具无非就是RESTful API的封装。所以如果有需要，可以直接使用curl来发送HTTP请求调用接口。</p>\n<p>下面的例子中会涉及到一些demo应用程序的节点：</p>\n<ul>\n<li>app server 3个节点</li>\n<li>app gateway 3个节点</li>\n</ul>\n<p>client1连接了：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/a8979/client1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQoz42R2Q6CMBRE+/9/qiIE6XLX6tCKIcaFyXmgpDNz24br6TKcLyyiqtLw+l9mVa2GKU0l5/smVUPOa+lN909CREicmZSIRU3NDyJAPQxpjDGa2bOqVsy/j4e+Nt9ypMIIY5jUmAW4146Zg9dyjznMtKSUieG1fuB180HzNY7LErVtwS+0U2vGsKAH9e83fLswQTO1gYG698LfYMIwLMNtnm27JBhF5OhTRUoF3cylcKEVdOMUR57qAZkGTn+E4UX4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/8ac56/client1.webp 240w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/d3be9/client1.webp 480w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/e46b2/client1.webp 960w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/f992d/client1.webp 1440w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/f13a9/client1.webp 1828w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/8ff5a/client1.png 240w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/e85cb/client1.png 480w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/d9199/client1.png 960w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/07a9c/client1.png 1440w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/a8979/client1.png 1828w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/d9199/client1.png\"\n            alt=\"client1\"\n            title=\"client1\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>client2连接了：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/a8979/client1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQoz42R2Q6CMBRE+/9/qiIE6XLX6tCKIcaFyXmgpDNz24br6TKcLyyiqtLw+l9mVa2GKU0l5/smVUPOa+lN909CREicmZSIRU3NDyJAPQxpjDGa2bOqVsy/j4e+Nt9ypMIIY5jUmAW4146Zg9dyjznMtKSUieG1fuB180HzNY7LErVtwS+0U2vGsKAH9e83fLswQTO1gYG698LfYMIwLMNtnm27JBhF5OhTRUoF3cylcKEVdOMUR57qAZkGTn+E4UX4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/8ac56/client1.webp 240w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/d3be9/client1.webp 480w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/e46b2/client1.webp 960w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/f992d/client1.webp 1440w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/f13a9/client1.webp 1828w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/8ff5a/client1.png 240w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/e85cb/client1.png 480w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/d9199/client1.png 960w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/07a9c/client1.png 1440w,\n/static/8d5cfc3de93d1f5542391d5e8ca3af4e/a8979/client1.png 1828w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8d5cfc3de93d1f5542391d5e8ca3af4e/d9199/client1.png\"\n            alt=\"client1\"\n            title=\"client1\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"421-根据节点健康状态获取节点\" style=\"position:relative;\"><a href=\"#421-%E6%A0%B9%E6%8D%AE%E8%8A%82%E7%82%B9%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%E8%8E%B7%E5%8F%96%E8%8A%82%E7%82%B9\" aria-label=\"421 根据节点健康状态获取节点 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.1 根据节点健康状态获取节点</h3>\n<p>文档：<a href=\"https://www.consul.io/api/health.html#list-checks-in-state\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">List Checks in State</a></p>\n<p>这个接口可以有效过滤掉已经失效的节点。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://127.0.0.1:18500/v1/health/state/any <span class=\"token operator\">|</span> jq <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"serfHealth\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Serf Health Status\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Agent alive and reachable\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">15</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service:1fw20gk4kq30tk\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Service 'server' check\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP GET http://fullstack_server2:50052/health: 200 OK Output: OK\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20gk4kq30tk\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">29</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service:1fw20gk4kq35py\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Service 'gateway' check\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP GET http://fullstack_gateway3:3000/health: 200 OK Output: OK\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20gk4kq35py\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gateway\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">32</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service:1fw20hk4kq5i2h\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Service 'gateway' check\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP GET http://fullstack_gateway1:3000/health: 200 OK Output: OK\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20hk4kq5i2h\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gateway\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">48</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">49</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"serfHealth\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Serf Health Status\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Agent alive and reachable\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">13</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service:1fw20hk4kq30n8\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Service 'server' check\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP GET http://fullstack_server3:50052/health: 200 OK Output: OK\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20hk4kq30n8\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">27</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service:1fw20ik4kq35th\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Service 'gateway' check\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP GET http://fullstack_gateway2:3000/health: 200 OK Output: OK\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20ik4kq35th\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gateway\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">34</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service:eewk9hk4kq2uvy\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Service 'server' check\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP GET http://fullstack_server1:50052/health: 200 OK Output: OK\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eewk9hk4kq2uvy\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">23</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-server1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"serfHealth\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Serf Health Status\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Agent alive and reachable\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-server2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"serfHealth\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Serf Health Status\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Agent alive and reachable\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-server3\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CheckID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"serfHealth\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Serf Health Status\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"passing\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Notes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Output\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Agent alive and reachable\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Definition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>any可以更换成其他状态：<code class=\"language-text\">any, passing, warning, or critical</code>。</p>\n<h3 id=\"422-获取所有服务\" style=\"position:relative;\"><a href=\"#422-%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1\" aria-label=\"422 获取所有服务 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.2 获取所有服务</h3>\n<p>文档：<a href=\"https://www.consul.io/api/catalog.html#list-services\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">List Services</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://127.0.0.1:18500/v1/catalog/services <span class=\"token operator\">|</span> jq <span class=\"token builtin class-name\">.</span> </code></pre></div>\n<p>结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"consul\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"gateway\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"server\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>The keys are the service names, and the array values provide all known tags for a given service.</p>\n</blockquote>\n<h3 id=\"423-根据服务名获取所有对应的服务节点\" style=\"position:relative;\"><a href=\"#423-%E6%A0%B9%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%90%8D%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E5%AF%B9%E5%BA%94%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%8A%82%E7%82%B9\" aria-label=\"423 根据服务名获取所有对应的服务节点 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.3 根据服务名获取所有对应的服务节点</h3>\n<p>文档：<a href=\"https://www.consul.io/api/catalog.html#list-nodes-for-service\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">List Nodes for Service</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> http://127.0.0.1:18500/v1/catalog/service/:service_name <span class=\"token operator\">|</span> jq <span class=\"token builtin class-name\">.</span> </code></pre></div>\n<p><code class=\"language-text\">server</code>的结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"f33332e4-3881-b975-d647-bc21a4ca41da\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Address\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.8\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Datacenter\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dc1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"TaggedAddresses\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"lan\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.8\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"wan\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.8\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"NodeMeta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"consul-network-segment\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceKind\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20gk4kq30tk\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceAddress\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fullstack_server2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceWeights\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Passing\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Warning\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceMeta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServicePort\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50051</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceEnableTagOverride\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceProxy\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"MeshGateway\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceConnect\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">26</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"feaba61d-83ce-a7e6-3e99-f1b2fa889bf8\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Address\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.7\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Datacenter\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dc1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"TaggedAddresses\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"lan\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.7\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"wan\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.7\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"NodeMeta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"consul-network-segment\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceKind\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20hk4kq30n8\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceAddress\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fullstack_server3\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceWeights\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Passing\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Warning\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceMeta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServicePort\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50051</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceEnableTagOverride\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceProxy\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"MeshGateway\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceConnect\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">24</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"feaba61d-83ce-a7e6-3e99-f1b2fa889bf8\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"consul-client2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Address\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.7\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Datacenter\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dc1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"TaggedAddresses\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"lan\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.7\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"wan\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"172.26.0.7\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"NodeMeta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"consul-network-segment\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceKind\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eewk9hk4kq2uvy\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceTags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceAddress\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fullstack_server1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceWeights\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Passing\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Warning\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceMeta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServicePort\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50051</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceEnableTagOverride\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceProxy\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"MeshGateway\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ServiceConnect\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreateIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"ModifyIndex\"</span><span class=\"token operator\">:</span> <span class=\"token number\">22</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h3 id=\"424-根据service-id获取具体信息\" style=\"position:relative;\"><a href=\"#424-%E6%A0%B9%E6%8D%AEservice-id%E8%8E%B7%E5%8F%96%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF\" aria-label=\"424 根据service id获取具体信息 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.4 根据service id获取具体信息</h3>\n<p>文档：<a href=\"https://www.consul.io/api/agent/service.html#get-service-configuration\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Get Service Configuration</a></p>\n<p>需要注意，这个操作只能获取所查询agent（某个client）上注册的服务的信息。下面举两个例子，刚才有说到<code class=\"language-text\">fullstack_server2</code>是注册在<code class=\"language-text\">fullstack_consul_client1</code>上的；而<code class=\"language-text\">fullstack_server3</code>是注册在<code class=\"language-text\">fullstack_consul_client2</code>上的。</p>\n<p><strong>fullstack_server2</strong>    </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 首先需要登入到docker network中的某台机器上，因为client都没有向主机暴露端口</span>\n<span class=\"token comment\"># docker exec -it fullstack_consul_server1 /bin/sh</span>\n$ <span class=\"token function\">curl</span> http://fullstack_consul_client1:8500/v1/agent/service/1fw20gk4kq30tk <span class=\"token operator\">|</span> jq <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20gk4kq30tk\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Service\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Tags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Meta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50051</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Address\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fullstack_server2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Weights\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Passing\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Warning\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"EnableTagOverride\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ContentHash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"b13f5888fa84e5d\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>fullstack_server3</strong>    </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 首先需要登入到docker network中的某台机器上，因为client都没有向主机暴露端口</span>\n<span class=\"token comment\"># docker exec -it fullstack_consul_server1 /bin/sh</span>\n$ <span class=\"token function\">curl</span> http://fullstack_consul_client2:8500/v1/agent/service/1fw20hk4kq30n8 <span class=\"token operator\">|</span> jq <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>结果：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1fw20hk4kq30n8\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Service\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"server\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Tags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Meta\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50051</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Address\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fullstack_server3\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Weights\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Passing\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Warning\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"EnableTagOverride\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ContentHash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"120b74b874209fe8\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"425-删除某个服务的注册\" style=\"position:relative;\"><a href=\"#425-%E5%88%A0%E9%99%A4%E6%9F%90%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B3%A8%E5%86%8C\" aria-label=\"425 删除某个服务的注册 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.5 删除某个服务的注册</h3>\n<p>文档：<a href=\"https://www.consul.io/api/agent/service.html#deregister-service\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Deregister Service</a></p>\n<p>做开发的时候，为了测试，有的时候需要手动删除某些服务，这时候就要用到这个接口了。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">curl</span> --request PUT http://127.0.0.1:18500/v1/agent/service/deregister/:service_id <span class=\"token operator\">|</span> jq <span class=\"token builtin class-name\">.</span></code></pre></div>\n<h2 id=\"43-ui\" style=\"position:relative;\"><a href=\"#43-ui\" aria-label=\"43 ui permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 UI</h2>\n<p>访问：<a href=\"http://127.0.0.1:18500%EF%BC%8C%E5%B0%B1%E4%BC%9A%E5%BC%80%E5%90%AF%E7%AE%A1%E7%90%86UI%E3%80%82\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://127.0.0.1:18500，就会开启管理UI。</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd712d02420a780715573faf6704ea56/c0786/ui.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkUlEQVQY032LPQ6CQBBG91ZakGgUY2OlCQVS4QEkFFighYe1sRJhw+7On0BBEA1fXiYzb2ZU6oeX1TFbhqkXJPNDMtv3nDv6MfOCfB3dNnG+iK7b+L47qeLxlLeVCkRDW8sB1chYKYy8THvfUDqlrXFMDSQywhL+eh70yjmQTvF3gFBDTTwVhYh/F8QEBJO//AFp9wFH8kBZbgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bd712d02420a780715573faf6704ea56/8ac56/ui.webp 240w,\n/static/bd712d02420a780715573faf6704ea56/d3be9/ui.webp 480w,\n/static/bd712d02420a780715573faf6704ea56/e46b2/ui.webp 960w,\n/static/bd712d02420a780715573faf6704ea56/f992d/ui.webp 1440w,\n/static/bd712d02420a780715573faf6704ea56/06e3f/ui.webp 1873w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bd712d02420a780715573faf6704ea56/8ff5a/ui.png 240w,\n/static/bd712d02420a780715573faf6704ea56/e85cb/ui.png 480w,\n/static/bd712d02420a780715573faf6704ea56/d9199/ui.png 960w,\n/static/bd712d02420a780715573faf6704ea56/07a9c/ui.png 1440w,\n/static/bd712d02420a780715573faf6704ea56/c0786/ui.png 1873w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bd712d02420a780715573faf6704ea56/d9199/ui.png\"\n            alt=\"ui\"\n            title=\"ui\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>实际功能非常有限，主要是观察下集群及服务的状况。</p>\n<h2 id=\"44-template\" style=\"position:relative;\"><a href=\"#44-template\" aria-label=\"44 template permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 Template</h2>\n<p>Consul有一个非常好用的功能就是能把注册的服务，通过一个模板，生成配置文件并输出到指定的位置。最常见的使用案例就是consul配合nginx，多个业务服务跑在后台，注册到consul，通过consul将业务后台的信息生成成nginx配置文件。同时，任何业务后台的变动都会触发配置文件的重新生成。consul的template还可以指定一个外部命令，在刚才提到的例子中就可以触发nginx的reload，使改变的配置文件生效。</p>\n<p>template有单独的镜像：<a href=\"https://hub.docker.com/r/hashicorp/consul-template/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">hashicorp/consul-template</a></p>\n<p>范例nginx配置模板，文件位置：<code class=\"language-text\">./vendor/consul/nginx</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{{range services}} {{$name := .Name}} {{$service := service .Name}} {{ if eq $name \"gateway\" }}\nupstream gateway {\n    {{range $service}}server {{.Address}}:{{.Port}} max_fails=3 fail_timeout=60 weight=1;\n    {{else}}server 127.0.0.1:65535; # force a 502{{end}}\n} {{end}} {{end}}\n\nserver {\n    listen 80;\n    server_name localhost;\n\n    access_log /var/log/nginx/fullstack.access.log;\n    error_log /var/log/nginx/fullstack.error.log;\n\n    root /usr/share/nginx/html;\n\n    index index.html index.htm index.nginx-debian.html;\n\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n\n    location / {\n        proxy_set_header x-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header HOST $http_host;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_redirect http:// https://;\n        proxy_connect_timeout 240;\n        proxy_send_timeout 240;\n        proxy_read_timeout 240;\n        proxy_pass http://gateway;\n    }\n}</code></pre></div>\n<p>template启动：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker run --rm -it --name templateX <span class=\"token punctuation\">\\</span>\n    -v ./vendor/consul/nginx:/tmp/nginx.ctmpl <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># 将模板配置文件映射到容器内</span>\n    -v /tmp/template:/consul-template/data <span class=\"token punctuation\">\\</span>    <span class=\"token comment\"># 将主机的临时文件夹映射到容器内配置文件的生成位置，方便后续在主机上直接查看生成的配置文件</span>\n    hashicorp/consul-template:0.22.1-alpine <span class=\"token punctuation\">\\</span>\n    -dry <span class=\"token punctuation\">\\</span>\n    -log-level<span class=\"token operator\">=</span>debug <span class=\"token punctuation\">\\</span>\n    -consul-addr<span class=\"token operator\">=</span>host.docker.internal:18500 <span class=\"token punctuation\">\\</span>\n    -consul-retry <span class=\"token punctuation\">\\</span>\n    -consul-retry-attempts<span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token punctuation\">\\</span>\n    -consul-retry-backoff<span class=\"token operator\">=</span>500ms <span class=\"token punctuation\">\\</span>\n    -template<span class=\"token operator\">=</span>/tmp/nginx.ctmpl:/consul-template/data/default.conf</code></pre></div>\n<p>查看生成的：<code class=\"language-text\">/tmp/template/default.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">upstream</span> gateway</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server</span> fullstack_gateway3:3000 max_fails=3 fail_timeout=60 weight=1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server</span> fullstack_gateway1:3000 max_fails=3 fail_timeout=60 weight=1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server</span> fullstack_gateway2:3000 max_fails=3 fail_timeout=60 weight=1</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">server_name</span> localhost</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">access_log</span> /var/log/nginx/fullstack.access.log</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">error_log</span> /var/log/nginx/fullstack.error.log</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">root</span> /usr/share/nginx/html</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">index</span> index.html index.htm index.nginx-debian.html</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">error_page</span>   <span class=\"token number\">500</span> <span class=\"token number\">502</span> <span class=\"token number\">503</span> <span class=\"token number\">504</span>  /50x.html</span><span class=\"token punctuation\">;</span>\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> = /50x.html</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">root</span>   /usr/share/nginx/html</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> x-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> HOST <span class=\"token variable\">$http_host</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-Proto https</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_redirect</span> http:// https://</span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_connect_timeout</span> <span class=\"token number\">240</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_send_timeout</span> <span class=\"token number\">240</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_read_timeout</span> <span class=\"token number\">240</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://gateway</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"45-dns\" style=\"position:relative;\"><a href=\"#45-dns\" aria-label=\"45 dns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5 DNS</h2>\n<p>官方文档：<a href=\"https://www.consul.io/docs/agent/dns.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DNS Interface</a>。</p>\n<p>使用上应该说是非常简便了，而且基本上对业务没什么侵入性。我之前做的实验项目里没使用这个功能，主要是因为需要改动主机的DNS，比较麻烦。</p>\n<h2 id=\"46-application\" style=\"position:relative;\"><a href=\"#46-application\" aria-label=\"46 application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.6 Application</h2>\n<p>Consul有不少语言对应的客户端，我的实验项目用过node.js的：<a href=\"https://www.npmjs.com/package/consul\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Consul</a>。</p>\n<p>注册服务：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> Consul <span class=\"token keyword\">from</span> <span class=\"token string\">\"consul\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> exitHook <span class=\"token keyword\">from</span> <span class=\"token string\">\"async-exit-hook\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> serviceId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token function\">uniqid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> consul <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Consul</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    host<span class=\"token operator\">:</span> <span class=\"token constant\">CONSUL_HOST</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// fullstack_consul_client2</span>\n    port<span class=\"token operator\">:</span> <span class=\"token constant\">CONSUL_PORT</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 8500</span>\n    promisify<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">register</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> serverConf <span class=\"token operator\">=</span> Config<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRaw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> consul<span class=\"token punctuation\">.</span>agent<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> serverConf<span class=\"token punctuation\">.</span>serviceName<span class=\"token punctuation\">,</span> <span class=\"token comment\">// server</span>\n        id<span class=\"token operator\">:</span> serviceId<span class=\"token punctuation\">,</span>\n        address<span class=\"token operator\">:</span> <span class=\"token constant\">SERVICE_HOST</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// fullstack_server3</span>\n        port<span class=\"token operator\">:</span> serverConf<span class=\"token punctuation\">.</span>servicePort<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 50051</span>\n        check<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            http<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">http://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">SERVICE_HOST</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>serverConf<span class=\"token punctuation\">.</span>webPort<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/health</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// http://fullstack_server3:50052/health</span>\n            interval<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span>\n            ttl<span class=\"token operator\">:</span> <span class=\"token string\">\"15s\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">cleanup</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function-variable function\">done</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    consul<span class=\"token punctuation\">.</span>agent<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">.</span><span class=\"token function\">deregister</span><span class=\"token punctuation\">(</span>serviceId<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cleanup done\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// exit</span>\nexitHook<span class=\"token punctuation\">.</span><span class=\"token function\">forceExitTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// wait 0.5s before force exit</span>\n<span class=\"token function\">exitHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">done</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Process::exitHook - Got exit signal\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">cleanup</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// start</span>\n<span class=\"token function\">startServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">startWeb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>在服务启动的时候进行注册，并且记得要<code class=\"language-text\">处理程序退出</code>，退出的时候需要将注册信息删除，否则即便应用程序退出了，在consul里那个服务还是存在的。</p>\n<p>客户端获取<code class=\"language-text\">可用节点</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> consul <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Consul</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    host<span class=\"token operator\">:</span> <span class=\"token constant\">CONSUL_HOST</span><span class=\"token punctuation\">,</span>\n    port<span class=\"token operator\">:</span> <span class=\"token constant\">CONSUL_PORT</span><span class=\"token punctuation\">,</span>\n    promisify<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> servers <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> consul<span class=\"token punctuation\">.</span>health<span class=\"token punctuation\">.</span><span class=\"token function\">service</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    service<span class=\"token operator\">:</span> <span class=\"token constant\">CONFIG</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRaw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">.</span>serviceName<span class=\"token punctuation\">,</span> <span class=\"token comment\">// server</span>\n    passing<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>                               <span class=\"token comment\">// get only living nodes</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> IResHealthService<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span></code></pre></div>\n<h2 id=\"47-health-check\" style=\"position:relative;\"><a href=\"#47-health-check\" aria-label=\"47 health check permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.7 Health Check</h2>\n<p>官方文档：<a href=\"https://www.consul.io/docs/agent/checks.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Checks</a></p>\n<p>在4.6的范例里也提到了，在注册服务的时候可以提供当前注册进consul的应用程序的健康检查设置，consul会使用HTTP请求来检查该URL，只要是200返回就表示该服务仍旧存活。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/23244d26c857cb83c4739c797a881a66/92bb4/living_node.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVklEQVQI15XMSw6AIAwEUO5/VBUlCPQDbQVca8LLpGkXU3deYduPAmhmusjleJcExLUTkbWyjz6npCo2tdqISE3fUyb74AoBIiMxII0FmWv/IP/hMfUBm+DsWZuDfUoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/23244d26c857cb83c4739c797a881a66/8ac56/living_node.webp 240w,\n/static/23244d26c857cb83c4739c797a881a66/d3be9/living_node.webp 480w,\n/static/23244d26c857cb83c4739c797a881a66/e46b2/living_node.webp 960w,\n/static/23244d26c857cb83c4739c797a881a66/f992d/living_node.webp 1440w,\n/static/23244d26c857cb83c4739c797a881a66/a6abc/living_node.webp 1824w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/23244d26c857cb83c4739c797a881a66/8ff5a/living_node.png 240w,\n/static/23244d26c857cb83c4739c797a881a66/e85cb/living_node.png 480w,\n/static/23244d26c857cb83c4739c797a881a66/d9199/living_node.png 960w,\n/static/23244d26c857cb83c4739c797a881a66/07a9c/living_node.png 1440w,\n/static/23244d26c857cb83c4739c797a881a66/92bb4/living_node.png 1824w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/23244d26c857cb83c4739c797a881a66/d9199/living_node.png\"\n            alt=\"living node\"\n            title=\"living node\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1 id=\"appendix\" style=\"position:relative;\"><a href=\"#appendix\" aria-label=\"appendix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Appendix</h1>\n<h2 id=\"资料\" style=\"position:relative;\"><a href=\"#%E8%B5%84%E6%96%99\" aria-label=\"资料 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>资料</h2>\n<ul>\n<li><a href=\"https://my.oschina.net/qiangmzsx/blog/1634206\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">consul服务注册与服务发现的巨坑</a></li>\n<li><a href=\"https://juejin.im/post/5d2d0c736fb9a07eb67dc156\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node.js + Consul 实现服务注册、健康检查、配置中心</a></li>\n<li><a href=\"https://www.hi-linux.com/posts/36431.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">通过 Consul-Template 实现动态配置服务</a></li>\n</ul>\n<h2 id=\"consul-agent---help-idappagent_help\" style=\"position:relative;\"><a href=\"#consul-agent---help-idappagent_help\" aria-label=\"consul agent   help idappagent_help permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>consul agent —help {#ID<em>APP</em>AGENT_HELP}</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run -it --rm consul:1.6.1 agent --help\nUsage: consul agent <span class=\"token punctuation\">[</span>options<span class=\"token punctuation\">]</span>\n\n  Starts the Consul agent and runs <span class=\"token keyword\">until</span> an interrupt is received. The\n  agent represents a single node <span class=\"token keyword\">in</span> a cluster.\n\nHTTP API Options\n\n  -datacenter<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Datacenter of the agent.\n\nCommand Options\n\n  -advertise<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the advertise address to use.\n\n  -advertise-wan<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets address to advertise on WAN instead of -advertise address.\n\n  -allow-write-http-from<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Only allow <span class=\"token function\">write</span> endpoint calls from given network. CIDR format,\n     can be specified multiple times.\n\n  -alt-domain<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Alternate domain to use <span class=\"token keyword\">for</span> DNS interface.\n\n  -bind<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the <span class=\"token builtin class-name\">bind</span> address <span class=\"token keyword\">for</span> cluster communication.\n\n  -bootstrap\n     Sets server to bootstrap mode.\n\n  -bootstrap-expect<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets server to <span class=\"token function\">expect</span> bootstrap mode.\n\n  -check_output_max_size<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the maximum output size <span class=\"token keyword\">for</span> checks on this agent\n\n  -client<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the address to <span class=\"token builtin class-name\">bind</span> <span class=\"token keyword\">for</span> client access. This includes RPC, DNS,\n     HTTP, HTTPS and gRPC <span class=\"token punctuation\">(</span>if configured<span class=\"token punctuation\">)</span>.\n\n  -config-dir<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Path to a directory to <span class=\"token builtin class-name\">read</span> configuration files from. This\n     will <span class=\"token builtin class-name\">read</span> every <span class=\"token function\">file</span> ending <span class=\"token keyword\">in</span> <span class=\"token string\">'.json'</span> as configuration <span class=\"token keyword\">in</span> this\n     directory <span class=\"token keyword\">in</span> alphabetical order. Can be specified multiple times.\n\n  -config-file<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Path to a <span class=\"token function\">file</span> <span class=\"token keyword\">in</span> JSON or HCL <span class=\"token function\">format</span> with a matching <span class=\"token function\">file</span>\n     extension. Can be specified multiple times.\n\n  -config-format<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Config files are <span class=\"token keyword\">in</span> this <span class=\"token function\">format</span> irrespective of their extension.\n     Must be <span class=\"token string\">'hcl'</span> or <span class=\"token string\">'json'</span>\n\n  -data-dir<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Path to a data directory to store agent state.\n\n  -dev\n     Starts the agent <span class=\"token keyword\">in</span> development mode.\n\n  -disable-host-node-id\n     Setting this to <span class=\"token boolean\">true</span> will prevent Consul from using information\n     from the <span class=\"token function\">host</span> to generate a node ID, and will cause Consul to\n     generate a random node ID instead.\n\n  -disable-keyring-file\n     Disables the backing up of the keyring to a file.\n\n  -dns-port<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     DNS port to use.\n\n  -domain<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Domain to use <span class=\"token keyword\">for</span> DNS interface.\n\n  -enable-local-script-checks\n     Enables health check scripts from configuration file.\n\n  -enable-script-checks\n     Enables health check scripts.\n\n  -encrypt<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Provides the gossip encryption key.\n\n  -grpc-port<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the gRPC API port to listen on <span class=\"token punctuation\">(</span>currently needed <span class=\"token keyword\">for</span> Envoy xDS\n     only<span class=\"token punctuation\">)</span>.\n\n  -hcl<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     hcl config fragment. Can be specified multiple times.\n\n  -http-port<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the HTTP API port to listen on.\n\n  -join<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address of an agent to <span class=\"token function\">join</span> at start time. Can be specified\n     multiple times.\n\n  -join-wan<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address of an agent to <span class=\"token function\">join</span> -wan at start time. Can be specified\n     multiple times.\n\n  -log-file<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Path to the <span class=\"token function\">file</span> the logs get written to\n\n  -log-level<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Log level of the agent.\n\n  -log-rotate-bytes<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Maximum number of bytes that should be written to a log <span class=\"token function\">file</span>\n\n  -log-rotate-duration<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Time after <span class=\"token function\">which</span> log rotation needs to be performed\n\n  -log-rotate-max-files<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Maximum number of log <span class=\"token function\">file</span> archives to keep\n\n  -node<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Name of this node. Must be unique <span class=\"token keyword\">in</span> the cluster.\n\n  -node-id<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     A unique ID <span class=\"token keyword\">for</span> this node across space and time. Defaults to a\n     randomly-generated ID that persists <span class=\"token keyword\">in</span> the data-dir.\n\n  -node-meta<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>key:value<span class=\"token operator\">></span>\n     An arbitrary metadata key/value pair <span class=\"token keyword\">for</span> this node, of the <span class=\"token function\">format</span>\n     <span class=\"token variable\"><span class=\"token variable\">`</span>key:value<span class=\"token variable\">`</span></span><span class=\"token builtin class-name\">.</span> Can be specified multiple times.\n\n  -non-voting-server\n     <span class=\"token punctuation\">(</span>Enterprise-only<span class=\"token punctuation\">)</span> This flag is used to <span class=\"token function\">make</span> the server not\n     participate <span class=\"token keyword\">in</span> the Raft quorum, and have it only receive the data\n     replication stream. This can be used to <span class=\"token function\">add</span> <span class=\"token builtin class-name\">read</span> scalability to\n     a cluster <span class=\"token keyword\">in</span> cases where a high volume of reads to servers are\n     needed.\n\n  -pid-file<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Path to <span class=\"token function\">file</span> to store agent PID.\n\n  -protocol<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the protocol version. Defaults to latest.\n\n  -raft-protocol<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the Raft protocol version. Defaults to latest.\n\n  -recursor<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address of an upstream DNS server. Can be specified multiple times.\n\n  -rejoin\n     Ignores a previous leave and attempts to rejoin the cluster.\n\n  -retry-interval<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Time to <span class=\"token function\">wait</span> between <span class=\"token function\">join</span> attempts.\n\n  -retry-interval-wan<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Time to <span class=\"token function\">wait</span> between <span class=\"token function\">join</span> -wan attempts.\n\n  -retry-join<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address of an agent to <span class=\"token function\">join</span> at start <span class=\"token function\">time</span> with retries enabled. Can\n     be specified multiple times.\n\n  -retry-join-wan<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address of an agent to <span class=\"token function\">join</span> -wan at start <span class=\"token function\">time</span> with retries\n     enabled. Can be specified multiple times.\n\n  -retry-max<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Maximum number of <span class=\"token function\">join</span> attempts. Defaults to <span class=\"token number\">0</span>, <span class=\"token function\">which</span> will retry\n     indefinitely.\n\n  -retry-max-wan<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Maximum number of <span class=\"token function\">join</span> -wan attempts. Defaults to <span class=\"token number\">0</span>, <span class=\"token function\">which</span> will\n     retry indefinitely.\n\n  -segment<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     <span class=\"token punctuation\">(</span>Enterprise-only<span class=\"token punctuation\">)</span> Sets the network segment to join.\n\n  -serf-lan-bind<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address to <span class=\"token builtin class-name\">bind</span> Serf LAN listeners to.\n\n  -serf-lan-port<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the Serf LAN port to listen on.\n\n  -serf-wan-bind<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Address to <span class=\"token builtin class-name\">bind</span> Serf WAN listeners to.\n\n  -serf-wan-port<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the Serf WAN port to listen on.\n\n  -server\n     Switches agent to server mode.\n\n  -server-port<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the server port to listen on.\n\n  -syslog\n     Enables logging to syslog.\n\n  -ui\n     Enables the built-in static web UI server.\n\n  -ui-content-path<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Sets the external UI path to a string. Defaults to: /ui/\n\n  -ui-dir<span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>\n     Path to directory containing the web UI resources.</code></pre></div>\n<h2 id=\"consul---help\" style=\"position:relative;\"><a href=\"#consul---help\" aria-label=\"consul   help permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>consul —help</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker run -it --rm consul:1.6.1 --help\nUsage: consul <span class=\"token punctuation\">[</span>--version<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>--help<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span>command<span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&lt;</span>args<span class=\"token operator\">></span><span class=\"token punctuation\">]</span>\n\nAvailable commands are:\n    acl            Interact with Consul<span class=\"token string\">'s ACLs\n    agent          Runs a Consul agent\n    catalog        Interact with the catalog\n    config         Interact with Consul'</span>s Centralized Configurations\n    connect        Interact with Consul Connect\n    debug          Records a debugging archive <span class=\"token keyword\">for</span> operators\n    event          Fire a new event\n    <span class=\"token builtin class-name\">exec</span>           Executes a <span class=\"token builtin class-name\">command</span> on Consul nodes\n    force-leave    Forces a member of the cluster to enter the <span class=\"token string\">\"left\"</span> state\n    info           Provides debugging information <span class=\"token keyword\">for</span> operators.\n    intention      Interact with Connect <span class=\"token function\">service</span> intentions\n    <span class=\"token function\">join</span>           Tell Consul agent to <span class=\"token function\">join</span> cluster\n    keygen         Generates a new encryption key\n    keyring        Manages gossip layer encryption keys\n    kv             Interact with the key-value store\n    leave          Gracefully leaves the Consul cluster and shuts down\n    lock           Execute a <span class=\"token builtin class-name\">command</span> holding a lock\n    login          Login to Consul using an auth method\n    <span class=\"token builtin class-name\">logout</span>         Destroy a Consul token created with login\n    maint          Controls node or <span class=\"token function\">service</span> maintenance mode\n    members        Lists the members of a Consul cluster\n    monitor        Stream logs from a Consul agent\n    operator       Provides cluster-level tools <span class=\"token keyword\">for</span> Consul operators\n    reload         Triggers the agent to reload configuration files\n    rtt            Estimates network round trip <span class=\"token function\">time</span> between nodes\n    services       Interact with services\n    snapshot       Saves, restores and inspects snapshots of Consul server state\n    tls            Builtin helpers <span class=\"token keyword\">for</span> creating CAs and certificates\n    validate       Validate config files/directories\n    version        Prints the Consul version\n    <span class=\"token function\">watch</span>          Watch <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">changes</span> <span class=\"token keyword\">in</span> Consul</code></pre></div>\n<blockquote>\n<p>EOF</p>\n</blockquote>","fields":{"slug":"/posts/2019/12/consul-note","tagSlugs":["/tag/consul/","/tag/service-discovery/","/tag/dev-ops/","/tag/keynote/"]},"frontmatter":{"date":"2019-12-25T02:36:22.000Z","description":"","tags":["Consul","ServiceDiscovery","DevOps","Keynote"],"title":"Consul Notes","socialImage":{"publicURL":"/static/7e722e026a41a08a8f9a1cc76782dd27/default-social-image.jpg"}}}},"pageContext":{"slug":"/posts/2019/12/consul-note"}},"staticQueryHashes":["251939775","401334301","825871152"]}