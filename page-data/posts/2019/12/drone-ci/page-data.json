{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/2019/12/drone-ci","result":{"data":{"markdownRemark":{"id":"348ddc5f-f140-5085-b429-9b42461e095c","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%E5%89%8D%E8%A8%80\">1. 前言</a></li>\n<li><a href=\"#2-%E6%A6%82%E5%BF%B5\">2. 概念</a>\n<ul>\n<li><a href=\"#21-pipeline\">2.1 pipeline</a></li>\n<li><a href=\"#22-step\">2.2 step</a></li>\n<li><a href=\"#23-workspace\">2.3 workspace</a></li>\n<li><a href=\"#24-trigger\">2.4 trigger</a></li>\n<li><a href=\"#25-condition\">2.5 condition</a></li>\n</ul>\n</li>\n<li><a href=\"#3-%E6%9E%B6%E6%9E%84--multiple-pipeline--parallelism\">3. 架构 &#x26; Multiple Pipeline &#x26; Parallelism</a>\n<ul>\n<li><a href=\"#31-%E6%9E%B6%E6%9E%84\">3.1 架构</a></li>\n<li><a href=\"#32-multiple-pipeline\">3.2 Multiple Pipeline</a></li>\n<li><a href=\"#33-parallelism\">3.3 Parallelism</a></li>\n</ul>\n</li>\n<li><a href=\"#4-%E4%BD%BF%E7%94%A8\">4. 使用</a>\n<ul>\n<li><a href=\"#41-server%E5%AE%89%E8%A3%85--%E8%BF%90%E8%A1%8C\">4.1 Server：安装 &#x26; 运行</a>\n<ul>\n<li><a href=\"#411-oauth2%E5%87%86%E5%A4%87\">4.1.1 OAuth2准备</a></li>\n<li><a href=\"#412-%E5%90%AF%E5%8A%A8drone\">4.1.2 启动drone</a></li>\n<li><a href=\"#413-oauth2%E6%8E%88%E6%9D%83\">4.1.3 OAuth2授权</a></li>\n<li><a href=\"#414-ui%E5%90%8C%E6%AD%A5--%E6%BF%80%E6%B4%BB%E4%BB%A3%E7%A0%81%E5%BA%93\">4.1.4 UI同步 &#x26; 激活代码库</a></li>\n<li><a href=\"#415-api%E7%A7%98%E9%92%A5\">4.1.5 API秘钥</a></li>\n</ul>\n</li>\n<li><a href=\"#42-runner%E5%AE%89%E8%A3%85--%E8%BF%90%E8%A1%8C\">4.2 Runner：安装 &#x26; 运行</a>\n<ul>\n<li><a href=\"#421-%E5%AE%89%E8%A3%85\">4.2.1 安装</a></li>\n<li><a href=\"#422-%E8%BF%90%E8%A1%8C\">4.2.2 运行</a></li>\n</ul>\n</li>\n<li><a href=\"#43-ui%E7%A7%98%E9%92%A5%E8%AE%BE%E7%BD%AE\">4.3 UI秘钥设置</a></li>\n<li><a href=\"#44-%E7%A7%81%E6%9C%89registry\">4.4 私有Registry</a></li>\n<li><a href=\"#45-%E9%83%A8%E7%BD%B2--%E5%A4%9A%E7%82%B9%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91\">4.5 部署 &#x26; 多点事件触发</a>\n<ul>\n<li><a href=\"#451-drone-api--drone-cli\">4.5.1 drone api | drone cli</a></li>\n<li><a href=\"#452-plugin\">4.5.2 plugin</a></li>\n<li><a href=\"#453-webhook-plugin\">4.5.3 webhook plugin</a></li>\n<li><a href=\"#454-webhook-fake\">4.5.4 webhook fake</a></li>\n<li><a href=\"#455-waiting-hack\">4.5.5 waiting hack</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>Drone是一个Golang技术栈的CI解决方案，功能和Jenkins之类的CI工具类似。</p>\n<p>优点：</p>\n<ul>\n<li>Golang编写，分发及搭建非常容易（镜像体积很小）</li>\n<li>Golang编写，运行时占用资源极小（特指和Java栈的一系列工具比较）</li>\n<li>构建运行时以镜像优先，保证在不同平台的构建结果一致</li>\n<li>优秀的设计，支持插件化提供强大的功能支持</li>\n<li>现代化的UI，开箱即用，甩开Jenkins之类有历史包袱的工具几条街</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>较年轻，文档工作需要强化</li>\n<li>插件的数量和质量，以及插件的文档支持需要强化</li>\n<li>功能尚不能说强大，和Jenkins之类的老牌CI相比差距较大</li>\n</ul>\n<p>简单选择：</p>\n<ul>\n<li>Drone：\n<ul>\n<li>小型团队，对新技术适应能力较强的团队</li>\n<li>对功能的丰富性要求并不是很高，但要求性能强大功能稳定</li>\n</ul>\n</li>\n<li>Jenkins：\n<ul>\n<li>对功能的丰富性要求较高，要求任何情况任何需求都能快速应对</li>\n<li>运维人员对Jenkins非常熟悉可以很快上手使用</li>\n</ul>\n</li>\n</ul>\n<p>相关资源：</p>\n<ul>\n<li>官方站点：<a href=\"https://drone.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">drone.io</a></li>\n<li>文档站点：<a href=\"https://docs.drone.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docs.drone.io</a></li>\n<li>官方论坛：<a href=\"https://discourse.drone.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">discourse.drone.io</a></li>\n</ul>\n<h1 id=\"2-概念\" style=\"position:relative;\"><a href=\"#2-%E6%A6%82%E5%BF%B5\" aria-label=\"2 概念 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 概念</h1>\n<h2 id=\"21-pipeline\" style=\"position:relative;\"><a href=\"#21-pipeline\" aria-label=\"21 pipeline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 <a href=\"https://docs.drone.io/configure/pipeline/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pipeline</a></h2>\n<ul>\n<li>pipeline是drone的核心概念</li>\n<li>pipeline一般负责完成一个<code class=\"language-text\">任务</code>：构建、发布、部署，其内部会有多个行为共同组成一个pipeline</li>\n<li>pipeline在drone里是进行分类的，按类型有多种种类，常用的有：\n<ul>\n<li><a href=\"https://docker-runner.docs.drone.io/configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docker</a>：所有的构建行为都在临时docker容器内进行，跨平台保证行为一致\n<ul>\n<li><a href=\"https://exec-runner.docs.drone.io/configuration/variables/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Environment Variables</a></li>\n</ul>\n</li>\n<li><a href=\"https://exec-runner.docs.drone.io/configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">exec</a>：所有的构建行为都在runner所在主机上进行，一般用在某些不方便放在容器内运行的工作，e.g xcode项目的构建\n<ul>\n<li><a href=\"https://docker-runner.docs.drone.io/configuration/environment/variables/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Environment Variables</a></li>\n</ul>\n</li>\n<li><a href=\"https://ssh-runner.docs.drone.io/configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ssh</a>：构建行为通过ssh执行远程命令进行\n<ul>\n<li><a href=\"https://ssh-runner.docs.drone.io/configuration/variables/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Environment Variables</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"22-step\" style=\"position:relative;\"><a href=\"#22-step\" aria-label=\"22 step permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 <a href=\"https://docker-runner.docs.drone.io/configuration/steps/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">step</a></h2>\n<ul>\n<li>pipeline里的每一个操作被称为<code class=\"language-text\">step</code></li>\n<li>组织多个<code class=\"language-text\">step</code>可以完成一个特定的pipeline，e.g\n<ul>\n<li>构建pipeline：clone、安装依赖、单元测试、打包、制作镜像、推送镜像</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"23-workspace\" style=\"position:relative;\"><a href=\"#23-workspace\" aria-label=\"23 workspace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 <a href=\"https://docker-runner.docs.drone.io/configuration/workspace/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">workspace</a></h2>\n<ul>\n<li>构建运行的工作空间，在不同的环境下其位置会有所不同</li>\n<li>Posix系统（含docker容器），工作空间在：<code class=\"language-text\">/tmp/drone-${RANDOM}/drone/src</code></li>\n<li>OSX系统，工作空间在：<code class=\"language-text\">/private/var/folders/...</code></li>\n<li>Win系统，工作空间在：<code class=\"language-text\">C:\\windows\\drone-%RANDOM%\\drone\\src</code></li>\n<li>有一点要强调下，如果在bash脚本中访问当前pipeline的<code class=\"language-text\">~</code>或<code class=\"language-text\">$HOME</code>，获得的地址就是workspace的根目录，而<code class=\"language-text\">不是</code>当前runner的用户home</li>\n<li>此外，workspace是临时的，会在pipeline创建的时候产生，并在完成的时候被销毁</li>\n</ul>\n<h2 id=\"24-trigger\" style=\"position:relative;\"><a href=\"#24-trigger\" aria-label=\"24 trigger permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 <a href=\"https://docker-runner.docs.drone.io/configuration/trigger/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">trigger</a></h2>\n<ul>\n<li>trigger决定当前的<code class=\"language-text\">pipeline</code>是否要<code class=\"language-text\">触发</code></li>\n<li>trigger有很多类型：\n<ul>\n<li>根据分支：e.g 是否dev分支</li>\n<li>根据事件：e.g 是否tag事件（注意，tag和分支trigger不能同时存在，因为tag是不区分分支的）</li>\n<li>根据reference：e.g refs/tags/**</li>\n<li>根据代码库：e.g octocat/hello-world</li>\n<li>根据runner实例：e.g drone.instance1.com</li>\n<li>根据状态触发：e.g failure</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"25-condition\" style=\"position:relative;\"><a href=\"#25-condition\" aria-label=\"25 condition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 <a href=\"https://docker-runner.docs.drone.io/configuration/conditions/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">condition</a></h2>\n<ul>\n<li>condition决定当前的<code class=\"language-text\">step</code>是否要<code class=\"language-text\">触发</code></li>\n<li>condition有很多类型：\n<ul>\n<li>根据分支：e.g 是否dev分支</li>\n<li>根据事件：e.g 是否tag事件（注意，tag和分支condition不能同时存在，因为tag是不区分分支的）</li>\n<li>根据reference：e.g refs/tags/**</li>\n<li>根据代码库：e.g octocat/hello-world</li>\n<li>根据runner实例：e.g drone.instance1.com</li>\n<li>根据状态触发：e.g failure</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"3-架构--multiple-pipeline--parallelism\" style=\"position:relative;\"><a href=\"#3-%E6%9E%B6%E6%9E%84--multiple-pipeline--parallelism\" aria-label=\"3 架构  multiple pipeline  parallelism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 架构 &#x26; Multiple Pipeline &#x26; Parallelism</h1>\n<h2 id=\"31-架构\" style=\"position:relative;\"><a href=\"#31-%E6%9E%B6%E6%9E%84\" aria-label=\"31 架构 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 架构</h2>\n<p>Drone这个CI其实很简单，也说不上什么架构。一般Drone会有一个单点Server，在git工具上注册好webhook接收事件，然后启动多个Runner来处理Server上产生的任务。这些Runner可以在同一台主机上，也可以分散在多台不同的主机上，官方文档的指引中要求不要将runner和server放在同一台主机上。</p>\n<h2 id=\"32-multiple-pipeline\" style=\"position:relative;\"><a href=\"#32-multiple-pipeline\" aria-label=\"32 multiple pipeline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 Multiple Pipeline</h2>\n<p>官方说明：</p>\n<blockquote>\n<p>Drone supports configuring and orchestrating multiple pipelines. This is useful when you need to fan-out and distribute your build tasks across multiple machines to reduce build times, or to execute your build tasks across multiple platforms (e.g. amd64 and arm64).</p>\n</blockquote>\n<p><strong>用途1：</strong></p>\n<p>在处理大型项目任务的时候，将任务拆散，分散到不同的物理机上进行并行处理，加速整个构建进程。如果是不同主机的话，需要用到<code class=\"language-text\">2.4</code>提到的pipeline trigger，将不同的pipeline设定好自己的运行目标主机。保证同一个repo在不同主机上触发的时候，只有当前主机（runner）应该执行的pipeline得到执行。</p>\n<p><strong>用途2：</strong></p>\n<p>确定pipeline之间的先后顺序，通过在pipeline一级定义<code class=\"language-text\">depends_on</code>来申明相互之间的依赖关系。这里特别需要注意的是：pipeline之间是不共享workspace的。所以每一步都需要单独做类似于依赖安装之类的工作，这需要特别小心。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> p3\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notify\n  <span class=\"token comment\"># ...</span>\n\n<span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> p1\n  <span class=\"token punctuation\">-</span> p2</code></pre></div>\n<h2 id=\"33-parallelism\" style=\"position:relative;\"><a href=\"#33-parallelism\" aria-label=\"33 parallelism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 Parallelism</h2>\n<p>这部分内容与 Multiple Pipeline 的关系，和之前讲过的 trigger 与 condition 的关系一样。Multiple Pipeline 是pipeline级别的，而Parallelism则是step级别的，本质上仍旧是并行运行。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3\n  <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token comment\"># ...</span>\n  <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> s1\n    <span class=\"token punctuation\">-</span> s2</code></pre></div>\n<h1 id=\"4-使用\" style=\"position:relative;\"><a href=\"#4-%E4%BD%BF%E7%94%A8\" aria-label=\"4 使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 使用</h1>\n<h2 id=\"41-server安装--运行\" style=\"position:relative;\"><a href=\"#41-server%E5%AE%89%E8%A3%85--%E8%BF%90%E8%A1%8C\" aria-label=\"41 server安装  运行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 Server：安装 &#x26; 运行</h2>\n<h3 id=\"411-oauth2准备\" style=\"position:relative;\"><a href=\"#411-oauth2%E5%87%86%E5%A4%87\" aria-label=\"411 oauth2准备 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.1 OAuth2准备</h3>\n<p>需要在git repo软件上申请一个OAuth应用。这里我使用的是Gitea，就拿它来做演示：</p>\n<p>点击：<code class=\"language-text\">右上角头像 > 设置（下拉菜单） > 应用（页面中间）</code>，打开的页面是管理用户级别的<code class=\"language-text\">Access Tokens</code>和<code class=\"language-text\">OAuth2应用</code>的。</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/oauth1.png\" alt=\"\"></p>\n<p>找到：<code class=\"language-text\">创建新的 OAuth2 应用程序</code>这一栏，输入：</p>\n<ul>\n<li>应用名称：这名字后面用不到，填可理解的内容即可</li>\n<li><code class=\"language-text\">重定向 URI</code>：http://<code class=\"language-text\">${drone_host}:${drone_ip}</code>/login</li>\n</ul>\n<p><img src=\"/media/posts/2019/12/drone-ci/oauth2.png\" alt=\"\"></p>\n<p>点击<code class=\"language-text\">创建应用</code>。</p>\n<p>在打开的页面上显示了OAuth2应用的相关信息，这里需要记下：</p>\n<ul>\n<li>客户端ID</li>\n<li>客户端秘钥</li>\n</ul>\n<p><img src=\"/media/posts/2019/12/drone-ci/oauth3.png\" alt=\"\"></p>\n<h3 id=\"412-启动drone\" style=\"position:relative;\"><a href=\"#412-%E5%90%AF%E5%8A%A8drone\" aria-label=\"412 启动drone permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.2 启动drone</h3>\n<p>Golang应用程序，使用上最容易的方式仍旧是镜像：<a href=\"https://hub.docker.com/r/drone/drone\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">drone/drone</a>。</p>\n<p>drone服务器启动时的环境变量文档在：<a href=\"https://docs.drone.io/installation/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drone Documentation > Installation > Reference</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> run -it -d <span class=\"token punctuation\">\\</span>\n    --name drone-server <span class=\"token punctuation\">\\</span>\n    -p <span class=\"token number\">18980</span>:80 <span class=\"token punctuation\">\\</span>\n    --log-driver<span class=\"token operator\">=</span>json-file <span class=\"token punctuation\">\\</span>\n    --log-opt max-size<span class=\"token operator\">=</span>512m <span class=\"token punctuation\">\\</span>\n    -v /tmp/drone/data:/data <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># sqlite db file</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_DEBUG</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_COLOR</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_PRETTY</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_TRACE</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_AGENTS_ENABLED</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>                                              <span class=\"token comment\"># drone server running with no agents, start runners manually</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_SKIP_VERIFY</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>                                           <span class=\"token comment\"># gitea: use http protocol</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_SERVER</span><span class=\"token operator\">=</span>http://host.docker.internal:13000 <span class=\"token punctuation\">\\</span>                   <span class=\"token comment\"># gitea: server address with protocol</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_CLIENT_ID</span><span class=\"token operator\">=</span>fd023edb-7976-4d50-a92f-b16612683240 <span class=\"token punctuation\">\\</span>             <span class=\"token comment\"># gitea: oauth client id</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_CLIENT_SECRET</span><span class=\"token operator\">=</span>S4Q6PktE3dKNHPUzZrTdyNJsTThwal4doUWf6jf4eRA<span class=\"token operator\">=</span> <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># gitea: oauth client secret </span>\n    -e <span class=\"token assign-left variable\">DRONE_RPC_SECRET</span><span class=\"token operator\">=</span>d9856af41ffe31f5e8025be020e981be <span class=\"token punctuation\">\\</span>                      <span class=\"token comment\"># drone: runner shall connect server with this secret</span>\n    -e <span class=\"token assign-left variable\">DRONE_SERVER_HOST</span><span class=\"token operator\">=</span>host.docker.internal:18980 <span class=\"token punctuation\">\\</span>                           <span class=\"token comment\"># drone: server address without protocol</span>\n    -e <span class=\"token assign-left variable\">DRONE_SERVER_PROTO</span><span class=\"token operator\">=</span>http <span class=\"token punctuation\">\\</span>                                                <span class=\"token comment\"># drone: server with http protocol</span>\n    drone/drone:1.6.3</code></pre></div>\n<h3 id=\"413-oauth2授权\" style=\"position:relative;\"><a href=\"#413-oauth2%E6%8E%88%E6%9D%83\" aria-label=\"413 oauth2授权 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.3 OAuth2授权</h3>\n<p>访问drone的地址：<code class=\"language-text\">http://host.docker.internal:18980</code>，会跳转到gitea进行授权，授权完成后会跳转回drone。这时应该就已经以刚才制作OAuth2应用的用户身份登录drone了。</p>\n<p>这里说明下，因为gitea和drone都运行在容器内，他们之间相互访问是通过容器名来进行的，而host主机访问这两者都是通过loopback地址，两者之间存在差异，会导致OAuth的过程失败。因此这里统一使用docker MAC desktop版本的<code class=\"language-text\">host.docker.internal</code>域名来贯通内部和外部。但需要额外修改host主机的<code class=\"language-text\">/etc/hosts</code>配置，把这个host解析为loopback地址。</p>\n<h3 id=\"414-ui同步--激活代码库\" style=\"position:relative;\"><a href=\"#414-ui%E5%90%8C%E6%AD%A5--%E6%BF%80%E6%B4%BB%E4%BB%A3%E7%A0%81%E5%BA%93\" aria-label=\"414 ui同步  激活代码库 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.4 UI同步 &#x26; 激活代码库</h3>\n<p>刚完成授权的账户是没有任何代码库的，打开drone首页发现是空列表（即便当前通过OAuth2授权的账号在gitea内有代码库）：</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/drone1.png\" alt=\"\"></p>\n<p>点击右上角的<code class=\"language-text\">SYNC</code>就会开始和gitea同步账户的代码库数据，完成后即可获得所有当前账号在gitea内所拥有的代码库列表：</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/drone2.png\" alt=\"\"></p>\n<p>这时候账号下的drone项目都是<code class=\"language-text\">未激活</code>状态，需要点击面板上项目右边的<code class=\"language-text\">ACTIVATE</code>进行激活：</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/drone3.png\" alt=\"\">\n<img src=\"/media/posts/2019/12/drone-ci/drone4.png\" alt=\"\"></p>\n<p>点击<code class=\"language-text\">SAVE</code>保存即可。经过这几个操作，drone即激活了对这几个代码库的webhook事件监听。</p>\n<p>至此为止drone本体的安装基本上完成了，后续还需要配置下runner。</p>\n<h3 id=\"415-api秘钥\" style=\"position:relative;\"><a href=\"#415-api%E7%A7%98%E9%92%A5\" aria-label=\"415 api秘钥 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.5 API秘钥</h3>\n<p>点击右上角的用户头像，然后点击<code class=\"language-text\">User settings</code>会打开用户的设置页面。在这个页面上能找到用户的token。如果有需要使用drone API的话（或者是cli命令行工具），这个token是必须的。</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/drone7.png\" alt=\"\"></p>\n<h2 id=\"42-runner安装--运行\" style=\"position:relative;\"><a href=\"#42-runner%E5%AE%89%E8%A3%85--%E8%BF%90%E8%A1%8C\" aria-label=\"42 runner安装  运行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 Runner：安装 &#x26; 运行</h2>\n<h3 id=\"421-安装\" style=\"position:relative;\"><a href=\"#421-%E5%AE%89%E8%A3%85\" aria-label=\"421 安装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.1 安装</h3>\n<p>服务器设置完成后，如果没有单独安装和运行runner，服务器上所有触发的事件都会是<code class=\"language-text\">Pending</code>状态，而且没有任何日志。</p>\n<p>关于Pending的debug，可以看下官方的一篇帖子：<a href=\"https://discourse.drone.io/t/builds-are-stuck-in-pending-status/4437\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Builds are Stuck in Pending Status</a>。</p>\n<p>Runner的安装见官方文档：<a href=\"https://docs.drone.io/installation/runners/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drone Documentation > Installation > Runners</a>。Runner也分不同的类型，一般常用的是：</p>\n<ul>\n<li><a href=\"https://docs.drone.io/installation/runners/exec/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Exec Runner</a>：直接运行在主机上的runner</li>\n<li><a href=\"https://docs.drone.io/installation/runners/docker/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Docker Runner</a>：运行在docker容器内的runner</li>\n</ul>\n<p>Runner的类型和pipeline的类型并不要求一致，runner只是pipeline的运行者，不管是什么类型的pipeline，都可以在任何类型的runner上运作。举例来说，一个docker类型的pipeline，在exec runner上就会在主机上启动docker容器并运行，而docker runner则是直接在docker容器内运行。</p>\n<h3 id=\"422-运行\" style=\"position:relative;\"><a href=\"#422-%E8%BF%90%E8%A1%8C\" aria-label=\"422 运行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.2 运行</h3>\n<p><strong>Exec Runner</strong><br>\nExec Runner需要手动在<code class=\"language-text\">~/.drone-runner-exec/config</code>创建一个配置文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">DRONE_DEBUG</span><span class=\"token operator\">=</span>true\n<span class=\"token assign-left variable\">DRONE_LOG_FILE</span><span class=\"token operator\">=</span>/tmp/drone-runner-exec.txt\n<span class=\"token assign-left variable\">DRONE_LOG_FILE_MAX_SIZE</span><span class=\"token operator\">=</span><span class=\"token number\">50</span>\n<span class=\"token assign-left variable\">DRONE_RPC_DUMP_HTTP</span><span class=\"token operator\">=</span>true\n<span class=\"token assign-left variable\">DRONE_RPC_DUMP_HTTP_BODY</span><span class=\"token operator\">=</span>true\n<span class=\"token assign-left variable\">DRONE_RPC_PROTO</span><span class=\"token operator\">=</span>http\n<span class=\"token assign-left variable\">DRONE_RPC_HOST</span><span class=\"token operator\">=</span>host.docker.internal:18980\n<span class=\"token assign-left variable\">DRONE_RPC_SECRET</span><span class=\"token operator\">=</span>d9856af41ffe31f5e8025be020e981be\n<span class=\"token assign-left variable\">DRONE_RUNNER_PATH</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$HOME</span>/.yarn/bin:<span class=\"token environment constant\">$HOME</span>/.config/yarn/global/node_modules/.bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</code></pre></div>\n<p>更多的配置项可以查阅官方文档：<a href=\"https://exec-runner.docs.drone.io/installation/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Exec Runner > Installation > Configuration Reference</a>。</p>\n<p>配置文件里最重要的是<code class=\"language-text\">DRONE_RPC_HOST``DRONE_RPC_SECRET</code>这两项。修改完成后记得重启runner：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ drone-runner-exec <span class=\"token function\">service</span> stop <span class=\"token operator\">&amp;&amp;</span> drone-runner-exec <span class=\"token function\">service</span> start</code></pre></div>\n<p>Runner在执行pipeline操作时候的用户即是runner启动时的用户，这需要非常小心，否则会搞错用户导致权限错误。此外，在2.3 workspace的时候也提到过了，在runner执行pipeline的时候，<code class=\"language-text\">~</code>指向的是workspace的根目录，而不是用户的home，这点要非常小心。</p>\n<p>举例来说，存放在<code class=\"language-text\">$HOME/.docker</code>下的凭证在exec runner运行的时候是不可访问的（<code class=\"language-text\">~</code>会定位到workspace而不是<code class=\"language-text\">$HOME</code>），这会导致私有registry的访问失败。同样的，pipeline运行时的PATH也不同于用户自身的PATH，需要在配置文件中设置好<code class=\"language-text\">DRONE_RUNNER_PATH</code>。</p>\n<p><strong>Docker Runner</strong><br>\n这部分就非常简单了，无非就是一个docker容器，直接使用对应的官方镜像即可：<a href=\"https://hub.docker.com/r/drone/drone-runner-docker\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">drone/drone-runner-docker</a>。</p>\n<p>相关配置项可以查阅官方文档：<a href=\"https://docker-runner.docs.drone.io/installation/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Docker Runner > Installation > Configuration Reference</a>。</p>\n<h2 id=\"43-ui秘钥设置\" style=\"position:relative;\"><a href=\"#43-ui%E7%A7%98%E9%92%A5%E8%AE%BE%E7%BD%AE\" aria-label=\"43 ui秘钥设置 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 UI秘钥设置</h2>\n<p>在执行pipeline的时候不可避免需要访问一些密码秘钥之类的信息，而构建过程中，理论上runner只能访问代码库里的内容。这就造成了问题，因为代码库并不是安全的存放秘钥的地方。针对这样的问题，drone有对应的解决方案。</p>\n<p>在drone ui仓库的设置中，有一处：</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/drone5.png\" alt=\"\"></p>\n<p>设置完成后，就会保存在drone系统中：</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/drone6.png\" alt=\"\"></p>\n<p>后续在pipeline可以如下的形式进行访问：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alpine\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">USERNAME</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">from_secret</span><span class=\"token punctuation\">:</span> docker_username\n    <span class=\"token key atrule\">PASSWORD</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">from_secret</span><span class=\"token punctuation\">:</span> docker_password</code></pre></div>\n<p>更多关于secret的设置及访问，可以参见官方文档：<a href=\"https://docs.drone.io/configure/secrets/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drone Documentation > Configuration > Secrets</a>。在这方面，drone支持得非常全面，甚至外部的加密设施也可以支持访问。</p>\n<h2 id=\"44-私有registry\" style=\"position:relative;\"><a href=\"#44-%E7%A7%81%E6%9C%89registry\" aria-label=\"44 私有registry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 私有Registry</h2>\n<p>在pipeline应用的过程中，比较常见的问题是对于私有registry的访问。毕竟现在的CI基本上都围绕着镜像打转，抓取镜像进行部署或者构建镜像向上推送都是常见需求。</p>\n<p>官方对此也有解决方案：<a href=\"https://discourse.drone.io/t/how-to-pull-private-images-with-1-0/3155\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to pull private images with 1.0</a>。</p>\n<h2 id=\"45-部署--多点事件触发\" style=\"position:relative;\"><a href=\"#45-%E9%83%A8%E7%BD%B2--%E5%A4%9A%E7%82%B9%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91\" aria-label=\"45 部署  多点事件触发 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5 部署 &#x26; 多点事件触发</h2>\n<p>上述的内容基本上把CI的最基础的应用都讲到了，如果只是简单的<code class=\"language-text\">提交代码 > 触发webhook > drone pipeline</code>这个流程的话，是没有问题的。</p>\n<p>那么接下来就可以考虑下稍微复杂点的需求：</p>\n<ul>\n<li>项目的构建和部署需要分开</li>\n<li>构建定义为一个pipeline</li>\n<li>部署定义为一个pipeline</li>\n<li>部署pipeline应该由构建pipeline异步触发</li>\n<li>部署pipeline应该和构建pipeline解耦，两者可能发生在完全隔离的两个物理机的runner上</li>\n</ul>\n<p>然后我简单说下结论：在当前的版本（drone/drone:1.6.3），这个需求<code class=\"language-text\">做不到</code>，如果是按官方的API和功能的话。而使用一些非官方的hacking思路，则可以做到<code class=\"language-text\">基本上一致的效果</code>。</p>\n<p>根据一开始说的，如果单独只是一个构建pipeline，很简单就能做到。而如果要实现刚才列出的需求，就需要在构建pipeline完成并退出之前触发一个额外的事件，只要能触发额外的事件，再配合上：trigger &#x26; condition，保证代码库的pipeline启动的时候，只有部署pipeline进入工作，且只有正确的runner实例进入工作，那一切就通了。</p>\n<p>那么，能不能手动触发一个部署呢？研究了下官方的资料，发现正常途径基本上做不到，只有一些非正常的思路才可以做到。下面说下思路。</p>\n<h3 id=\"451-drone-api--drone-cli\" style=\"position:relative;\"><a href=\"#451-drone-api--drone-cli\" aria-label=\"451 drone api  drone cli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.1 drone api | drone cli</h3>\n<p>首先想到的是看看官方的API中有没有可用的命令（cli实际上就是官方API的封装）：<a href=\"https://docs.drone.io/api/overview/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API文档</a>、<a href=\"https://docs.drone.io/cli/install/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CLI文档</a>。</p>\n<p>发现官方有一个命令：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ drone build promote --help\n  NAME:\n     drone build promote - promote a build\n  \n  USAGE:\n     drone build promote <span class=\"token punctuation\">[</span>command options<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span>repo/name<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>build<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>environment<span class=\"token operator\">></span>\n  \n  OPTIONS:\n     --param value, -p value  custom parameters to be injected into the job environment. Format: <span class=\"token assign-left variable\">KEY</span><span class=\"token operator\">=</span>value\n     --format value           <span class=\"token function\">format</span> output <span class=\"token punctuation\">(</span>default: <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>结合<code class=\"language-text\">.drone.yml</code>使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo \"tested\"\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> tag\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo \"built\"\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> tag\n\n<span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> test\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notify\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notify\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> drone build promote fullstack/gateway 100 production\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">DRONE_SERVER</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//host.docker.internal<span class=\"token punctuation\">:</span><span class=\"token number\">18980</span>\n      <span class=\"token key atrule\">DRONE_TOKEN</span><span class=\"token punctuation\">:</span> K5i8g6PMlLM3tWaPDRagigPkBrl1YKGu\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> tag\n\n<span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> build\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo \"deployed\"\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> promote\n      <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> production</code></pre></div>\n<p>测试后发现，如果<code class=\"language-text\">build</code>参数给的是已经存在的构建的话，则会重复之前的构建流程；而如果给的是一个很大的不存在该build的值（比如上面举例的100），则构建在notify这一步失败，并报错：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">+ drone build promote fullstack/gateway <span class=\"token number\">100</span> production\nclient error <span class=\"token number\">404</span>: <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sql: no rows in result set\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>查找了下相关资料，并没有找到官方文档，仅在论坛中找到几篇讨论：</p>\n<ul>\n<li><a href=\"https://discourse.drone.io/t/manually-trigger-a-build/874/8\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Manually trigger a build</a></li>\n<li><a href=\"https://discourse.drone.io/t/promoting-a-build-by-branch/4755\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Promoting a build by branch</a></li>\n<li><a href=\"https://github.com/drone/drone/issues/2679#issue-435262568\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Trigger build for Branch, Commit</a></li>\n</ul>\n<p>根据官方人员的解释：</p>\n<blockquote>\n<p>When you deploy, you are essentially “promoting” a build, which means you need to provide the build number you are promoting, and the environment you are promoting to. For example:</p>\n</blockquote>\n<blockquote>\n<p>drone deploy octocat/hello-world 42 production</p>\n</blockquote>\n<blockquote>\n<p>In the above example, you are promoting build 42 to production. This will execute a deployment event in the system with environment name production.</p>\n</blockquote>\n<p>也就是说你只能对<code class=\"language-text\">已经存在</code>的build进行触发让这个<code class=\"language-text\">已经测试构建完成的</code>build进行部署，而不能从头创建一个新的build。也就是说，上述的工具能大致满足上面提出的那串需求，但本质上还是不同的：</p>\n<ul>\n<li>测试构建等必须是一个单独的行为，需要先行做完，并形成一个完成的build</li>\n<li>需要手动触发（因为你需要确认build号，所以这个行为必然是手动的，不可能自动化）这个完成的build，让yaml中配置为promote的event触发，进行部署</li>\n</ul>\n<h3 id=\"452-plugin\" style=\"position:relative;\"><a href=\"#452-plugin\" aria-label=\"452 plugin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.2 plugin</h3>\n<p>官方有一个插件叫：<a href=\"http://plugins.drone.io/drone-plugins/drone-downstream/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Downstream Build</a>。乍看之下貌似是满足需求的，但我实际扒了下源码，发现这个插件的本质其实就是封装了下官方的API。所以实际上和4.5.1一样，不行。</p>\n<h3 id=\"453-webhook-plugin\" style=\"position:relative;\"><a href=\"#453-webhook-plugin\" aria-label=\"453 webhook plugin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.3 webhook plugin</h3>\n<p>后续的思路是尝试使用webhook插件，在构建pipeline完成之后用webhook触发一个构建：<a href=\"http://plugins.drone.io/drone-plugins/drone-webhook/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Webhook</a>。</p>\n<p>文档工作总是半吊子，参数有几个根本不知道具体应该填什么，只能随便尝试下：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> run --rm <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_URLS</span><span class=\"token operator\">=</span>http://host.docker.internal:18980/hook <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_USERNAME</span><span class=\"token operator\">=</span>root <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_PASSWORD</span><span class=\"token operator\">=</span>Abcd1234_ <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_DEBUG</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_SKIP_VERIFY</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_REPO_OWNER</span><span class=\"token operator\">=</span>fullstack <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_REPO_NAME</span><span class=\"token operator\">=</span>gateway <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_COMMIT_SHA</span><span class=\"token operator\">=</span>2087d78f48 <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_COMMIT_BRANCH</span><span class=\"token operator\">=</span>master <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_BUILD_EVENT</span><span class=\"token operator\">=</span>deployment <span class=\"token punctuation\">\\</span>\n          plugins/webhook:latest\nWebhook <span class=\"token number\">1</span>\n  URL: http://host.docker.internal:18980/hook\n  METHOD: POST\n  HEADERS: map<span class=\"token punctuation\">[</span>Authorization:<span class=\"token punctuation\">[</span>Basic <span class=\"token assign-left variable\">cm9vdDpBYmNkMTIzNF8</span><span class=\"token operator\">=</span><span class=\"token punctuation\">]</span> Content-Type:<span class=\"token punctuation\">[</span>application/json<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  REQUEST BODY: <span class=\"token punctuation\">{</span><span class=\"token string\">\"repo\"</span>:<span class=\"token punctuation\">{</span><span class=\"token string\">\"owner\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"fullstack\"</span>,<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"gateway\"</span><span class=\"token punctuation\">}</span>,<span class=\"token string\">\"build\"</span>:<span class=\"token punctuation\">{</span><span class=\"token string\">\"tag\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"event\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"deployment\"</span>,<span class=\"token string\">\"number\"</span>:0,<span class=\"token string\">\"commit\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2087d78f48\"</span>,<span class=\"token string\">\"ref\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"refs/heads/master\"</span>,<span class=\"token string\">\"branch\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"master\"</span>,<span class=\"token string\">\"author\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"success\"</span>,<span class=\"token string\">\"link\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"started\"</span>:0,<span class=\"token string\">\"created\"</span>:0<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n  RESPONSE STATUS: <span class=\"token number\">200</span> OK\n  RESPONSE BODY:</code></pre></div>\n<p>返回结果是200，正常，但结果本身为<code class=\"language-text\">空</code>。查看drone的UI发现实际上没有任何build被触发。这就很无奈了，这里的问题可能出在：</p>\n<ul>\n<li>操作者：给的参数不正确</li>\n<li>webhook插件：没有发送正确的webhook请求</li>\n<li>drone服务器：忽略了不正确的webhook请求</li>\n</ul>\n<p>无论如何，后续如果要继续的话就需要看源码了，插件的以及服务器的源码。</p>\n<h3 id=\"454-webhook-fake\" style=\"position:relative;\"><a href=\"#454-webhook-fake\" aria-label=\"454 webhook fake permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.4 webhook fake</h3>\n<p>到这里就是非正常思路了。</p>\n<p>因为gitea可以正常触发drone的webhook，思路就是使用curl仿造gitea的请求，发送到drone。其实drone官方也有对webhook的描述：<a href=\"https://discourse.drone.io/t/how-to-use-global-webhooks/3755\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to use Global Webhooks</a>，但实在是没什么正式的支持，API之类的易用性的工具都没有，只有这篇文章。</p>\n<p>gitea官方有webhook相关的文档：<a href=\"https://docs.gitea.io/en-us/webhooks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Webhooks</a>。</p>\n<p>gitea的钩子可以在这里找到，点击下面的链接可以查看请求细节：</p>\n<p><img src=\"/media/posts/2019/12/drone-ci/gitea1.png\" alt=\"\">\n<img src=\"/media/posts/2019/12/drone-ci/gitea2.png\" alt=\"\">\n<img src=\"/media/posts/2019/12/drone-ci/gitea3.png\" alt=\"\"></p>\n<p>当然这也非常麻烦，而且gitea发送出去的webhook请求里有非常多repo详细信息，如果要做到自动化的话，这块的获取也是很麻烦的一件事情。</p>\n<h3 id=\"455-waiting-hack\" style=\"position:relative;\"><a href=\"#455-waiting-hack\" aria-label=\"455 waiting hack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.5 waiting hack</h3>\n<p>另一个非正常思路就是定义一个pipeline，仅在指定的runner上运行，然后命令中执行脚本，查询私有registry，看目标仓库（镜像）的目标tag是否存在，存在的话就进行部署。而在其他的runner上进行构建和镜像推送操作。</p>\n<p>这样就能做到一开始提的需求，虽然恶心了点。</p>\n<blockquote>\n<p>EOF</p>\n</blockquote>","fields":{"slug":"/posts/2019/12/drone-ci","tagSlugs":["/tag/drone/","/tag/ci/","/tag/devops/","/tag/keynote/"]},"frontmatter":{"date":"2019-12-23T02:36:22.000Z","description":"","tags":["Drone","CI","DevOps","Keynote"],"title":"使用Drone进行CI支持","socialImage":"/media/default-social-image.jpg"}},"allFile":{"totalCount":0,"nodes":[]}},"pageContext":{"slug":"/posts/2019/12/drone-ci","gallery":"media/posts/2019/12/drone-ci/gallery"}},"staticQueryHashes":["251939775","357378587","401334301"]}