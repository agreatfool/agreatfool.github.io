{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2019/12/drone-ci","result":{"data":{"markdownRemark":{"id":"fc5931cd-f47a-5c13-a221-10909f976170","html":"<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>Drone是一个Golang技术栈的CI解决方案，功能和Jenkins之类的CI工具类似。</p>\n<p>优点：</p>\n<ul>\n<li>Golang编写，分发及搭建非常容易（镜像体积很小）</li>\n<li>Golang编写，运行时占用资源极小（特指和Java栈的一系列工具比较）</li>\n<li>构建运行时以镜像优先，保证在不同平台的构建结果一致</li>\n<li>优秀的设计，支持插件化提供强大的功能支持</li>\n<li>现代化的UI，开箱即用，甩开Jenkins之类有历史包袱的工具几条街</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>较年轻，文档工作需要强化</li>\n<li>插件的数量和质量，以及插件的文档支持需要强化</li>\n<li>功能尚不能说强大，和Jenkins之类的老牌CI相比差距较大</li>\n</ul>\n<p>简单选择：</p>\n<ul>\n<li>\n<p>Drone：</p>\n<ul>\n<li>小型团队，对新技术适应能力较强的团队</li>\n<li>对功能的丰富性要求并不是很高，但要求性能强大功能稳定</li>\n</ul>\n</li>\n<li>\n<p>Jenkins：</p>\n<ul>\n<li>对功能的丰富性要求较高，要求任何情况任何需求都能快速应对</li>\n<li>运维人员对Jenkins非常熟悉可以很快上手使用</li>\n</ul>\n</li>\n</ul>\n<p>相关资源：</p>\n<ul>\n<li>官方站点：<a href=\"https://drone.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">drone.io</a></li>\n<li>文档站点：<a href=\"https://docs.drone.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docs.drone.io</a></li>\n<li>官方论坛：<a href=\"https://discourse.drone.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">discourse.drone.io</a></li>\n</ul>\n<h1 id=\"2-概念\" style=\"position:relative;\"><a href=\"#2-%E6%A6%82%E5%BF%B5\" aria-label=\"2 概念 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 概念</h1>\n<h2 id=\"21-pipeline\" style=\"position:relative;\"><a href=\"#21-pipeline\" aria-label=\"21 pipeline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 <a href=\"https://docs.drone.io/configure/pipeline/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pipeline</a></h2>\n<ul>\n<li>pipeline是drone的核心概念</li>\n<li>pipeline一般负责完成一个<code class=\"language-text\">任务</code>：构建、发布、部署，其内部会有多个行为共同组成一个pipeline</li>\n<li>\n<p>pipeline在drone里是进行分类的，按类型有多种种类，常用的有：</p>\n<ul>\n<li>\n<p><a href=\"https://docker-runner.docs.drone.io/configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docker</a>：所有的构建行为都在临时docker容器内进行，跨平台保证行为一致</p>\n<ul>\n<li><a href=\"https://exec-runner.docs.drone.io/configuration/variables/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Environment Variables</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://exec-runner.docs.drone.io/configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">exec</a>：所有的构建行为都在runner所在主机上进行，一般用在某些不方便放在容器内运行的工作，e.g xcode项目的构建</p>\n<ul>\n<li><a href=\"https://docker-runner.docs.drone.io/configuration/environment/variables/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Environment Variables</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://ssh-runner.docs.drone.io/configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ssh</a>：构建行为通过ssh执行远程命令进行</p>\n<ul>\n<li><a href=\"https://ssh-runner.docs.drone.io/configuration/variables/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Environment Variables</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"22-step\" style=\"position:relative;\"><a href=\"#22-step\" aria-label=\"22 step permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 <a href=\"https://docker-runner.docs.drone.io/configuration/steps/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">step</a></h2>\n<ul>\n<li>pipeline里的每一个操作被称为<code class=\"language-text\">step</code></li>\n<li>\n<p>组织多个<code class=\"language-text\">step</code>可以完成一个特定的pipeline，e.g</p>\n<ul>\n<li>构建pipeline：clone、安装依赖、单元测试、打包、制作镜像、推送镜像</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"23-workspace\" style=\"position:relative;\"><a href=\"#23-workspace\" aria-label=\"23 workspace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 <a href=\"https://docker-runner.docs.drone.io/configuration/workspace/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">workspace</a></h2>\n<ul>\n<li>构建运行的工作空间，在不同的环境下其位置会有所不同</li>\n<li>Posix系统（含docker容器），工作空间在：<code class=\"language-text\">/tmp/drone-${RANDOM}/drone/src</code></li>\n<li>OSX系统，工作空间在：<code class=\"language-text\">/private/var/folders/...</code></li>\n<li>Win系统，工作空间在：<code class=\"language-text\">C:\\windows\\drone-%RANDOM%\\drone\\src</code></li>\n<li>有一点要强调下，如果在bash脚本中访问当前pipeline的<code class=\"language-text\">~</code>或<code class=\"language-text\">$HOME</code>，获得的地址就是workspace的根目录，而<code class=\"language-text\">不是</code>当前runner的用户home</li>\n<li>此外，workspace是临时的，会在pipeline创建的时候产生，并在完成的时候被销毁</li>\n</ul>\n<h2 id=\"24-trigger\" style=\"position:relative;\"><a href=\"#24-trigger\" aria-label=\"24 trigger permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 <a href=\"https://docker-runner.docs.drone.io/configuration/trigger/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">trigger</a></h2>\n<ul>\n<li>trigger决定当前的<code class=\"language-text\">pipeline</code>是否要<code class=\"language-text\">触发</code></li>\n<li>\n<p>trigger有很多类型：</p>\n<ul>\n<li>根据分支：e.g 是否dev分支</li>\n<li>根据事件：e.g 是否tag事件（注意，tag和分支trigger不能同时存在，因为tag是不区分分支的）</li>\n<li>根据reference：e.g refs/tags/**</li>\n<li>根据代码库：e.g octocat/hello-world</li>\n<li>根据runner实例：e.g drone.instance1.com</li>\n<li>根据状态触发：e.g failure</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"25-condition\" style=\"position:relative;\"><a href=\"#25-condition\" aria-label=\"25 condition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 <a href=\"https://docker-runner.docs.drone.io/configuration/conditions/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">condition</a></h2>\n<ul>\n<li>condition决定当前的<code class=\"language-text\">step</code>是否要<code class=\"language-text\">触发</code></li>\n<li>\n<p>condition有很多类型：</p>\n<ul>\n<li>根据分支：e.g 是否dev分支</li>\n<li>根据事件：e.g 是否tag事件（注意，tag和分支condition不能同时存在，因为tag是不区分分支的）</li>\n<li>根据reference：e.g refs/tags/**</li>\n<li>根据代码库：e.g octocat/hello-world</li>\n<li>根据runner实例：e.g drone.instance1.com</li>\n<li>根据状态触发：e.g failure</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"3-架构--multiple-pipeline--parallelism\" style=\"position:relative;\"><a href=\"#3-%E6%9E%B6%E6%9E%84--multiple-pipeline--parallelism\" aria-label=\"3 架构  multiple pipeline  parallelism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 架构 &#x26; Multiple Pipeline &#x26; Parallelism</h1>\n<h2 id=\"31-架构\" style=\"position:relative;\"><a href=\"#31-%E6%9E%B6%E6%9E%84\" aria-label=\"31 架构 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 架构</h2>\n<p>Drone这个CI其实很简单，也说不上什么架构。一般Drone会有一个单点Server，在git工具上注册好webhook接收事件，然后启动多个Runner来处理Server上产生的任务。这些Runner可以在同一台主机上，也可以分散在多台不同的主机上，官方文档的指引中要求不要将runner和server放在同一台主机上。</p>\n<h2 id=\"32-multiple-pipeline\" style=\"position:relative;\"><a href=\"#32-multiple-pipeline\" aria-label=\"32 multiple pipeline permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 Multiple Pipeline</h2>\n<p>官方说明：</p>\n<blockquote>\n<p>Drone supports configuring and orchestrating multiple pipelines. This is useful when you need to fan-out and distribute your build tasks across multiple machines to reduce build times, or to execute your build tasks across multiple platforms (e.g. amd64 and arm64).</p>\n</blockquote>\n<p><strong>用途1：</strong></p>\n<p>在处理大型项目任务的时候，将任务拆散，分散到不同的物理机上进行并行处理，加速整个构建进程。如果是不同主机的话，需要用到<code class=\"language-text\">2.4</code>提到的pipeline trigger，将不同的pipeline设定好自己的运行目标主机。保证同一个repo在不同主机上触发的时候，只有当前主机（runner）应该执行的pipeline得到执行。</p>\n<p><strong>用途2：</strong></p>\n<p>确定pipeline之间的先后顺序，通过在pipeline一级定义<code class=\"language-text\">depends_on</code>来申明相互之间的依赖关系。这里特别需要注意的是：pipeline之间是不共享workspace的。所以每一步都需要单独做类似于依赖安装之类的工作，这需要特别小心。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> p3\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notify\n  <span class=\"token comment\"># ...</span>\n\n<span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> p1\n  <span class=\"token punctuation\">-</span> p2</code></pre></div>\n<h2 id=\"33-parallelism\" style=\"position:relative;\"><a href=\"#33-parallelism\" aria-label=\"33 parallelism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 Parallelism</h2>\n<p>这部分内容与 Multiple Pipeline 的关系，和之前讲过的 trigger 与 condition 的关系一样。Multiple Pipeline 是pipeline级别的，而Parallelism则是step级别的，本质上仍旧是并行运行。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3\n  <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token comment\"># ...</span>\n  <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> s1\n    <span class=\"token punctuation\">-</span> s2</code></pre></div>\n<h1 id=\"4-使用\" style=\"position:relative;\"><a href=\"#4-%E4%BD%BF%E7%94%A8\" aria-label=\"4 使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 使用</h1>\n<h2 id=\"41-server：安装--运行\" style=\"position:relative;\"><a href=\"#41-server%EF%BC%9A%E5%AE%89%E8%A3%85--%E8%BF%90%E8%A1%8C\" aria-label=\"41 server：安装  运行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 Server：安装 &#x26; 运行</h2>\n<h3 id=\"411-oauth2准备\" style=\"position:relative;\"><a href=\"#411-oauth2%E5%87%86%E5%A4%87\" aria-label=\"411 oauth2准备 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.1 OAuth2准备</h3>\n<p>需要在git repo软件上申请一个OAuth应用。这里我使用的是Gitea，就拿它来做演示：</p>\n<p>点击：<code class=\"language-text\">右上角头像 > 设置（下拉菜单） > 应用（页面中间）</code>，打开的页面是管理用户级别的<code class=\"language-text\">Access Tokens</code>和<code class=\"language-text\">OAuth2应用</code>的。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f52c9adde13a02ceb796ac874ebb9be0/064b2/oauth1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABPElEQVQoz4WSXW+CMBSG+///wS79YCI4kmm2293vHyzuwmlEKEyotEBLC3st0WSbbE/ak5eWw/mCOO7E8/zp1HGc+9FoPB5PZjO3X647v+r53PMXD8un5yB4XPiBvwx8zyNd13YDGGOGrlSjGqMJ52K33e73++PxmGVZbxljEHFM8zzPMhh23oydLIUQ0EVREKlklERJkuCBWZRSWhuNbYwVZ32xFiFS+z6RWkUnygvetm3TNPCEtbXgoO3F99XV63VOaSUlUVJ+bDY0oZxzhC3L0vr8Ba5RihCCoPKaV60+hwVIquuDDoNypJSwJJfF3dZ7SV/tJ/+J+QNSyfotet99hqUo5S/qAaqqQgKoWSUHGoVRHMf9hECappRSzOy2P061Rv4EdWPI6Bb6bC70E7nxk9heNuHhtFpBfQGZYGx9avKsAAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f52c9adde13a02ceb796ac874ebb9be0/8ac56/oauth1.webp 240w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/d3be9/oauth1.webp 480w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/e46b2/oauth1.webp 960w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/f992d/oauth1.webp 1440w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/e6e89/oauth1.webp 1874w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f52c9adde13a02ceb796ac874ebb9be0/8ff5a/oauth1.png 240w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/e85cb/oauth1.png 480w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/d9199/oauth1.png 960w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/07a9c/oauth1.png 1440w,\n/static/f52c9adde13a02ceb796ac874ebb9be0/064b2/oauth1.png 1874w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f52c9adde13a02ceb796ac874ebb9be0/d9199/oauth1.png\"\n            alt=\"oauth1\"\n            title=\"oauth1\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>找到：<code class=\"language-text\">创建新的 OAuth2 应用程序</code>这一栏，输入：</p>\n<ul>\n<li>应用名称：这名字后面用不到，填可理解的内容即可</li>\n<li><code class=\"language-text\">重定向 URI</code>：<a href=\"http://%60$%7Bdrone_host%7D:$%7Bdrone_ip%7D%60/login\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://`${drone_host}:${drone_ip}`/login</a></li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dec1690a24028920c9f70c8d711173b7/7e117/oauth2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQY042PzQrCMBAG8/7gM/gcnhU8KCiCHqRVUGhtmzbGJM3PJhtjD95aOsxpBz5YUpblbYBS2nVd27aMMTWOVMobBQF674nW2hjjnDVa90NOlzhJxuB5zv09J5x/ZFpTvXPwz4ijprh/ucv6AKcjqaqibgqp3taqGAHRJeO0EX77iERLBpbHqDGImXovPPAAkuTNdffYMl4IXglRR1TzlBg0WdWbRbakphteDfNNfAEI1ZVieBRspgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/dec1690a24028920c9f70c8d711173b7/8ac56/oauth2.webp 240w,\n/static/dec1690a24028920c9f70c8d711173b7/d3be9/oauth2.webp 480w,\n/static/dec1690a24028920c9f70c8d711173b7/e46b2/oauth2.webp 960w,\n/static/dec1690a24028920c9f70c8d711173b7/f992d/oauth2.webp 1440w,\n/static/dec1690a24028920c9f70c8d711173b7/0a3b3/oauth2.webp 1715w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/dec1690a24028920c9f70c8d711173b7/8ff5a/oauth2.png 240w,\n/static/dec1690a24028920c9f70c8d711173b7/e85cb/oauth2.png 480w,\n/static/dec1690a24028920c9f70c8d711173b7/d9199/oauth2.png 960w,\n/static/dec1690a24028920c9f70c8d711173b7/07a9c/oauth2.png 1440w,\n/static/dec1690a24028920c9f70c8d711173b7/7e117/oauth2.png 1715w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/dec1690a24028920c9f70c8d711173b7/d9199/oauth2.png\"\n            alt=\"oauth2\"\n            title=\"oauth2\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>点击<code class=\"language-text\">创建应用</code>。</p>\n<p>在打开的页面上显示了OAuth2应用的相关信息，这里需要记下：</p>\n<ul>\n<li>客户端ID</li>\n<li>客户端秘钥</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d1ac13873b6cf0abdf715f01dc7ebd18/b2b2c/oauth3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAl0lEQVQoz5WPTRLCIAxGuf8lPII3cO8xYCHSFpPKPwOtQVa6KX2bzCTz5svHpJRCCM7564vWGgDdEdZa7z3rI8boG20bQtgH2LaNKaUAgISmOldK6YdDaq1sXRGxyWR2P+c8Ks8aH88ppUhOohFjDx96W8Pbhfy3HU1elpn6jjs/MiBQaepqjKHO5+QLv96mOyWX2jglfwBncw+0ztfILgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d1ac13873b6cf0abdf715f01dc7ebd18/8ac56/oauth3.webp 240w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/d3be9/oauth3.webp 480w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/e46b2/oauth3.webp 960w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/f992d/oauth3.webp 1440w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/44f6d/oauth3.webp 1708w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d1ac13873b6cf0abdf715f01dc7ebd18/8ff5a/oauth3.png 240w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/e85cb/oauth3.png 480w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/d9199/oauth3.png 960w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/07a9c/oauth3.png 1440w,\n/static/d1ac13873b6cf0abdf715f01dc7ebd18/b2b2c/oauth3.png 1708w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d1ac13873b6cf0abdf715f01dc7ebd18/d9199/oauth3.png\"\n            alt=\"oauth3\"\n            title=\"oauth3\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"412-启动drone\" style=\"position:relative;\"><a href=\"#412-%E5%90%AF%E5%8A%A8drone\" aria-label=\"412 启动drone permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.2 启动drone</h3>\n<p>Golang应用程序，使用上最容易的方式仍旧是镜像：<a href=\"https://hub.docker.com/r/drone/drone\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">drone/drone</a>。</p>\n<p>drone服务器启动时的环境变量文档在：<a href=\"https://docs.drone.io/installation/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drone Documentation > Installation > Reference</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker run -it -d <span class=\"token punctuation\">\\</span>\n    --name drone-server <span class=\"token punctuation\">\\</span>\n    -p <span class=\"token number\">18980</span>:80 <span class=\"token punctuation\">\\</span>\n    --log-driver<span class=\"token operator\">=</span>json-file <span class=\"token punctuation\">\\</span>\n    --log-opt max-size<span class=\"token operator\">=</span>512m <span class=\"token punctuation\">\\</span>\n    -v /tmp/drone/data:/data <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># sqlite db file</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_DEBUG</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_COLOR</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_PRETTY</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_LOGS_TRACE</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n    -e <span class=\"token assign-left variable\">DRONE_AGENTS_ENABLED</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>                                              <span class=\"token comment\"># drone server running with no agents, start runners manually</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_SKIP_VERIFY</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>                                           <span class=\"token comment\"># gitea: use http protocol</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_SERVER</span><span class=\"token operator\">=</span>http://host.docker.internal:13000 <span class=\"token punctuation\">\\</span>                   <span class=\"token comment\"># gitea: server address with protocol</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_CLIENT_ID</span><span class=\"token operator\">=</span>fd023edb-7976-4d50-a92f-b16612683240 <span class=\"token punctuation\">\\</span>             <span class=\"token comment\"># gitea: oauth client id</span>\n    -e <span class=\"token assign-left variable\">DRONE_GITEA_CLIENT_SECRET</span><span class=\"token operator\">=</span>S4Q6PktE3dKNHPUzZrTdyNJsTThwal4doUWf6jf4eRA<span class=\"token operator\">=</span> <span class=\"token punctuation\">\\</span> <span class=\"token comment\"># gitea: oauth client secret </span>\n    -e <span class=\"token assign-left variable\">DRONE_RPC_SECRET</span><span class=\"token operator\">=</span>d9856af41ffe31f5e8025be020e981be <span class=\"token punctuation\">\\</span>                      <span class=\"token comment\"># drone: runner shall connect server with this secret</span>\n    -e <span class=\"token assign-left variable\">DRONE_SERVER_HOST</span><span class=\"token operator\">=</span>host.docker.internal:18980 <span class=\"token punctuation\">\\</span>                           <span class=\"token comment\"># drone: server address without protocol</span>\n    -e <span class=\"token assign-left variable\">DRONE_SERVER_PROTO</span><span class=\"token operator\">=</span>http <span class=\"token punctuation\">\\</span>                                                <span class=\"token comment\"># drone: server with http protocol</span>\n    drone/drone:1.6.3</code></pre></div>\n<h3 id=\"413-oauth2授权\" style=\"position:relative;\"><a href=\"#413-oauth2%E6%8E%88%E6%9D%83\" aria-label=\"413 oauth2授权 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.3 OAuth2授权</h3>\n<p>访问drone的地址：<code class=\"language-text\">http://host.docker.internal:18980</code>，会跳转到gitea进行授权，授权完成后会跳转回drone。这时应该就已经以刚才制作OAuth2应用的用户身份登录drone了。</p>\n<p>这里说明下，因为gitea和drone都运行在容器内，他们之间相互访问是通过容器名来进行的，而host主机访问这两者都是通过loopback地址，两者之间存在差异，会导致OAuth的过程失败。因此这里统一使用docker MAC desktop版本的<code class=\"language-text\">host.docker.internal</code>域名来贯通内部和外部。但需要额外修改host主机的<code class=\"language-text\">/etc/hosts</code>配置，把这个host解析为loopback地址。</p>\n<h3 id=\"414-ui同步--激活代码库\" style=\"position:relative;\"><a href=\"#414-ui%E5%90%8C%E6%AD%A5--%E6%BF%80%E6%B4%BB%E4%BB%A3%E7%A0%81%E5%BA%93\" aria-label=\"414 ui同步  激活代码库 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.4 UI同步 &#x26; 激活代码库</h3>\n<p>刚完成授权的账户是没有任何代码库的，打开drone首页发现是空列表（即便当前通过OAuth2授权的账号在gitea内有代码库）：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e9439aac7b5b12e2b9281fd8616102cc/3126c/drone1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVQoz2NQNfFQMnIDktJa9pIatkCkbOiiZuqmZuymZOAip+ekoO8kp+Moq+2gbOKmYeGvbuKtZOxp5Bjo4BPNsHzTocXr989fvWfpxgPLNh0EojXbj63bcXztjmNrth1dDUarth5ZuvHg0g0HFqzZM3/NniXr96/cdmTTgdMM/ykADF+//fjx4xeQ9ffvPwiCgC9fv3/+8vXb9x9ANlAMWerb959fvv4Akgzff/z68fP3r19/0ND37z+B0kBZLFI/foF1/WKAsMhAQ1gzMLSAof39J4hDhIbfSOQvho+fv3768u3T52+fv/zArxMY+GBl3z9+/gbU9fXrdwCo2ESCowtbWAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e9439aac7b5b12e2b9281fd8616102cc/8ac56/drone1.webp 240w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/d3be9/drone1.webp 480w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/e46b2/drone1.webp 960w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/f992d/drone1.webp 1440w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/c571f/drone1.webp 1876w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e9439aac7b5b12e2b9281fd8616102cc/8ff5a/drone1.png 240w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/e85cb/drone1.png 480w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/d9199/drone1.png 960w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/07a9c/drone1.png 1440w,\n/static/e9439aac7b5b12e2b9281fd8616102cc/3126c/drone1.png 1876w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e9439aac7b5b12e2b9281fd8616102cc/d9199/drone1.png\"\n            alt=\"drone1\"\n            title=\"drone1\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>点击右上角的<code class=\"language-text\">SYNC</code>就会开始和gitea同步账户的代码库数据，完成后即可获得所有当前账号在gitea内所拥有的代码库列表：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b0da1b1cdcc68fa6ab6f64366b1a0929/2858a/drone2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAy0lEQVQoz8WRXQtBQRCG988iLijKEYpw5cJB1LmSn4izM7Of1qyNuPCRG9PTNjXzNPWuGM53tV5ezSLc1LK83l+1p0VnVrQnRXO0YVrjbb2/jNNeXukuqtmiMVgPV3thnQshGOu0tuFTnc9BacNv7H0QEojIlEAygsZa5z2Tyj3DsxNYUgZJozICkJS2ySwlsOxfF8tHMKSjT3e5lHSSKJH4sHP+Fcb6g2TtQU7dD/xRRlQqBXCL4RuSIo4lSFCAigPnD3jvxLXrZlIuIswrnku2fY4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b0da1b1cdcc68fa6ab6f64366b1a0929/8ac56/drone2.webp 240w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/d3be9/drone2.webp 480w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/e46b2/drone2.webp 960w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/f992d/drone2.webp 1440w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/c33af/drone2.webp 1877w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b0da1b1cdcc68fa6ab6f64366b1a0929/8ff5a/drone2.png 240w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/e85cb/drone2.png 480w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/d9199/drone2.png 960w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/07a9c/drone2.png 1440w,\n/static/b0da1b1cdcc68fa6ab6f64366b1a0929/2858a/drone2.png 1877w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b0da1b1cdcc68fa6ab6f64366b1a0929/d9199/drone2.png\"\n            alt=\"drone2\"\n            title=\"drone2\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>这时候账号下的drone项目都是<code class=\"language-text\">未激活</code>状态，需要点击面板上项目右边的<code class=\"language-text\">ACTIVATE</code>进行激活：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0918042d9fd1c198161dc5bb4966b081/a83dd/drone3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtklEQVQoz5WNTQqDMBBGvf8F2l6iu9obdOO+UCh0U2oNqUnMn0km2hFBRK3U4TEwM99jkkr5sgrSuIIyyoS2ztb+T5KSq9sjf+ZUG4eYTbJUllDGhPpwWVA+vhnbsSY7FwJEpJKGC+09DABuAcabMSgmALGdVdN0ncrmLeIwTgrFNflO4vUFG+Q+p+uYZvx4Ycgp48ou/P8pcwX7M9mlxaHrpJSwLNfOOx8m+BAw3LaxB8d5BsUvblkKzFt2X+AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0918042d9fd1c198161dc5bb4966b081/8ac56/drone3.webp 240w,\n/static/0918042d9fd1c198161dc5bb4966b081/d3be9/drone3.webp 480w,\n/static/0918042d9fd1c198161dc5bb4966b081/e46b2/drone3.webp 960w,\n/static/0918042d9fd1c198161dc5bb4966b081/f992d/drone3.webp 1440w,\n/static/0918042d9fd1c198161dc5bb4966b081/83d4c/drone3.webp 1482w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0918042d9fd1c198161dc5bb4966b081/8ff5a/drone3.png 240w,\n/static/0918042d9fd1c198161dc5bb4966b081/e85cb/drone3.png 480w,\n/static/0918042d9fd1c198161dc5bb4966b081/d9199/drone3.png 960w,\n/static/0918042d9fd1c198161dc5bb4966b081/07a9c/drone3.png 1440w,\n/static/0918042d9fd1c198161dc5bb4966b081/a83dd/drone3.png 1482w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0918042d9fd1c198161dc5bb4966b081/d9199/drone3.png\"\n            alt=\"drone3\"\n            title=\"drone3\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d55696f922f5b0e895cf8ef69cea023f/fe8a7/drone4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCUlEQVQoz41Ry24DIQzk0/sz/Yfc+gU99NxIvazUtAn7CE+DWXdYtpeqWWFZAgzjmTFqsaQXMi5e9aIn43wMMXWmuur5/DF8fo0pM7IfWcF342/jMi32+zajRQjkkTHVrPtDsLUhUlpXSSmnxOsWzIVLQbGUUvf/JR4r6wMY8FRE8i6bytbC+4iKPIjMRYEQzJQyzj7Eu3GYGYqZGX2xPgJjQDsYMnAmgs/YuhxwIqArwjPA1fTOTPA4Wb5oJ2s1baxvjv4E7kIDM+8kbdSYU09Uz3CbfhVCAcSIdIOhU4Rlo7Mu+AjmqvgYuckm9T740+tsQmmltVN0/deiXt7mp+fhMlID9ye+4wdfePtbFy+T1gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d55696f922f5b0e895cf8ef69cea023f/8ac56/drone4.webp 240w,\n/static/d55696f922f5b0e895cf8ef69cea023f/d3be9/drone4.webp 480w,\n/static/d55696f922f5b0e895cf8ef69cea023f/e46b2/drone4.webp 960w,\n/static/d55696f922f5b0e895cf8ef69cea023f/c77ba/drone4.webp 1223w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d55696f922f5b0e895cf8ef69cea023f/8ff5a/drone4.png 240w,\n/static/d55696f922f5b0e895cf8ef69cea023f/e85cb/drone4.png 480w,\n/static/d55696f922f5b0e895cf8ef69cea023f/d9199/drone4.png 960w,\n/static/d55696f922f5b0e895cf8ef69cea023f/fe8a7/drone4.png 1223w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d55696f922f5b0e895cf8ef69cea023f/d9199/drone4.png\"\n            alt=\"drone4\"\n            title=\"drone4\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>点击<code class=\"language-text\">SAVE</code>保存即可。经过这几个操作，drone即激活了对这几个代码库的webhook事件监听。</p>\n<p>至此为止drone本体的安装基本上完成了，后续还需要配置下runner。</p>\n<h3 id=\"415-api秘钥\" style=\"position:relative;\"><a href=\"#415-api%E7%A7%98%E9%92%A5\" aria-label=\"415 api秘钥 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1.5 API秘钥</h3>\n<p>点击右上角的用户头像，然后点击<code class=\"language-text\">User settings</code>会打开用户的设置页面。在这个页面上能找到用户的token。如果有需要使用drone API的话（或者是cli命令行工具），这个token是必须的。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a186ee68477f88b1c92e83fd216c017f/3126c/drone7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA90lEQVQoz42QW0sDMRCF93fri9YibvHSFa03RLALW6mP/qx2u9lcJpNE6klji6yrdPgIZDhnTjLZ1dP78Xg6vC6PLl8P8ufD0ctgPM3v3i4e5+cP83wyO5vMTm+qQVEmTopyWJSj2+q++shC+FxvyvkgFRni9d6VSU3aMDBkyXLAsL4KW4hc1FMk0wYeByx70apGSI02O+d8L8w+6cFPs2tbBS8RrN77EA8fOtheM0YqTQgHq0YuaiGEspY7yfav5GRLn48Q75uM7rIWi2VTr9q6kThbqS36HTrmdEcyYx+blexA8zffYTBjvDIW7J7wPzoqWemo/wK1UC/QRufcqQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a186ee68477f88b1c92e83fd216c017f/8ac56/drone7.webp 240w,\n/static/a186ee68477f88b1c92e83fd216c017f/d3be9/drone7.webp 480w,\n/static/a186ee68477f88b1c92e83fd216c017f/e46b2/drone7.webp 960w,\n/static/a186ee68477f88b1c92e83fd216c017f/f992d/drone7.webp 1440w,\n/static/a186ee68477f88b1c92e83fd216c017f/c571f/drone7.webp 1876w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a186ee68477f88b1c92e83fd216c017f/8ff5a/drone7.png 240w,\n/static/a186ee68477f88b1c92e83fd216c017f/e85cb/drone7.png 480w,\n/static/a186ee68477f88b1c92e83fd216c017f/d9199/drone7.png 960w,\n/static/a186ee68477f88b1c92e83fd216c017f/07a9c/drone7.png 1440w,\n/static/a186ee68477f88b1c92e83fd216c017f/3126c/drone7.png 1876w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a186ee68477f88b1c92e83fd216c017f/d9199/drone7.png\"\n            alt=\"drone7\"\n            title=\"drone7\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"42-runner：安装--运行\" style=\"position:relative;\"><a href=\"#42-runner%EF%BC%9A%E5%AE%89%E8%A3%85--%E8%BF%90%E8%A1%8C\" aria-label=\"42 runner：安装  运行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 Runner：安装 &#x26; 运行</h2>\n<h3 id=\"421-安装\" style=\"position:relative;\"><a href=\"#421-%E5%AE%89%E8%A3%85\" aria-label=\"421 安装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.1 安装</h3>\n<p>服务器设置完成后，如果没有单独安装和运行runner，服务器上所有触发的事件都会是<code class=\"language-text\">Pending</code>状态，而且没有任何日志。</p>\n<p>关于Pending的debug，可以看下官方的一篇帖子：<a href=\"https://discourse.drone.io/t/builds-are-stuck-in-pending-status/4437\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Builds are Stuck in Pending Status</a>。</p>\n<p>Runner的安装见官方文档：<a href=\"https://docs.drone.io/installation/runners/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drone Documentation > Installation > Runners</a>。Runner也分不同的类型，一般常用的是：</p>\n<ul>\n<li><a href=\"https://docs.drone.io/installation/runners/exec/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Exec Runner</a>：直接运行在主机上的runner</li>\n<li><a href=\"https://docs.drone.io/installation/runners/docker/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Docker Runner</a>：运行在docker容器内的runner</li>\n</ul>\n<p>Runner的类型和pipeline的类型并不要求一致，runner只是pipeline的运行者，不管是什么类型的pipeline，都可以在任何类型的runner上运作。举例来说，一个docker类型的pipeline，在exec runner上就会在主机上启动docker容器并运行，而docker runner则是直接在docker容器内运行。</p>\n<h3 id=\"422-运行\" style=\"position:relative;\"><a href=\"#422-%E8%BF%90%E8%A1%8C\" aria-label=\"422 运行 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.2 运行</h3>\n<p><strong>Exec Runner</strong><br>\nExec Runner需要手动在<code class=\"language-text\">~/.drone-runner-exec/config</code>创建一个配置文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">DRONE_DEBUG</span><span class=\"token operator\">=</span>true\n<span class=\"token assign-left variable\">DRONE_LOG_FILE</span><span class=\"token operator\">=</span>/tmp/drone-runner-exec.txt\n<span class=\"token assign-left variable\">DRONE_LOG_FILE_MAX_SIZE</span><span class=\"token operator\">=</span><span class=\"token number\">50</span>\n<span class=\"token assign-left variable\">DRONE_RPC_DUMP_HTTP</span><span class=\"token operator\">=</span>true\n<span class=\"token assign-left variable\">DRONE_RPC_DUMP_HTTP_BODY</span><span class=\"token operator\">=</span>true\n<span class=\"token assign-left variable\">DRONE_RPC_PROTO</span><span class=\"token operator\">=</span>http\n<span class=\"token assign-left variable\">DRONE_RPC_HOST</span><span class=\"token operator\">=</span>host.docker.internal:18980\n<span class=\"token assign-left variable\">DRONE_RPC_SECRET</span><span class=\"token operator\">=</span>d9856af41ffe31f5e8025be020e981be\n<span class=\"token assign-left variable\">DRONE_RUNNER_PATH</span><span class=\"token operator\">=</span><span class=\"token environment constant\">$HOME</span>/.yarn/bin:<span class=\"token environment constant\">$HOME</span>/.config/yarn/global/node_modules/.bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</code></pre></div>\n<p>更多的配置项可以查阅官方文档：<a href=\"https://exec-runner.docs.drone.io/installation/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Exec Runner > Installation > Configuration Reference</a>。</p>\n<p>配置文件里最重要的是<code class=\"language-text\">DRONE_RPC_HOST``DRONE_RPC_SECRET</code>这两项。修改完成后记得重启runner：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ drone-runner-exec <span class=\"token function\">service</span> stop <span class=\"token operator\">&amp;&amp;</span> drone-runner-exec <span class=\"token function\">service</span> start</code></pre></div>\n<p>Runner在执行pipeline操作时候的用户即是runner启动时的用户，这需要非常小心，否则会搞错用户导致权限错误。此外，在2.3 workspace的时候也提到过了，在runner执行pipeline的时候，<code class=\"language-text\">~</code>指向的是workspace的根目录，而不是用户的home，这点要非常小心。</p>\n<p>举例来说，存放在<code class=\"language-text\">$HOME/.docker</code>下的凭证在exec runner运行的时候是不可访问的（<code class=\"language-text\">~</code>会定位到workspace而不是<code class=\"language-text\">$HOME</code>），这会导致私有registry的访问失败。同样的，pipeline运行时的PATH也不同于用户自身的PATH，需要在配置文件中设置好<code class=\"language-text\">DRONE_RUNNER_PATH</code>。</p>\n<p><strong>Docker Runner</strong><br>\n这部分就非常简单了，无非就是一个docker容器，直接使用对应的官方镜像即可：<a href=\"https://hub.docker.com/r/drone/drone-runner-docker\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">drone/drone-runner-docker</a>。</p>\n<p>相关配置项可以查阅官方文档：<a href=\"https://docker-runner.docs.drone.io/installation/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Docker Runner > Installation > Configuration Reference</a>。</p>\n<h2 id=\"43-ui秘钥设置\" style=\"position:relative;\"><a href=\"#43-ui%E7%A7%98%E9%92%A5%E8%AE%BE%E7%BD%AE\" aria-label=\"43 ui秘钥设置 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 UI秘钥设置</h2>\n<p>在执行pipeline的时候不可避免需要访问一些密码秘钥之类的信息，而构建过程中，理论上runner只能访问代码库里的内容。这就造成了问题，因为代码库并不是安全的存放秘钥的地方。针对这样的问题，drone有对应的解决方案。</p>\n<p>在drone ui仓库的设置中，有一处：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/262ffcfd007b301c9a7469be3d12ab93/bb3b7/drone5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.25000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwklEQVQoz5WPvQrCMBSF8/4IvkJfQNC1jg4uooODILgUpNXWhNZqe/8S0zpJW4iHDwI55yT3qvL5epjKOTuUv3SjhrUi0gAqf7gJVY0tajvl+ifGy7avbC+8OsDf5a+bGUxy8DNOlpml+2iAsAijMDHzaMDvrVrAQlemrJF8UH6xPTKKz6v6Dfnd5DetHyWLDacFVn4sISBsEAGIMRhAUqekjtZpFF83R+2cULdjoEjtztVskc6XWbw3znGLhBQEIH4AFTBJ5pYY5ssAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/262ffcfd007b301c9a7469be3d12ab93/8ac56/drone5.webp 240w,\n/static/262ffcfd007b301c9a7469be3d12ab93/d3be9/drone5.webp 480w,\n/static/262ffcfd007b301c9a7469be3d12ab93/e46b2/drone5.webp 960w,\n/static/262ffcfd007b301c9a7469be3d12ab93/52f78/drone5.webp 1211w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/262ffcfd007b301c9a7469be3d12ab93/8ff5a/drone5.png 240w,\n/static/262ffcfd007b301c9a7469be3d12ab93/e85cb/drone5.png 480w,\n/static/262ffcfd007b301c9a7469be3d12ab93/d9199/drone5.png 960w,\n/static/262ffcfd007b301c9a7469be3d12ab93/bb3b7/drone5.png 1211w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/262ffcfd007b301c9a7469be3d12ab93/d9199/drone5.png\"\n            alt=\"drone5\"\n            title=\"drone5\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>设置完成后，就会保存在drone系统中：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bb26deb3a3be75d565d7e9b5dfe87c7f/d43b4/drone6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQY05WQOw7CMBBEff8CcYScAIk61DQUiAaJhtbpkB3/9s8eIX4abTeanQlpr3upZiaqx8WqHTCU2lMuzGJTtCFuBsDWBhHpFICCFBBpDPArU5gSsydTH0jkRWwqm90sfqAJVmGcyibi8PjkZd2WNb6+2SdH/+YYPlO4PX+nSzxf4/2dzNgbeIcj8p3+ReLU6SSluIEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bb26deb3a3be75d565d7e9b5dfe87c7f/8ac56/drone6.webp 240w,\n/static/bb26deb3a3be75d565d7e9b5dfe87c7f/d3be9/drone6.webp 480w,\n/static/bb26deb3a3be75d565d7e9b5dfe87c7f/e46b2/drone6.webp 960w,\n/static/bb26deb3a3be75d565d7e9b5dfe87c7f/ccc09/drone6.webp 1202w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bb26deb3a3be75d565d7e9b5dfe87c7f/8ff5a/drone6.png 240w,\n/static/bb26deb3a3be75d565d7e9b5dfe87c7f/e85cb/drone6.png 480w,\n/static/bb26deb3a3be75d565d7e9b5dfe87c7f/d9199/drone6.png 960w,\n/static/bb26deb3a3be75d565d7e9b5dfe87c7f/d43b4/drone6.png 1202w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bb26deb3a3be75d565d7e9b5dfe87c7f/d9199/drone6.png\"\n            alt=\"drone6\"\n            title=\"drone6\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>后续在pipeline可以如下的形式进行访问：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> default\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alpine\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">USERNAME</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">from_secret</span><span class=\"token punctuation\">:</span> docker_username\n    <span class=\"token key atrule\">PASSWORD</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">from_secret</span><span class=\"token punctuation\">:</span> docker_password</code></pre></div>\n<p>更多关于secret的设置及访问，可以参见官方文档：<a href=\"https://docs.drone.io/configure/secrets/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drone Documentation > Configuration > Secrets</a>。在这方面，drone支持得非常全面，甚至外部的加密设施也可以支持访问。</p>\n<h2 id=\"44-私有registry\" style=\"position:relative;\"><a href=\"#44-%E7%A7%81%E6%9C%89registry\" aria-label=\"44 私有registry permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 私有Registry</h2>\n<p>在pipeline应用的过程中，比较常见的问题是对于私有registry的访问。毕竟现在的CI基本上都围绕着镜像打转，抓取镜像进行部署或者构建镜像向上推送都是常见需求。</p>\n<p>官方对此也有解决方案：<a href=\"https://discourse.drone.io/t/how-to-pull-private-images-with-1-0/3155\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to pull private images with 1.0</a>。</p>\n<h2 id=\"45-部署--多点事件触发\" style=\"position:relative;\"><a href=\"#45-%E9%83%A8%E7%BD%B2--%E5%A4%9A%E7%82%B9%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91\" aria-label=\"45 部署  多点事件触发 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5 部署 &#x26; 多点事件触发</h2>\n<p>上述的内容基本上把CI的最基础的应用都讲到了，如果只是简单的<code class=\"language-text\">提交代码 > 触发webhook > drone pipeline</code>这个流程的话，是没有问题的。</p>\n<p>那么接下来就可以考虑下稍微复杂点的需求：</p>\n<ul>\n<li>项目的构建和部署需要分开</li>\n<li>构建定义为一个pipeline</li>\n<li>部署定义为一个pipeline</li>\n<li>部署pipeline应该由构建pipeline异步触发</li>\n<li>部署pipeline应该和构建pipeline解耦，两者可能发生在完全隔离的两个物理机的runner上</li>\n</ul>\n<p>然后我简单说下结论：在当前的版本（drone/drone:1.6.3），这个需求<code class=\"language-text\">做不到</code>，如果是按官方的API和功能的话。而使用一些非官方的hacking思路，则可以做到<code class=\"language-text\">基本上一致的效果</code>。</p>\n<p>根据一开始说的，如果单独只是一个构建pipeline，很简单就能做到。而如果要实现刚才列出的需求，就需要在构建pipeline完成并退出之前触发一个额外的事件，只要能触发额外的事件，再配合上：trigger &#x26; condition，保证代码库的pipeline启动的时候，只有部署pipeline进入工作，且只有正确的runner实例进入工作，那一切就通了。</p>\n<p>那么，能不能手动触发一个部署呢？研究了下官方的资料，发现正常途径基本上做不到，只有一些非正常的思路才可以做到。下面说下思路。</p>\n<h3 id=\"451-drone-api--drone-cli\" style=\"position:relative;\"><a href=\"#451-drone-api--drone-cli\" aria-label=\"451 drone api  drone cli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.1 drone api | drone cli</h3>\n<p>首先想到的是看看官方的API中有没有可用的命令（cli实际上就是官方API的封装）：<a href=\"https://docs.drone.io/api/overview/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API文档</a>、<a href=\"https://docs.drone.io/cli/install/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CLI文档</a>。</p>\n<p>发现官方有一个命令：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ drone build promote --help\n  NAME:\n     drone build promote - promote a build\n  \n  USAGE:\n     drone build promote <span class=\"token punctuation\">[</span>command options<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span>repo/name<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>build<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>environment<span class=\"token operator\">></span>\n  \n  OPTIONS:\n     --param value, -p value  custom parameters to be injected into the job environment. Format: <span class=\"token assign-left variable\">KEY</span><span class=\"token operator\">=</span>value\n     --format value           <span class=\"token function\">format</span> output <span class=\"token punctuation\">(</span>default: <span class=\"token string\">\"...\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>结合<code class=\"language-text\">.drone.yml</code>使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> test\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo \"tested\"\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> tag\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> build\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo \"built\"\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> tag\n\n<span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> test\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notify\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notify\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> drone build promote fullstack/gateway 100 production\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">DRONE_SERVER</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//host.docker.internal<span class=\"token punctuation\">:</span><span class=\"token number\">18980</span>\n      <span class=\"token key atrule\">DRONE_TOKEN</span><span class=\"token punctuation\">:</span> K5i8g6PMlLM3tWaPDRagigPkBrl1YKGu\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> tag\n\n<span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> build\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> pipeline\n<span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> exec\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy\n\n<span class=\"token key atrule\">platform</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">os</span><span class=\"token punctuation\">:</span> darwin\n  <span class=\"token key atrule\">arch</span><span class=\"token punctuation\">:</span> amd64\n\n<span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy\n    <span class=\"token key atrule\">commands</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> echo \"deployed\"\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> promote\n      <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> production</code></pre></div>\n<p>测试后发现，如果<code class=\"language-text\">build</code>参数给的是已经存在的构建的话，则会重复之前的构建流程；而如果给的是一个很大的不存在该build的值（比如上面举例的100），则构建在notify这一步失败，并报错：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">+ drone build promote fullstack/gateway <span class=\"token number\">100</span> production\nclient error <span class=\"token number\">404</span>: <span class=\"token punctuation\">{</span><span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"sql: no rows in result set\"</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>查找了下相关资料，并没有找到官方文档，仅在论坛中找到几篇讨论：</p>\n<ul>\n<li><a href=\"https://discourse.drone.io/t/manually-trigger-a-build/874/8\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Manually trigger a build</a></li>\n<li><a href=\"https://discourse.drone.io/t/promoting-a-build-by-branch/4755\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Promoting a build by branch</a></li>\n<li><a href=\"https://github.com/drone/drone/issues/2679#issue-435262568\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Trigger build for Branch, Commit</a></li>\n</ul>\n<p>根据官方人员的解释：</p>\n<blockquote>\n<p>When you deploy, you are essentially “promoting” a build, which means you need to provide the build number you are promoting, and the environment you are promoting to. For example:</p>\n</blockquote>\n<blockquote>\n<p>drone deploy octocat/hello-world 42 production</p>\n</blockquote>\n<blockquote>\n<p>In the above example, you are promoting build 42 to production. This will execute a deployment event in the system with environment name production. </p>\n</blockquote>\n<p>也就是说你只能对<code class=\"language-text\">已经存在</code>的build进行触发让这个<code class=\"language-text\">已经测试构建完成的</code>build进行部署，而不能从头创建一个新的build。也就是说，上述的工具能大致满足上面提出的那串需求，但本质上还是不同的：</p>\n<ul>\n<li>测试构建等必须是一个单独的行为，需要先行做完，并形成一个完成的build</li>\n<li>需要手动触发（因为你需要确认build号，所以这个行为必然是手动的，不可能自动化）这个完成的build，让yaml中配置为promote的event触发，进行部署</li>\n</ul>\n<h3 id=\"452-plugin\" style=\"position:relative;\"><a href=\"#452-plugin\" aria-label=\"452 plugin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.2 plugin</h3>\n<p>官方有一个插件叫：<a href=\"http://plugins.drone.io/drone-plugins/drone-downstream/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Downstream Build</a>。乍看之下貌似是满足需求的，但我实际扒了下源码，发现这个插件的本质其实就是封装了下官方的API。所以实际上和4.5.1一样，不行。</p>\n<h3 id=\"453-webhook-plugin\" style=\"position:relative;\"><a href=\"#453-webhook-plugin\" aria-label=\"453 webhook plugin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.3 webhook plugin</h3>\n<p>后续的思路是尝试使用webhook插件，在构建pipeline完成之后用webhook触发一个构建：<a href=\"http://plugins.drone.io/drone-plugins/drone-webhook/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Webhook</a>。</p>\n<p>文档工作总是半吊子，参数有几个根本不知道具体应该填什么，只能随便尝试下：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker run --rm <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_URLS</span><span class=\"token operator\">=</span>http://host.docker.internal:18980/hook <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_USERNAME</span><span class=\"token operator\">=</span>root <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_PASSWORD</span><span class=\"token operator\">=</span>Abcd1234_ <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_DEBUG</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">PLUGIN_SKIP_VERIFY</span><span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_REPO_OWNER</span><span class=\"token operator\">=</span>fullstack <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_REPO_NAME</span><span class=\"token operator\">=</span>gateway <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_COMMIT_SHA</span><span class=\"token operator\">=</span>2087d78f48 <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_COMMIT_BRANCH</span><span class=\"token operator\">=</span>master <span class=\"token punctuation\">\\</span>\n          -e <span class=\"token assign-left variable\">DRONE_BUILD_EVENT</span><span class=\"token operator\">=</span>deployment <span class=\"token punctuation\">\\</span>\n          plugins/webhook:latest\nWebhook <span class=\"token number\">1</span>\n  URL: http://host.docker.internal:18980/hook\n  METHOD: POST\n  HEADERS: map<span class=\"token punctuation\">[</span>Authorization:<span class=\"token punctuation\">[</span>Basic <span class=\"token assign-left variable\">cm9vdDpBYmNkMTIzNF8</span><span class=\"token operator\">=</span><span class=\"token punctuation\">]</span> Content-Type:<span class=\"token punctuation\">[</span>application/json<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  REQUEST BODY: <span class=\"token punctuation\">{</span><span class=\"token string\">\"repo\"</span>:<span class=\"token punctuation\">{</span><span class=\"token string\">\"owner\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"fullstack\"</span>,<span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"gateway\"</span><span class=\"token punctuation\">}</span>,<span class=\"token string\">\"build\"</span>:<span class=\"token punctuation\">{</span><span class=\"token string\">\"tag\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"event\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"deployment\"</span>,<span class=\"token string\">\"number\"</span>:0,<span class=\"token string\">\"commit\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"2087d78f48\"</span>,<span class=\"token string\">\"ref\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"refs/heads/master\"</span>,<span class=\"token string\">\"branch\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"master\"</span>,<span class=\"token string\">\"author\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"status\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"success\"</span>,<span class=\"token string\">\"link\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"\"</span>,<span class=\"token string\">\"started\"</span>:0,<span class=\"token string\">\"created\"</span>:0<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n  RESPONSE STATUS: <span class=\"token number\">200</span> OK\n  RESPONSE BODY:</code></pre></div>\n<p>返回结果是200，正常，但结果本身为<code class=\"language-text\">空</code>。查看drone的UI发现实际上没有任何build被触发。这就很无奈了，这里的问题可能出在：</p>\n<ul>\n<li>操作者：给的参数不正确</li>\n<li>webhook插件：没有发送正确的webhook请求</li>\n<li>drone服务器：忽略了不正确的webhook请求</li>\n</ul>\n<p>无论如何，后续如果要继续的话就需要看源码了，插件的以及服务器的源码。</p>\n<h3 id=\"454-webhook-fake\" style=\"position:relative;\"><a href=\"#454-webhook-fake\" aria-label=\"454 webhook fake permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.4 webhook fake</h3>\n<p>到这里就是非正常思路了。</p>\n<p>因为gitea可以正常触发drone的webhook，思路就是使用curl仿造gitea的请求，发送到drone。其实drone官方也有对webhook的描述：<a href=\"https://discourse.drone.io/t/how-to-use-global-webhooks/3755\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to use Global Webhooks</a>，但实在是没什么正式的支持，API之类的易用性的工具都没有，只有这篇文章。</p>\n<p>gitea官方有webhook相关的文档：<a href=\"https://docs.gitea.io/en-us/webhooks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Webhooks</a>。</p>\n<p>gitea的钩子可以在这里找到，点击下面的链接可以查看请求细节：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4ed09e611e8411e303413f39b9deb483/064b2/gitea1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8UlEQVQoz6WSS27DMAxEdf9j9QbNOju3KBzYUmh9SP07kpGsmkXbB4MgTM6IoKTIaee9D+wCB+aUUn1QSnkmMUaUkDCzsPgkkqKC8LbthxdNzgfhAAcJk/gAsuE/SqgHbe5ER85ZiQicUT67nRtzIFprjTGIEOA/z6EgGONELjGkU7xtG/og9hM7IaJlWdZ1PSanURi+/u1q3j+o16Lg9zVBt9b6DogM2X3f4Yuj0uSZgMunvd58701hjFyb5Map+lgk1RALEp4x5tp/pJbemsIy2y8ptUEEhyHuf+V/YlzDuYwzeTXq7MkxYQvzw3vJ+RtSYEh1ibzqEwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4ed09e611e8411e303413f39b9deb483/8ac56/gitea1.webp 240w,\n/static/4ed09e611e8411e303413f39b9deb483/d3be9/gitea1.webp 480w,\n/static/4ed09e611e8411e303413f39b9deb483/e46b2/gitea1.webp 960w,\n/static/4ed09e611e8411e303413f39b9deb483/f992d/gitea1.webp 1440w,\n/static/4ed09e611e8411e303413f39b9deb483/e6e89/gitea1.webp 1874w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4ed09e611e8411e303413f39b9deb483/8ff5a/gitea1.png 240w,\n/static/4ed09e611e8411e303413f39b9deb483/e85cb/gitea1.png 480w,\n/static/4ed09e611e8411e303413f39b9deb483/d9199/gitea1.png 960w,\n/static/4ed09e611e8411e303413f39b9deb483/07a9c/gitea1.png 1440w,\n/static/4ed09e611e8411e303413f39b9deb483/064b2/gitea1.png 1874w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4ed09e611e8411e303413f39b9deb483/d9199/gitea1.png\"\n            alt=\"gitea1\"\n            title=\"gitea1\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5c41f1a03d113669a76c51105bf802f0/3707e/gitea2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 296.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAA7CAIAAAD0ET25AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEiUlEQVRIx5VXW2/bNhT2/38ZsJcCA4ZhQ1sk2Dqsw/ayAcMeig3rljbNkhRpazuWL7pSN95FSd5HUYmTzHbkA4YRLX483zk8PDwaUZ4xzrkQaELIqqqapmlb2+6K1hqv6rqWUmqlmJay0iMMopjkTJKcUo6RVEoJKalQVQUIZuKh4p2IToqiKMvCVNXIrmeMe42pjFke6HIq8jwvy9Kq6pZAb4yBcuCxDp5H+MuyDPMwqfuVU0AZo7RcLpdhGAJPKcUE9Lf6KS8tuG1bTAqCAK/TNHWTKFcFFRjCiMqyR2fQ3zTNBAVwtF6vMbk3VQhnsOhYQOCq9VZpbWfB0IB5prP8Vpx72x3S7UinGd4DWwy2KNghcFuv2XkCY7el7QDpNePP9wPgnavBth0mveY4jkHbkVwPkw0YOwmz/z/DWfEIGF4FbeeDu0I72eXIHgwYovKBw9yiIOV+2Qd2MejcBgxCpe4Ei7qQ3gl24Y15LsJMJ1DoDuAjtB09IDF7oMN7MP45bzlxCu8+uEF9LzU0G83rul3X67ppYZm5SRrOct0NZFVLXVf2LBt3pDear8l8XMyzaKlmniLkcc5Wnd3/ERj8uPrts/nx6a/HxedPylevnE1DLB/BABLFyEttbdoGtLTYLUgijVIXKfk9DHqbz2bR0evFy3fh8dv5L++TkqvaVLraIvgRay+K/GOW9uCsKAuuS6WvyqU0gw+HAwd+kJK4LHJBmeDMhZrLEOjxvEW/TTIdeLFYnJ+fz2Yz5EqEWhRF6LFPcrfgba95Pp9fXl5iCcCQRpFMccIRcy5vq22C7e/Bvu+Px+MwCIGB8iiMkiRBViSEgLbeIX0aQvaxV1O3+6419y+qrdJrxs2Tr0L+0eOzFZ/5Iiaqs2qPbGgnCbkeT+gqEq6R/AAwNmPl+7gjcLUoU6lKq8dkA4brsU+ZHyqSySSTeWkb44PACNqF5+XzlViGMi/UALlLm2GrS5IpymT3Rmk9GFzSiefhdtUIz4LKgqq9nB86zJt53I9B2zbPF0F8AO3pdIqwQv1gHY52AG1Krz58iOZLu8lw2GObfN/bXKyCIC3KCrCuUjoAjNj2PG++XOI0gAXKocPACBIPRzJJCsbkQbShbDKZXHteUhRSqcOCBKcqRGy7mkgfGiSUzqZThtiMEhwpBImk7AAwwpOGiYxTG17W54fQDlYr1Hw4SZILhdbdtYPAuNg/fRpn0yWYMxzJEqsMo42MpQSnadKgpqFlq4S296Pej+wToL0xuJ4SdZ3KSapmqdSm3pP/zI304LMVffJH+OVf4Rd/hs9OEqabm8p0i7jKepP0ryJ+fEq+PyPfvSM/X4LHTjC0PXTY+5A/PUmOT5Pnb5If/k25RkHW7ipBbwviWzAD7NvT5Oht8vI8ZXvBD2lfBuzrv+Pnb+JnJ/GLM7If7C7ADW3YfHRKXnQ2/3SRiWqfzbcfKz34wqdfvY6ensTf/BOBPFM7NaOGekhbmSYTdS7rHL0wdbO9ur5b+7uKZ9RteIVqpjEV6pldnwbuC0RVqMYabRplP+7MfxVqWNOS9xwaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5c41f1a03d113669a76c51105bf802f0/8ac56/gitea2.webp 240w,\n/static/5c41f1a03d113669a76c51105bf802f0/d3be9/gitea2.webp 480w,\n/static/5c41f1a03d113669a76c51105bf802f0/e46b2/gitea2.webp 960w,\n/static/5c41f1a03d113669a76c51105bf802f0/f992d/gitea2.webp 1440w,\n/static/5c41f1a03d113669a76c51105bf802f0/6c20f/gitea2.webp 1878w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5c41f1a03d113669a76c51105bf802f0/8ff5a/gitea2.png 240w,\n/static/5c41f1a03d113669a76c51105bf802f0/e85cb/gitea2.png 480w,\n/static/5c41f1a03d113669a76c51105bf802f0/d9199/gitea2.png 960w,\n/static/5c41f1a03d113669a76c51105bf802f0/07a9c/gitea2.png 1440w,\n/static/5c41f1a03d113669a76c51105bf802f0/3707e/gitea2.png 1878w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5c41f1a03d113669a76c51105bf802f0/d9199/gitea2.png\"\n            alt=\"gitea2\"\n            title=\"gitea2\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8a372f63965459c7467eba1a1507bff6/7e117/gitea3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5klEQVQY042QQU/EIBCF+f9/xuMePO3Jg4memmjW2rV2qZUCZaAMLdAKNZp4sNkvjxcC8zIDpKbd7UN5/8ofzzL500WgHXfQWlvQh/e34wclCv3dWR+f+U1RHk607Od1lxij934JYYmRGFBhdquf0Qu3YroOMcRdlo20IVyI00t5oa3gwyCVVJk0W3JjjPufaZpI13VVVbVt2zQNpdRa664jhznnRVHUdf3dChFdXg5/ivCvfg9zGABSZt4IIazbY64hFRMp5SdjQso0gmJ9z9ig1AjaKjCQNWbpJFSAg8qfAZBsQvwCarTKBW8wwFQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/8a372f63965459c7467eba1a1507bff6/8ac56/gitea3.webp 240w,\n/static/8a372f63965459c7467eba1a1507bff6/d3be9/gitea3.webp 480w,\n/static/8a372f63965459c7467eba1a1507bff6/e46b2/gitea3.webp 960w,\n/static/8a372f63965459c7467eba1a1507bff6/f992d/gitea3.webp 1440w,\n/static/8a372f63965459c7467eba1a1507bff6/0a3b3/gitea3.webp 1715w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/8a372f63965459c7467eba1a1507bff6/8ff5a/gitea3.png 240w,\n/static/8a372f63965459c7467eba1a1507bff6/e85cb/gitea3.png 480w,\n/static/8a372f63965459c7467eba1a1507bff6/d9199/gitea3.png 960w,\n/static/8a372f63965459c7467eba1a1507bff6/07a9c/gitea3.png 1440w,\n/static/8a372f63965459c7467eba1a1507bff6/7e117/gitea3.png 1715w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/8a372f63965459c7467eba1a1507bff6/d9199/gitea3.png\"\n            alt=\"gitea3\"\n            title=\"gitea3\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>当然这也非常麻烦，而且gitea发送出去的webhook请求里有非常多repo详细信息，如果要做到自动化的话，这块的获取也是很麻烦的一件事情。</p>\n<h3 id=\"455-waiting-hack\" style=\"position:relative;\"><a href=\"#455-waiting-hack\" aria-label=\"455 waiting hack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5.5 waiting hack</h3>\n<p>另一个非正常思路就是定义一个pipeline，仅在指定的runner上运行，然后命令中执行脚本，查询私有registry，看目标仓库（镜像）的目标tag是否存在，存在的话就进行部署。而在其他的runner上进行构建和镜像推送操作。</p>\n<p>这样就能做到一开始提的需求，虽然恶心了点。</p>\n<blockquote>\n<p>EOF</p>\n</blockquote>","fields":{"slug":"/posts/2019/12/drone-ci","tagSlugs":["/tag/drone/","/tag/ci/","/tag/dev-ops/","/tag/keynote/"]},"frontmatter":{"date":"2019-12-23T02:36:22.000Z","description":"","tags":["Drone","CI","DevOps","Keynote"],"title":"使用Drone进行CI支持","socialImage":{"publicURL":"/static/7e722e026a41a08a8f9a1cc76782dd27/default-social-image.jpg"}}}},"pageContext":{"slug":"/posts/2019/12/drone-ci"}},"staticQueryHashes":["251939775","401334301","825871152"]}