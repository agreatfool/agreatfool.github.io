{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/2019/12/wxpay","result":{"data":{"markdownRemark":{"id":"a53b084d-8352-566b-b54c-af3a982c0052","html":"<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#1-%E5%89%8D%E8%A8%80\">1. 前言</a></li>\n<li>\n<p><a href=\"#2-%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B\">2. 支付流程</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#21-%E7%BD%91%E9%A1%B5%E7%AB%AF\">2.1 网页端</a></li>\n<li><a href=\"#22-%E7%A7%BB%E5%8A%A8%E5%8E%9F%E7%94%9F\">2.2 移动原生</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"#3-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\">3. 准备工作</a></li>\n<li>\n<p><a href=\"#4-api--sdk\">4. API &#x26; SDK</a></p>\n<ul>\n<li><a href=\"#41-sdk%E9%80%89%E6%8B%A9\">4.1 SDK选择</a></li>\n<li>\n<p><a href=\"#42-api%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80\">4.2 API使用基础</a></p>\n<ul>\n<li><a href=\"#421-%E7%BD%91%E9%A1%B5%E7%AB%AF\">4.2.1 网页端</a></li>\n<li><a href=\"#422-%E7%A7%BB%E5%8A%A8%E5%8E%9F%E7%94%9F\">4.2.2 移动原生</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#43-%E5%B8%B8%E7%94%A8%E6%8E%A5%E5%8F%A3\">4.3 常用接口</a></p>\n<ul>\n<li><a href=\"#431-%E7%BB%9F%E4%B8%80%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3\">4.3.1 统一下单接口</a></li>\n<li><a href=\"#432-%E8%AE%A2%E5%8D%95%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3\">4.3.2 订单查询接口</a></li>\n</ul>\n</li>\n<li><a href=\"#44-%E9%87%91%E9%A2%9D%E9%97%AE%E9%A2%98\">4.4 金额问题</a></li>\n<li><a href=\"#45-%E5%9B%9E%E8%B0%83%E5%A4%84%E7%90%86\">4.5 回调处理</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#5-%E6%B2%99%E7%AE%B1%E4%BD%BF%E7%94%A8\">5. 沙箱使用</a></p>\n<ul>\n<li><a href=\"#51-%E6%B2%99%E7%AE%B1%E7%94%B3%E8%AF%B7\">5.1 沙箱申请</a></li>\n<li><a href=\"#52-%E6%B2%99%E7%AE%B1%E4%BD%BF%E7%94%A8\">5.2 沙箱使用</a></li>\n<li><a href=\"#53-%E6%B2%99%E7%AE%B1%E9%97%AE%E9%A2%98\">5.3 沙箱问题</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#6-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86\">6. 错误处理</a></p>\n<ul>\n<li><a href=\"#61-%E5%9B%9E%E8%B0%83%E5%A4%84%E7%90%86\">6.1 回调处理</a></li>\n<li><a href=\"#62-%E4%BF%AE%E5%A4%8D%E8%AE%A2%E5%8D%95\">6.2 修复订单</a></li>\n</ul>\n</li>\n<li><a href=\"#7-%E4%B8%8A%E7%BA%BF%E7%94%9F%E6%95%88\">7. 上线生效</a></li>\n<li>\n<p><a href=\"#appendix\">Appendix</a></p>\n<ul>\n<li><a href=\"#%E9%93%BE%E6%8E%A5\">链接</a></li>\n</ul>\n</li>\n</ul>\n</div>\n<h1 id=\"1-前言\" style=\"position:relative;\"><a href=\"#1-%E5%89%8D%E8%A8%80\" aria-label=\"1 前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 前言</h1>\n<p>微信支付的接入，权当笔记。</p>\n<h1 id=\"2-支付流程\" style=\"position:relative;\"><a href=\"#2-%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B\" aria-label=\"2 支付流程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 支付流程</h1>\n<h3 id=\"21-网页端\" style=\"position:relative;\"><a href=\"#21-%E7%BD%91%E9%A1%B5%E7%AB%AF\" aria-label=\"21 网页端 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 网页端</h3>\n<p>官方文档：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">扫码支付 > 模式二</a>。</p>\n<p>官方配图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 853px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/97a315d7cdbe355b16fa85c2f97116f4/66caf/wxpay_pc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 98.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFZ0lEQVQ4y1WUaVBTVxTHT/JCXkiCYRExoLUEGbGg0hkQcLBARtkkkoCM1LZUCwKBhBHc6gI4boBQLTACBtkqggFDWQJIQuCFrGYhQQSM2hn9YDt2+9CZbh869L1XUHtnznt3zj339/7n3PMutLW1V8pkt6oUCkWVXq/btry8DCOKO76dsq85AEADNoseQaGgUwB+qQAojculs1A6HV9zm1TK/c6eKmEScwYDdcPfDCAAYVu3vEe8T5VXw8ulh7Bgm25YsGO5ru8ckI5HTQD4uJjM6RleEG8q+2NiDwV3w6IdU1p145EGzRDJoeIDAvwDWBQK1X/nziiUcL545oSwD0LCt24JDkxO2YtLBFhHRVjhLNautAT++t/++HNNU8stgofu2BYaE8Dlctf7esOVy1coKIoiwPZgUwnQu6Mw9zO4Wnka3vVPAsSVSEs2LS0tXXvyxHV4/vEig1jfGrwJurt7oLLyAhFGJR4IL3CTW3Z2NjQ1N63uR4jF5JQkwFMgHXaAPNmtlnCtVrvnwYMHGRg2E91SXyUoLSnePDf3KHF+/rFgZGTYBwiZxJf65HIYHx+H9rY2OHmyFLlRV0sUGQbnHpFAE0B+Q01NhH12NtNoNImcTqfQatZlylpursEwrYf5ocWzqKiITsrslNX7f1VX51Xf0MC2Wh5uwDBMNDWFCQ0GvQ9Ji0+AUQAhH4Bjm3OGWq227WaTacesY27b73//Q3O5nkNZ2fE3KYNNr9qPQ/ZrNJpMg8F4oLenO/1Oe7MfNyiCCKBcr7rKGO/t5au12qDvX78ma7ta38uXLoLNZoNJjeZNvakOkyrB9fQpvPrhJ3i+5AS9emCLarhnx8omWvc3XdwhpTIJr13MkSNH3Hk8Hj06Zhe99WZd0pnTJ3gWiyXFYrEKx8bHfVaAar5ON+M7a7f5zy8+8x5W3N3e3y3bvLz8F6lkRouFazRTKU6HM2liYsKH8LEDPgT1SG+0FwoMq32WYTSZ2eLCArLuFLtBlYgDE+02W6bFakvvaG+Nv1FdvnYlA5pgXyoTP7B9Y2Nj4QQsMjISJTqhruZyqNM5l7qwsJC4uLi4R96v4JAKnWZ1vNFohFmHA0x6DHQqRYxaKU8mPhYXF4d0dbSjLY2N/kNDw17SYgmSkSEilXx7r+PApYsXIh8vLK576nL5nT1XjpLAWaOKPzoyiPz6y8/U6utNCH7qlV2y+saWxlpfxcBAJK7u8ASGZeE1JOxT5ehYtLfPWlSl7EvMyhSSmSgUA28b+15Xs0/WgQzYmyyAiJh4WkH+URaR2oJDD9NTatSgN7Avb9zIU9y/H4t3Q6HBYMibnp6OG+m7veH8uTOsY8dKGYGBPPD09ESA8t9fAbG7d0Np6TG8qU+gAoGAuEEoxCXw46uX8IVYAlaAjzTqiSAtps3BFecolaM7J4Z6dp88XuqVX1BIT05JBSaTSbKQwPffo/H5fCguLgapVIpmZmSwCOALlwPutjdCd/tNTsWZssprVyqax4b6DvXK73Nvt7b6RUVFeUkkEj+xWIympaW9BRKWkJAA+CKUlJQQCt2JlDmeXiApEsPZL0+5F3lyUnI+ORQ7qZ6UmM3mfJ1OH9xYWxl4vKyUW1BQiAMF/weGhYVBRUUFoRIViUQeISEhNHyOCIRCal5uLlPF5WYScR2dnVGDg4NpOZ8f9uu/e3uvVFIcmJt3lC4UisDd3R1ZPRnydLy9vcnGO3jwIAs3dllZmXuhWMysrrrK7KHTs8rPn99uMpmy5fL+4LS0VMb+dJGXRCplEtl4eHgAgiAkh0FclrjRV8ztHaOtGNIMEBq7K4ajVCo31tTUclZErMas7mP8C/6gRbw/VhOIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/97a315d7cdbe355b16fa85c2f97116f4/8ac56/wxpay_pc.webp 240w,\n/static/97a315d7cdbe355b16fa85c2f97116f4/d3be9/wxpay_pc.webp 480w,\n/static/97a315d7cdbe355b16fa85c2f97116f4/d8b1f/wxpay_pc.webp 853w\"\n              sizes=\"(max-width: 853px) 100vw, 853px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/97a315d7cdbe355b16fa85c2f97116f4/8ff5a/wxpay_pc.png 240w,\n/static/97a315d7cdbe355b16fa85c2f97116f4/e85cb/wxpay_pc.png 480w,\n/static/97a315d7cdbe355b16fa85c2f97116f4/66caf/wxpay_pc.png 853w\"\n            sizes=\"(max-width: 853px) 100vw, 853px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/97a315d7cdbe355b16fa85c2f97116f4/66caf/wxpay_pc.png\"\n            alt=\"wxpay pc\"\n            title=\"wxpay pc\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>流程涉及到几个角色：</p>\n<ul>\n<li>PC网站网页</li>\n<li>PC网站后台</li>\n<li>微信支付系统</li>\n</ul>\n<p>支付流程如下：</p>\n<ul>\n<li><code class=\"language-text\">用户</code>打开PC网站网页的商品页</li>\n<li><code class=\"language-text\">用户</code>对商品进行下单</li>\n<li><code class=\"language-text\">PC网站网页</code>发送下单请求到PC网站后台</li>\n<li><code class=\"language-text\">PC网站后台</code>在自身系统内生成订单（生成内部订单号），并返回给网页</li>\n<li><code class=\"language-text\">PC网站网页</code>获得内部订单信息，并将用户导向到支付页面</li>\n<li><code class=\"language-text\">用户</code>确认订单内容，并开始付款流程</li>\n<li><code class=\"language-text\">PC网站网页</code>发起支付请求到PC网站后台</li>\n<li><code class=\"language-text\">PC网站后台</code>向微信支付系统发起下单请求，并将返回的信息交付给PC网站网页</li>\n<li><code class=\"language-text\">PC网站网页</code>收到微信支付返回信息，将其中的QRCode渲染到页面</li>\n<li><code class=\"language-text\">用户</code>打开微信，使用扫码的方式完成支付</li>\n<li><code class=\"language-text\">微信支付系统</code>确认支付完成，向notify_url发送回调信息</li>\n<li><code class=\"language-text\">PC网站后台</code>验证微信支付回调完成，标记订单状态为已支付</li>\n</ul>\n<h3 id=\"22-移动原生\" style=\"position:relative;\"><a href=\"#22-%E7%A7%BB%E5%8A%A8%E5%8E%9F%E7%94%9F\" aria-label=\"22 移动原生 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 移动原生</h3>\n<p>官方文档：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">APP支付 > 业务流程</a>。</p>\n<p>官方配图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 894px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3e81527f2a916a0bc8c6c89205cfd521/38af3/wxpay_app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAGiklEQVQ4y12VDVRT5xnHH0KIQIjUaoJtAMdkpUwhEMGQWL6CIHA4VK24o+50nCIreDxOrMWKimun1iGYoK1aBIpQEYKQ7xBIbm6+bnKTe0NCQBQKax3r2s7OdT073c7ObHZv6Fa3e8577jn3fZ/f/b/P/3mfF8ZG77YODg6+pdboUqYw4/NL99wF9dV7o1mhEHM5KUmymJHxYwiFIgJ5efw/JiYWNOGuaABgLi+QgofzxCaAKObZs2fiQtSasrKyXGoONlAjcmy4HxDtbckUZmjHPluAb4EBfja73c7hVE9lZ4MTQOjj8QZpuHcOB6dptBm3ahofBOygHupiVFVVQXFx8WZou/ibjRVlJfGq0bGY3p7eA/LOq00OpzOP+knUhqSkrPUcDv+TxY+fPX7xYgrw+c9HALBg5aGFJFDKYP/+A4yioiKQSqWZ4HUYxF6bjhf6xx/gz4++jPvuyb841v6BaCu1mmQyhRNvHKtzzcy0TJO+g9poNpMm0ZD/PCYzEn7n5+fTwAxwo1oxaddzJzRDIBblMLKzBJEdVMADFgu8a9ZkOffvF5tCIW73kSMp5rQ0qdvnK/ORvl23+npE586+yQnO3I9FECR29+7dUFJSkhkGeq06ntOshu6bH7C6um5Gh6JYsMzhgJ/LFfwV4Fmi9WxY1fy+fbUuH1mGOXGJn3Q2dra/k+fxkuKA3y84ffo0lJaWCsJAPza+Tq3oCwfRo+PJd3CfHQtzGZu33jt+vBAPhdYTAx9tQisqGlDMWYPj+CGS8Lzl8bj2Ljz8E5OOEYlEK1t2UUCzbiSR/oiYTalu3JODaTSrvlSqYFIozMBuXN9DLC4W+qzWnRMl23dAZkYEtTYKtTpjA4GZ1XS5ZGYIIr7PYSYNlExohpNpoNk0mW53OBpsKFqhRlGB6syZn83K5Jvsvb3gnZmF0KACdtbUgGJYAQ2Nhxm0GUqVCuLj4yOqq6uBcpo2RScOuCe4hEMHj5c9qxGjslh5d2yL1uXOtb1xrHamu/sAvrC4zYYgaXRBS0uktNMRjQ31zzQdPRxLCzEajWH3KysrV3I45dCtuzdlhy8+DSQ7EJUonEuNAcYB0gMtLVVG3FNjMZm2p6SmsnOFgmh6Xqnozb8iu5Dvxr0vBfyBVz7//IsKmUzWCCRmKpoi8Fe95NR2t8tRp9eMSuiAk/dnmSNJyWvJoaFcnCoTD45LVlHFXiItYtDzOtUd7vysJ86KToaNPHHixPdbtuolGDq+kZnWwPB50E1Wk6qAiot8X9YR91pHB/uOVst3OZ1ik8XywtbW1pj+vg+fqT/cwrrV835u+2/fyaRM3BIMBssePXqUu6emJmelsG1arm1SCRbDSI5i4MawdnRg90eDw+wrlzvWn3/77bV8QWbUKz9Nj1G0nik1mc11qNW+z2EztfR1XxVjxFws4fXyKZVx5eXlWWFTCLs+YZZEwYMhIsI1kfMg6ILz5y/BqbLtESOdnVF1VMKDPF7MeGHBm0azuZkgyDaScPfhmEk4RTrCW25ubv7BZcJuSAgSKHhdSI5lUl3+63Mdq29eu7YW85Hb7E5no8vtrjUb9L/EentbJ82mYr3eKEKR8YMGjWIrZtWCXHaJKRQKV+qQBpIOQ8J9Pwrz0/ZElx1pQhDLazYnVjdxe7DZrtMdwgnidQS1pYcUPWDU3g4rkrVfiP+w53rsQF8X7Nq1k0HBnmoODj1vIeiA339MJPk9pmw64J9bt4GZwcjG3333VcfM7Mta5diBlkN1ey9dOFWuG+17jsoC41JbW1xLyykoL6/4PyCVQ7pRLs3hP5omLLlL3z4EDxVxLzExazE6OhE91gTnKku5XUcPm+WX20b1auUeBEELbnzQldTXfxt+UVv7P8A8qjnw6C1/tuh9boaYTF96/CksUMBpHk/wiUCQQilmGo428QOVVT/H/YFdqMVabzSo6/UahdCGaOD0qRORTwNfcpiU/MU5EqZ9LgnpcTa+d1LOCibwwclmb9EUF0nQ+Xmp5tp1sX7jxpIRvTZ17O7YiyNDt1Kpwder78DBuqcUqkb6029cbV9H581k1P3EapksOvn6kZjQi5tBl5wsHBCJsrGl3wlsKuWaHOos61VK0BuoQwlx1G3AgcKyvdRdIv0B+Ktjzez35G0rvfDJ3+Fv3zyGi/5Z6FrFgjEuN1FWUJi28JevN3y1vBxLNwCz0cj46utv4EqnPEouuxwpl3XAjh07/gv8N2ELY5J18fRwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3e81527f2a916a0bc8c6c89205cfd521/8ac56/wxpay_app.webp 240w,\n/static/3e81527f2a916a0bc8c6c89205cfd521/d3be9/wxpay_app.webp 480w,\n/static/3e81527f2a916a0bc8c6c89205cfd521/26e8f/wxpay_app.webp 894w\"\n              sizes=\"(max-width: 894px) 100vw, 894px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3e81527f2a916a0bc8c6c89205cfd521/8ff5a/wxpay_app.png 240w,\n/static/3e81527f2a916a0bc8c6c89205cfd521/e85cb/wxpay_app.png 480w,\n/static/3e81527f2a916a0bc8c6c89205cfd521/38af3/wxpay_app.png 894w\"\n            sizes=\"(max-width: 894px) 100vw, 894px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3e81527f2a916a0bc8c6c89205cfd521/38af3/wxpay_app.png\"\n            alt=\"wxpay app\"\n            title=\"wxpay app\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>流程涉及到几个角色：</p>\n<ul>\n<li>PC网站网页</li>\n<li>PC网站后台</li>\n<li>微信支付系统</li>\n</ul>\n<p>支付流程如下：</p>\n<ul>\n<li><code class=\"language-text\">用户</code>打开PC网站网页的商品页</li>\n<li><code class=\"language-text\">用户</code>对商品进行下单</li>\n<li><code class=\"language-text\">PC网站网页</code>发送下单请求到PC网站后台</li>\n<li><code class=\"language-text\">PC网站后台</code>在自身系统内生成订单（生成内部订单号），并返回给网页</li>\n<li><code class=\"language-text\">PC网站网页</code>获得内部订单信息，并将用户导向到支付页面</li>\n<li><code class=\"language-text\">用户</code>确认订单内容，并开始付款流程</li>\n<li><code class=\"language-text\">PC网站网页</code>发起支付请求到PC网站后台</li>\n<li><code class=\"language-text\">PC网站后台</code>向微信支付系统发起下单请求，并将返回的信息交付给PC网站网页</li>\n<li><code class=\"language-text\">PC网站网页</code>收到微信支付返回信息，使用其中的参数唤起微信APP</li>\n<li><code class=\"language-text\">用户</code>在微信APP中完成支付</li>\n<li><code class=\"language-text\">微信支付系统</code>确认支付完成，向notify_url发送回调信息</li>\n<li><code class=\"language-text\">PC网站后台</code>验证微信支付回调完成，标记订单状态为已支付</li>\n</ul>\n<h1 id=\"3-准备工作\" style=\"position:relative;\"><a href=\"#3-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C\" aria-label=\"3 准备工作 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 准备工作</h1>\n<p>微信的权限系统非常有问题，没有分级的子账号，只有一个申请人所拥有的主账号。这导致了后续的一系列操作全部都必须主账号持有人来完成（对，你没有看错，必须你的老板来操作，别人不能代劳）。</p>\n<p>申请人必须操作：</p>\n<ul>\n<li>申请公司账号</li>\n<li>申请支付应用</li>\n</ul>\n<p>申请完成之后，必须获得以下几个信息，程序才可以对接：</p>\n<ul>\n<li>APPID：支付应用的ID</li>\n<li>商户号：商户的ID</li>\n<li>商户的API秘钥：这里切记是<code class=\"language-text\">商户秘钥</code>；微信整个生态中应用非常繁多，因此各种秘钥也多，特别是去生成秘钥的又是老板，一般没有技术经验，所以这步非常非常容易出错，会导致后面验证签名无论如何都不正确，所以一定要当心，必须是商户秘钥</li>\n</ul>\n<p>微信支付也有证书，但这并不是必须项，大部分支付API是不需要证书的，只有部分才需要。证书也是在商户部分申请，申请完之后可以打包下载，里面含文件：</p>\n<ul>\n<li>apiclient_cert.p12：证书pkcs12格式</li>\n<li>apiclient_cert.pem：证书</li>\n<li>apiclient_key.pem：私钥</li>\n</ul>\n<p>申请及配置的相关操作可以看这篇：<a href=\"https://www.leapcloud.cn/website/docs/doc_config/wxwangyezf/wxwangyezhifu.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信公众号支付配置</a>，以及<a href=\"https://www.leapcloud.cn/website/docs/doc_config/wxappzf/weixinapp.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信APP支付配置</a>。</p>\n<p>移动端还会遇到制作应用签名的问题：<a href=\"https://www.leapcloud.cn/website/docs/doc_config/keystorecreate/keystorecreate.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Android App 签名生成教程</a>。</p>\n<h1 id=\"4-api--sdk\" style=\"position:relative;\"><a href=\"#4-api--sdk\" aria-label=\"4 api  sdk permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. API &#x26; SDK</h1>\n<h2 id=\"41-sdk选择\" style=\"position:relative;\"><a href=\"#41-sdk%E9%80%89%E6%8B%A9\" aria-label=\"41 sdk选择 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 SDK选择</h2>\n<p>npm上可用的SDK包基本上只有：<a href=\"https://www.npmjs.com/package/tenpay\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">tenpay</a>。</p>\n<p>SDK的使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> tenpay <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tenpay'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  appid<span class=\"token operator\">:</span> <span class=\"token string\">'公众号ID'</span><span class=\"token punctuation\">,</span>\n  mchid<span class=\"token operator\">:</span> <span class=\"token string\">'微信商户号'</span><span class=\"token punctuation\">,</span>\n  partnerKey<span class=\"token operator\">:</span> <span class=\"token string\">'微信支付安全密钥'</span><span class=\"token punctuation\">,</span>\n  pfx<span class=\"token operator\">:</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'证书文件路径'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  notify_url<span class=\"token operator\">:</span> <span class=\"token string\">'支付回调网址'</span><span class=\"token punctuation\">,</span>\n  spbill_create_ip<span class=\"token operator\">:</span> <span class=\"token string\">'IP地址'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 方式一</span>\n<span class=\"token keyword\">const</span> api <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">tenpay</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 方式二</span>\n<span class=\"token keyword\">const</span> api <span class=\"token operator\">=</span> tenpay<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n<span class=\"token comment\">// 调试模式(传入第二个参数为true, 可在控制台输出数据)</span>\n<span class=\"token keyword\">const</span> api <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">tenpay</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n<span class=\"token comment\">// 沙盒模式(用于微信支付验收)</span>\n<span class=\"token keyword\">const</span> sandboxAPI <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> tenpay<span class=\"token punctuation\">.</span><span class=\"token function\">sandbox</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>config说明:</p>\n<ul>\n<li>appid - 公众号ID(必填)</li>\n<li>mchid - 微信商户号(必填)</li>\n<li>partnerKey - 微信支付安全密钥(必填, 在微信商户管理界面获取)</li>\n<li>\n<p>pfx - 证书文件(选填, 在微信商户管理界面获取)</p>\n<ul>\n<li>当不需要调用依赖证书的API时可不填此参数</li>\n<li>若业务流程中使用了依赖证书的API则需要在初始化时传入此参数</li>\n</ul>\n</li>\n<li>\n<p>notify_url - 支付结果通知回调地址(选填)</p>\n<ul>\n<li>可以在初始化的时候传入设为默认值, 不传则需在调用相关API时传入</li>\n<li>调用相关API时传入新值则使用新值</li>\n</ul>\n</li>\n<li>\n<p>refund_url - 退款结果通知回调地址(选填)</p>\n<ul>\n<li>可以在初始化的时候传入设为默认值, 不传则使用微信商户后台配置</li>\n<li>调用相关API时传入新值则使用新值</li>\n</ul>\n</li>\n<li>\n<p>spbill_create_ip - IP地址(选填)</p>\n<ul>\n<li>可以在初始化的时候传入设为默认值, 不传则默认值为127.0.0.1</li>\n<li>调用相关API时传入新值则使用新值</li>\n</ul>\n</li>\n</ul>\n<p>证书相关可以查阅：<a href=\"https://kf.qq.com/faq/161222NneAJf161222U7fARv.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">什么是API证书？如何获取API证书？</a>。</p>\n<p>如果在接入的时候遇到签名问题，可以使用：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付接口签名校验工具</a>或<a href=\"https://pay.weixin.qq.com/wiki/tools/signverify/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信公众平台支付接口调试工具</a>进行调试。</p>\n<h2 id=\"42-api使用基础\" style=\"position:relative;\"><a href=\"#42-api%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80\" aria-label=\"42 api使用基础 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 API使用基础</h2>\n<h3 id=\"421-网页端\" style=\"position:relative;\"><a href=\"#421-%E7%BD%91%E9%A1%B5%E7%AB%AF\" aria-label=\"421 网页端 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.1 网页端</h3>\n<p>API接入手册：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=4_1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">扫码支付 > 接口规则 > 协议规则</a>。API列表：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">扫码支付 > API列表 > 统一下单</a>。</p>\n<h3 id=\"422-移动原生\" style=\"position:relative;\"><a href=\"#422-%E7%A7%BB%E5%8A%A8%E5%8E%9F%E7%94%9F\" aria-label=\"422 移动原生 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2.2 移动原生</h3>\n<p>API接入手册：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=4_1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">APP支付 > 接口规则 > 协议规则</a>。API列表：<a href=\"https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">APP支付 > API列表 > 统一下单</a>。</p>\n<h2 id=\"43-常用接口\" style=\"position:relative;\"><a href=\"#43-%E5%B8%B8%E7%94%A8%E6%8E%A5%E5%8F%A3\" aria-label=\"43 常用接口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 常用接口</h2>\n<h3 id=\"431-统一下单接口\" style=\"position:relative;\"><a href=\"#431-%E7%BB%9F%E4%B8%80%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3\" aria-label=\"431 统一下单接口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3.1 统一下单接口</h3>\n<p>范例代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>prepay_id<span class=\"token punctuation\">,</span> code_url<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wxpay<span class=\"token punctuation\">.</span><span class=\"token function\">unifiedOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    out_trade_no<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    body<span class=\"token operator\">:</span> name<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// 微信支付的金额是不带小数位的，所有的小数金额都必须*100转为正整数</span>\n    <span class=\"token comment\">// 数值先会被小数点后2位截断或补足，然后转为整数字符串</span>\n    <span class=\"token comment\">// 8.8     => 8.80 => 880</span>\n    <span class=\"token comment\">// 9.24678 => 9.25 => 925</span>\n    total_fee<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    trade_type<span class=\"token operator\">:</span> type<span class=\"token punctuation\">,</span> <span class=\"token comment\">// NATIVE：扫码支付 | APP：原生支付</span>\n    product_id<span class=\"token operator\">:</span> productId<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    prepayId<span class=\"token operator\">:</span> prepay_id<span class=\"token punctuation\">,</span>\n    codeUrl<span class=\"token operator\">:</span> code_url<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>拿到返回值之后，后续根据支付类型不同，处理方式也不一样：</p>\n<p><strong>扫码支付</strong><br>\n需要将code_url的值，转换为QRCode，后续前端才可以将其渲染到HTML页面上（当然也可以直接将url传给前端，让前端渲染）。这里比较好用的是：<a href=\"https://www.npmjs.com/package/qrcode\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">qrcode</a>。</p>\n<p>后端代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> QRCode <span class=\"token operator\">=</span> <span class=\"token keyword\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"qrcode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">const</span> svg <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token punctuation\">(</span>QRCode <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>codeUrl<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span> <span class=\"token string\">\"svg\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>HTML页面：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>qrcode<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 200px<span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 200px<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>前端代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">renderXml</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">id<span class=\"token punctuation\">,</span> xmlString</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span> <span class=\"token comment\">// xmlString: svg content</span>\n  <span class=\"token keyword\">let</span> doc <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DOMParser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseFromString</span><span class=\"token punctuation\">(</span>xmlString<span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> el <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  el<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">.</span>ownerDocument<span class=\"token punctuation\">.</span><span class=\"token function\">importNode</span><span class=\"token punctuation\">(</span>doc<span class=\"token punctuation\">.</span>documentElement<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">renderXml</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"qrcode\"</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>extra<span class=\"token punctuation\">.</span>codeUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>原生支付</strong><br>\n在统一下单接口完成之后，还需要根据prepay_id来申请唤起微信的参数：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wxpay<span class=\"token punctuation\">.</span><span class=\"token function\">getAppParamsByPrepay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>prepay_id<span class=\"token operator\">:</span> prepayId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"432-订单查询接口\" style=\"position:relative;\"><a href=\"#432-%E8%AE%A2%E5%8D%95%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3\" aria-label=\"432 订单查询接口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3.2 订单查询接口</h3>\n<p>范例代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> order <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wxpay<span class=\"token punctuation\">.</span><span class=\"token function\">orderQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>out_trade_no<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"44-金额问题\" style=\"position:relative;\"><a href=\"#44-%E9%87%91%E9%A2%9D%E9%97%AE%E9%A2%98\" aria-label=\"44 金额问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 金额问题</h2>\n<p>在刚才<code class=\"language-text\">4.3.1</code>的例子中，代码里其实已经体现出来了。微信支付的金额和支付宝是不一样的，支付宝的金额就是自然的数额，带小数点后两位。而微信的做法不同，微信要求调用接口下单的时候的支付金额必须不带小数位，所有的金额都是小数点后两位的数字<code class=\"language-text\">*100转化为整数</code>的数额。也就是说下单接口金额为<code class=\"language-text\">1</code>的情况，实际支付的是<code class=\"language-text\">0.01</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 微信支付的金额是不带小数位的，所有的小数金额都必须*100转为正整数</span>\n<span class=\"token comment\">// 数值先会被小数点后2位截断或补足，然后转为整数字符串</span>\n<span class=\"token comment\">// 8.8     => 8.80 => 880</span>\n<span class=\"token comment\">// 9.24678 => 9.25 => 925</span>\ntotal_fee<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"45-回调处理\" style=\"position:relative;\"><a href=\"#45-%E5%9B%9E%E8%B0%83%E5%A4%84%E7%90%86\" aria-label=\"45 回调处理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5 回调处理</h2>\n<p>微信的所有API都是使用XML作为输入和输出，因此获得的回调信息也是XML。因为之前的API调用中都有SDK处理完了，所以这里就有点恶心，需要自己处理。</p>\n<p>回调结构：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IResOrderPayed</span> <span class=\"token punctuation\">{</span>\n    return_code<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SUCCESS</span>\n    return_msg<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// OK</span>\n    appid<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// wx3...</span>\n    mch_id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 156..</span>\n    nonce_str<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// cwGl...</span>\n    sign<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// C51A...</span>\n    result_code<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SUCCESS</span>\n    openid<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// oqvcFj-Uf...</span>\n    is_subscribe<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// N</span>\n    trade_type<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// NATIVE</span>\n    bank_type<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// OTHERS</span>\n    total_fee<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1，需要 / 100</span>\n    fee_type<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// CNY</span>\n    transaction_id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 42000004...</span>\n    out_trade_no<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    attach<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// \"\"</span>\n    time_end<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2019XXXX144155</span>\n    trade_state<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SUCCESS</span>\n    cash_fee<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1，需要 / 100</span>\n    trade_state_desc<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 支付成功</span>\n    cash_fee_type<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// CNY</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"5-沙箱使用\" style=\"position:relative;\"><a href=\"#5-%E6%B2%99%E7%AE%B1%E4%BD%BF%E7%94%A8\" aria-label=\"5 沙箱使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 沙箱使用</h1>\n<p>微信支付的沙箱和支付宝有点不同，支付宝是完全隔离，从环境、访问地址到账号，支付的支付宝APP全部都是单独分离的。微信则不同，账号、测试用APP都还是原来的微信商户号以及用户真实的微信APP，但访问地址是隔离的，在原来的API地址中间插入<code class=\"language-text\">/sandboxnew/</code>。</p>\n<p>虽然易用性上看起来是微信占优，但实际使用上微信的沙箱有相当多的问题，甚至我研发到最后完成，都完全没使用过沙箱，都是使用0.01的金额进行下单测试。</p>\n<h2 id=\"51-沙箱申请\" style=\"position:relative;\"><a href=\"#51-%E6%B2%99%E7%AE%B1%E7%94%B3%E8%AF%B7\" aria-label=\"51 沙箱申请 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1 沙箱申请</h2>\n<p>和支付宝一样，微信支付的沙箱使用不需要额外申请。</p>\n<h2 id=\"52-沙箱使用\" style=\"position:relative;\"><a href=\"#52-%E6%B2%99%E7%AE%B1%E4%BD%BF%E7%94%A8\" aria-label=\"52 沙箱使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.2 沙箱使用</h2>\n<p>使用方面，可以看一篇第三方的教程：<a href=\"https://juejin.im/post/5bea7c1d6fb9a04a053f36c3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">浅析微信支付：如何使用沙箱环境测试</a>。</p>\n<p>在使用刚才说的SDK的情况下，只需要在SDK初始化的地方做点调整即可：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    appid<span class=\"token operator\">:</span> vendorConfig<span class=\"token punctuation\">.</span>appId<span class=\"token punctuation\">,</span>\n    mchid<span class=\"token operator\">:</span> vendorConfig<span class=\"token punctuation\">.</span>mchId<span class=\"token punctuation\">,</span>\n    partnerKey<span class=\"token operator\">:</span> vendorConfig<span class=\"token punctuation\">.</span>appSecret<span class=\"token punctuation\">,</span>\n    pfx<span class=\"token operator\">:</span> LibFs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>LibPath<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">\"../../../pem/wxpay/apiclient_key.pem\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    notify_url<span class=\"token operator\">:</span> vendorConfig<span class=\"token punctuation\">.</span>callbackUrl<span class=\"token punctuation\">,</span>\n    spbill_create_ip<span class=\"token operator\">:</span> vendorConfig<span class=\"token punctuation\">.</span>allowedIp<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> Tenpay<span class=\"token punctuation\">.</span>IConfig<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// wxpay</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isSandbox<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tenpay<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> isTest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSignkey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>sandbox_signkey<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wxpay <span class=\"token operator\">=</span> tenpay<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>partnerKey<span class=\"token operator\">:</span> key<span class=\"token punctuation\">,</span> sandbox<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> isTest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>wxpay <span class=\"token operator\">=</span> tenpay<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> isTest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>沙箱每次使用的秘钥（商户的API秘钥）和正式环境不一样，正式环境是配置死的，直接拿下来用即可。而沙箱则需要先使用正式环境的商户秘钥去调用<code class=\"language-text\">getSignkey</code>获取沙箱使用的临时商户秘钥，才可以后续继续调用API。</p>\n<h2 id=\"53-沙箱问题\" style=\"position:relative;\"><a href=\"#53-%E6%B2%99%E7%AE%B1%E9%97%AE%E9%A2%98\" aria-label=\"53 沙箱问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.3 沙箱问题</h2>\n<p>理解了沙箱的隔离以及如何初始化沙箱SDK之后，如果直接实际调用的话，还是会遇到问题：</p>\n<blockquote>\n<p>沙箱支付金额(1)无效，请检查需要验收的case</p>\n</blockquote>\n<p>参见：<a href=\"https://github.com/Wechat-Group/WxJava/issues/668\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付的沙箱环境能否使用？#668</a>。</p>\n<p>这里还需要额外做一个操作：在<code class=\"language-text\">微信支付商户接入验收助手</code>这个公众号申请你的验收case，写入验收金额作为use case。后续在沙箱环境做测试的时候，金额必须完全符合之前申请的验收case，否则报错。</p>\n<h1 id=\"6-错误处理\" style=\"position:relative;\"><a href=\"#6-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86\" aria-label=\"6 错误处理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. 错误处理</h1>\n<h2 id=\"61-回调处理\" style=\"position:relative;\"><a href=\"#61-%E5%9B%9E%E8%B0%83%E5%A4%84%E7%90%86\" aria-label=\"61 回调处理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6.1 回调处理</h2>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 业务处理</span>\n    \n    ctx<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">\"application/xml\"</span><span class=\"token punctuation\">;</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span>\n<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;xml>\n&lt;return_code>&lt;![CDATA[SUCCESS]]>&lt;/return_code>\n&lt;return_msg>&lt;![CDATA[OK]]>&lt;/return_msg>\n&lt;/xml></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ctx<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">\"application/xml\"</span><span class=\"token punctuation\">;</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span>\n<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;xml>\n&lt;return_code>&lt;![CDATA[FAIL]]>&lt;/return_code>\n&lt;return_msg>&lt;![CDATA[</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>err<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">]]>&lt;/return_msg>\n&lt;/xml></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"62-修复订单\" style=\"position:relative;\"><a href=\"#62-%E4%BF%AE%E5%A4%8D%E8%AE%A2%E5%8D%95\" aria-label=\"62 修复订单 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6.2 修复订单</h2>\n<p>在某些情况下，回调可能没有收到，或者一直报错导致回调没有正常处理。表现在用户视角，就是支付完成后订单状态无法正常改为支付完成（也就不会发货）。这是很糟糕的，因此需要制作修复订单功能。</p>\n<p>客户端在检查到订单状态为等待支付之后，可以提供一个入口给用户，用户点击之后，应用后端应该向支付宝查询订单信息，如果在支付宝这里已经是<code class=\"language-text\">已支付</code>而在应用这边还是<code class=\"language-text\">等待支付</code>的话，就立即将业务订单改为已支付，并向用户发货。</p>\n<h1 id=\"7-上线生效\" style=\"position:relative;\"><a href=\"#7-%E4%B8%8A%E7%BA%BF%E7%94%9F%E6%95%88\" aria-label=\"7 上线生效 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. 上线生效</h1>\n<p>微信支付应该是在应用申请审核通过的时候就直接上线了，不需要额外操作。</p>\n<h1 id=\"appendix\" style=\"position:relative;\"><a href=\"#appendix\" aria-label=\"appendix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Appendix</h1>\n<h2 id=\"链接\" style=\"position:relative;\"><a href=\"#%E9%93%BE%E6%8E%A5\" aria-label=\"链接 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>链接</h2>\n<ul>\n<li><a href=\"https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_Pay/Vendor_Service_Center.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信APP支付接入商户服务中心</a></li>\n<li><a href=\"https://www.jianshu.com/p/753393a0514a\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信APP支付接入</a></li>\n<li><a href=\"https://juejin.im/post/59c4bc7df265da06434b8c2b\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信App支付全解析</a></li>\n<li><a href=\"https://www.leapcloud.cn/website/docs/doc_config/wxwangyezf/wxwangyezhifu.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信公众号支付配置</a></li>\n<li><a href=\"https://www.leapcloud.cn/website/docs/doc_config/wxappzf/weixinapp.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信APP支付配置</a></li>\n<li><a href=\"https://www.leapcloud.cn/website/docs/doc_config/keystorecreate/keystorecreate.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Android App 签名生成教程</a></li>\n<li><a href=\"https://kf.qq.com/faq/161222NneAJf161222U7fARv.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">什么是API证书？如何获取API证书？</a></li>\n<li><a href=\"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信网页开发 > 网页授权</a></li>\n<li><a href=\"https://juejin.im/post/5bea7c1d6fb9a04a053f36c3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">浅析微信支付：如何使用沙箱环境测试</a></li>\n<li><a href=\"https://github.com/Wechat-Group/WxJava/issues/668\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付的沙箱环境能否使用？#668</a></li>\n<li><a href=\"https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付接口签名校验工具</a></li>\n<li><a href=\"https://pay.weixin.qq.com/wiki/tools/signverify/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信公众平台支付接口调试工具</a></li>\n<li><a href=\"https://blog.51cto.com/xihan/2096880\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付接口返回“签名错误”的排查方法</a></li>\n<li><a href=\"https://blog.csdn.net/yhm_brave/article/details/70240935\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付统一下单，签名错误</a></li>\n<li><a href=\"https://blog.csdn.net/qq_35624642/article/details/53667679\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">微信支付统一下单，签名错误（生成的签名和测试工具生成的一样还报错）解决方法</a></li>\n</ul>\n<blockquote>\n<p>EOF</p>\n</blockquote>","fields":{"slug":"/posts/2019/12/wxpay","tagSlugs":["/tag/payment/","/tag/wxpay/"]},"frontmatter":{"date":"2019-12-27T03:36:22.000Z","description":"","tags":["Payment","Wxpay"],"title":"微信支付接入","socialImage":{"publicURL":"/static/7e722e026a41a08a8f9a1cc76782dd27/default-social-image.jpg"}}}},"pageContext":{"slug":"/posts/2019/12/wxpay"}},"staticQueryHashes":["251939775","401334301","825871152"]}