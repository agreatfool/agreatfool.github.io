<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="twitter:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="twitter:title" content="Node.JS Profile 4.1 Profile实践 - Blog by Jonathan Dai"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" property="og:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><meta data-react-helmet="true" property="og:site_name" content="Node.JS Profile 4.1 Profile实践 - Blog by Jonathan Dai"/><meta data-react-helmet="true" name="description" content=""/><meta name="theme-color" content="hsl(31, 92%, 62%)"/><meta name="generator" content="Gatsby 4.12.1"/><style data-href="/styles.5b949cc382fdd55e1237.css" data-identity="gatsby-global-css">html{font-size:100}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizelegibility;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#212121;font-size:16px;line-height:1.625;margin:0 0 0 calc(100vw - 100%)}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:40px;line-height:52px;margin-bottom:26px;margin-top:104px}h2{font-size:27px;line-height:39px}h2,h3{margin-bottom:13px;margin-top:52px}h3{font-size:22px;line-height:26px}h4{font-size:19.2px;margin-top:39px}h4,h5{line-height:26px;margin-bottom:13px}h5,h6{font-size:16px;margin-top:65px}h6{line-height:26px;margin-bottom:13px}img{max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#212121 0,#212121 15px,transparent 0,transparent 26px);background-size:100% 26px;color:#212121;height:26px;margin:52px auto;width:100px}a{color:#5c92ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a145}b,strong{font-weight:600}ul{list-style:square;margin-bottom:26px}ul li{margin-bottom:10px;padding:0 5px}p{line-height:26px;margin-bottom:26px}blockquote{font-style:italic;padding:0;text-align:center}figure{display:block;height:auto;width:100%}figcaption{color:#212121;font-size:14px;font-style:italic;line-height:19.5px;margin-bottom:0;margin-top:6.5px;text-align:center}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:310px;padding:0 26px}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-ms-hyphens:none;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83;cursor:help}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}blockquote{border-left:5px solid #424242!important;color:#424242!important;display:block!important;font-style:normal!important;padding-left:1rem!important;text-align:left!important}table{border-collapse:collapse;box-shadow:0 0 20px rgba(0,0,0,.15)}thead tr{background-color:#009879;color:#fff;text-align:left}td,th{padding:12px 15px}tbody tr{border-bottom:1px solid #ddd}tbody tr:nth-of-type(2n){background-color:#f3f3f3}tbody tr:last-of-type{border-bottom:2px solid #009879}h1{margin-top:0!important}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky{margin-bottom:32.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky:last-child{margin-bottom:13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W{font-size:27px;line-height:39px;margin-bottom:13px;margin-top:0}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE{color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:hover{border-bottom:1px solid #212121;color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--description--UXUO2{font-size:16px;line-height:26px;margin-bottom:19.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--time--17yla{color:#212121;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--divider--3kBgQ{margin:0 13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE{color:#f7a145;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:hover{color:#5c92ff}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-{color:#5c92ff;font-size:16px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Layout-module--layout--36KWw{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--36KWw:before{content:"";display:table}.Layout-module--layout--36KWw:after{clear:both;content:"";display:table}.Page-module--page--2Y5e7{margin-bottom:52px}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:26px 19.5px 0}.Page-module--page--2Y5e7 .Page-module--title--Z69a4{font-size:40px;font-weight:600;line-height:52px;margin-bottom:37.7px;margin-top:0}.Page-module--page--2Y5e7 .Page-module--body--hPYHN{font-size:16px;line-height:26px;margin:0 0 26px}@media screen and (min-width:685px){.Page-module--page--2Y5e7{width:calc(58.275% - 12.5px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(12n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(12n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:32.5px 19.5px 0}}@media screen and (min-width:960px){.Page-module--page--2Y5e7{width:calc(66.6% - 10px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(3n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(3n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:39px 26px 0}}.Pagination-module--pagination--3KtNE{display:flex;margin-top:52px}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8{text-align:left;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:focus,.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj{text-align:right;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:focus,.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Author-module--author--12DFk .Author-module--photo--1WT_U{background-clip:padding-box;border-radius:50%;display:inline-block;height:75px;margin-bottom:0;width:75px}.Author-module--author--12DFk .Author-module--title--2UdHe{font-size:18px;font-weight:600;line-height:29.25px;margin:13px 0}.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:focus,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:hover{color:#212121}.Author-module--author--12DFk .Author-module--subtitle--3HDSh{color:#878787;line-height:26px;margin-bottom:26px}.Icon-module--icon--fdMTB{fill:currentcolor;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;speak:none;stroke:currentcolor;stroke-width:0;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--3rFuK{margin-bottom:26px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:13px 0;max-width:150px;padding:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X{align-content:center;align-items:center;border:1px solid #ebebeb;border-radius:50%;display:flex;height:35px;justify-content:center;line-height:35px;margin:6.5px;padding:0;text-align:center;width:35px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X:nth-child(3n+1){margin-left:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi{border:0;color:#212121;display:flex}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:focus,.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:hover{color:#5c92ff}.Copyright-module--copyright--1IQFN{color:#999;font-size:14px}.Menu-module--menu--3SbXJ{margin-bottom:26px}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI{list-style:none;margin:0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8{margin:13px 0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV{border:0;color:#212121;font-size:16px;font-weight:400}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:focus,.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV.Menu-module--active--aYO_r{border-bottom:1px solid #212121;color:#212121}.Sidebar-module--sidebar--1NhQN{width:100%}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:26px 19.5px 0;position:relative}@media screen and (min-width:685px){.Sidebar-module--sidebar--1NhQN{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:32.5px 19.5px 0}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);bottom:0;content:"";height:540px;position:absolute;right:-10px;top:30px;width:1px}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1NhQN{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:39px}}.Author-module--author--2kT-Q{border-top:1px solid #e6e6e6;line-height:26px;margin-bottom:52px;margin-top:26px;max-width:640px;padding-top:26px}.Author-module--author--2kT-Q .Author-module--bio--2YX8- .Author-module--twitter--1B6I5{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2kT-Q{margin-left:auto;margin-right:auto}}.Content-module--content--3dNJJ{margin:0 auto;max-width:945px;padding:0 13px}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:32px;font-weight:600;line-height:42.9px;margin:26px auto 0;max-width:640px;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure{margin-bottom:26px}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote{font-style:italic;margin-top:0;padding:26px 0;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote p{font-size:26.9072px;line-height:39px;margin-bottom:26px;margin-top:0;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt a{text-decoration:underline}.Content-module--content--3dNJJ .Content-module--body--3LJXt *{margin-left:auto;margin-right:auto;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{visibility:hidden}.Content-module--content--3dNJJ .Content-module--body--3LJXt img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3dNJJ{padding:0}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:48px;line-height:58.5px;margin-bottom:39px;margin-top:58.5px}.Content-module--content--3dNJJ .Content-module--body--3LJXt,.Content-module--content--3dNJJ .Content-module--body--3LJXt p{font-size:18px;line-height:29.25px;margin-bottom:29.25px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{padding-right:26px;visibility:unset}}.Meta-module--meta--3YYBJ .Meta-module--date--U0EV3{font-style:italic}.Tags-module--tags--1r6Jk{margin-bottom:13px}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka{list-style:none;padding:0}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ{display:inline-block;margin:13px 3.25px}@media screen and (min-width:685px){.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ:first-child{margin-left:0;padding-left:0}}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:inline-block;height:35px;line-height:35px;padding:0 19.5px;text-decoration:none}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:focus,.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:hover{color:#5c92ff}.Gallery-module--gallery--2g0Rf{grid-gap:.5em;display:grid;grid-auto-rows:16vw;grid-template-columns:repeat(4,1fr)}.Gallery-module--gallery--2g0Rf>*{box-shadow:0 2px 8px 0 rgba(0,0,0,.2),0 3px 20px 0 rgba(0,0,0,.19)}.Gallery-module--gallery--2g0Rf>:hover{cursor:pointer;-webkit-filter:blur(4px);filter:blur(4px);transition:all .5s ease}.Gallery-module--gallery--2g0Rf>:nth-child(6n+3){grid-column:span 1;grid-row:span 2}.Gallery-module--gallery--2g0Rf>:nth-child(6n+2),.Gallery-module--gallery--2g0Rf>:nth-child(6n+5),.Gallery-module--gallery--2g0Rf>:nth-child(6n+6){grid-column:span 2;grid-row:span 2}.Post-module--post--mo55f .Post-module--content--3cRzw{margin:0 auto}.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{margin:0 auto;max-width:640px;padding:0 13px}.Post-module--post--mo55f .Post-module--button--27HfC{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:block;font-size:16px;font-weight:400;height:35px;line-height:35px;margin-left:auto;margin-right:auto;margin-top:26px;max-width:90px;padding:0 26px;text-align:center}.Post-module--post--mo55f .Post-module--button--27HfC:focus,.Post-module--post--mo55f .Post-module--button--27HfC:hover{color:#5c92ff}@media screen and (min-width:960px){.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{padding:0}.Post-module--post--mo55f .Post-module--button--27HfC{left:30px;margin:0;max-width:none;position:fixed;top:30px}}</style><link rel="alternate" type="application/rss+xml" title="Blog by Jonathan Dai" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-11349149-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-11349149-2', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=bc5f0053fc3ffc2dfb62b5abaa975347" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Node.JS Profile 4.1 Profile实践 - Blog by Jonathan Dai</title><link as="script" rel="preload" href="/webpack-runtime-36b8c7ecf6189fe49091.js"/><link as="script" rel="preload" href="/framework-5af3c233cfe8f9b378d1.js"/><link as="script" rel="preload" href="/app-240856784b6548a98a4c.js"/><link as="script" rel="preload" href="/5576a503ee3134145eb2de8ee0bcd322ef9007e9-89aa5c437fd0655d4835.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-post-template-tsx-f6c7c632cb298ebf6b27.js"/><link as="fetch" rel="preload" href="/page-data/posts/2018/02/node-profile-practice/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/357378587.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--36KWw"><div class="Post-module--post--mo55f"><a class="Post-module--button--27HfC" href="/">All Articles</a><div class="Post-module--content--3cRzw"><div class="Content-module--content--3dNJJ"><h1 class="Content-module--title--3vQh6">Node.JS Profile 4.1 Profile实践</h1><div class="Content-module--body--3LJXt"><div class="table-of-contents">
<ul>
<li><a href="#1-%E5%89%8D%E8%A8%80">1. 前言</a></li>
<li><a href="#2-%E4%BB%8B%E7%BB%8D">2. 介绍</a></li>
<li><a href="#3-node%E5%8E%9F%E7%94%9F%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8Cprofile">3. Node原生工具进行Profile</a>
<ul>
<li><a href="#31-node%E5%AE%98%E6%96%B9guide">3.1 Node官方Guide</a></li>
<li><a href="#32-%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82">3.2 版本要求</a></li>
<li><a href="#33-profile%E8%8C%83%E4%BE%8B">3.3 Profile范例</a></li>
<li><a href="#34-%E8%A7%A3%E6%9E%90profile%E6%97%A5%E5%BF%97">3.4 解析Profile日志</a></li>
<li><a href="#35-%E7%90%86%E8%A7%A3profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9">3.5 理解Profile日志内容</a>
<ul>
<li><a href="#351-shared-libraries">3.5.1 Shared libraries</a></li>
<li><a href="#352-javascriptcsummary">3.5.2 JavaScript、C++、Summary</a>
<ul>
<li><a href="#javascript">JavaScript</a></li>
<li><a href="#c">C++</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#%E5%88%97%E5%90%AB%E4%B9%89">列含义</a></li>
</ul>
</li>
<li><a href="#353-c-entry-points">3.5.3 C++ entry points</a></li>
<li><a href="#354-bottom-up-heavy-profile">3.5.4 Bottom up (heavy) profile</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-%E8%B5%84%E6%96%99">4. 资料</a>
<ul>
<li><a href="#41-%E7%81%AB%E7%84%B0%E5%9B%BE%E7%9B%B8%E5%85%B3">4.1 火焰图相关</a></li>
</ul>
</li>
<li><a href="#5-%E9%99%84%E5%BD%95">5. 附录</a>
<ul>
<li><a href="#51-%E8%A7%A3%E6%9E%90%E5%AE%8C%E6%88%90%E7%9A%84profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9-id51">5.1 解析完成的Profile日志内容 {#ID51}</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="1-前言" style="position:relative;"><a href="#1-%E5%89%8D%E8%A8%80" aria-label="1 前言 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 前言</h1>
<p>本文是系列文章<a href="/2018/01/node-profile/">Node.JS Profile</a>的一部分，完整的文章列表请去总章查看。</p>
<p>本文主要负责介绍Node的命令行Profile知识及实践操作。</p>
<h1 id="2-介绍" style="position:relative;"><a href="#2-%E4%BB%8B%E7%BB%8D" aria-label="2 介绍 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. 介绍</h1>
<p>在系列文章的前几节里，基本上已经把Node应用程序最关键的几个性能指标项目都过了一遍，这几节的主要目的都是为了Profile进行知识储备，并打好对某一方面进行针对性查错的基础。</p>
<p>在掌握了前几节的内容之后，就可以回过头来回到当前这个系列文章的主题<code class="language-text">Profile</code>来了，当然我们这里说的是<code class="language-text">狭义上的Profile（时间消耗）</code>，即观察，并了解Node进程具体在做什么，每一步都花了多少时间，以便有针对性地进行查错和调优。</p>
<p>狭义上的Profile（时间消耗）是非常重要的。一个应用程序如果需要顺利运行需要很多资源，包括且不限于：CPU、内存、磁盘、网络，很多情况下应用程序都会去申请、消耗这些资源以完成自身的工作任务，而Profile让应用程序研发者详细了解应用程序是如何申请、消耗这些资源并完成任务的。只有了解了这些信息之后，研发者才能知道哪里出了问题，哪里还有提升空间。</p>
<p>Note：</p>
<p>本文的版本时效性可能比较敏感，关于行文及范例中使用的Node版本，请查看<a href="/2018/01/node-profile/">总章</a>进行了解。</p>
<h1 id="3-node原生工具进行profile" style="position:relative;"><a href="#3-node%E5%8E%9F%E7%94%9F%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8Cprofile" aria-label="3 node原生工具进行profile permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. Node原生工具进行Profile</h1>
<h2 id="31-node官方guide" style="position:relative;"><a href="#31-node%E5%AE%98%E6%96%B9guide" aria-label="31 node官方guide permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1 Node官方Guide</h2>
<p>Node官方文档有一篇<a href="https://nodejs.org/en/docs/guides/simple-profiling/" target="_blank" rel="nofollow noopener noreferrer">Guide</a>，详细介绍了如何进行profile。本文下面主要就是对该Guide进行翻译及针对实际操作进行总结。</p>
<p>Node的内置Profiler来自V8，V8官方的Profiler介绍可以查看：<a href="https://github.com/v8/v8/wiki/Using%20V8%E2%80%99s%20internal%20profiler" target="_blank" rel="nofollow noopener noreferrer">Using V8’s internal profiler</a>，其实和Node的Guide比起来差的不多，但更针对性地对浏览器进行了操作介绍。</p>
<h2 id="32-版本要求" style="position:relative;"><a href="#32-%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82" aria-label="32 版本要求 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2 版本要求</h2>
<p>Node官方的Profiler内嵌自版本4.4.0，所以请至少使用这个及以上的版本：</p>
<blockquote>
<p>Luckily, tools have recently been introduced into Node.js 4.4.0 that facilitate the consumption of this information without separately building V8 from source.</p>
</blockquote>
<h2 id="33-profile范例" style="position:relative;"><a href="#33-profile%E8%8C%83%E4%BE%8B" aria-label="33 profile范例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.3 Profile范例</h2>
<p>调优前的范例代码如下，注意运行前请预先装好<a href="https://httpd.apache.org/docs/2.4/programs/ab.html" target="_blank" rel="nofollow noopener noreferrer">ApacheBench</a>：</p>
<script src="https://gist.github.com/agreatfool/a55f5cbdd66d097ba4855e47d42338e5.js"> </script>
<p>文件夹结构：</p>
<ul>
<li>bash/profile-ab.sh</li>
<li>bash/profile-server.sh</li>
<li>profile/package.json</li>
<li>profile/server.js</li>
</ul>
<p>执行步骤：</p>
<ul>
<li>cd profile</li>
<li>npm install</li>
<li>cd ..</li>
<li>chmod +x bash/profile-ab.sh</li>
<li>chmod +x bash/profile-server.sh</li>
<li>./bash/profile-server.sh：保证服务器进程运行中</li>
<li>./bash/profile-ab.sh</li>
<li>查看结果</li>
</ul>
<p>执行结果：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Benchmarking localhost (be patient)
Completed 100 requests
Completed 200 requests
Finished 250 requests


Server Software:        
Server Hostname:        localhost
Server Port:            5000

Document Path:          /auth?username=matt&amp;password=password
Document Length:        2 bytes

Concurrency Level:      20
Time taken for tests:   24.817 seconds
Complete requests:      250
Failed requests:        0
Keep-Alive requests:    250
Total transferred:      51500 bytes
HTML transferred:       500 bytes
Requests per second:    10.07 [#/sec] (mean)
Time per request:       1985.384 [ms] (mean)
Time per request:       99.269 [ms] (mean, across all concurrent requests)
Transfer rate:          2.03 [Kbytes/sec] received

Connection Times (ms)
             min  mean[+/-sd] median   max
Connect:        0    0   0.1      0       1
Processing:    99 1909 305.1   1985    2019
Waiting:       99 1909 305.1   1985    2019
Total:        100 1909 304.9   1985    2019

Percentage of the requests served within a certain time (ms)
  50%   1985
  66%   1991
  75%   1995
  80%   1997
  90%   2002
  95%   2005
  98%   2011
  99%   2014
 100%   2019 (longest request)</code></pre></div>
<p>结论：</p>
<ul>
<li><code class="language-text">20</code>个并发，完成<code class="language-text">250</code>个请求，耗时<code class="language-text">24.817</code>秒</li>
<li>平均每秒只能处理<code class="language-text">10.07</code>个请求</li>
<li>很糟糕</li>
</ul>
<h2 id="34-解析profile日志" style="position:relative;"><a href="#34-%E8%A7%A3%E6%9E%90profile%E6%97%A5%E5%BF%97" aria-label="34 解析profile日志 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.4 解析Profile日志</h2>
<p>在刚才运行<code class="language-text">profile-ab.sh</code>脚本的路径下，会产生一个文件名类似<code class="language-text">isolate-0x103000000-v8.log</code>这样的文件。该文件比较大，就不放gist了，请自行实验获取范例。</p>
<p>然后使用以下命令将该日志解析生成可读的内容：</p>
<blockquote>
<p>node —prof-process isolate-0x103000000-v8.log > processed.txt</p>
</blockquote>
<h2 id="35-理解profile日志内容" style="position:relative;"><a href="#35-%E7%90%86%E8%A7%A3profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9" aria-label="35 理解profile日志内容 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.5 理解Profile日志内容</h2>
<p>解析出来的日志文件内容有点多，原文放在附录部分，点击<a href="#ID51">这里</a>查看。</p>
<p>从上到下主要分为几个耗时分类，一个个细说。</p>
<h3 id="351-shared-libraries" style="position:relative;"><a href="#351-shared-libraries" aria-label="351 shared libraries permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.5.1 Shared libraries</h3>
<p>Node进程使用到的系统级动态链接库部分的时间消耗，会显示在这个分类下。</p>
<p>该分类的几列：</p>
<ul>
<li>ticks：每个库所占用的ticks数量</li>
<li>total：每个库占用的ticks总量百分比</li>
<li>nonlib：这列在当前分类不适用，因为本来这里列的就都是类库时间消耗，nonlib当然没有数据</li>
<li>name：动态链接库的文件位置</li>
</ul>
<h3 id="352-javascriptcsummary" style="position:relative;"><a href="#352-javascriptcsummary" aria-label="352 javascriptcsummary permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.5.2 JavaScript、C++、Summary</h3>
<p>这几个分类放一起说，因为他们的列数据含义相同。</p>
<h4 id="javascript" style="position:relative;"><a href="#javascript" aria-label="javascript permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript</h4>
<p>JavaScript代码部分的时间消耗，包括了当前项目源代码部分的时间消耗和第三方node_modules的时间消耗。</p>
<h4 id="c" style="position:relative;"><a href="#c" aria-label="c permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>C++</h4>
<p>Node进程在C++代码里的时间消耗，Node本身是构建在V8引擎之上的，所以一些Node标准库里的API，基本上都是C++时间消耗。当然这个分类也包含了一些作为第三方addon加载的插件的时间消耗。</p>
<h4 id="summary" style="position:relative;"><a href="#summary" aria-label="summary permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Summary</h4>
<p>这个分类应该是当前报表中最重要的部分，没有细节，就仅仅只是将所有的分类的时间消耗总量都放在一起，形成一个直观的结果。一般来说看Profile结论报表，第一个要看的就是Summary，有一个最直观的结论之后再去找对应部分的细节。</p>
<p>这里需要注意的有两处：</p>
<ul>
<li>GC：整个报表中唯一只在这个Summary中能找到<code class="language-text">内存回收（GC）</code>相关的时间消耗数据</li>
<li>Unaccounted：偶尔，Profiler会无法当前执行的内容到底是什么，这类的ticks就会被归类到<code class="language-text">Unaccounted</code>这个分类下</li>
</ul>
<h4 id="列含义" style="position:relative;"><a href="#%E5%88%97%E5%90%AB%E4%B9%89" aria-label="列含义 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>列含义</h4>
<ul>
<li>ticks：占用的ticks数量</li>
<li>total：占用的ticks总量百分比</li>
<li><code class="language-text">nonlib</code>：
<ul>
<li>这列描述的是将<code class="language-text">Shared libraries</code>所产生的时间消耗忽略之后，当前条目自身产生的时间消耗（ticks）所占的百分比</li>
<li>举例来说：你写的JS代码中new了一个对象，然后内存分配器会问系统去要内存，这里可能就会产生<code class="language-text">/usr/lib/system/libsystem_malloc.dylib</code>的时间消耗了，<code class="language-text">nonlib</code>列给的百分比就是去掉这个<code class="language-text">libsystem_malloc.dylib</code>库产生的时间消耗之后，你代码中new对象所产生的时间消耗所占的百分比</li>
</ul>
</li>
<li>name：
<ul>
<li>JavaScript：函数名，以及其在源代码中的位置</li>
<li>C++：函数名，一般都是Node运行时和V8相关的函数</li>
<li>Summary：分类名</li>
</ul>
</li>
</ul>
<p>关于JavaScript的name列，还有一些细节可以说一下：</p>
<p>每个name列实际函数名之前一般会有一个<code class="language-text">*</code>或<code class="language-text">~</code>，星号表示该函数得到了优化，而波浪号则表示没有。<a href="#ID51">这个例子</a>里只有未优化的范例，下面放一个有优化的例子：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">ticks parent  name
3567   16.9%  Builtin: StringEqual
3567  100.0%    LazyCompile: *&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:43:54
3567  100.0%      LazyCompile: *InnerArrayFind native array.js:843:24
3441   96.5%        LazyCompile: *find native array.js:855:19
3278   95.3%          LazyCompile: *&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37
3278  100.0%            Builtin: ArrayForEach
 163    4.7%          Function: ~&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37
 163  100.0%            Builtin: ArrayForEach
 126    3.5%        Function: ~find native array.js:855:19
 114   90.5%          LazyCompile: *&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37
 114  100.0%            Builtin: ArrayForEach
  12    9.5%          Function: ~&lt;anonymous> .../node_modules/typeorm/query-builder/transformer/RawSqlResultsToEntityTransformer.js:39:37
  12  100.0%            Builtin: ArrayForEach</code></pre></div>
<p>此外，函数名之前都会有一个前缀，例如：<code class="language-text">LazyCompile</code>，他们都有各自的意义，这里罗列下一般常见的（不保证全）：</p>
<ul>
<li>Function：普通的JS函数</li>
<li>LazyCompile：懒编译的JS函数</li>
<li>RegExp：正则表达式引擎</li>
<li>Builtin：Node运行时内建的JS函数</li>
<li>Stub：Node运行时内建的C函数</li>
</ul>
<h3 id="353-c-entry-points" style="position:relative;"><a href="#353-c-entry-points" aria-label="353 c entry points permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.5.3 C++ entry points</h3>
<p>这部分描述的是当逻辑从JS代码跨界到C++代码运行时，其中消耗的时间。</p>
<p>这部分的意义不是很大，毕竟如果真的有大量和C++相关的时间消耗的话，直接看C++相关的部分即可。只有一种情况是需要仔细查看这部分的，就是从JS到C++之间的交换出了问题，JS本身没有很大的性能问题，且C++也没有，而是在两者之间做数据和消息交换的时候出了问题。</p>
<p>范例直接看<a href="#ID51">本文附带的例子</a>即可，里面C++占了绝大部分的时间消耗，而同样的在C++ entry points也有对应的巨量时间消耗占比。</p>
<h3 id="354-bottom-up-heavy-profile" style="position:relative;"><a href="#354-bottom-up-heavy-profile" aria-label="354 bottom up heavy profile permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.5.4 Bottom up (heavy) profile</h3>
<p>这部分是性能问题的暴露部分，一般看完Summery不想了解其细节就直接来看这部分是解决问题的最快方案。</p>
<p>和之前其他分类耗时部分不同的是，在这部分里按空行分隔的不同段落都是一个个单独的性能瓶颈点，每个段落的多行表示的是一个调用栈。</p>
<p>此外，这个部分的列内容也和之前的略有不同（主要是parent字段），<code class="language-text">parent</code>列的百分比意味着：当前行有<code class="language-text">X%</code>的统计结果会调用当前行的上一行里的函数。</p>
<blockquote>
<p>Within each of the “call stacks” above, the percentage in the parent column tells you the percentage of samples for which the function in the row above was called by the function in the current row.</p>
</blockquote>
<p>一般情况下，看完Profile报表中的这部分，性能问题都能找到原因。</p>
<h1 id="4-资料" style="position:relative;"><a href="#4-%E8%B5%84%E6%96%99" aria-label="4 资料 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. 资料</h1>
<ul>
<li><a href="https://httpd.apache.org/docs/2.4/programs/ab.html" target="_blank" rel="nofollow noopener noreferrer">ApacheBench</a></li>
<li><a href="https://nodejs.org/en/docs/guides/simple-profiling/" target="_blank" rel="nofollow noopener noreferrer">Easy profiling for Node.js Applications</a>：如何在命令行下进行Profile的官方指引</li>
<li><a href="https://github.com/v8/v8/wiki/Using%20V8%E2%80%99s%20internal%20profiler" target="_blank" rel="nofollow noopener noreferrer">Using V8’s internal profiler</a>：V8官方wiki的一篇教程</li>
<li><a href="https://blog.continuation.io/node-js-profiling-using-the-v8-tick-profiler/" target="_blank" rel="nofollow noopener noreferrer">Node.js Profiling Using the V8 Tick Profiler</a>：细节相当多的博文，唯一找到的一篇对profile分析文本的每个段落都有细节解释的文章</li>
<li><a href="https://stackoverflow.com/questions/23934451/how-to-read-nodejs-internal-profiler-tick-processor-output" target="_blank" rel="nofollow noopener noreferrer">How to read nodejs internal profiler tick-processor output</a>：stackoverflow的一个帖子</li>
<li><a href="https://groups.google.com/forum/#!topic/nodejs/oRbX5eZvOPg" target="_blank" rel="nofollow noopener noreferrer">Understanding the v8-profiler output</a>：google论坛上的一个帖子，细节蛮多的</li>
<li><a href="https://www.jetbrains.com/help/webstorm/v8-cpu-and-memory-profiling.html" target="_blank" rel="nofollow noopener noreferrer">V8 CPU and Memory Profiling</a>：WebStorm官方的一个教程贴，当然教的是他们的整合工具，但底层本质仍旧是V8的Profiler</li>
<li><a href="https://mrale.ph/blog/2011/12/18/v8-optimization-checklist.html" target="_blank" rel="nofollow noopener noreferrer">I-want-to-optimize-my-JS-application-on-V8 checklist</a>：这篇有点老了</li>
</ul>
<h2 id="41-火焰图相关" style="position:relative;"><a href="#41-%E7%81%AB%E7%84%B0%E5%9B%BE%E7%9B%B8%E5%85%B3" aria-label="41 火焰图相关 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1 火焰图相关</h2>
<p>MAC下的简单生成步骤：</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> stackvis -g

$ <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production <span class="token function">node</span> profile/server.js
Server started, listening on port <span class="token number">5000</span> <span class="token punctuation">..</span>.

$ <span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">node</span> <span class="token operator">|</span> <span class="token function">grep</span> -v <span class="token function">grep</span>
XXX         <span class="token number">69941</span>   <span class="token number">0.0</span>  <span class="token number">0.2</span>  <span class="token number">4920704</span>  <span class="token number">34256</span> s003  S+    <span class="token number">2</span>:45Pm   <span class="token number">0</span>:00.43 <span class="token function">node</span> profile/server.js

$ <span class="token function">sudo</span> dtrace -n <span class="token string">'profile-99 /pid == 69941 &amp;&amp; arg1/ { @[ustack()] = count(); }'</span> <span class="token operator">></span> stacks.out

$ ./bash/profile-ab.sh

$ stackvis dtrace flamegraph-svg <span class="token operator">&lt;</span> stacks.out <span class="token operator">></span> stacks.svg

<span class="token comment"># 在浏览器中打开 stacks.svg</span></code></pre></div>
<p>资料：</p>
<ul>
<li><a href="https://nodejs.org/en/blog/uncategorized/profiling-node-js/" target="_blank" rel="nofollow noopener noreferrer">Profiling Node.js</a>：使用dtrace获取数据，并制作火焰图</li>
<li><a href="http://cn.windyland.me/2015/11/28/profiling-with-dtrace/" target="_blank" rel="nofollow noopener noreferrer">Dtrace on Mac OS X</a></li>
<li><a href="http://carol-nichols.com/2017/04/20/rust-profiling-with-dtrace-on-osx/" target="_blank" rel="nofollow noopener noreferrer">Rust Profiling with DTrace and FlameGraph on OSX</a></li>
<li><a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="nofollow noopener noreferrer">brendangregg/FlameGraph</a>：虽然是个工具库，但README里有不少如何采集数据的指引</li>
<li><a href="https://xizhibei.github.io/2017/09/09/node-js-profiling-tool-flamegraph/" target="_blank" rel="nofollow noopener noreferrer">Node.js 性能分析之火焰图</a></li>
</ul>
<h1 id="5-附录" style="position:relative;"><a href="#5-%E9%99%84%E5%BD%95" aria-label="5 附录 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. 附录</h1>
<h2 id="51-解析完成的profile日志内容-id51" style="position:relative;"><a href="#51-%E8%A7%A3%E6%9E%90%E5%AE%8C%E6%88%90%E7%9A%84profile%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9-id51" aria-label="51 解析完成的profile日志内容 id51 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.1 解析完成的Profile日志内容 {#ID51}</h2>
<script src="https://gist.github.com/agreatfool/0a77653e033db0779e55993f97ed65ca.js"> </script></div></div></div><div class="Post-module--footer--NpFTW"><div class="Meta-module--meta--3YYBJ"><p class="Meta-module--date--U0EV3">Published<!-- --> <!-- -->2018/2/27</p></div><div class="Tags-module--tags--1r6Jk"><ul class="Tags-module--list--3a6Ka"><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/javascript/">JavaScript</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/performance/">Performance</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/profile/">Profile</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/cpu/">CPU</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/memory/">Memory</a></li></ul></div><div class="Author-module--author--2kT-Q"><p class="Author-module--bio--2YX8-">Some tech &amp; personal blog posts<a class="Author-module--twitter--1B6I5" href="https://github.com/agreatfool" rel="noopener noreferrer" target="_blank"><strong>Jonathan Dai</strong> on Github</a></p></div></div><div class="Post-module--comments--2bE-0"><div id="disqus_thread"></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2018/02/node-profile-practice";window.___webpackCompilationHash="5adf906a15d41f88442c";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-cfda27ad3437359c4565.js"],"app":["/app-240856784b6548a98a4c.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-0f5b8a073afc45a4d929.js"],"component---src-templates-categories-template-categories-template-tsx":["/component---src-templates-categories-template-categories-template-tsx-5148aeacbb751fe6739f.js"],"component---src-templates-category-template-category-template-tsx":["/component---src-templates-category-template-category-template-tsx-1d85aa91418fed671106.js"],"component---src-templates-index-template-index-template-tsx":["/component---src-templates-index-template-index-template-tsx-88dfad82c6d04ad989b6.js"],"component---src-templates-not-found-template-not-found-template-tsx":["/component---src-templates-not-found-template-not-found-template-tsx-e28a12bd991ea48fdc4d.js"],"component---src-templates-page-template-page-template-tsx":["/component---src-templates-page-template-page-template-tsx-8cb451c783c871f064ed.js"],"component---src-templates-post-template-post-template-tsx":["/component---src-templates-post-template-post-template-tsx-f6c7c632cb298ebf6b27.js"],"component---src-templates-tag-template-tag-template-tsx":["/component---src-templates-tag-template-tag-template-tsx-d4c751b30d0c0bfe9d77.js"],"component---src-templates-tags-template-tags-template-tsx":["/component---src-templates-tags-template-tags-template-tsx-afe2e353c834d4282f1d.js"]};/*]]>*/</script><script src="/polyfill-cfda27ad3437359c4565.js" nomodule=""></script><script src="/component---src-templates-post-template-post-template-tsx-f6c7c632cb298ebf6b27.js" async=""></script><script src="/5576a503ee3134145eb2de8ee0bcd322ef9007e9-89aa5c437fd0655d4835.js" async=""></script><script src="/app-240856784b6548a98a4c.js" async=""></script><script src="/framework-5af3c233cfe8f9b378d1.js" async=""></script><script src="/webpack-runtime-36b8c7ecf6189fe49091.js" async=""></script></body></html>