<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.20.0"/><meta name="theme-color" content="hsl(31, 92%, 62%)"/><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:site_name" content="Elasticsearch Notes - Blog by Jonathan Dai"/><meta data-react-helmet="true" property="og:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Elasticsearch Notes - Blog by Jonathan Dai"/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="twitter:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><style data-href="/styles.73ba2c353057148cd83d.css" data-identity="gatsby-global-css">html{font-size:100}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizelegibility;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#212121;font-size:16px;line-height:1.625;margin:0 0 0 calc(100vw - 100%)}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:40px;line-height:52px;margin-bottom:26px;margin-top:104px}h2{font-size:27px;line-height:39px}h2,h3{margin-bottom:13px;margin-top:52px}h3{font-size:22px;line-height:26px}h4{font-size:19.2px;margin-top:39px}h4,h5{line-height:26px;margin-bottom:13px}h5,h6{font-size:16px;margin-top:65px}h6{line-height:26px;margin-bottom:13px}img{max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#212121 0,#212121 15px,transparent 0,transparent 26px);background-size:100% 26px;color:#212121;height:26px;margin:52px auto;width:100px}a{color:#5c92ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a145}b,strong{font-weight:600}ul{list-style:square;margin-bottom:26px}ul li{margin-bottom:10px;padding:0 5px}p{line-height:26px;margin-bottom:26px}blockquote{font-style:italic;padding:0;text-align:center}figure{display:block;height:auto;width:100%}figcaption{color:#212121;font-size:14px;font-style:italic;line-height:19.5px;margin-bottom:0;margin-top:6.5px;text-align:center}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:310px;padding:0 26px}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83;cursor:help}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}blockquote{border-left:5px solid #424242!important;color:#424242!important;display:block!important;font-style:normal!important;padding-left:1rem!important;text-align:left!important}table{border-collapse:collapse;box-shadow:0 0 20px rgba(0,0,0,.15)}thead tr{background-color:#009879;color:#fff;text-align:left}td,th{padding:12px 15px}tbody tr{border-bottom:1px solid #ddd}tbody tr:nth-of-type(2n){background-color:#f3f3f3}tbody tr:last-of-type{border-bottom:2px solid #009879}h1{margin-top:0!important}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky{margin-bottom:32.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky:last-child{margin-bottom:13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W{font-size:27px;line-height:39px;margin-bottom:13px;margin-top:0}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE{color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:hover{border-bottom:1px solid #212121;color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--description--UXUO2{font-size:16px;line-height:26px;margin-bottom:19.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--time--17yla{color:#212121;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--divider--3kBgQ{margin:0 13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE{color:#f7a145;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:hover{color:#5c92ff}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-{color:#5c92ff;font-size:16px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Layout-module--layout--36KWw{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--36KWw:before{content:"";display:table}.Layout-module--layout--36KWw:after{clear:both;content:"";display:table}.Page-module--page--2Y5e7{margin-bottom:52px}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:26px 19.5px 0}.Page-module--page--2Y5e7 .Page-module--title--Z69a4{font-size:40px;font-weight:600;line-height:52px;margin-bottom:37.7px;margin-top:0}.Page-module--page--2Y5e7 .Page-module--body--hPYHN{font-size:16px;line-height:26px;margin:0 0 26px}@media screen and (min-width:685px){.Page-module--page--2Y5e7{width:calc(58.275% - 12.5px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(12n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(12n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:32.5px 19.5px 0}}@media screen and (min-width:960px){.Page-module--page--2Y5e7{width:calc(66.6% - 10px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(3n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(3n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:39px 26px 0}}.Pagination-module--pagination--3KtNE{display:flex;margin-top:52px}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8{text-align:left;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:focus,.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj{text-align:right;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:focus,.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Author-module--author--12DFk .Author-module--photo--1WT_U{background-clip:padding-box;border-radius:50%;display:inline-block;height:75px;margin-bottom:0;width:75px}.Author-module--author--12DFk .Author-module--title--2UdHe{font-size:18px;font-weight:600;line-height:29.25px;margin:13px 0}.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:focus,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:hover{color:#212121}.Author-module--author--12DFk .Author-module--subtitle--3HDSh{color:#878787;line-height:26px;margin-bottom:26px}.Icon-module--icon--fdMTB{fill:currentcolor;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;speak:none;stroke:currentcolor;stroke-width:0;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--3rFuK{margin-bottom:26px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:13px 0;max-width:150px;padding:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X{align-content:center;align-items:center;border:1px solid #ebebeb;border-radius:50%;display:flex;height:35px;justify-content:center;line-height:35px;margin:6.5px;padding:0;text-align:center;width:35px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X:nth-child(3n+1){margin-left:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi{border:0;color:#212121;display:flex}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:focus,.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:hover{color:#5c92ff}.Copyright-module--copyright--1IQFN{color:#999;font-size:14px}.Menu-module--menu--3SbXJ{margin-bottom:26px}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI{list-style:none;margin:0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8{margin:13px 0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV{border:0;color:#212121;font-size:16px;font-weight:400}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:focus,.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV.Menu-module--active--aYO_r{border-bottom:1px solid #212121;color:#212121}.Sidebar-module--sidebar--1NhQN{width:100%}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:26px 19.5px 0;position:relative}@media screen and (min-width:685px){.Sidebar-module--sidebar--1NhQN{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:32.5px 19.5px 0}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);bottom:0;content:"";height:540px;position:absolute;right:-10px;top:30px;width:1px}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1NhQN{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:39px}}.Author-module--author--2kT-Q{border-top:1px solid #e6e6e6;line-height:26px;margin-bottom:52px;margin-top:26px;max-width:640px;padding-top:26px}.Author-module--author--2kT-Q .Author-module--bio--2YX8- .Author-module--twitter--1B6I5{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2kT-Q{margin-left:auto;margin-right:auto}}.Content-module--content--3dNJJ{margin:0 auto;max-width:945px;padding:0 13px}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:32px;font-weight:600;line-height:42.9px;margin:26px auto 0;max-width:640px;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure{margin-bottom:26px}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote{font-style:italic;margin-top:0;padding:26px 0;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote p{font-size:26.9072px;line-height:39px;margin-bottom:26px;margin-top:0;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt a{text-decoration:underline}.Content-module--content--3dNJJ .Content-module--body--3LJXt *{margin-left:auto;margin-right:auto;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{visibility:hidden}.Content-module--content--3dNJJ .Content-module--body--3LJXt img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3dNJJ{padding:0}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:48px;line-height:58.5px;margin-bottom:39px;margin-top:58.5px}.Content-module--content--3dNJJ .Content-module--body--3LJXt,.Content-module--content--3dNJJ .Content-module--body--3LJXt p{font-size:18px;line-height:29.25px;margin-bottom:29.25px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{padding-right:26px;visibility:unset}}.Meta-module--meta--3YYBJ .Meta-module--date--U0EV3{font-style:italic}.Tags-module--tags--1r6Jk{margin-bottom:13px}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka{list-style:none;padding:0}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ{display:inline-block;margin:13px 3.25px}@media screen and (min-width:685px){.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ:first-child{margin-left:0;padding-left:0}}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:inline-block;height:35px;line-height:35px;padding:0 19.5px;text-decoration:none}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:focus,.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:hover{color:#5c92ff}.Gallery-module--gallery--2g0Rf{grid-gap:.5em;display:grid;grid-auto-rows:16vw;grid-template-columns:repeat(4,1fr)}.Gallery-module--gallery--2g0Rf>*{box-shadow:0 2px 8px 0 rgba(0,0,0,.2),0 3px 20px 0 rgba(0,0,0,.19)}.Gallery-module--gallery--2g0Rf>:hover{cursor:pointer;-webkit-filter:blur(4px);filter:blur(4px);transition:all .5s ease}.Gallery-module--gallery--2g0Rf>:nth-child(6n+3){grid-column:span 1;grid-row:span 2}.Gallery-module--gallery--2g0Rf>:nth-child(6n+2),.Gallery-module--gallery--2g0Rf>:nth-child(6n+5),.Gallery-module--gallery--2g0Rf>:nth-child(6n+6){grid-column:span 2;grid-row:span 2}.Post-module--post--mo55f .Post-module--content--3cRzw{margin:0 auto}.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{margin:0 auto;max-width:640px;padding:0 13px}.Post-module--post--mo55f .Post-module--button--27HfC{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:block;font-size:16px;font-weight:400;height:35px;line-height:35px;margin-left:auto;margin-right:auto;margin-top:26px;max-width:90px;padding:0 26px;text-align:center}.Post-module--post--mo55f .Post-module--button--27HfC:focus,.Post-module--post--mo55f .Post-module--button--27HfC:hover{color:#5c92ff}@media screen and (min-width:960px){.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{padding:0}.Post-module--post--mo55f .Post-module--button--27HfC{left:30px;margin:0;max-width:none;position:fixed;top:30px}}</style><link rel="alternate" type="application/rss+xml" title="Blog by Jonathan Dai" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-FHVTN0K4SH"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FHVTN0K4SH', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=bc5f0053fc3ffc2dfb62b5abaa975347" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Elasticsearch Notes - Blog by Jonathan Dai</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--36KWw"><div class="Post-module--post--mo55f"><a class="Post-module--button--27HfC" href="/">All Articles</a><div class="Post-module--content--3cRzw"><div class="Content-module--content--3dNJJ"><h1 class="Content-module--title--3vQh6">Elasticsearch Notes</h1><div class="Content-module--body--3LJXt"><div class="table-of-contents">
<ul>
<li><a href="#1-%E5%89%8D%E8%A8%80">1. 前言</a></li>
<li><a href="#2-log-shipper">2. Log Shipper</a>
<ul>
<li><a href="#21-%E6%A8%AA%E5%90%91%E6%AF%94%E8%BE%83--%E9%80%89%E6%8B%A9">2.1 横向比较 &#x26; 选择</a></li>
<li><a href="#22-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">2.2 架构设计</a></li>
</ul>
</li>
<li><a href="#3-filebeat">3. Filebeat</a>
<ul>
<li><a href="#31-%E8%AE%BE%E8%AE%A1--%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">3.1 设计 &#x26; 基础概念</a></li>
<li><a href="#32-%E4%BD%BF%E7%94%A8">3.2 使用</a></li>
<li><a href="#33-%E6%A8%A1%E5%9D%97">3.3 模块</a></li>
<li><a href="#34-%E8%BF%87%E6%BB%A4%E5%92%8C%E4%B8%B0%E5%AF%8C">3.4 过滤和丰富</a></li>
<li><a href="#35-%E6%96%87%E4%BB%B6%E7%8A%B6%E6%80%81%E8%AE%B0%E5%BD%95--%E6%8A%95%E9%80%92%E4%BF%9D%E8%AF%81">3.5 文件状态记录 &#x26; 投递保证</a></li>
</ul>
</li>
<li><a href="#4-elasticsearch">4. Elasticsearch</a>
<ul>
<li><a href="#41-%E7%9F%A5%E8%AF%86%E7%82%B9">4.1 知识点</a>
<ul>
<li><a href="#411-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">4.1.1 基础概念</a></li>
<li><a href="#412-%E5%AE%89%E8%A3%85--%E9%85%8D%E7%BD%AE">4.1.2 安装 &#x26; 配置</a></li>
<li><a href="#413-api">4.1.3 API</a></li>
<li><a href="#414-query-dsl">4.1.4 Query DSL</a></li>
<li><a href="#415-sql">4.1.5 SQL</a></li>
<li><a href="#416-ingest%E8%8A%82%E7%82%B9">4.1.6 Ingest节点</a></li>
</ul>
</li>
<li><a href="#42-%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93--%E7%B4%A2%E5%BC%95-id_index">4.2 文档数据库 &#x26; 索引 {#ID_INDEX}</a>
<ul>
<li><a href="#421-index-template">4.2.1 Index Template</a></li>
<li><a href="#422-%E8%AE%BE%E7%BD%AEindex%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">4.2.2 设置index生命周期</a></li>
<li><a href="#423-index%E7%9A%84%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E8%AE%BE%E7%BD%AE">4.2.3 Index的自动创建设置</a></li>
</ul>
</li>
<li><a href="#43-%E5%AD%98%E5%82%A8-id_storage">4.3 存储 {#ID_STORAGE}</a></li>
<li><a href="#44-%E9%9B%86%E7%BE%A4-id_arc_cluster">4.4 集群 {#ID_ARC_CLUSTER}</a></li>
<li><a href="#45-%E7%9B%91%E6%8E%A7--%E9%AB%98%E5%8F%AF%E7%94%A8">4.5 监控 &#x26; 高可用</a>
<ul>
<li><a href="#451-%E7%9B%91%E6%8E%A7">4.5.1 监控</a></li>
<li><a href="#452-%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5">4.5.2 监控实践</a></li>
<li><a href="#453-%E9%AB%98%E5%8F%AF%E7%94%A8">4.5.3 高可用</a></li>
</ul>
</li>
<li><a href="#46-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98">4.6 性能调优</a></li>
</ul>
</li>
<li><a href="#5-kibana">5. Kibana</a>
<ul>
<li><a href="#51-index-pattern-id_index_pattern">5.1 Index Pattern {#ID_INDEX_PATTERN}</a></li>
<li><a href="#52-%E4%BD%BF%E7%94%A8%E7%AE%80%E4%BB%8B">5.2 使用简介</a></li>
<li><a href="#53-qa">5.3 Q&#x26;A</a></li>
</ul>
</li>
<li><a href="#6-filebeat%E7%9B%B4%E8%BF%9Eelasticsearch%E5%AE%9E%E8%B7%B5">6. Filebeat直连Elasticsearch实践</a>
<ul>
<li><a href="#61-%E7%9B%B4%E8%BF%9E%E6%B5%81%E7%A8%8B">6.1 直连流程</a></li>
<li><a href="#62-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">6.2 应用场景</a></li>
<li><a href="#63-index-template-id_index_template">6.3 Index Template {#ID_INDEX_TEMPLATE}</a></li>
<li><a href="#64-issues">6.4 Issues</a>
<ul>
<li><a href="#641-filebeat%E5%AD%97%E6%AE%B5%E5%B1%82%E7%BA%A7">6.4.1 Filebeat字段层级</a></li>
<li><a href="#642-kibana-message%E5%AD%97%E6%AE%B5">6.4.2 Kibana message字段</a></li>
<li><a href="#643-input--processors-fields">6.4.3 input | processors fields</a></li>
<li><a href="#644-index-template%E8%AE%BE%E7%BD%AE-id_filebeat_index_template">6.4.4 Index Template设置 {#ID_FILEBEAT_INDEX_TEMPLATE}</a></li>
<li><a href="#645-%E5%88%87%E7%89%87%E6%95%B0%E9%87%8F">6.4.5 切片数量</a></li>
<li><a href="#646-kibana-timestamp">6.4.6 Kibana @timestamp</a></li>
<li><a href="#647-elasticsearch-%E9%A2%84%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE">6.4.7 Elasticsearch 预创建数据</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#7-%E5%AE%9E%E8%B7%B5%E8%8C%83%E4%BE%8B">7. 实践范例</a></li>
<li><a href="#8-docker%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">8. Docker集群部署</a>
<ul>
<li><a href="#81-elasticsearch%E9%85%8D%E7%BD%AE-id_es_config">8.1 Elasticsearch配置 {#ID_ES_CONFIG}</a>
<ul>
<li><a href="#811-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE">8.1.1 环境变量配置</a></li>
<li><a href="#812-%E5%A4%9A%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%E7%9A%84%E5%85%B1%E4%BA%AB">8.1.2 多节点配置的共享</a></li>
<li><a href="#813-%E9%9B%86%E7%BE%A4%E5%8F%91%E7%8E%B0%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE">8.1.3 集群发现相关配置</a></li>
</ul>
</li>
<li><a href="#82-kibana%E9%85%8D%E7%BD%AE">8.2 Kibana配置</a></li>
<li><a href="#83-filebeat%E9%85%8D%E7%BD%AE">8.3 Filebeat配置</a></li>
</ul>
</li>
<li><a href="#9-todo">9. TODO</a></li>
<li><a href="#%E8%B5%84%E6%96%99">资料</a>
<ul>
<li><a href="#%E9%93%BE%E6%8E%A5">链接</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="1-前言" style="position:relative;"><a href="#1-%E5%89%8D%E8%A8%80" aria-label="1 前言 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 前言</h1>
<p>之前做了Prometheus和Jaeger相关的调研工作，这两者虽然也涉及到日志聚合相关的技术或是类似的技术，但毕竟不是通用的日志聚合系统。通用的日志聚合系统需要能接受任何类型的日志，并将其索引入库以备后续的查询。市面上这方面的产品现在基本上是Elasticsearch为主要选择，已经可以说是很成熟了。所以这块需求我这里也是以ELK为第一备选进行相关的调研。</p>
<p>后续的调研内容版本如下：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">elasticsearch 7.0.0
elastic/filebeat 7.0.0
kibana 7.0.0</code></pre></div>
<p>在提到Elasticsearch的时候我们一般不会只说Elasticsearch本身，而是会提到<code class="language-text">ELK</code>这个词，这里说的其实就是从日志采集、清洗、转换、分发、到最后入库的整个流程，以及查询用的面板包含在内的一整套生态。因此下面行文会从：日志采集、日志存储、日志查询三方面着手。</p>
<p>官方文档：</p>
<ul>
<li><a href="https://www.elastic.co/guide/index.html" target="_blank" rel="nofollow noopener noreferrer">Elastic Stack and Product Documentation</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/index.html" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch Reference</a></li>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/index.html" target="_blank" rel="nofollow noopener noreferrer">Filebeat Reference</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/index.html" target="_blank" rel="nofollow noopener noreferrer">Kibana User Guide</a></li>
</ul>
<h1 id="2-log-shipper" style="position:relative;"><a href="#2-log-shipper" aria-label="2 log shipper permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Log Shipper</h1>
<p>日志是在各个应用程序中生产的，此外也包括了操作系统级别的日志生产。因此日志的产生这个行为是分散在各个节点上的，日志的收集就是从分散的节点采集数据汇集到中心存储的一个过程，这也是所谓的<code class="language-text">聚合</code>。而从分散的节点上采集数据，我们需要Agent（Log Shipper）来执行这个操作。</p>
<p>经典的<code class="language-text">ELK</code>中，<code class="language-text">L</code>代表的就是日志采集Agent：Logstash。当然，市面上也有非常多的其他选择，可以做到和Logstash类似的功能。从系统设计上来说，ELK三者本身是完全解耦分离的，所以所谓的ELK堆栈，只是一种经过验证的实践方案，其实中间除了E之外，L和K都是可以自由更换的。</p>
<h2 id="21-横向比较--选择" style="position:relative;"><a href="#21-%E6%A8%AA%E5%90%91%E6%AF%94%E8%BE%83--%E9%80%89%E6%8B%A9" aria-label="21 横向比较  选择 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.1 横向比较 &#x26; 选择</h2>
<p>关于日志采集组件的备选有大量横向比较，推荐阅读：<a href="https://sematext.com/blog/logstash-alternatives/" target="_blank" rel="nofollow noopener noreferrer">5 Logstash Alternatives</a>。这篇的时间还算比较新<code class="language-text">2018-10-09</code>，讲解也非常到位，基本上看这篇就OK了。</p>
<p>此外，<a href="https://gist.github.com/StevenACoffman/4e267f0f60c8e7fcb3f77b9e504f3bd7" target="_blank" rel="nofollow noopener noreferrer">StevenACoffman/fluent-filebeat-comparison.md</a>也可以看下。</p>
<p>排除比较年轻的项目，以及资历不太雄厚的项目，剩下的主要选项有三个：</p>
<ul>
<li>Logstash
<ul>
<li>优势：功能强大；经过实践检验</li>
<li>劣势：资源占用过大；JVM</li>
</ul>
</li>
<li>Filebeat
<ul>
<li>优势：Go语言；部署简单；资源占用极小</li>
<li>劣势：功能相对简单</li>
</ul>
</li>
<li>Fluentd
<ul>
<li>优势：CNCF孵化项目</li>
<li>劣势：Ruby语言实现</li>
</ul>
</li>
</ul>
<p>Log Shipper作为每个应用程序都需要附加的边车组件其中之一，Logstash的内存和CPU消耗在某些情况下是完全不能接受的（1GB内存，开玩笑）。JVM众所周知是比较难搞的虚拟机，如果要用好，调优需要有非常专门的知识，所以算是一个减分项。但放在Elasticsearch堆栈上来说，倒也不是那么严重，因为你无论如何都需要JVM知识来调优Elasticsearch本身。功能强大是Logstash的最大优势，能满足基本上所有的应用场景，在某些架构上，即便使用了Filebeat等高效轻量级的Log Shipper，在进入Elasticsearch入库之前仍旧需要一个Logstash来进行转换等工作。</p>
<p>Filebeat基本上没有缺点，如果它的功能能满足你的需求的话。如果不能满足，那么最新的Kafka输出能解决你的问题。使用Filebeat作为边车的Log Shipper，输出到Kafka，然后使用Logstash或者自己编写的组件来消费Kafka里的日志，最终入库到Elasticsearch。</p>
<p>Fluentd的最大优势在于CNCF的加持（背书）。但基于我多年的编程经验，ruby的性能一般来说是不可靠的，甚至使用JVM的Logstash都已经为性能付出了过大的代价，我又有什么理由要去相信口碑一直不怎么样的ruby呢。Logstash至少使用的JVM还和Elasticsearch本身是一个技术栈的，Fluentd会引入一个完全新的ruby虚拟机，就更加增加系统复杂度了。甚至，我在调研的初期就随手找到了：<a href="https://github.com/fluent/fluentd/issues/1657" target="_blank" rel="nofollow noopener noreferrer">Fluentd retains excessive amounts of memory after handling traffic peaks #1657</a>，<code class="language-text">2017年</code>的BUG，到现在还是<code class="language-text">Open状态</code>。</p>
<p>综上所述，任何情况下都应该使用Filebeat作为边车的Log Shipper。Filebeat能满足需求的直接入库到Elasticsearch，不能满足需求的日志进Kafka，然后使用Logstash或其他Consumer来进行转换，最终入库到Elasticsearch。</p>
<h2 id="22-架构设计" style="position:relative;"><a href="#22-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1" aria-label="22 架构设计 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2 架构设计</h2>
<p><img src="/media/posts/2019/04/elasticsearch-note/log_shipper_arc.jpg" alt="Architecture"></p>
<p>图中的Logstash部分可以替换成自编写的轻量级Consumer。</p>
<h1 id="3-filebeat" style="position:relative;"><a href="#3-filebeat" aria-label="3 filebeat permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. Filebeat</h1>
<p>非常细节的使用及配置，可以查看这篇中文的博客：<a href="https://www.cnblogs.com/cjsblog/p/9495024.html" target="_blank" rel="nofollow noopener noreferrer">Filebeat 模块与配置</a>。</p>
<h2 id="31-设计--基础概念" style="position:relative;"><a href="#31-%E8%AE%BE%E8%AE%A1--%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" aria-label="31 设计  基础概念 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1 设计 &#x26; 基础概念</h2>
<p><img src="/media/posts/2019/04/elasticsearch-note/filebeat.png" alt="Architecture"></p>
<p>这张图看看就好，意义不大。</p>
<p>Filebeat是一种<a href="https://www.elastic.co/cn/products/beats" target="_blank" rel="nofollow noopener noreferrer">Elastic Beat</a>，其实现基于<code class="language-text">libbeat</code>框架，更多的可以查看：<a href="https://www.elastic.co/guide/en/beats/libbeat/7.0/index.html" target="_blank" rel="nofollow noopener noreferrer">Beats Platform Reference</a>。</p>
<p>工作流：</p>
<ul>
<li>输入：从指定的文件进行监控日志增加行为，并触发读取发送</li>
<li>输出：可直接向Elasticsearch集群发送日志，也可以将日志输出到外部的消息队列（Kafka）里</li>
<li>模块：对某些日志进行的采集行为及Elasticsearch集群对这些日志进行分析的配置化和固化</li>
<li>消费：Elasticsearch集群解析日志入库，或从Kafka读取日志然后解析入库</li>
</ul>
<h2 id="32-使用" style="position:relative;"><a href="#32-%E4%BD%BF%E7%94%A8" aria-label="32 使用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2 使用</h2>
<p>部分说明文档：</p>
<ul>
<li>安装请参照：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-installation.html#filebeat-installation" target="_blank" rel="nofollow noopener noreferrer">Step 1: Install Filebeat</a></li>
<li>配置请参照：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-configuration.html#filebeat-configuration" target="_blank" rel="nofollow noopener noreferrer">Step 2: Configure Filebeat</a></li>
<li>容器内运行：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/running-on-docker.html#running-on-docker" target="_blank" rel="nofollow noopener noreferrer">Running Filebeat on Docker</a></li>
</ul>
<h2 id="33-模块" style="position:relative;"><a href="#33-%E6%A8%A1%E5%9D%97" aria-label="33 模块 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.3 模块</h2>
<p>官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-modules-overview.html" target="_blank" rel="nofollow noopener noreferrer">Modules overview</a>。</p>
<blockquote>
<p>Elasticsearch Ingest Node pipeline definition, which is used to parse the log lines.</p>
</blockquote>
<p>首先明确一点，Filebeat的模块并不是一般意义上的<code class="language-text">功能模块</code>。按软件设计思维来说，模块意味着功能的拓展，意味着根据模块设计的要求（框架）可以将软件本身能做的事情大幅拓展。而Filebeat的模块则不是，在Filebeat里，模块意味着一系列既有行为的组合：</p>
<ul>
<li>Nginx有两个日志：access和error</li>
<li>Nginx在Elasticsearch上处理的Ingest Pipeline是XXX</li>
<li>Nginx的日志格式是XXX，Elasticsearch里对应的字段是XXX</li>
<li>Nginx日志对应的Kibana面板有XXX，可以看到XXX数据</li>
</ul>
<p>从上面的例子可见：Filebeat本身并没有做什么，它做的仍旧只是采集日志，发送出去，没了。只不过指定了Elasticsearch集群中处理这个日志的Ingest Pipeline是谁，日志应该怎么入库（事情是在Elasticsearch集群上完成的）。因此在功能性上Filebeat是<code class="language-text">不可能替代</code>Logstash的，它的定位只是轻量级的应用端Log Shipper，如果要在功能上覆盖Logstash的功能点，就需要使用Elasticsearch自身的Ingest Pipeline，仍旧需要Filebeat以外的系统支持。</p>
<p>部分文档：</p>
<ul>
<li>如何创建一个新的模块：<a href="https://www.elastic.co/guide/en/beats/devguide/7.0/filebeat-modules-devguide.html#filebeat-modules-devguide" target="_blank" rel="nofollow noopener noreferrer">Creating a New Filebeat Module</a></li>
<li>模块清单：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-modules.html#filebeat-modules" target="_blank" rel="nofollow noopener noreferrer">Modules</a></li>
<li>命令行列出模块：</li>
</ul>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--name</span> filebeat <span class="token punctuation">\</span>
    elastic/filebeat:7.0.0 modules list</code></pre></div>
<h2 id="34-过滤和丰富" style="position:relative;"><a href="#34-%E8%BF%87%E6%BB%A4%E5%92%8C%E4%B8%B0%E5%AF%8C" aria-label="34 过滤和丰富 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.4 过滤和丰富</h2>
<p>Filebeat可以在配置中指定一些受限的过滤和清洗功能：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filtering-and-enhancing-data.html" target="_blank" rel="nofollow noopener noreferrer">Filter and enhance the exported data</a>。</p>
<p>可选的processor清单有：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/defining-processors.html#processors" target="_blank" rel="nofollow noopener noreferrer">Define processors</a>。</p>
<p>触发的条件：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/defining-processors.html#conditions" target="_blank" rel="nofollow noopener noreferrer">Conditions</a>。</p>
<h2 id="35-文件状态记录--投递保证" style="position:relative;"><a href="#35-%E6%96%87%E4%BB%B6%E7%8A%B6%E6%80%81%E8%AE%B0%E5%BD%95--%E6%8A%95%E9%80%92%E4%BF%9D%E8%AF%81" aria-label="35 文件状态记录  投递保证 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.5 文件状态记录 &#x26; 投递保证</h2>
<p>Filebeat对于输入的日志文件，会制作一个本地的注册文件，将状态都保存下来，因此在重启或者挂掉重新拉起来之后，Filebeat总是能知道之前发送到哪里。</p>
<p>Filebeat会保证本地的日志文件至少被输出一次，如果在输出的结果返回之前Filebeat就挂掉的话，在下次Filebeat启动之后，它还会将之前最后的日志再投递一次（对于Filebeat来说，它并不知道自己死前已经投递过一次，并被输出方接收到了）。因此，收取数据的服务端<code class="language-text">可能</code>在某些情况下收到<code class="language-text">重复的数据</code>。</p>
<h1 id="4-elasticsearch" style="position:relative;"><a href="#4-elasticsearch" aria-label="4 elasticsearch permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Elasticsearch</h1>
<p>2套电子书非常不错：</p>
<ul>
<li><a href="https://fdv.github.io/running-elasticsearch-fun-profit/" target="_blank" rel="nofollow noopener noreferrer">Operating Elasticsearch for Fun and Profit</a></li>
<li><a href="https://es.xiaoleilu.com/index.html" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch 权威指南（中文版）</a></li>
</ul>
<p>对于作为Elasticsearch底层的Lucene有兴趣的，可以查看这篇：<a href="https://www.infoq.cn/article/ejEG02VRoeGVaLw4j_LL" target="_blank" rel="nofollow noopener noreferrer">Lucene 查询原理及解析</a>。</p>
<h2 id="41-知识点" style="position:relative;"><a href="#41-%E7%9F%A5%E8%AF%86%E7%82%B9" aria-label="41 知识点 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1 知识点</h2>
<p>这一节基本上都是简单的知识点和概念罗列，主要阐明：“这是什么”。详细的内容会在后续的章节里分析。</p>
<h3 id="411-基础概念" style="position:relative;"><a href="#411-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" aria-label="411 基础概念 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1.1 基础概念</h3>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/getting-started-concepts.html#getting-started-concepts" target="_blank" rel="nofollow noopener noreferrer">Basic Concepts</a>。</p>
<p>提到了几点：</p>
<ul>
<li>Near Realtime (NRT)</li>
<li>Cluster</li>
<li>Node</li>
<li>Index</li>
<li>Document</li>
<li>Shards &#x26; Replicas</li>
</ul>
<h3 id="412-安装--配置" style="position:relative;"><a href="#412-%E5%AE%89%E8%A3%85--%E9%85%8D%E7%BD%AE" aria-label="412 安装  配置 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1.2 安装 &#x26; 配置</h3>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker" target="_blank" rel="nofollow noopener noreferrer">Install Elasticsearch with Docker</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/settings.html#settings" target="_blank" rel="nofollow noopener noreferrer">Configuring Elasticsearch</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/jvm-options.html#jvm-options" target="_blank" rel="nofollow noopener noreferrer">Setting JVM options</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/important-settings.html#important-settings" target="_blank" rel="nofollow noopener noreferrer">Important Elasticsearch configuration</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/system-config.html#system-config" target="_blank" rel="nofollow noopener noreferrer">Important System Configuration</a></li>
</ul>
<p>后面三条对生产环境影响比较大，需要仔细阅读。更贴近实践的范例可以参见：<a href="#ID_ES_CONFIG">8.1 Elasticsearch配置</a>。</p>
<h3 id="413-api" style="position:relative;"><a href="#413-api" aria-label="413 api permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1.3 API</h3>
<p>Elasticsearch的API文档相当散，主要是以下几项：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs.html" target="_blank" rel="nofollow noopener noreferrer">Document APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search.html" target="_blank" rel="nofollow noopener noreferrer">Search APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search-aggregations.html" target="_blank" rel="nofollow noopener noreferrer">Aggregations</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/indices.html" target="_blank" rel="nofollow noopener noreferrer">Indices APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat.html" target="_blank" rel="nofollow noopener noreferrer">cat APIs</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cluster.html" target="_blank" rel="nofollow noopener noreferrer">Cluster APIs</a></li>
</ul>
<p>API最常见的用途是对Elasticsearch集群进行观察，并进行一些例如Index Template设置之类的，超乎于日常日志输入相关业务之外的管理和控制。</p>
<h3 id="414-query-dsl" style="position:relative;"><a href="#414-query-dsl" aria-label="414 query dsl permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1.4 Query DSL</h3>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/query-dsl.html" target="_blank" rel="nofollow noopener noreferrer">Query DSL</a>。</p>
<p>了解Elasticsearch的人肯定会问：Query DSL和Elasticsearch的基础Lucene之间是什么关系。关于这个知识点可以查看：<a href="https://stackoverflow.com/questions/27793721/what-is-the-difference-between-lucene-and-elasticsearch" target="_blank" rel="nofollow noopener noreferrer">What is the difference between Lucene and Elasticsearch</a>。</p>
<blockquote>
<p>Elasticsearch is a JSON Based, Distributed, web server build over Lucene. Though it’s Lucene who is doing the actual work beneath, Elasticsearch provides us a convenient layer over Lucene. Each shard that gets created in Elasticsearch is a separate Lucene instance.</p>
</blockquote>
<p>Lucene是底层，Elasticsearch是基于Lucene之上的超集开发，而QueryDSL则是用户和Elasticsearch之间交互的桥梁。</p>
<h3 id="415-sql" style="position:relative;"><a href="#415-sql" aria-label="415 sql permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1.5 SQL</h3>
<p>Elasticsearch还可以使用SQL进行查询：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/xpack-sql.html" target="_blank" rel="nofollow noopener noreferrer">SQL access</a>。</p>
<h3 id="416-ingest节点" style="position:relative;"><a href="#416-ingest%E8%8A%82%E7%82%B9" aria-label="416 ingest节点 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1.6 Ingest节点</h3>
<p>在整个<a href="#ID_ARC_CLUSTER">Elasticsearch集群</a>中，有一部分节点是用来进行日志过滤、清洗、丰富化的，这些工作在这个设计出现之前是只能在Agent上实现的，一般来说就是Logstash，而现在在服务器节点上也可以处理相对应的工作了。</p>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/ingest.html#ingest" target="_blank" rel="nofollow noopener noreferrer">Ingest Node</a>。</p>
<p>通过定义Processors来进行日志的解析和处理：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/ingest-processors.html#ingest-processors" target="_blank" rel="nofollow noopener noreferrer">Processors</a>。</p>
<p>初步了解下来功能应该还算强大，可以使用脚本化代码进行功能拓展：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/script-processor.html#script-processor" target="_blank" rel="nofollow noopener noreferrer">Script Processor</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/modules-scripting-using.html#modules-scripting-using" target="_blank" rel="nofollow noopener noreferrer">How to use scripts</a></li>
</ul>
<p>此外还有插件机制：<a href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.0/ingest.html#ingest" target="_blank" rel="nofollow noopener noreferrer">Ingest Plugins</a>。</p>
<h2 id="42-文档数据库--索引-id_index" style="position:relative;"><a href="#42-%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93--%E7%B4%A2%E5%BC%95-id_index" aria-label="42 文档数据库  索引 id_index permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.2 文档数据库 &#x26; 索引 {#ID_INDEX}</h2>
<p>Elasticsearch是一个文档数据库，从本质上来看，它和Mongo其实相当类似。和传统RDBMS比较起来：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Relational DB -> Databases -> Tables  -> Rows      -> Columns
Elasticsearch -> Cluster   -> Indices -> Documents -> Fields</code></pre></div>
<p>简单理解：所谓的索引就是<code class="language-text">表名</code>，用来定位查询以及根据该名字进行分片sharding。</p>
<p>举个例子：
PUT /employee/1</p>
<p>Index：<code class="language-text">employee</code><br>
Document：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"first_name"</span> <span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    <span class="token property">"last_name"</span> <span class="token operator">:</span>  <span class="token string">"Smith"</span><span class="token punctuation">,</span>
    <span class="token property">"age"</span> <span class="token operator">:</span>        <span class="token number">25</span><span class="token punctuation">,</span>
    <span class="token property">"about"</span> <span class="token operator">:</span>      <span class="token string">"I love to go rock climbing"</span><span class="token punctuation">,</span>
    <span class="token property">"interests"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"sports"</span><span class="token punctuation">,</span> <span class="token string">"music"</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Fields：</p>
<ul>
<li>first_name</li>
<li>last_name</li>
<li>age</li>
<li>about</li>
<li>interests</li>
</ul>
<p>索引非常重要，在集群模式（cluster）中，索引是用来进行分区的唯一指标。Elasticsearch会根据Index来决定当前数据落到哪台实际的存储服务器上。</p>
<p>此外，需要注意，Index可以被Reindex，但不可以Reshard。换句话说，在Index被创建出来的时候，其shards数量就已经被固定下来了，以后不可更改。如果有这样的需求的话，必须使用Reindex来重新分配并平衡Index，已经创建出来的就没办法了。而Replicas则可以随时更改数量。</p>
<p>关于索引的细节，以及一些集群相关的索引知识，可以查看：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs-index_.html" target="_blank" rel="nofollow noopener noreferrer">Index API</a>。</p>
<h3 id="421-index-template" style="position:relative;"><a href="#421-index-template" aria-label="421 index template permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.2.1 Index Template</h3>
<p>和索引（<code class="language-text">Index</code>）息息相关的有一个概念叫：<code class="language-text">Index Template</code>。这部分比较重要也稍微有点复杂，后面会结合实际实践一并解释，会更容易理解：<a href="#ID_INDEX_TEMPLATE">6.3 Index Template</a>。</p>
<h3 id="422-设置index生命周期" style="position:relative;"><a href="#422-%E8%AE%BE%E7%BD%AEindex%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-label="422 设置index生命周期 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.2.2 设置index生命周期</h3>
<p>一般实践的时候，建议不要向单个Index内放入过多的文档，这会对写入和查询都造成比较大的压力。比较常见的做法是对输出端进行设置，将日志的输出索引设置成按日划分：<code class="language-text">index: "dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}"</code>，这样就有一个最基本的保障。但这样做的缺陷一样非常明显，当单日的业务量上涨之后，单日的日志量可能就比较夸张。</p>
<p>在Elasticsearch中，Index的生命周期有另外的管理方法：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/getting-started-index-lifecycle-management.html#getting-started-index-lifecycle-management" target="_blank" rel="nofollow noopener noreferrer">Getting started with index lifecycle management</a>。</p>
<p>同时需要在Filebeat端进行配合：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/ilm.html" target="_blank" rel="nofollow noopener noreferrer">Configure index lifecycle management</a>。</p>
<h3 id="423-index的自动创建设置" style="position:relative;"><a href="#423-index%E7%9A%84%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E8%AE%BE%E7%BD%AE" aria-label="423 index的自动创建设置 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.2.3 Index的自动创建设置</h3>
<p>在大部分情况下Elasticsearch都是允许自动创建Index的。在某些情况下可能需要关闭自动创建的允许权限，可以参见文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docs-index_.html#index-creation" target="_blank" rel="nofollow noopener noreferrer">Automatic Index Creation</a>，来查看如何操作。</p>
<h2 id="43-存储-id_storage" style="position:relative;"><a href="#43-%E5%AD%98%E5%82%A8-id_storage" aria-label="43 存储 id_storage permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.3 存储 {#ID_STORAGE}</h2>
<p>在官方手册文档中，并没有关于存储相关的设计及实现的详细内容。在Blog中找到一篇：<a href="https://www.elastic.co/blog/found-dive-into-elasticsearch-storage" target="_blank" rel="nofollow noopener noreferrer">A Dive into the Elasticsearch Storage</a>，不过时间也稍微有点久，但还算可以用来一窥存储相关的技术点。</p>
<p>此外，<strong>shards：Lucene segments</strong></p>
<blockquote>
<p>Each Elasticsearch index is divided into shards. Shards are both logical and physical division of an index. Each Elasticsearch shard is a Lucene index. The maximum number of documents you can have in a Lucene index is 2,147,483,519. The Lucene index is divided into smaller files called segments. A segment is a small Lucene index. Lucene searches in all segments sequentially.</p>
</blockquote>
<p><img src="/media/posts/2019/04/elasticsearch-note/elk_shards.png" alt="elk_shards"></p>
<h2 id="44-集群-id_arc_cluster" style="position:relative;"><a href="#44-%E9%9B%86%E7%BE%A4-id_arc_cluster" aria-label="44 集群 id_arc_cluster permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.4 集群 {#ID_ARC_CLUSTER}</h2>
<p>关于架构和集群的基础概念可以阅读官方的一份PPT：<a href="https://www.elastic.co/pdf/architecture-best-practices.pdf" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch Best Practice Architecture</a>。</p>
<p>主要是了解下Elasticsearch集群的节点分类：</p>
<p><img src="/media/posts/2019/04/elasticsearch-note/elk_node_types.png" alt="elk_node_types"></p>
<p>然后看下之前提到过的ELK整体集群拓扑：</p>
<p><img src="/media/posts/2019/04/elasticsearch-note/elk_arch.png" alt="elk_arch"></p>
<p>此外推荐一篇：<a href="https://thoughts.t37.net/designing-the-perfect-elasticsearch-cluster-the-almost-definitive-guide-e614eabc1a87" target="_blank" rel="nofollow noopener noreferrer">Designing the Perfect Elasticsearch Cluster: the (almost) Definitive Guide</a>。</p>
<p>在官方的文档库中我并没有找到比较新版本的文档有讲解到分布式和高可用之类的架构设计内容，大部分的文档都是各种API和各种细节。在老的版本中倒是找到一点信息：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_how_primary_and_replica_shards_interact.html" target="_blank" rel="nofollow noopener noreferrer">How Primary and Replica Shards Interact</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/distrib-write.html" target="_blank" rel="nofollow noopener noreferrer">Creating, Indexing, and Deleting a Document</a></li>
</ul>
<p>此外，中文书里的内容也可以阅读：<a href="https://es.xiaoleilu.com/020_Distributed_Cluster/00_Intro.html" target="_blank" rel="nofollow noopener noreferrer">集群内部工作方式</a>，注意这本中文书的版本已经相当老了，里面的内容有部分和现在的版本明显不同。</p>
<p>几点整理：</p>
<ul>
<li>replica与数据主节点并不一定是1：1的关系（并不一定一个master拖一个slave这样的设计），这个replica节点数量是可设置的，一个主节点可能有多份完全一致的replica</li>
<li>当你的replica设置越多，写入速度就越慢（参与的节点多），主节点写入完毕之后还要让所有的replica写入，全部都完成才会返回客户端完成</li>
<li>当你的replica设置越多，查询（读取）速度就越快（参与的节点多）</li>
<li>当发生查询请求时，查询请求是会落到所有的shard上的，所以集群shards做的越多，整个集群的查询性能开销就越大，这里就有一个平衡的问题</li>
</ul>
<h2 id="45-监控--高可用" style="position:relative;"><a href="#45-%E7%9B%91%E6%8E%A7--%E9%AB%98%E5%8F%AF%E7%94%A8" aria-label="45 监控  高可用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.5 监控 &#x26; 高可用</h2>
<h3 id="451-监控" style="position:relative;"><a href="#451-%E7%9B%91%E6%8E%A7" aria-label="451 监控 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.5.1 监控</h3>
<p>对于Elasticsearch的监控，官方有一套解决方案（Elasticsearch算是一个生态了，在上游和下游都有完整的处理）。可以查阅下官方文档：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/es-monitoring.html" target="_blank" rel="nofollow noopener noreferrer">Monitoring Elasticsearch</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/setup-xpack.html#setup-xpack" target="_blank" rel="nofollow noopener noreferrer">Set up X-Pack</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/getting-started-cluster-health.html#getting-started-cluster-health" target="_blank" rel="nofollow noopener noreferrer">Cluster Health</a></li>
</ul>
<p>当然也可以选用Prometheus作为监控：</p>
<ul>
<li><a href="https://github.com/vvanholl/elasticsearch-prometheus-exporter" target="_blank" rel="nofollow noopener noreferrer">Prometheus Exporter Plugin for Elasticsearch</a></li>
</ul>
<h3 id="452-监控实践" style="position:relative;"><a href="#452-%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5" aria-label="452 监控实践 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.5.2 监控实践</h3>
<p>除了官方插件之外，还有更好用的Prometheus集成工具，由justwatch提供的一整套：</p>
<ul>
<li>Exporter：
<ul>
<li>代码：<a href="https://github.com/justwatchcom/elasticsearch_exporter" target="_blank" rel="nofollow noopener noreferrer">justwatchcom/elasticsearch_exporter</a></li>
<li>镜像：<a href="https://hub.docker.com/r/justwatch/elasticsearch_exporter" target="_blank" rel="nofollow noopener noreferrer">justwatch/elasticsearch_exporter</a>
<ul>
<li>justwatch/elasticsearch_exporter:1.1.0rc1</li>
</ul>
</li>
</ul>
</li>
<li>Dashboard：<a href="https://grafana.com/dashboards/2322" target="_blank" rel="nofollow noopener noreferrer">ElasticSearch</a></li>
</ul>
<p>只需要在Elasticsearch集群之外启动一个Exporter镜像，并提供Elasticsearch集群的访问地址即可获得所有的metrics，然后在Grafana内导入justwatch提供的Dashboard就可以将数据可视化。整个过程不需要代码介入，直接使用即可，非常完美。</p>
<h3 id="453-高可用" style="position:relative;"><a href="#453-%E9%AB%98%E5%8F%AF%E7%94%A8" aria-label="453 高可用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.5.3 高可用</h3>
<p><strong>数据节点数量选择</strong></p>
<ul>
<li><a href="https://thoughts.t37.net/resizing-your-elasticsearch-indexes-in-production-d7a0402d137e" target="_blank" rel="nofollow noopener noreferrer">Resizing your Elasticsearch Indexes in Production</a></li>
<li><a href="https://www.signalfx.com/blog/scaling-elasticsearch-sharding-availability-hundreds-millions-documents/" target="_blank" rel="nofollow noopener noreferrer">Scaling Elasticsearch: Sharding and Availability for Hundreds Of Millions of Documents</a>：这篇当中有一段讲解了<code class="language-text">Resharding With Zero Downtime</code>，这是非常有价值的一个topic</li>
</ul>
<p><strong>可恢复的集群最低配置</strong></p>
<ul>
<li>3 locations to host your nodes. 2 locations to run half of your cluster, and one for the backup master node.</li>
<li>3 master nodes. You need an odd number of eligible master nodes to avoid split brains when you lose a whole data center. Put one master node in each location so you hopefully never lose the quorum.</li>
<li>2 http nodes, one in each primary data center.</li>
<li>As many data nodes as you need, split evenly between both main locations.</li>
</ul>
<p><strong>故障恢复</strong></p>
<p>Elasticsearch在集群中分主节点shard和复制节点replica，当集群的设置足够多（数据冗余充分）的情况下，当某个物理节点不可用时，Elasticsearch会自动进行选举，将丢失的主节点shard的replica节点设置成主节点，并重新对集群进行平衡。举个例子：</p>
<p>事故发生前：</p>
<ul>
<li>一共有3个物理节点</li>
<li>一共有3个主节点shard</li>
<li>每个主节点shard有2个复制节点replica</li>
<li>当前物理节点1是作为整个集群的master节点进行服务的</li>
<li>后续事故会发生在物理节点1，这个节点会下线</li>
</ul>
<p><img src="/media/posts/2019/04/elasticsearch-note/elk_ha_01.png" alt="Before"></p>
<p>事故发生后：</p>
<ul>
<li>master节点下线了，因此集群重新开始选取master节点，设定为物理节点2</li>
<li>0号主节点shard（P0）本来就在物理节点3上，因此不受影响</li>
<li>1号和2号主节点shard之前在物理节点1上，全部丢失，集群将物理节点2上的2号shard的replica（R2）提升为主节点shard（P2），并将物理节点3上的1号shard的replica（R1）提升为主节点shard（P1）</li>
<li>此时所有的主节点shard都已恢复，且各主节点shard都存在一份replica</li>
<li>后续集群会继续为各主节点shard复制缺失的一份replica</li>
</ul>
<p><img src="/media/posts/2019/04/elasticsearch-note/elk_ha_02.png" alt="After"></p>
<h2 id="46-性能调优" style="position:relative;"><a href="#46-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98" aria-label="46 性能调优 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.6 性能调优</h2>
<p>Ebay有一篇非常细节非常棒的设计及性能优化分析博文：<a href="https://www.ebayinc.com/stories/blogs/tech/elasticsearch-performance-tuning-practice-at-ebay/" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch Performance Tuning Practice at eBay</a>。从时间上来看，这篇文章也还算近：<code class="language-text">2018-01-08</code>。</p>
<p>这篇博文分析了大规模Elasticsearch集群会面临的挑战，以及解决方案，还按实际的应用Scenario进行了问题分析以及给出了解决范例，很棒。</p>
<h1 id="5-kibana" style="position:relative;"><a href="#5-kibana" aria-label="5 kibana permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Kibana</h1>
<p>Kibana这块相对来说比较简单。一些关键文档位置：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/docker.html#docker" target="_blank" rel="nofollow noopener noreferrer">Running Kibana on Docker</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/settings.html#settings" target="_blank" rel="nofollow noopener noreferrer">Configuring Kibana</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/kuery-query.html" target="_blank" rel="nofollow noopener noreferrer">Kibana Query Language</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/lucene-query.html#lucene-query" target="_blank" rel="nofollow noopener noreferrer">Lucene Query Syntax</a></li>
</ul>
<h2 id="51-index-pattern-id_index_pattern" style="position:relative;"><a href="#51-index-pattern-id_index_pattern" aria-label="51 index pattern id_index_pattern permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.1 Index Pattern {#ID_INDEX_PATTERN}</h2>
<p>在打开Kibana页面进行任何查询和设置之前，必须进行<code class="language-text">Index Pattern</code>的设置。这是使用的前提。该设置是用来告知Kibana，Elasticsearch集群中的哪些Index是需要进行解析和观察的，作为后续所有查询的数据来源。</p>
<p>官方文档：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/index-patterns.html#index-patterns" target="_blank" rel="nofollow noopener noreferrer">Index Patterns</a> <a href="https://www.elastic.co/guide/cn/kibana/current/index-patterns.html" target="_blank" rel="nofollow noopener noreferrer">中文</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-define-index.html#tutorial-define-index" target="_blank" rel="nofollow noopener noreferrer">Defining your index patterns</a></li>
</ul>
<p>官方对于自动化的支持做的不太好，如果需要在Elasticsearch集群启动之后自动化对Kibana内设置Index Pattern的话，该需求是没有官方的解决方案的。找了一圈有一些hack方案，但都不稳定，非常容易因版本更新的原因后续就无法使用了。这方面后面只能说有需要再临时找对应版本的hack。</p>
<ul>
<li><a href="https://github.com/elastic/kibana/issues/3709" target="_blank" rel="nofollow noopener noreferrer">Index pattern creation API #3709</a></li>
</ul>
<h2 id="52-使用简介" style="position:relative;"><a href="#52-%E4%BD%BF%E7%94%A8%E7%AE%80%E4%BB%8B" aria-label="52 使用简介 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.2 使用简介</h2>
<ul>
<li>如果只是要简单过滤下数据进行简单的统计或者进行临时的debug日志搜索，那么在<code class="language-text">Discover</code>页面直接使用条件搜索过滤即可：<a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-discovering.html#tutorial-discovering" target="_blank" rel="nofollow noopener noreferrer">Discovering your data</a></li>
<li>如果需要对一个常用的搜索或数值结果进行定义，方便后续直接查看，那么可以使用<code class="language-text">Visualize</code>页面制作图表，这里的Visualize是和Grafana里的<code class="language-text">Panel</code>同样的概念：<a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-visualizing.html#tutorial-visualizing" target="_blank" rel="nofollow noopener noreferrer">Visualizing your data</a></li>
<li>如果需要定义一系列常用的图表进行观察，则可以使用<code class="language-text">Dashboard</code>页面进行设置，这里的Dashboard是和Grafana里的<code class="language-text">Dashboard</code>同样的概念：<a href="https://www.elastic.co/guide/en/kibana/7.0/tutorial-dashboard.html#tutorial-dashboard" target="_blank" rel="nofollow noopener noreferrer">Displaying your visualizations in a dashboard</a></li>
</ul>
<p>一般如果将Elasticsearch作为日志聚合debug工具的话，不需要很复杂的设置，直接使用Discover即可。偶尔会有些例如同时在线或最近请求数量之类的观测需求，那么简单设置下Visualize即可。</p>
<h2 id="53-qa" style="position:relative;"><a href="#53-qa" aria-label="53 qa permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.3 Q&#x26;A</h2>
<ul>
<li><a href="https://stackoverflow.com/questions/47370280/whats-the-difference-between-the-field-and-field-keyword-fields-in-kibana" target="_blank" rel="nofollow noopener noreferrer">What’s the difference between the ‘field’ and ‘field.keyword’ fields in Kibana?</a></li>
</ul>
<h1 id="6-filebeat直连elasticsearch实践" style="position:relative;"><a href="#6-filebeat%E7%9B%B4%E8%BF%9Eelasticsearch%E5%AE%9E%E8%B7%B5" aria-label="6 filebeat直连elasticsearch实践 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. Filebeat直连Elasticsearch实践</h1>
<h2 id="61-直连流程" style="position:relative;"><a href="#61-%E7%9B%B4%E8%BF%9E%E6%B5%81%E7%A8%8B" aria-label="61 直连流程 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.1 直连流程</h2>
<p>在实际应用的场景中，大部分情况下我们需要的这是将本地日志的内容分类传送到Elasticsearch集群中，按条件定位到不同的索引内。最多也就是对日志里的字段进行一些简单的丰富化或转换。而完成这样的需求其实是不需要Logstash这样的工具，仅使用Filebeat就可以独立完成。这样做的好处是节约了大量系统资源（Golang vs Java），同时还兼具了高可用和性能。</p>
<p>流程也非常简单：</p>
<ul>
<li>Filebeat监听本地日志变化</li>
<li>Filebeat将新产生的日志内容按JSON进行解析</li>
<li>Filebeat根据日志内的字段内容，进行<code class="language-text">processors</code>处理，进行丰富化或进行格式转换</li>
<li>Filebeat根据根据<code class="language-text">Elasticsearch template setting</code>，启用在Elasticsearch集群上设置好的Index Template（只有这步是依赖Elasticsearch集群的，需要预先在Elasticsearch集群中设置好Template）</li>
<li>Filebeat根据设置，将日志传输到Elasticsearch集群中不同的Index里</li>
</ul>
<p>基本上全部的处理都是在Filebeat里完成了，不需要Ingest Pipeline做什么，更不需要Logstash出马。</p>
<p>实际操作下来，还是有很多细节问题，后面一一细说。</p>
<h2 id="62-应用场景" style="position:relative;"><a href="#62-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" aria-label="62 应用场景 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2 应用场景</h2>
<p>先描述下应用场景，否则后面的一些配置和细节都不好说明。</p>
<p>系统有三个应用程序：</p>
<ul>
<li>web</li>
<li>service</li>
<li>consumer</li>
</ul>
<p>每个应用程序都会输出一份日志：</p>
<ul>
<li>web：/tmp/logs/app/app.web.stdout.log</li>
<li>service：/tmp/logs/app/app.service.stdout.log</li>
<li>consumer：/tmp/logs/app/app.consumer.stdout.log</li>
</ul>
<p>每个应用除了自身的业务日志之外，也会有一些使用中的组件会在对应的日志内输出内容：</p>
<ul>
<li>web：
<ul>
<li>web：自身业务日志</li>
<li>gin：web框架gin的日志</li>
</ul>
</li>
<li>service：
<ul>
<li>service：自身业务日志</li>
<li>gorm：数据库orm框架的日志</li>
</ul>
</li>
<li>consumer：
<ul>
<li>consumer：自身业务日志</li>
<li>gorm：数据库orm框架的日志</li>
</ul>
</li>
</ul>
<p>需求是跟踪、解析这三份日志文件，将输出的日志根据应用以及组件分发到Elasticsearch不同的Index中：</p>
<ul>
<li>web：
<ul>
<li>web：分发到 dist-web-web-*</li>
<li>gin：分发到 dist-web-gin-*</li>
</ul>
</li>
<li>service：
<ul>
<li>service：分发到 dist-service-service-*</li>
<li>gorm：分发到 dist-service-gorm-*</li>
</ul>
</li>
<li>consumer：
<ul>
<li>consumer：分发到 dist-consumer-consumer-*</li>
<li>gorm：分发到 dist-consumer-gorm-*</li>
</ul>
</li>
</ul>
<p>解决方案：</p>
<ul>
<li>使用input配置下的fields配置，根据输入的文件，添加自定义字段：<code class="language-text">fields.app: web|service|consumer</code></li>
<li>使用processors，解析JSON日志内容、字段，添加自定义字段：<code class="language-text">fields.module: web|gin|service|consumer|gorm</code></li>
<li>根据字段<code class="language-text">fields.app``fields.module</code>输出日志到不同的Index：<code class="language-text">dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}</code></li>
</ul>
<h2 id="63-index-template-id_index_template" style="position:relative;"><a href="#63-index-template-id_index_template" aria-label="63 index template id_index_template permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.3 Index Template {#ID_INDEX_TEMPLATE}</h2>
<p>中间还需要补一个Elasticsearch的概念：<code class="language-text">Index Template</code>。官方文档在：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/indices-templates.html" target="_blank" rel="nofollow noopener noreferrer">Index Templates</a>，也有一份<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index-templates.html" target="_blank" rel="nofollow noopener noreferrer">中文</a>的。</p>
<p>之前在<a href="#ID_INDEX">4.2 文档数据库 &#x26; 索引</a>已经讲到了，Index即相当于RDBMS里的<code class="language-text">表名</code>，且在Elasticsearch中是用来进行sharding的重要字段。而同时我们之前也提到过了，在大部分的情况下，Index是自动创建的，按某些格式：<code class="language-text">dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}</code>。所以如果要针对每一个Index进行单独的配置，这基本上是不可能的。在Elasticsearch中，为了应对这样的需求，就有了<code class="language-text">Index Template</code>这个设置。新创建的Index都会根据名字套用上某个Template（如果有匹配到的话），达到对Index进行设置的目的。</p>
<p>此外，Index Template里还设置了很多细节（这些设置都会在名字匹配的Index上生效）：</p>
<ul>
<li>Index的shards数量</li>
<li>Index的replicas数量</li>
<li>Index如何分词、如何过滤</li>
<li>Index对应日志中的字段应该怎么解析，分别都是什么类型的字段（如果不设置的话，Elasticsearch会根据第一次出现的值进行猜测，以后将不再更改，除非使用API手动重设）</li>
<li>等等</li>
</ul>
<p>如果某个新创建的Index不符合任何Elasticsearch集群上已知的所有Template，则该Index内的所有设置都会按默认值来。一般来说这种情况下最严重的问题是：该Index将只会存在一个shard，且只会有一份replica。</p>
<p>所以，一般来说都需要在正式使用之前将需要的Index Template创建好，才可能开始向Elasticsearch输入日志，否则创建出来的Index会有问题，至少分片就不对。</p>
<p>额外的资料：</p>
<ul>
<li>有一份中文的博文，讲解的很好，后续可以看下：<a href="https://www.jianshu.com/p/1f67e4436c37" target="_blank" rel="nofollow noopener noreferrer">初探 Elasticsearch Index Template（索引模板)</a>。</li>
<li>官方社区有一个讨论帖，里面有comment对如何操作自定义Index Template有比较详细的步骤讲解：<a href="https://discuss.elastic.co/t/custom-filebeat-template-for-json-log-lines/114761/5" target="_blank" rel="nofollow noopener noreferrer">Custom filebeat template for JSON log lines</a>。</li>
</ul>
<h2 id="64-issues" style="position:relative;"><a href="#64-issues" aria-label="64 issues permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4 Issues</h2>
<h3 id="641-filebeat字段层级" style="position:relative;"><a href="#641-filebeat%E5%AD%97%E6%AE%B5%E5%B1%82%E7%BA%A7" aria-label="641 filebeat字段层级 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.1 Filebeat字段层级</h3>
<p>Filebeat默认将日志JSON解析出来的内容放到<code class="language-text">message</code>字段下，见下图的message字段内容：</p>
<p><img src="/media/posts/2019/04/elasticsearch-note/filebeat_json_no_root.png" alt=""></p>
<p>如果不知道这点的话，在使用<code class="language-text">processors</code>时候会发现设定的条件因字段没有找到而没有被触发。调试的时候会非常痛苦。</p>
<p>这里需要了解filebeat的设置：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-input-log.html#filebeat-input-log-config-json" target="_blank" rel="nofollow noopener noreferrer">Log input > json</a>。</p>
<p>有几项配置需要了解下：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /<span class="token punctuation">...</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">json.overwrite_keys</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">json.message_key</span><span class="token punctuation">:</span> message
    <span class="token punctuation">...</span></code></pre></div>
<ul>
<li><code class="language-text">json.keys_under_root: true</code>：将之前存放在message字段里的JSON释放到根节点，效果见下图，可以和上面的图做下比对；一般来说这也是用户希望的效果</li>
<li><code class="language-text">json.overwrite_keys: true</code>：是否在冲突的时候使用释放出来的字段的值覆盖根目录下同Key的值，一般也需要配置</li>
<li><code class="language-text">json.message_key: message</code>：这项一般不要改，留默认的<code class="language-text">message</code>即可，后面会解释原因</li>
</ul>
<p><img src="/media/posts/2019/04/elasticsearch-note/filebeat_json_root.png" alt=""></p>
<p>如果不配置<code class="language-text">json.keys_under_root: true</code>也不是不可以，但在查找日志JSON内容的时候就需要到message字段下去查找，而不是根节点。</p>
<h3 id="642-kibana-message字段" style="position:relative;"><a href="#642-kibana-message%E5%AD%97%E6%AE%B5" aria-label="642 kibana message字段 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.2 Kibana message字段</h3>
<p>Kibana页面上的原始日志页面，显示的是filebeat传输到Elasticsearch日志内容中的<code class="language-text">message</code>字段内容，且显示的仅只有message字段的内容。并且，当Kibana发现Elasticsearch中存放的日志不存在message字段的时候，还会显示错误：<code class="language-text">failed to find message</code>。因此之前提到，不要随意更改：<code class="language-text">json.message_key: message</code>。要更改Kibana的行为也不是不可以，参见：</p>
<ul>
<li><a href="https://discuss.elastic.co/t/log-ui-failed-to-format-message-from/163196" target="_blank" rel="nofollow noopener noreferrer">Log UI failed to format message from</a></li>
<li><a href="https://github.com/elastic/kibana/pull/26579/files#diff-3d8e25bfa60ef76c1ce7b5e7a68232f2R9" target="_blank" rel="nofollow noopener noreferrer">[InfraOps] Update docs with data source configuration</a></li>
</ul>
<p>实际效果可以参见下面两张图的比对，第一张是没有使用<code class="language-text">json.keys_under_root: true</code>的情况，第二张则是释放之后的情况：</p>
<p><img src="/media/posts/2019/04/elasticsearch-note/filebeat_logs_msg_no_root.png" alt="">
<img src="/media/posts/2019/04/elasticsearch-note/filebeat_logs_msg_root.png" alt=""></p>
<h3 id="643-input--processors-fields" style="position:relative;"><a href="#643-input--processors-fields" aria-label="643 input  processors fields permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.3 input | processors fields</h3>
<p>在filebeat的input配置中，可以根据日志输入向日志内容中添加自定义的字段：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/app/logs/app.web.stdout.log
    <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> web
    <span class="token punctuation">...</span></code></pre></div>
<p>在processors配置中，也可以根据条件向日志内容中添加自定义的字段：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">processors</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_fields</span><span class="token punctuation">:</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span>
        <span class="token key atrule">contains</span><span class="token punctuation">:</span>
          <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">"WEB.Handler"</span>
      <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"web"</span>
<span class="token punctuation">...</span></code></pre></div>
<p>但有一点需要明确，这些添加的字段，都会存放在根节点下的<code class="language-text">fields</code>字段里。上面例子里的两个设置，会产生：</p>
<ul>
<li>fields.app: web</li>
<li>fields.module: web</li>
</ul>
<p>可以看下之前6.4.1图中的字段列表。</p>
<h3 id="644-index-template设置-id_filebeat_index_template" style="position:relative;"><a href="#644-index-template%E8%AE%BE%E7%BD%AE-id_filebeat_index_template" aria-label="644 index template设置 id_filebeat_index_template permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.4 Index Template设置 {#ID_FILEBEAT_INDEX_TEMPLATE}</h3>
<p>Index Template虽然是在Elasticsearch上创建的（见：<a href="#ID_INDEX_TEMPLATE">6.3 Index Template</a>），但在filebeat端还是需要做设置的。主要是需要在filebeat端加载Elasticsearch上存在的Index Template，然后后续在filebeat向Elasticsearch传输日志的时候，就会应用这些Template。如果配置不正确的话，诸如shards数量之类的配置就会出错、不生效。</p>
<ul>
<li>filebeat中关于Index Template的配置项：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/configuration-template.html" target="_blank" rel="nofollow noopener noreferrer">Load the Elasticsearch index template</a></li>
<li>filebeat中如何加载Index Template：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/filebeat-template.html" target="_blank" rel="nofollow noopener noreferrer">Step 4: Load the index template in Elasticsearch</a></li>
<li>此外，该功能一般和输出相关配置有关：<a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/elasticsearch-output.html#indices-option-es" target="_blank" rel="nofollow noopener noreferrer">Configure the Elasticsearch output > indices</a></li>
</ul>
<p>如果不想在Elasticsearch端创建自定义的Index Template，那么可以使用的Template只有一个，就是filebeat默认的：<code class="language-text">filebeat-%{[agent.version]}-%{+yyyy.MM.dd}</code>，在当前的版本下就是：<code class="language-text">filebeat-7.0.0-2019-05-29</code>。</p>
<p>该默认的Template在Elastcsearch上的配置可以通过API <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/indices-templates.html#getting" target="_blank" rel="nofollow noopener noreferrer">Getting templates</a> 进行观察：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token property">"filebeat-7.0.0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"order"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"index_patterns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"filebeat-7.0.0-*"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"lifecycle"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"filebeat-7.0.0"</span><span class="token punctuation">,</span>
        <span class="token property">"rollover_alias"</span><span class="token operator">:</span> <span class="token string">"filebeat-7.0.0"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"mapping"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"total_fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"limit"</span><span class="token operator">:</span> <span class="token string">"10000"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"refresh_interval"</span><span class="token operator">:</span> <span class="token string">"5s"</span><span class="token punctuation">,</span>
      <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
      ...</code></pre></div>
<p>可以看到，该Template的名字匹配pattern是：<code class="language-text">filebeat-7.0.0-*</code>，所以如果要利用这个默认的Template的话，名字一定不能搞错。我之前做实验的时候使用过：</p>
<ul>
<li>filebeat-web-web-7.0.0-*</li>
<li>filebeat-web-gin-7.0.0-*</li>
<li>…</li>
</ul>
<p>之类的，就因为名字不匹配导致没有套用上这个Template，最后shards数量之类的就全错了。</p>
<h3 id="645-切片数量" style="position:relative;"><a href="#645-%E5%88%87%E7%89%87%E6%95%B0%E9%87%8F" aria-label="645 切片数量 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.5 切片数量</h3>
<p>查看集群Index切片状态，可以通过API <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat-shards.html#cat-shards" target="_blank" rel="nofollow noopener noreferrer">cat shards</a>。</p>
<p>范例集群的切片设置为：<code class="language-text">主节点</code>数量3，<code class="language-text">replica</code>数量1。也就是说一个Index的切片总数为：<code class="language-text">primary * (1 + replica)</code> = 6。公式括号中的1就是primary，每一份切片只会有一个primary。</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">curl</span> <span class="token parameter variable">-X</span> GET <span class="token string">"http://127.0.0.1:9201/_cat/shards"</span>
dist-consumer-gorm-7.0.0-2019.05.29     <span class="token number">2</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
dist-consumer-gorm-7.0.0-2019.05.29     <span class="token number">2</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
dist-consumer-gorm-7.0.0-2019.05.29     <span class="token number">1</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
dist-consumer-gorm-7.0.0-2019.05.29     <span class="token number">1</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.3 es_1
dist-consumer-gorm-7.0.0-2019.05.29     <span class="token number">0</span> p STARTED <span class="token number">1</span> <span class="token number">17</span>.2kb <span class="token number">172.20</span>.0.2 es_3
dist-consumer-gorm-7.0.0-2019.05.29     <span class="token number">0</span> r STARTED <span class="token number">1</span> <span class="token number">17</span>.2kb <span class="token number">172.20</span>.0.3 es_1
dist-web-gin-7.0.0-2019.05.29           <span class="token number">2</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
dist-web-gin-7.0.0-2019.05.29           <span class="token number">2</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
dist-web-gin-7.0.0-2019.05.29           <span class="token number">1</span> r STARTED <span class="token number">2</span> <span class="token number">32</span>.3kb <span class="token number">172.20</span>.0.4 es_2
dist-web-gin-7.0.0-2019.05.29           <span class="token number">1</span> p STARTED <span class="token number">2</span> <span class="token number">32</span>.3kb <span class="token number">172.20</span>.0.3 es_1
dist-web-gin-7.0.0-2019.05.29           <span class="token number">0</span> p STARTED <span class="token number">2</span> <span class="token number">32</span>.3kb <span class="token number">172.20</span>.0.2 es_3
dist-web-gin-7.0.0-2019.05.29           <span class="token number">0</span> r STARTED <span class="token number">2</span> <span class="token number">32</span>.3kb <span class="token number">172.20</span>.0.3 es_1
dist-service-gorm-7.0.0-2019.05.29      <span class="token number">2</span> p STARTED <span class="token number">4</span> <span class="token number">33</span>.4kb <span class="token number">172.20</span>.0.2 es_3
dist-service-gorm-7.0.0-2019.05.29      <span class="token number">2</span> r STARTED <span class="token number">4</span> <span class="token number">33</span>.4kb <span class="token number">172.20</span>.0.3 es_1
dist-service-gorm-7.0.0-2019.05.29      <span class="token number">1</span> r STARTED <span class="token number">1</span> <span class="token number">16</span>.6kb <span class="token number">172.20</span>.0.4 es_2
dist-service-gorm-7.0.0-2019.05.29      <span class="token number">1</span> p STARTED <span class="token number">1</span> <span class="token number">16</span>.6kb <span class="token number">172.20</span>.0.3 es_1
dist-service-gorm-7.0.0-2019.05.29      <span class="token number">0</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
dist-service-gorm-7.0.0-2019.05.29      <span class="token number">0</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
dist-consumer-consumer-7.0.0-2019.05.29 <span class="token number">2</span> p STARTED <span class="token number">1</span> <span class="token number">14</span>.6kb <span class="token number">172.20</span>.0.4 es_2
dist-consumer-consumer-7.0.0-2019.05.29 <span class="token number">2</span> r STARTED <span class="token number">1</span> <span class="token number">14</span>.6kb <span class="token number">172.20</span>.0.2 es_3
dist-consumer-consumer-7.0.0-2019.05.29 <span class="token number">1</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
dist-consumer-consumer-7.0.0-2019.05.29 <span class="token number">1</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.3 es_1
dist-consumer-consumer-7.0.0-2019.05.29 <span class="token number">0</span> p STARTED <span class="token number">1</span> <span class="token number">14</span>.6kb <span class="token number">172.20</span>.0.4 es_2
dist-consumer-consumer-7.0.0-2019.05.29 <span class="token number">0</span> r STARTED <span class="token number">1</span> <span class="token number">14</span>.6kb <span class="token number">172.20</span>.0.3 es_1
.kibana_1                               <span class="token number">0</span> r STARTED <span class="token number">6</span> <span class="token number">50</span>.2kb <span class="token number">172.20</span>.0.4 es_2
.kibana_1                               <span class="token number">0</span> p STARTED <span class="token number">6</span> <span class="token number">50</span>.2kb <span class="token number">172.20</span>.0.3 es_1
dist-service-service-7.0.0-2019.05.29   <span class="token number">2</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
dist-service-service-7.0.0-2019.05.29   <span class="token number">2</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
dist-service-service-7.0.0-2019.05.29   <span class="token number">1</span> r STARTED <span class="token number">3</span> <span class="token number">28</span>.2kb <span class="token number">172.20</span>.0.2 es_3
dist-service-service-7.0.0-2019.05.29   <span class="token number">1</span> p STARTED <span class="token number">3</span> <span class="token number">14</span>.9kb <span class="token number">172.20</span>.0.3 es_1
dist-service-service-7.0.0-2019.05.29   <span class="token number">0</span> p STARTED <span class="token number">1</span> <span class="token number">13</span>.9kb <span class="token number">172.20</span>.0.4 es_2
dist-service-service-7.0.0-2019.05.29   <span class="token number">0</span> r STARTED <span class="token number">1</span> <span class="token number">13</span>.9kb <span class="token number">172.20</span>.0.3 es_1
.kibana_task_manager                    <span class="token number">0</span> p STARTED <span class="token number">2</span> <span class="token number">45</span>.4kb <span class="token number">172.20</span>.0.4 es_2
.kibana_task_manager                    <span class="token number">0</span> r STARTED <span class="token number">2</span> <span class="token number">45</span>.4kb <span class="token number">172.20</span>.0.2 es_3
dist-web-web-7.0.0-2019.05.29           <span class="token number">2</span> p STARTED <span class="token number">2</span> <span class="token number">27</span>.9kb <span class="token number">172.20</span>.0.2 es_3
dist-web-web-7.0.0-2019.05.29           <span class="token number">2</span> r STARTED <span class="token number">2</span> <span class="token number">27</span>.9kb <span class="token number">172.20</span>.0.3 es_1
dist-web-web-7.0.0-2019.05.29           <span class="token number">1</span> r STARTED <span class="token number">1</span>   14kb <span class="token number">172.20</span>.0.4 es_2
dist-web-web-7.0.0-2019.05.29           <span class="token number">1</span> p STARTED <span class="token number">1</span>   14kb <span class="token number">172.20</span>.0.3 es_1
dist-web-web-7.0.0-2019.05.29           <span class="token number">0</span> p STARTED <span class="token number">1</span>   14kb <span class="token number">172.20</span>.0.4 es_2
dist-web-web-7.0.0-2019.05.29           <span class="token number">0</span> r STARTED <span class="token number">1</span>   14kb <span class="token number">172.20</span>.0.2 es_3
filebeat-7.0.0-2019.05.29-000001        <span class="token number">2</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
filebeat-7.0.0-2019.05.29-000001        <span class="token number">2</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
filebeat-7.0.0-2019.05.29-000001        <span class="token number">1</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.2 es_3
filebeat-7.0.0-2019.05.29-000001        <span class="token number">1</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.3 es_1
filebeat-7.0.0-2019.05.29-000001        <span class="token number">0</span> p STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.4 es_2
filebeat-7.0.0-2019.05.29-000001        <span class="token number">0</span> r STARTED <span class="token number">0</span>   230b <span class="token number">172.20</span>.0.3 es_1</code></pre></div>
<p>输出的内容有几列，这里解释下含义：</p>
<ul>
<li><code class="language-text">Index名</code>：dist-consumer-gorm-7.0.0-2019.05.29</li>
<li><code class="language-text">节点编号</code>：切片在当前Index的切片组中的编号，从0开始，一个primary占用一个编号，所有该primary的从属replicas和primary共享同一个编号</li>
<li><code class="language-text">节点类型</code>：只有<code class="language-text">p</code>和<code class="language-text">r</code>，表示是primary还是replica</li>
<li><code class="language-text">节点状态</code>：正常状态为<code class="language-text">STARTED</code>，启动中为<code class="language-text">INITIALIZING</code>，错误状态为<code class="language-text">UNASSIGNED</code>；unassigned相关参见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/cat-shards.html#reason-unassigned" target="_blank" rel="nofollow noopener noreferrer">Reasons for unassigned shard</a></li>
<li><code class="language-text">文档数量</code>：存储在该节点内的文档数量</li>
<li><code class="language-text">节点容量</code>：节点占用的磁盘容量</li>
<li><code class="language-text">节点IP</code>：节点的IP地址</li>
<li><code class="language-text">节点名</code>：节点在Elasticsearch集群中的名字</li>
</ul>
<h3 id="646-kibana-timestamp" style="position:relative;"><a href="#646-kibana-timestamp" aria-label="646 kibana timestamp permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.6 Kibana @timestamp</h3>
<p>Filebeat向Elasticsearch传输的日志内容会添加一个字段：<code class="language-text">@timestamp</code>。而Kibana在设置Index Pattern（<a href="#ID_INDEX_PATTERN">5.1 Index Pattern</a>）的时候，强制需要选择一项日志内的时间字段作为后续时间相关过滤的指标。如果用户没有自己的时间字段的话，一般都会选择<code class="language-text">@timestamp</code>字段，因为该段总是存在的。</p>
<p>不过这里有一项需要注意：</p>
<p>@timestamp 是日志被filebeat处理的时间点，而不是日志发生的时间点。一般来说这两者可以混用，但在日志有堆积，处理比较慢的情况下，就不合适了。千万需要小心，一般来说尽量选择业务日志自带的时间字段，就不会有问题了。</p>
<h3 id="647-elasticsearch-预创建数据" style="position:relative;"><a href="#647-elasticsearch-%E9%A2%84%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE" aria-label="647 elasticsearch 预创建数据 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.4.7 Elasticsearch 预创建数据</h3>
<p>一般来说，在Elasticsearch启动的时候都会有创建一些预设配置的需求，特别是在docker中运行的时候，因为docker本来就具有高度自动化的特征，也就格外需要这样的预设数据。这方面只能说官方仍旧没有提供非常完备的支持，只能自行处理：</p>
<ul>
<li><a href="https://discuss.elastic.co/t/best-practice-for-creating-an-index-when-an-es-docker-container-starts/126651" target="_blank" rel="nofollow noopener noreferrer">Best practice for creating an index when an ES docker container starts</a></li>
<li><a href="https://stackoverflow.com/questions/35526532/how-to-add-an-elasticsearch-index-during-docker-build" target="_blank" rel="nofollow noopener noreferrer">How to add an elasticsearch index during docker build</a></li>
</ul>
<h1 id="7-实践范例" style="position:relative;"><a href="#7-%E5%AE%9E%E8%B7%B5%E8%8C%83%E4%BE%8B" aria-label="7 实践范例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7. 实践范例</h1>
<p>和之前做Prometheus实验的时候一样，因为需要把握一些细节，所以实验使用的还是下载下来的Elasticsearch、Kibana以及Filebeat。作为配角的Nginx使用的则是镜像版本。</p>
<p>范例代码可以在Github查看：<a href="https://github.com/agreatfool/dist-system-practice/tree/master/experiment/elasticsearch" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/experiment/elasticsearch/</a>。</p>
<p>这则例子非常简单，基本上没有涉及任何比较核心的使用，粗略看下启动还是可以的。</p>
<h1 id="8-docker集群部署" style="position:relative;"><a href="#8-docker%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2" aria-label="8 docker集群部署 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8. Docker集群部署</h1>
<p>仍旧是使用docker-compose进行群组的编辑和启动，可运行范例可以查看：<a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/conf/dev/elk-cluster.yaml" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/conf/dev/elk-cluster.yaml</a>。</p>
<p>启动脚本：<a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/bash/dev/docker_elasticsearch.sh" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/bash/dev/docker_elasticsearch.sh</a>。</p>
<p>下面会根据职责一一解析配置文件。</p>
<h2 id="81-elasticsearch配置-id_es_config" style="position:relative;"><a href="#81-elasticsearch%E9%85%8D%E7%BD%AE-id_es_config" aria-label="81 elasticsearch配置 id_es_config permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.1 Elasticsearch配置 {#ID_ES_CONFIG}</h2>
<p><strong>elk-cluster.yaml</strong></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">x-es-environment-defaults</span><span class="token punctuation">:</span>
  <span class="token key atrule">C1</span><span class="token punctuation">:</span> <span class="token important">&amp;DISCOVERY_SEED_HOSTS</span> <span class="token string">"discovery.seed_hosts=es_1:9300,es_2:9300,es_3:9300"</span> <span class="token comment"># 集群中的所有可用节点，这个配置中需要完整给出节点的HOST和PORT</span>
  <span class="token key atrule">C2</span><span class="token punctuation">:</span> <span class="token important">&amp;CLUSTER_INITIAL_MASTER_NODES</span> <span class="token string">"cluster.initial_master_nodes=es_1,es_2,es_3"</span> <span class="token comment"># 集群初始化的master节点，这个配置中只需要给节点名，即 node.name=es_1 里面设置的名字</span>
  <span class="token key atrule">C4</span><span class="token punctuation">:</span> <span class="token important">&amp;ES_JAVA_OPTS</span> "ES_JAVA_OPTS=\
      <span class="token punctuation">-</span>Xms256m \
      <span class="token punctuation">-</span>Xmx256m \
    "

<span class="token key atrule">x-es-ulimit-defaults</span><span class="token punctuation">:</span> <span class="token important">&amp;ES_ULIMIT_DEFAULTS</span>
  <span class="token key atrule">nproc</span><span class="token punctuation">:</span> <span class="token number">65535</span>
  <span class="token key atrule">nofile</span><span class="token punctuation">:</span>
    <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">65535</span>
    <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">65535</span>
  <span class="token key atrule">memlock</span><span class="token punctuation">:</span>
    <span class="token key atrule">soft</span><span class="token punctuation">:</span> <span class="token number">-1</span>
    <span class="token key atrule">hard</span><span class="token punctuation">:</span> <span class="token number">-1</span>

<span class="token key atrule">x-es-logging-defaults</span><span class="token punctuation">:</span> <span class="token important">&amp;ES_LOGGING_DEFAULTS</span>
  <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"json-file"</span>
  <span class="token key atrule">options</span><span class="token punctuation">:</span>
    <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token string">"512m"</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">net</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"bridge"</span>

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">es_vol_1_logs</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"local"</span>
  <span class="token key atrule">es_vol_1_data</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"local"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">es_1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"elasticsearch:7.0.0"</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">"es_1"</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">"es_1"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> es_vol_1_data<span class="token punctuation">:</span>/usr/share/elasticsearch/data
      <span class="token punctuation">-</span> es_vol_1_logs<span class="token punctuation">:</span>/usr/share/elasticsearch/logs
      <span class="token punctuation">-</span> /private/tmp/elasticsearch.yaml<span class="token punctuation">:</span>/usr/share/elasticsearch/config/elasticsearch.yml
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"net"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9201:9201"</span> <span class="token comment"># 该PORT是给外部访问使用的，比如Kibana、Filebeat，以及客户端查询API</span>
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9300"</span> <span class="token comment"># 该PORT是给集群内部流量使用的，所以只要expose即可</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token string">"always"</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*ES_LOGGING_DEFAULTS</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> node.name=es_1 <span class="token comment"># 节点名必须设置且不可重复</span>
      <span class="token punctuation">-</span> http.port=9201 <span class="token comment"># 这个PORT同上</span>
      <span class="token punctuation">-</span> node.master=true <span class="token comment"># 如果需要该节点作为master角色提供服务，则这里设置成true</span>
      <span class="token punctuation">-</span> node.data=true <span class="token comment"># 如果需要该节点作为数据节点提供服务（数据存储），则这里设置成true</span>
      <span class="token punctuation">-</span> <span class="token important">*DISCOVERY_SEED_HOSTS</span>
      <span class="token punctuation">-</span> <span class="token important">*CLUSTER_INITIAL_MASTER_NODES</span>
      <span class="token punctuation">-</span> <span class="token important">*ES_JAVA_OPTS</span>
    <span class="token key atrule">ulimits</span><span class="token punctuation">:</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*ES_ULIMIT_DEFAULTS</span></code></pre></div>
<p><strong>elasticsearch.yaml</strong></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> es_cluster
<span class="token key atrule">path.data</span><span class="token punctuation">:</span> /usr/share/elasticsearch/data
<span class="token key atrule">path.logs</span><span class="token punctuation">:</span> /usr/share/elasticsearch/logs
<span class="token key atrule">bootstrap.memory_lock</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">transport.tcp.port</span><span class="token punctuation">:</span> <span class="token number">9300</span></code></pre></div>
<p>相关文档：</p>
<ul>
<li>官方文档及范例配置文件：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker-cli-run-prod-mode" target="_blank" rel="nofollow noopener noreferrer">Install Elasticsearch with Docker</a></li>
<li>理解Elasticsearch的集群发现：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/modules-discovery-hosts-providers.html#modules-discovery-hosts-providers" target="_blank" rel="nofollow noopener noreferrer">Discovery</a></li>
<li>全局变量配置的使用：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/settings.html#_environment_variable_substitution" target="_blank" rel="nofollow noopener noreferrer">Environment variable substitution</a></li>
<li>同上，不同的做法：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker-configuration-methods" target="_blank" rel="nofollow noopener noreferrer">Configuring Elasticsearch with Docker</a></li>
<li>一些比较常见的问题：<a href="https://www.jianshu.com/p/fa31f38d241e" target="_blank" rel="nofollow noopener noreferrer">使用ElasticSearch踩过的坑</a></li>
<li>一个非常完整的搭建例子：<a href="https://www.infvie.com/ops-notes/elkstack-beats" target="_blank" rel="nofollow noopener noreferrer">ELK Stack+Beats 搭建分布式日志平台</a></li>
<li>大杂烩：<a href="https://www.jianshu.com/p/6a700cc61913" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch安装配置</a></li>
<li>带说明的非docker安装：<a href="https://logz.io/blog/elasticsearch-cluster-tutorial/" target="_blank" rel="nofollow noopener noreferrer">Creating an Elasticsearch Cluster: Getting Started</a></li>
</ul>
<h3 id="811-环境变量配置" style="position:relative;"><a href="#811-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE" aria-label="811 环境变量配置 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.1.1 环境变量配置</h3>
<p>Elasticsearch的环境变量配置要求使用配置文件中的配置项字符串，完全不用改动，全部都是小写，然后使用<code class="language-text">=</code>连接配置项的值。此外需要注意，数组的配置和配置文件中有所不同，直接使用以<code class="language-text">,</code>分隔的字符串即可：<code class="language-text">discovery.seed_hosts=es_1:9300,es_2:9300,es_3:9300</code>。</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">environment</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> node.name=es_1
  <span class="token punctuation">-</span> http.port=9201
  <span class="token punctuation">-</span> node.master=true
  <span class="token punctuation">-</span> node.data=true
  <span class="token punctuation">-</span> <span class="token punctuation">...</span></code></pre></div>
<h3 id="812-多节点配置的共享" style="position:relative;"><a href="#812-%E5%A4%9A%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%E7%9A%84%E5%85%B1%E4%BA%AB" aria-label="812 多节点配置的共享 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.1.2 多节点配置的共享</h3>
<p>Elasticsearch docker compose的配置中，需要把environment配置成数组，而YAML则恰恰不支持数组的Anchor Merge。这是YAML的一个功能性问题，不支持Array的平铺Merge：<a href="https://github.com/yaml/yaml/issues/35" target="_blank" rel="nofollow noopener noreferrer">Merge arrays #35</a>。社区的方案一般都需要在原生的YAML之外，再使用工具把嵌套的Array整平：<a href="https://stackoverflow.com/questions/4948933/is-there-a-way-to-alias-anchor-an-array-in-yaml" target="_blank" rel="nofollow noopener noreferrer">Is there a way to alias/anchor an array in YAML?</a>，这就在我的接受范围之外了，我不希望使用任何第三方工具来修改yaml文件。</p>
<p>最后方案为：</p>
<ul>
<li>把不怎么需要在运行时修改的共通变量写入配置文件</li>
<li>使用bind mount的方法加载配置文件到容器里</li>
<li>在yaml中设置变量</li>
<li>在多节点中使用变量，至少里面的值只需要改一个地方就可以生效了</li>
</ul>
<h3 id="813-集群发现相关配置" style="position:relative;"><a href="#813-%E9%9B%86%E7%BE%A4%E5%8F%91%E7%8E%B0%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE" aria-label="813 集群发现相关配置 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.1.3 集群发现相关配置</h3>
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/discovery-settings.html#discovery-settings" target="_blank" rel="nofollow noopener noreferrer">Important discovery and cluster formation settings</a>。</p>
<p>集群发现主要依赖两项配置：</p>
<ul>
<li>discovery.seed_hosts=es_1:9300,es_2:9300,es_3:9300</li>
<li>cluster.initial_master_nodes=es_1,es_2,es_3</li>
</ul>
<p><code class="language-text">discovery.seed_hosts</code>用来告知Elasticsearch组成集群的所有节点都是谁，分别HOST和PORT是什么。无论是否是master节点，或者是否仅仅只是data节点，都需要列在这个选项中，告知给Elasticsearch。这个选项里的配置是常规的<code class="language-text">host:port</code>。</p>
<p><code class="language-text">cluster.initial_master_nodes</code>用来告知Elasticsearch，集群启动的时候初期可用的master节点是哪几个，之后Elasticsearch会从这些节点中选出master节点。列在这个配置中的节点，其<code class="language-text">node.master=true</code>必须为true。</p>
<p>然后，这个配置有个坑，非常非常坑，这个配置中的所有字符串，列的都是节点的名字，即必须和<code class="language-text">node.name=es_1</code>里的名字一致，不需要配置成<code class="language-text">host:port</code>，只需要<code class="language-text">node_name</code>。官方文档中的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html#docker-cli-run-prod-mode" target="_blank" rel="nofollow noopener noreferrer">例子</a>因为是docker，所以节点的名字和docker network中的container名字是一致的，而且官方的例子用的都是默认port，所有的port都没写，所以我一开始误认为这个选项里的配置也是<code class="language-text">host:port</code>，然后各种无法组成集群。而且Elasticsearch针对这种错误给的错误信息非常暧昧，完全找不到有用的信息。最后找了半天才在官方论坛的一个帖子里找到线索。我填了这个坑之后貌似官方文档就更新了。</p>
<p><a href="https://discuss.elastic.co/t/elastic-search-7-unable-to-bootstrap-the-cluster-due-to-master-not-discovered-yet/182073/2" target="_blank" rel="nofollow noopener noreferrer">Elastic Search 7 unable to bootstrap the cluster due to master not discovered yet</a>（这个comment离我找到它只隔了3天，超级新的问题）：</p>
<blockquote>
<p>Remove the port from the cluster.initial_master_nodes setting, and it will work. We have updated the docs recently to make it clearer that either node name, or ip/port is to be used. Node name/port is not a valid combination.</p>
</blockquote>
<p><a href="https://discuss.elastic.co/t/elastic-search-7-unable-to-bootstrap-the-cluster-due-to-master-not-discovered-yet/182073/4" target="_blank" rel="nofollow noopener noreferrer">另一个comment</a>：</p>
<blockquote>
<p>It is intentional. This setting does not denote a hostname, but the node name or the advertised publish address. In particular, it is not an address that is resolved or actively connected to. The discovery.seed_hosts setting is used for that. The cluster.initial_master_nodes setting is used to determine the identities of the subset of master-eligible nodes that participate in the bootstrapping process after discovery.seed_hosts has established a connection to the nodes.</p>
</blockquote>
<p><strong>UPDATE</strong></p>
<p>在后续的实践中遇到了新问题，之前测试因为都一直使用一个物理机，并将所有的es节点都部署在同一个docker network下，因此没有发现问题。</p>
<p>问题描述：如果将不同的容器放入并非同一个而是分开的单独network中，集群的组建就不能依赖docker network当中内部的host，而是需要手动设定，否则集群无法组建起来。</p>
<p>这个问题和kafka集群的INSIDE、OUTSIDE设置，需要配置不同的HOST是一样的道理。为了让es集群各节点能在隔离的网络下互相访问，需要在设置中指明内部流量应该通过什么地址进行相互发现。上文中关于集群组建的相关配置一个都不能少，也不需要改动，这里需要做的配置改动是引进一个新的配置项：<code class="language-text">network.publish_host</code>。</p>
<p>参见：<a href="https://www.elastic.co/cn/blog/docker-networking" target="_blank" rel="nofollow noopener noreferrer">Docker Networking</a>：</p>
<blockquote>
<p>When running Elasticsearch, you will need to ensure it publishes to an IP address that is reachable from outside the container; this can be configured via the setting network.publish_host.</p>
</blockquote>
<p>这个配置项配置为：<code class="language-text">${物理主机HOST/IP}:${内部流量PORT}</code>即可，e.g <code class="language-text">192.168.3.111:9300</code>。这样集群里的各节点就可以相互发现并组成集群了。</p>
<h2 id="82-kibana配置" style="position:relative;"><a href="#82-kibana%E9%85%8D%E7%BD%AE" aria-label="82 kibana配置 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.2 Kibana配置</h2>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">kibana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"kibana:7.0.0"</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">"kibana"</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">"kibana"</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"es_1"</span>
      <span class="token punctuation">-</span> <span class="token string">"es_2"</span>
      <span class="token punctuation">-</span> <span class="token string">"es_3"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"net"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"5601:5601"</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token string">"always"</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*ES_LOGGING_DEFAULTS</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> SERVER_PORT=5601
      <span class="token punctuation">-</span> SERVER_HOST=0.0.0.0
      <span class="token punctuation">-</span> SERVER_NAME=es_cluster
      <span class="token punctuation">-</span> ELASTICSEARCH_HOSTS=<span class="token punctuation">[</span><span class="token string">"http://es_1:9201"</span><span class="token punctuation">]</span>
      <span class="token punctuation">-</span> KIBANA_INDEX=.kibana
      <span class="token punctuation">-</span> DIBANA_DEFAULTAPPID=home
      <span class="token punctuation">-</span> ELASTICSEARCH_PINGTIMEOUT=1500
      <span class="token punctuation">-</span> ELASTICSEARCH_REQUESTTIMEOUT=10000
      <span class="token punctuation">-</span> ELASTICSEARCH_LOGQUERIES=false</code></pre></div>
<p>相关文档：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/docker.html" target="_blank" rel="nofollow noopener noreferrer">Running Kibana on Docker</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/7.0/docker.html#environment-variable-config" target="_blank" rel="nofollow noopener noreferrer">Environment variable configuration</a></li>
</ul>
<p>Kibana环境变量的配置和Elasticsearch不一致：</p>
<ul>
<li>Elasticsearch使用的是数组，常量的键使用的直接是配置文件中的键，不需要转大写和下划线</li>
<li>Kibana使用的是数组，常量的键使用的是配置文件中的键转大写，且将点转换成下划线</li>
</ul>
<p>当前版本有一个配置项相关非常严重的BUG：<a href="https://github.com/elastic/kibana/issues/32303" target="_blank" rel="nofollow noopener noreferrer">Kibana fails to validate config if elasticsearch.hosts is not a string #32303</a>。</p>
<p>简单来说就是<code class="language-text">ELASTICSEARCH_HOSTS</code>这项配置，如果写成下面的任何一种，都不正确，Kibana会报错告知找不到Elasticsearch集群：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">ELASTICSEARCH_HOSTS</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> http<span class="token punctuation">:</span>//es_1<span class="token punctuation">:</span><span class="token number">9201</span>
  <span class="token punctuation">-</span> http<span class="token punctuation">:</span>//es_2<span class="token punctuation">:</span><span class="token number">9202</span>
  <span class="token punctuation">-</span> http<span class="token punctuation">:</span>//es_3<span class="token punctuation">:</span><span class="token number">9203</span>

ELASTICSEARCH_HOSTS=<span class="token punctuation">[</span><span class="token string">"http://es_1:9201"</span><span class="token punctuation">,</span><span class="token string">"http://es_2:9202"</span><span class="token punctuation">,</span><span class="token string">"http://es_3:9203"</span><span class="token punctuation">]</span>

ELASTICSEARCH_HOSTS=es_1<span class="token punctuation">:</span><span class="token number">9201</span><span class="token punctuation">,</span>es_2<span class="token punctuation">:</span><span class="token number">9202</span><span class="token punctuation">,</span>es_3<span class="token punctuation">:</span><span class="token number">9203</span></code></pre></div>
<p>虽然上面的写法其实理论上来说都是合法的，但现在就是会出错。现在唯一的写法是：<code class="language-text">ELASTICSEARCH_HOSTS=["http://es_1:9201"]</code>。写成数组格式，但里面只能放一个节点，这样就不会出错。</p>
<h2 id="83-filebeat配置" style="position:relative;"><a href="#83-filebeat%E9%85%8D%E7%BD%AE" aria-label="83 filebeat配置 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.3 Filebeat配置</h2>
<p><strong>elk-cluster.yaml</strong></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"elastic/filebeat:7.0.0"</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">"filebeat"</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">"filebeat"</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"es_1"</span>
      <span class="token punctuation">-</span> <span class="token string">"es_2"</span>
      <span class="token punctuation">-</span> <span class="token string">"es_3"</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"net"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /private/tmp/filebeat.yaml<span class="token punctuation">:</span>/usr/share/filebeat/filebeat.yml
      <span class="token punctuation">-</span> /private/tmp/logs/app<span class="token punctuation">:</span>/tmp/app/logs
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token string">"always"</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*ES_LOGGING_DEFAULTS</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ES_HOSTS=es_1<span class="token punctuation">:</span><span class="token number">9200</span><span class="token punctuation">,</span>es_2<span class="token punctuation">:</span><span class="token number">9200</span><span class="token punctuation">,</span>es_3<span class="token punctuation">:</span><span class="token number">9200</span>
      <span class="token punctuation">-</span> LOGGING_LEVEL=debug <span class="token comment"># error, warning, info, debug</span>
      <span class="token punctuation">-</span> NUM_OF_OUTPUT_WORKERS=9 <span class="token comment"># workers会均匀分配到node：如果有3个ES的node，那么每个node会分到3个workers</span>
      <span class="token punctuation">-</span> NUM_OF_SHARDS=3
      <span class="token punctuation">-</span> NUM_OF_REPLICAS=1</code></pre></div>
<p><strong>filebeat.yaml</strong></p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /tmp/app/logs/app.web.stdout.log
  <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 释放日志JSON到根节点</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web <span class="token comment"># 根据日志文件，添加不同的app字段值，后续会使用该值进行不同的Index分发</span>

<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /tmp/app/logs/app.service.stdout.log
  <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> service

<span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /tmp/app/logs/app.consumer.stdout.log
  <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> consumer

<span class="token key atrule">logging.level</span><span class="token punctuation">:</span> <span class="token string">'${LOGGING_LEVEL}'</span>
<span class="token key atrule">logging.selectors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span>

<span class="token key atrule">processors</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_fields</span><span class="token punctuation">:</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span>
        <span class="token key atrule">contains</span><span class="token punctuation">:</span>
          <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">"WEB.Handler"</span> <span class="token comment"># 根据日志内容，进行条件匹配</span>
      <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"web"</span> <span class="token comment"># 根据不同的匹配，添加不同的module字段值，后续会使用该值进行不同的Index分发</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_fields</span><span class="token punctuation">:</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span>
        <span class="token key atrule">contains</span><span class="token punctuation">:</span>
          <span class="token key atrule">logger</span><span class="token punctuation">:</span> <span class="token string">"7c4b822813e7"</span> <span class="token comment"># "logger":"zap@v0.0.0-20190405225521-7c4b822813e7/zap.go:46"</span>
      <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"gin"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_fields</span><span class="token punctuation">:</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span>
        <span class="token key atrule">contains</span><span class="token punctuation">:</span>
          <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">"gorm"</span>
      <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"gorm"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_fields</span><span class="token punctuation">:</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span>
        <span class="token key atrule">contains</span><span class="token punctuation">:</span>
          <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">"Service.Rpc"</span>
      <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"service"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">add_fields</span><span class="token punctuation">:</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span>
        <span class="token key atrule">contains</span><span class="token punctuation">:</span>
          <span class="token key atrule">message</span><span class="token punctuation">:</span> <span class="token string">"Consumer"</span>
      <span class="token key atrule">fields</span><span class="token punctuation">:</span>
        <span class="token key atrule">module</span><span class="token punctuation">:</span> <span class="token string">"consumer"</span>

<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">"dist"</span> <span class="token comment"># 启用的Elasticsearch Index Template，注意这个Template必须在Elasticsearch中存在</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">"dist-*"</span> <span class="token comment"># Index名字匹配模式</span>
<span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>
  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token string">'${NUM_OF_SHARDS}'</span>
  <span class="token key atrule">index.number_of_replicas</span><span class="token punctuation">:</span> <span class="token string">'${NUM_OF_REPLICAS}'</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token string">'${ES_HOSTS}'</span>
  <span class="token key atrule">worker</span><span class="token punctuation">:</span> <span class="token string">'${NUM_OF_OUTPUT_WORKERS}'</span>
  <span class="token key atrule">indices</span><span class="token punctuation">:</span> <span class="token comment"># 根据之前添加的字段，决定应该发送日志到什么Index</span>
    <span class="token punctuation">-</span> <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">"dist-%{[fields.app]}-%{[fields.module]}-%{[agent.version]}-%{+yyyy.MM.dd}"</span> <span class="token comment"># 注意这里使用到的Index名字需要匹配Index Template</span></code></pre></div>
<p><strong>elk-index-template.json</strong></p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"order"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"index_patterns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"dist-*"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"refresh_interval"</span><span class="token operator">:</span> <span class="token string">"5s"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>相关文档：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/running-on-docker.html#_configure_filebeat_on_docker" target="_blank" rel="nofollow noopener noreferrer">Configure Filebeat on Docker</a></li>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/7.0/using-environ-vars.html#using-environ-vars" target="_blank" rel="nofollow noopener noreferrer">Use environment variables in the configuration</a></li>
</ul>
<p>Filebeat的环境变量配置和Kibana还有Elasticsearch都不一致，明明是一家公司的三个组件，居然相互之间的做法各不相同，也是服了。Filebeat的做法是在启动时设置环境变量，但这个环境变量不会自动转换并覆盖配置文件中的值，而是需要在配置文件中使用<code class="language-text">${ENV_KEY}</code>这样的方法来使用环境变量的值。</p>
<p>此外，关于非常重要的Index Template设置，参见：<a href="#ID_FILEBEAT_INDEX_TEMPLATE">6.4.4 Index Template设置</a>。</p>
<h1 id="9-todo" style="position:relative;"><a href="#9-todo" aria-label="9 todo permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>9. TODO</h1>
<ul>
<li>Elasticsearch集群及一些基本观察用的API熟悉</li>
<li>Elasticsearch JVM相关参数和实践研究</li>
<li>Elasticsearch reshard的策略，最佳实践</li>
<li>Elasticsearch reshard时候的CPU、磁盘、内存，还有特别是网络的影响</li>
<li>Elasticsearch reshard在各种集群规模下的耗时</li>
<li>Elasticsearch的性能指标研究</li>
<li>Elasticsearch性能测试</li>
<li>Kibana使用深入</li>
<li>添加Logstash部分内容，这块由于时间问题暂时不准备展开</li>
</ul>
<h1 id="资料" style="position:relative;"><a href="#%E8%B5%84%E6%96%99" aria-label="资料 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资料</h1>
<h2 id="链接" style="position:relative;"><a href="#%E9%93%BE%E6%8E%A5" aria-label="链接 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>链接</h2>
<ul>
<li><a href="https://sematext.com/blog/logstash-alternatives/" target="_blank" rel="nofollow noopener noreferrer">5 Logstash Alternatives</a></li>
<li><a href="https://gist.github.com/StevenACoffman/4e267f0f60c8e7fcb3f77b9e504f3bd7" target="_blank" rel="nofollow noopener noreferrer">StevenACoffman/fluent-filebeat-comparison.md</a></li>
<li><a href="https://github.com/fluent/fluentd/issues/1657" target="_blank" rel="nofollow noopener noreferrer">Fluentd retains excessive amounts of memory after handling traffic peaks #1657</a></li>
<li><a href="https://www.cnblogs.com/cjsblog/p/9495024.html" target="_blank" rel="nofollow noopener noreferrer">Filebeat 模块与配置</a></li>
<li><a href="https://fdv.github.io/running-elasticsearch-fun-profit/" target="_blank" rel="nofollow noopener noreferrer">Operating Elasticsearch for Fun and Profit</a></li>
<li><a href="https://es.xiaoleilu.com/index.html" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch 权威指南（中文版）</a></li>
<li><a href="https://www.infoq.cn/article/ejEG02VRoeGVaLw4j_LL" target="_blank" rel="nofollow noopener noreferrer">Lucene 查询原理及解析</a></li>
<li><a href="https://stackoverflow.com/questions/27793721/what-is-the-difference-between-lucene-and-elasticsearch" target="_blank" rel="nofollow noopener noreferrer">What is the difference between Lucene and Elasticsearch</a></li>
<li><a href="https://thoughts.t37.net/designing-the-perfect-elasticsearch-cluster-the-almost-definitive-guide-e614eabc1a87" target="_blank" rel="nofollow noopener noreferrer">Designing the Perfect Elasticsearch Cluster: the (almost) Definitive Guide</a></li>
<li><a href="https://es.xiaoleilu.com/020_Distributed_Cluster/00_Intro.html" target="_blank" rel="nofollow noopener noreferrer">集群内部工作方式</a></li>
<li><a href="https://github.com/vvanholl/elasticsearch-prometheus-exporter" target="_blank" rel="nofollow noopener noreferrer">Prometheus Exporter Plugin for Elasticsearch</a></li>
<li><a href="https://thoughts.t37.net/resizing-your-elasticsearch-indexes-in-production-d7a0402d137e" target="_blank" rel="nofollow noopener noreferrer">Resizing your Elasticsearch Indexes in Production</a></li>
<li><a href="https://www.signalfx.com/blog/scaling-elasticsearch-sharding-availability-hundreds-millions-documents/" target="_blank" rel="nofollow noopener noreferrer">Scaling Elasticsearch: Sharding and Availability for Hundreds Of Millions of Documents</a></li>
<li><a href="https://www.ebayinc.com/stories/blogs/tech/elasticsearch-performance-tuning-practice-at-ebay/" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch Performance Tuning Practice at eBay</a></li>
<li><a href="https://github.com/elastic/kibana/issues/3709" target="_blank" rel="nofollow noopener noreferrer">Index pattern creation API #3709</a></li>
<li><a href="https://stackoverflow.com/questions/47370280/whats-the-difference-between-the-field-and-field-keyword-fields-in-kibana" target="_blank" rel="nofollow noopener noreferrer">What’s the difference between the ‘field’ and ‘field.keyword’ fields in Kibana?</a></li>
<li><a href="https://www.jianshu.com/p/1f67e4436c37" target="_blank" rel="nofollow noopener noreferrer">初探 Elasticsearch Index Template（索引模板)</a></li>
<li><a href="https://discuss.elastic.co/t/custom-filebeat-template-for-json-log-lines/114761/5" target="_blank" rel="nofollow noopener noreferrer">Custom filebeat template for JSON log lines</a></li>
<li><a href="https://discuss.elastic.co/t/log-ui-failed-to-format-message-from/163196" target="_blank" rel="nofollow noopener noreferrer">Log UI failed to format message from</a></li>
<li><a href="https://github.com/elastic/kibana/pull/26579/files#diff-3d8e25bfa60ef76c1ce7b5e7a68232f2R9" target="_blank" rel="nofollow noopener noreferrer">[InfraOps] Update docs with data source configuration</a></li>
<li><a href="https://discuss.elastic.co/t/best-practice-for-creating-an-index-when-an-es-docker-container-starts/126651" target="_blank" rel="nofollow noopener noreferrer">Best practice for creating an index when an ES docker container starts</a></li>
<li><a href="https://stackoverflow.com/questions/35526532/how-to-add-an-elasticsearch-index-during-docker-build" target="_blank" rel="nofollow noopener noreferrer">How to add an elasticsearch index during docker build</a></li>
<li><a href="https://www.jianshu.com/p/fa31f38d241e" target="_blank" rel="nofollow noopener noreferrer">使用ElasticSearch踩过的坑</a></li>
<li><a href="https://www.infvie.com/ops-notes/elkstack-beats" target="_blank" rel="nofollow noopener noreferrer">ELK Stack+Beats 搭建分布式日志平台</a></li>
<li><a href="https://www.jianshu.com/p/6a700cc61913" target="_blank" rel="nofollow noopener noreferrer">Elasticsearch安装配置</a></li>
<li><a href="https://logz.io/blog/elasticsearch-cluster-tutorial/" target="_blank" rel="nofollow noopener noreferrer">Creating an Elasticsearch Cluster: Getting Started</a></li>
<li><a href="https://github.com/yaml/yaml/issues/35" target="_blank" rel="nofollow noopener noreferrer">Merge arrays #35</a></li>
<li><a href="https://stackoverflow.com/questions/4948933/is-there-a-way-to-alias-anchor-an-array-in-yaml" target="_blank" rel="nofollow noopener noreferrer">Is there a way to alias/anchor an array in YAML?</a></li>
<li><a href="https://discuss.elastic.co/t/elastic-search-7-unable-to-bootstrap-the-cluster-due-to-master-not-discovered-yet/182073/2" target="_blank" rel="nofollow noopener noreferrer">Elastic Search 7 unable to bootstrap the cluster due to master not discovered yet</a></li>
<li><a href="https://github.com/elastic/kibana/issues/32303" target="_blank" rel="nofollow noopener noreferrer">Kibana fails to validate config if elasticsearch.hosts is not a string #32303</a></li>
<li><a href="https://qbox.io/blog/optimizing-elasticsearch-how-many-shards-per-index" target="_blank" rel="nofollow noopener noreferrer">Optimizing Elasticsearch: How Many Shards per Index?</a></li>
</ul>
<blockquote>
<p>EOF</p>
</blockquote></div></div></div><div class="Post-module--footer--NpFTW"><div class="Meta-module--meta--3YYBJ"><p class="Meta-module--date--U0EV3">Published<!-- --> <!-- -->2019/4/25</p></div><div class="Tags-module--tags--1r6Jk"><ul class="Tags-module--list--3a6Ka"><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/elasticsearch/">Elasticsearch</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/searchengine/">SearchEngine</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/monitor/">Monitor</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/metrics/">Metrics</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/analytics/">Analytics</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/devops/">DevOps</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/keynote/">Keynote</a></li></ul></div><div class="Author-module--author--2kT-Q"><p class="Author-module--bio--2YX8-">Some tech &amp; personal blog posts<a class="Author-module--twitter--1B6I5" href="https://github.com/agreatfool" rel="noopener noreferrer" target="_blank"><strong>Jonathan Dai</strong> on Github</a></p></div></div><div class="Post-module--comments--2bE-0"><div id="disqus_thread"></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2019/04/elasticsearch-note";window.___webpackCompilationHash="0d4aee76ea314ec4b292";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-e212462f23ca5a50f487.js"],"app":["/app-0f92688bebb8baf761b5.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-0c915c7b1bdb5eac4fdf.js"],"component---src-templates-categories-template-categories-template-tsx":["/component---src-templates-categories-template-categories-template-tsx-94c6e6f05e922a0131c9.js"],"component---src-templates-category-template-category-template-tsx":["/component---src-templates-category-template-category-template-tsx-f517b0c0105ad6c2232c.js"],"component---src-templates-index-template-index-template-tsx":["/component---src-templates-index-template-index-template-tsx-3866c4783dc8a0fe6798.js"],"component---src-templates-not-found-template-not-found-template-tsx":["/component---src-templates-not-found-template-not-found-template-tsx-4cf57627eba764adc6f2.js"],"component---src-templates-page-template-page-template-tsx":["/component---src-templates-page-template-page-template-tsx-3e9c924c62fa8a8ed11c.js"],"component---src-templates-post-template-post-template-tsx":["/component---src-templates-post-template-post-template-tsx-97307c6a1e144b6353c9.js"],"component---src-templates-tag-template-tag-template-tsx":["/component---src-templates-tag-template-tag-template-tsx-2e76e7e6d3fd88dd1c96.js"],"component---src-templates-tags-template-tags-template-tsx":["/component---src-templates-tags-template-tags-template-tsx-7f2df64aecbc4949dcce.js"]};/*]]>*/</script><script src="/polyfill-e212462f23ca5a50f487.js" nomodule=""></script><script src="/app-0f92688bebb8baf761b5.js" async=""></script><script src="/framework-c14ed818a88fa3beed0f.js" async=""></script><script src="/webpack-runtime-c4f132164b75f788a4e6.js" async=""></script></body></html>