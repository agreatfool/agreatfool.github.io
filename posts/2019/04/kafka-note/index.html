<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.23.1"/><meta name="theme-color" content="hsl(31, 92%, 62%)"/><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:site_name" content="Kafka Notes - Blog by Jonathan Dai"/><meta data-react-helmet="true" property="og:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Kafka Notes - Blog by Jonathan Dai"/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="twitter:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><style data-href="/styles.73ba2c353057148cd83d.css" data-identity="gatsby-global-css">html{font-size:100}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizelegibility;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#212121;font-size:16px;line-height:1.625;margin:0 0 0 calc(100vw - 100%)}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:40px;line-height:52px;margin-bottom:26px;margin-top:104px}h2{font-size:27px;line-height:39px}h2,h3{margin-bottom:13px;margin-top:52px}h3{font-size:22px;line-height:26px}h4{font-size:19.2px;margin-top:39px}h4,h5{line-height:26px;margin-bottom:13px}h5,h6{font-size:16px;margin-top:65px}h6{line-height:26px;margin-bottom:13px}img{max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#212121 0,#212121 15px,transparent 0,transparent 26px);background-size:100% 26px;color:#212121;height:26px;margin:52px auto;width:100px}a{color:#5c92ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a145}b,strong{font-weight:600}ul{list-style:square;margin-bottom:26px}ul li{margin-bottom:10px;padding:0 5px}p{line-height:26px;margin-bottom:26px}blockquote{font-style:italic;padding:0;text-align:center}figure{display:block;height:auto;width:100%}figcaption{color:#212121;font-size:14px;font-style:italic;line-height:19.5px;margin-bottom:0;margin-top:6.5px;text-align:center}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:310px;padding:0 26px}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83;cursor:help}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}blockquote{border-left:5px solid #424242!important;color:#424242!important;display:block!important;font-style:normal!important;padding-left:1rem!important;text-align:left!important}table{border-collapse:collapse;box-shadow:0 0 20px rgba(0,0,0,.15)}thead tr{background-color:#009879;color:#fff;text-align:left}td,th{padding:12px 15px}tbody tr{border-bottom:1px solid #ddd}tbody tr:nth-of-type(2n){background-color:#f3f3f3}tbody tr:last-of-type{border-bottom:2px solid #009879}h1{margin-top:0!important}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky{margin-bottom:32.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky:last-child{margin-bottom:13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W{font-size:27px;line-height:39px;margin-bottom:13px;margin-top:0}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE{color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:hover{border-bottom:1px solid #212121;color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--description--UXUO2{font-size:16px;line-height:26px;margin-bottom:19.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--time--17yla{color:#212121;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--divider--3kBgQ{margin:0 13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE{color:#f7a145;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:hover{color:#5c92ff}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-{color:#5c92ff;font-size:16px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Layout-module--layout--36KWw{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--36KWw:before{content:"";display:table}.Layout-module--layout--36KWw:after{clear:both;content:"";display:table}.Page-module--page--2Y5e7{margin-bottom:52px}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:26px 19.5px 0}.Page-module--page--2Y5e7 .Page-module--title--Z69a4{font-size:40px;font-weight:600;line-height:52px;margin-bottom:37.7px;margin-top:0}.Page-module--page--2Y5e7 .Page-module--body--hPYHN{font-size:16px;line-height:26px;margin:0 0 26px}@media screen and (min-width:685px){.Page-module--page--2Y5e7{width:calc(58.275% - 12.5px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(12n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(12n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:32.5px 19.5px 0}}@media screen and (min-width:960px){.Page-module--page--2Y5e7{width:calc(66.6% - 10px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(3n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(3n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:39px 26px 0}}.Pagination-module--pagination--3KtNE{display:flex;margin-top:52px}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8{text-align:left;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:focus,.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj{text-align:right;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:focus,.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Author-module--author--12DFk .Author-module--photo--1WT_U{background-clip:padding-box;border-radius:50%;display:inline-block;height:75px;margin-bottom:0;width:75px}.Author-module--author--12DFk .Author-module--title--2UdHe{font-size:18px;font-weight:600;line-height:29.25px;margin:13px 0}.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:focus,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:hover{color:#212121}.Author-module--author--12DFk .Author-module--subtitle--3HDSh{color:#878787;line-height:26px;margin-bottom:26px}.Icon-module--icon--fdMTB{fill:currentcolor;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;speak:none;stroke:currentcolor;stroke-width:0;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--3rFuK{margin-bottom:26px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:13px 0;max-width:150px;padding:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X{align-content:center;align-items:center;border:1px solid #ebebeb;border-radius:50%;display:flex;height:35px;justify-content:center;line-height:35px;margin:6.5px;padding:0;text-align:center;width:35px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X:nth-child(3n+1){margin-left:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi{border:0;color:#212121;display:flex}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:focus,.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:hover{color:#5c92ff}.Copyright-module--copyright--1IQFN{color:#999;font-size:14px}.Menu-module--menu--3SbXJ{margin-bottom:26px}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI{list-style:none;margin:0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8{margin:13px 0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV{border:0;color:#212121;font-size:16px;font-weight:400}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:focus,.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV.Menu-module--active--aYO_r{border-bottom:1px solid #212121;color:#212121}.Sidebar-module--sidebar--1NhQN{width:100%}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:26px 19.5px 0;position:relative}@media screen and (min-width:685px){.Sidebar-module--sidebar--1NhQN{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:32.5px 19.5px 0}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);bottom:0;content:"";height:540px;position:absolute;right:-10px;top:30px;width:1px}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1NhQN{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:39px}}.Author-module--author--2kT-Q{border-top:1px solid #e6e6e6;line-height:26px;margin-bottom:52px;margin-top:26px;max-width:640px;padding-top:26px}.Author-module--author--2kT-Q .Author-module--bio--2YX8- .Author-module--twitter--1B6I5{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2kT-Q{margin-left:auto;margin-right:auto}}.Content-module--content--3dNJJ{margin:0 auto;max-width:945px;padding:0 13px}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:32px;font-weight:600;line-height:42.9px;margin:26px auto 0;max-width:640px;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure{margin-bottom:26px}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote{font-style:italic;margin-top:0;padding:26px 0;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote p{font-size:26.9072px;line-height:39px;margin-bottom:26px;margin-top:0;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt a{text-decoration:underline}.Content-module--content--3dNJJ .Content-module--body--3LJXt *{margin-left:auto;margin-right:auto;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{visibility:hidden}.Content-module--content--3dNJJ .Content-module--body--3LJXt img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3dNJJ{padding:0}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:48px;line-height:58.5px;margin-bottom:39px;margin-top:58.5px}.Content-module--content--3dNJJ .Content-module--body--3LJXt,.Content-module--content--3dNJJ .Content-module--body--3LJXt p{font-size:18px;line-height:29.25px;margin-bottom:29.25px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{padding-right:26px;visibility:unset}}.Meta-module--meta--3YYBJ .Meta-module--date--U0EV3{font-style:italic}.Tags-module--tags--1r6Jk{margin-bottom:13px}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka{list-style:none;padding:0}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ{display:inline-block;margin:13px 3.25px}@media screen and (min-width:685px){.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ:first-child{margin-left:0;padding-left:0}}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:inline-block;height:35px;line-height:35px;padding:0 19.5px;text-decoration:none}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:focus,.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:hover{color:#5c92ff}.Gallery-module--gallery--2g0Rf{grid-gap:.5em;display:grid;grid-auto-rows:16vw;grid-template-columns:repeat(4,1fr)}.Gallery-module--gallery--2g0Rf>*{box-shadow:0 2px 8px 0 rgba(0,0,0,.2),0 3px 20px 0 rgba(0,0,0,.19)}.Gallery-module--gallery--2g0Rf>:hover{cursor:pointer;-webkit-filter:blur(4px);filter:blur(4px);transition:all .5s ease}.Gallery-module--gallery--2g0Rf>:nth-child(6n+3){grid-column:span 1;grid-row:span 2}.Gallery-module--gallery--2g0Rf>:nth-child(6n+2),.Gallery-module--gallery--2g0Rf>:nth-child(6n+5),.Gallery-module--gallery--2g0Rf>:nth-child(6n+6){grid-column:span 2;grid-row:span 2}.Post-module--post--mo55f .Post-module--content--3cRzw{margin:0 auto}.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{margin:0 auto;max-width:640px;padding:0 13px}.Post-module--post--mo55f .Post-module--button--27HfC{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:block;font-size:16px;font-weight:400;height:35px;line-height:35px;margin-left:auto;margin-right:auto;margin-top:26px;max-width:90px;padding:0 26px;text-align:center}.Post-module--post--mo55f .Post-module--button--27HfC:focus,.Post-module--post--mo55f .Post-module--button--27HfC:hover{color:#5c92ff}@media screen and (min-width:960px){.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{padding:0}.Post-module--post--mo55f .Post-module--button--27HfC{left:30px;margin:0;max-width:none;position:fixed;top:30px}}</style><link rel="alternate" type="application/rss+xml" title="Blog by Jonathan Dai" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-FHVTN0K4SH"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FHVTN0K4SH', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=bc5f0053fc3ffc2dfb62b5abaa975347" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Kafka Notes - Blog by Jonathan Dai</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--36KWw"><div class="Post-module--post--mo55f"><a class="Post-module--button--27HfC" href="/">All Articles</a><div class="Post-module--content--3cRzw"><div class="Content-module--content--3dNJJ"><h1 class="Content-module--title--3vQh6">Kafka Notes</h1><div class="Content-module--body--3LJXt"><div class="table-of-contents">
<ul>
<li><a href="#1-%E5%89%8D%E8%A8%80">1. 前言</a></li>
<li><a href="#2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">2. 消息队列</a></li>
<li><a href="#3-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%80%89%E5%9E%8B%E6%AF%94%E8%BE%83">3. 消息队列选型比较</a>
<ul>
<li><a href="#31-apache-pulsar">3.1 Apache Pulsar</a></li>
</ul>
</li>
<li><a href="#4-kafka%E6%9E%B6%E6%9E%84">4. Kafka架构</a>
<ul>
<li><a href="#41-%E6%A6%82%E5%BF%B5">4.1 概念</a></li>
<li><a href="#42-%E9%9B%86%E7%BE%A4-id_cluster">4.2 集群 {#ID_CLUSTER}</a></li>
<li><a href="#43-%E5%88%86%E5%B8%83%E5%BC%8F%E7%97%9B%E7%82%B9offset">4.3 分布式痛点（offset）</a></li>
<li><a href="#44-%E4%B8%B4%E6%97%B6%E6%B6%88%E8%B4%B9%E5%8E%8B%E5%8A%9B%E5%BA%94%E6%80%A5">4.4 临时消费压力应急</a></li>
</ul>
</li>
<li><a href="#5-kafka%E7%9B%91%E6%8E%A7--%E9%AB%98%E5%8F%AF%E7%94%A8">5. Kafka监控 &#x26; 高可用</a>
<ul>
<li><a href="#51-%E7%9B%91%E6%8E%A7">5.1 监控</a>
<ul>
<li><a href="#511-exporter--grafana-dashboard">5.1.1 Exporter &#x26; Grafana Dashboard</a></li>
<li><a href="#512-docker%E5%AE%9E%E8%B7%B5">5.1.2 Docker实践</a></li>
</ul>
</li>
<li><a href="#52-%E9%AB%98%E5%8F%AF%E7%94%A8">5.2 高可用</a></li>
</ul>
</li>
<li><a href="#6-kafka-benchmark">6. Kafka Benchmark</a>
<ul>
<li><a href="#61-%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83">6.1 测试环境</a></li>
<li><a href="#62-%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E6%B5%8B%E8%AF%95">6.2 不同场景测试</a>
<ul>
<li><a href="#621-%E5%9C%BA%E6%99%AF1">6.2.1 场景1</a></li>
<li><a href="#622-%E5%9C%BA%E6%99%AF2">6.2.2 场景2</a></li>
<li><a href="#623-%E5%9C%BA%E6%99%AF3">6.2.3 场景3</a></li>
<li><a href="#624-%E5%9C%BA%E6%99%AF4-id_benchmark_scen4">6.2.4 场景4 {#ID_BENCHMARK_SCEN4}</a></li>
<li><a href="#625-%E5%9C%BA%E6%99%AF5">6.2.5 场景5</a></li>
<li><a href="#626-%E5%9C%BA%E6%99%AF6">6.2.6 场景6</a></li>
</ul>
</li>
<li><a href="#63-%E5%90%84%E5%9C%BA%E6%99%AF%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93">6.3 各场景测试总结</a></li>
</ul>
</li>
<li><a href="#7-kafka%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B">7. Kafka使用范例</a></li>
<li><a href="#8-%E5%9C%A8docker%E5%86%85%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4">8. 在Docker内部署集群</a>
<ul>
<li><a href="#81-%E9%87%8D%E8%A6%81%E9%85%8D%E7%BD%AE%E9%A1%B9">8.1 重要配置项</a></li>
<li><a href="#82-%E5%AF%B9%E5%AE%B9%E5%99%A8%E5%A4%96%E5%BA%94%E7%94%A8%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1-docker_out_net">8.2 对容器外应用提供服务 {#DOCKER_OUT_NET}</a></li>
<li><a href="#83-docker-compose-scale">8.3 docker-compose scale</a></li>
<li><a href="#84-yaml%E9%85%8D%E7%BD%AE%E9%87%8D%E7%94%A8">8.4 yaml配置重用</a></li>
<li><a href="#84-%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83">8.4 相关参考</a></li>
</ul>
</li>
<li><a href="#9-%E5%86%99%E6%80%A7%E8%83%BD%E4%B8%8E%E5%AE%89%E5%85%A8%E6%80%A7">9. 写性能与安全性</a></li>
<li><a href="#10-todo">10. TODO</a></li>
<li><a href="#%E8%B5%84%E6%96%99">资料</a>
<ul>
<li><a href="#%E9%93%BE%E6%8E%A5">链接</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="1-前言" style="position:relative;"><a href="#1-%E5%89%8D%E8%A8%80" aria-label="1 前言 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 前言</h1>
<p>Kafka是现在业界选择比较多的一种消息队列解决方案。我这里主要也是选Kafka作为消息队列这块需求的解决方案。下面的技术调研会先从消息队列本身开始，然后做一个横向比较，最后再聚焦到Kafka本身上。</p>
<p>调研用的Kafka版本为：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">2.2.0</code></pre></div>
<p>官方文档：</p>
<ul>
<li>官方介绍：<a href="https://kafka.apache.org/intro" target="_blank" rel="nofollow noopener noreferrer">Introduction</a></li>
<li>官方新手入门：<a href="https://kafka.apache.org/quickstart" target="_blank" rel="nofollow noopener noreferrer">Quickstart</a></li>
<li>官方应用场景介绍：<a href="https://kafka.apache.org/uses" target="_blank" rel="nofollow noopener noreferrer">Use cases</a></li>
<li>官方文档：<a href="https://kafka.apache.org/documentation/" target="_blank" rel="nofollow noopener noreferrer">Documentation</a></li>
<li>Docker Hub：<a href="https://hub.docker.com/r/wurstmeister/kafka" target="_blank" rel="nofollow noopener noreferrer">wurstmeister/kafka</a></li>
</ul>
<p>一本中文手册，版本较老，看看范例代码尚可：<a href="http://www.kubiji.cn/book/apache_kafka/APACHEKAFKAJiaoCheng/APACHEKAFKAGaiShu.html" target="_blank" rel="nofollow noopener noreferrer">Apache kafka中文手册</a>。</p>
<h1 id="2-消息队列" style="position:relative;"><a href="#2-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" aria-label="2 消息队列 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. 消息队列</h1>
<p>在聊Kafka之前，其实更需要关注下消息队列本身。什么需求下需要使用消息队列、消息队列的功能点有哪些、消息队列的模式有哪些、消息队列的实现难点有哪些，等等。如果什么都不了解，那技术选型就无从谈起了，也没办法理解为什么消息队列要做好是非常困难的一件事情。展开了说，也就没办法举一反三，理解其他软件系统的设计精髓了。</p>
<p>下面会简单列举下消息队列的一系列知识点，细节内容这里就不展开了，篇幅太大。</p>
<p>消息队列的需求：</p>
<ul>
<li>解耦</li>
<li>最终一致性</li>
<li>广播</li>
<li>错峰与流控</li>
</ul>
<p>消息队列的模型：</p>
<ul>
<li>点对点：单生产、单队列、单消费</li>
<li>生产者消费者模型：多生产、单队列、多消费</li>
<li>发布订阅模型：根据topic分队列，多生产、多队列、多消费</li>
</ul>
<p>消息队列的投递模式：</p>
<ul>
<li>Push：消息队列主动推送（e.g RocketMQ可选）</li>
<li>Pull：消费者主动抓取（e.g Kafka）</li>
</ul>
<p>消息队列的性能指标：</p>
<ul>
<li>吞吐量（Throughput）</li>
<li>响应时间（Latency）</li>
</ul>
<p>消息队列的投递策略：</p>
<ul>
<li>最多一次（At most Once）：消息可能会丢，但绝不会重复传输</li>
<li>最少一次（At least Once）：消息绝不会丢，但可能会重复传输</li>
<li>仅有一次（Exactly Once）：每条消息肯定会被传输一次且仅传输一次</li>
</ul>
<p>消息队列的功能性：</p>
<ul>
<li>优先级队列</li>
<li>延迟队列</li>
<li>死信队列</li>
<li>重试队列</li>
<li>消息回溯</li>
<li>消息堆积 + 持久化</li>
<li>消息追踪</li>
<li>消息过滤</li>
<li>多租户</li>
<li>多协议支持</li>
<li>跨语言支持</li>
<li>流量控制</li>
<li>可靠投递</li>
<li>消费确认</li>
<li>消息顺序性</li>
<li>安全机制</li>
<li>消息幂等性</li>
<li>事务性消息</li>
</ul>
<p>几篇值得一读的博文：</p>
<p><a href="/2019/04/message-queue-design/">消息队列设计精要 - 美团点评技术团队</a></p>
<p>一篇通论形式的消息队列设计博文，讲解了一些消息队列通用的知识点，值得一读。</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-01.png" alt=""></p>
<p><a href="https://www.infoq.cn/article/distributed-queue-programme-model-actual-combat-optimization" target="_blank" rel="nofollow noopener noreferrer">分布式队列编程：从模型、实战到优化</a></p>
<p>本质上也是一篇对于消息队列进行设计和讲解的博文，但结合了美团公司内部的实际项目经验，对于大型系统的设计者有更好的贴近应用场景的指导作用。</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&#x26;mid=2651745361&#x26;idx=1&#x26;sn=5f0f67484a0de4b0dd2796848ef9cc94" target="_blank" rel="nofollow noopener noreferrer">分布式队列编程优化篇</a></p>
<p>接上一篇的博文，更多讲到了性能和高级功能相关的实现以及性能的优化。</p>
<p><a href="https://www.jianshu.com/p/7a6deaba34d2" target="_blank" rel="nofollow noopener noreferrer">如何保证消息队列的高可用和幂等性以及数据丢失，顺序一致性</a></p>
<p>排版比较粗糙，但内容非常不错。以贴近项目经验的内容讲解了RabbitMQ和Kafka的：</p>
<ul>
<li>高可用性</li>
<li>消息幂等性</li>
<li>消息可靠性</li>
<li>消息顺序性</li>
<li>消息积压场景处理</li>
</ul>
<h1 id="3-消息队列选型比较" style="position:relative;"><a href="#3-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%80%89%E5%9E%8B%E6%AF%94%E8%BE%83" aria-label="3 消息队列选型比较 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. 消息队列选型比较</h1>
<p>消息队列的选型一直都是比较困难的，业界现在比较主流的选择有：ActiveMQ、RabbitMQ、Kafka、RocketMQ、ZeroMQ 这几种。</p>
<p>有几篇不错的博文可以看下：</p>
<p><a href="https://www.infoq.cn/article/kafka-vs-rabbitmq" target="_blank" rel="nofollow noopener noreferrer">消息中间件选型分析：从 Kafka 与 RabbitMQ 的对比看全局</a></p>
<p>这篇时间还算比较接近<code class="language-text">2018年5月2日</code>，主要是以Kafka和RabbitMQ为范例进行了消息队列选型的要点讲解。虽然讲解的时候使用了Kafka以及RabbitMQ作为范例，但实际上讲解的是通用的消息队列选型要点。结合本文上一节所讲到的消息队列的一系列知识点，应该能有更深刻的理解。</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-02.jpg" alt="">
<img src="/media/posts/2019/04/kafka-note/message-queue-03.jpg" alt="">
<img src="/media/posts/2019/04/kafka-note/message-queue-04.jpg" alt=""></p>
<p><a href="https://www.infoq.cn/article/dXJ3EYIp*WaHfmVwlMeu" target="_blank" rel="nofollow noopener noreferrer">滴滴出行基于 RocketMQ 构建企业级消息队列服务的实践</a></p>
<p>这篇时间稍微有点久，文中提到的Kafka版本还是0.8左右的（虽然文章的发布时间倒是不久之前），所以文中提到的性能指标之类的仅可作为参考。这篇文章是对Kafka和RocketMQ做的一个技术选型比较，文章中有相当多的性能指标比较，并结合滴滴公司的实际情况讲解了下消息队列系统进行替换时候所做的Migration工作，非常有借鉴价值。此外，文中还有一小节讲解了下RocketMQ使用的经验。</p>
<p><a href="https://stackoverflow.com/questions/39586635/why-is-kafka-pull-based-instead-of-push-based" target="_blank" rel="nofollow noopener noreferrer">Why is Kafka pull-based instead of push-based?</a></p>
<p>为什么Kafka消息队列使用的是Pull投递模式。</p>
<p><a href="https://medium.com/@philipfeng/modern-open-source-messaging-apache-kafka-rabbitmq-nats-pulsar-and-nsq-ca3bf7422db5" target="_blank" rel="nofollow noopener noreferrer">Modern Open Source Messaging: NATS, RabbitMQ, Apache Kafka, hmbdc, Synapse, NSQ and Pulsar</a></p>
<p>老外写的一篇，提到了不少国内较少提到的开源项目，可以作为参考。</p>
<h2 id="31-apache-pulsar" style="position:relative;"><a href="#31-apache-pulsar" aria-label="31 apache pulsar permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1 Apache Pulsar</h2>
<p>关于Kafka和后起新秀Pulsar的横向比较，可以看：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/47388267" target="_blank" rel="nofollow noopener noreferrer">比拼Kafka，大数据分析新秀Pulsar到底好在哪</a></li>
<li><a href="https://www.slideshare.net/merlimat/high-performance-messaging-with-apache-pulsar" target="_blank" rel="nofollow noopener noreferrer">High performance messaging with Apache Pulsar</a></li>
<li><a href="https://www.infoq.cn/article/Us*a8umKXT9LpV9hA6tF" target="_blank" rel="nofollow noopener noreferrer">选择 Pulsar 而不是 Kafka 的 7 大理由</a></li>
</ul>
<p>大略的要点：</p>
<ul>
<li>功能性上Pulsar要比Kafka更好，且这是在不牺牲性能的前提下的，就更加难能可贵</li>
<li>解决了Kafka单partition只能单consumer消费的问题</li>
<li>将Broker和存储解耦，做到更好的错误恢复，在Broker宕机之后可以做到无损耗恢复</li>
<li>存储方面的功能交付给Bookie，更细粒度的存储，更好的错误恢复和同步性能</li>
</ul>
<h1 id="4-kafka架构" style="position:relative;"><a href="#4-kafka%E6%9E%B6%E6%9E%84" aria-label="4 kafka架构 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. Kafka架构</h1>
<h2 id="41-概念" style="position:relative;"><a href="#41-%E6%A6%82%E5%BF%B5" aria-label="41 概念 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.1 概念</h2>
<p>老样子从基本的概念开始梳理：</p>
<ul>
<li><code class="language-text">broker</code>：kafka集群中的任意一台提供服务的物理服务器即被称为broker</li>
<li><code class="language-text">topic</code>：消息队列的一个队列，一般做架构的时候按需求将不同的消息分别派送到不同的管道里，而其中的任意一个管道在kafka里就是一个topic</li>
<li><code class="language-text">partition</code>：topic下的概念，任意一个topic根据启动时的设定，会分成多个partition，而每个partition会由集群安排在某一台物理机broker上，以此做到集群的横向扩展</li>
<li><code class="language-text">offset</code>：partition下的概念，topic被分为很多partition，而每个partition则都会存储消息，每个partition存储的消息都是从0开始进行标号，而这个每条消息一个的标号，即为offset；可以理解为消息在partition里的唯一id；不同的partition都是从0开始标号，因此offset只对其自身的partition生效，不可混用</li>
<li><code class="language-text">replica</code>：某个partition的完整备份（在接收写入请求时数据可能会落后于leader），用在集群的高可用服务上，同时也可以提供partition读操作的负载均衡</li>
<li><code class="language-text">producer</code>：向topic里输入消息数据的角色</li>
<li><code class="language-text">consumer</code>：从topic里消费消息数据的角色</li>
<li><code class="language-text">consumer group</code>：可扩展且具有容错性的consumer机制，多个consumer共享一个group id，组内的所有consumer一起来消费topic的所有partition；但一个partition仍旧只能由一个consumer进行消费；主要是为了解决consumer和partition配对balance的问题，将consumer做成组由集群自动进行平衡并分配到partition</li>
</ul>
<p>关于consumer group，更多的可以看：<a href="https://www.cnblogs.com/huxi2b/p/6223228.html" target="_blank" rel="nofollow noopener noreferrer">Kafka消费组(consumer group)</a>。</p>
<h2 id="42-集群-id_cluster" style="position:relative;"><a href="#42-%E9%9B%86%E7%BE%A4-id_cluster" aria-label="42 集群 id_cluster permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.2 集群 {#ID_CLUSTER}</h2>
<p>一张图基本上就能说明问题：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-05.jpg" alt=""></p>
<ul>
<li>kafka集群由多台broker（物理机）组成</li>
<li>图示中有<code class="language-text">四台</code>broker</li>
<li>每个topic会根据配置，生成固定数量的partition，均匀分配到物理机上</li>
<li>图示中的topic被分成了<code class="language-text">3个</code>partition：<code class="language-text">P1_leader</code>（broker1）、<code class="language-text">P2_leader</code>（broker2）、<code class="language-text">P3_leader</code>（broker4）</li>
<li>每个partition根据配置，会拥有固定数量的follower（replica），分别分配到各个物理机上</li>
<li>图示中即：<code class="language-text">P1_follower</code>（broker2、broker3）、<code class="language-text">P2_follower</code>（broker3、broker4）、<code class="language-text">P3_follower</code>（broker1、broker2）</li>
<li>当有broker宕机的时候：
<ul>
<li>丢失的follower会由集群重新寻找节点进行备份<code class="language-text">恢复</code></li>
<li>丢失的leader会由集群自现存的follower中<code class="language-text">选举</code>产生，成为新的leader</li>
</ul>
</li>
</ul>
<h2 id="43-分布式痛点offset" style="position:relative;"><a href="#43-%E5%88%86%E5%B8%83%E5%BC%8F%E7%97%9B%E7%82%B9offset" aria-label="43 分布式痛点offset permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.3 分布式痛点（offset）</h2>
<p>Kafka在分布式解决方案上也有痛点，主要是每个partition的offset问题。</p>
<p>为了性能，kafka将一个partition视作一个管道，拥有一个从0开始的offset。这样做的好处就是不再需要在每一个消息体上做metadata存放该消息是否被消费掉等信息，而是通过partition的offset来标记整个管道中的消息被消费到了哪里。消息体更简单，流程上也更简单，不会出现乱序的消费情况。但也正是因为这种设计，导致每个partition无法由多个consumer并发消费，每个partition绑定只能同时允许一个consumer消费。</p>
<p>因此，从机制上来说，kafka并不适合用来做consumer重消耗（CPU）类型的消息通道。虽然partition可以做很多，极端点来说可以做到和consumer实际需求1：1的配比，但超过适配当前需求的partition数量设置也会造成吞吐量的下降（参见：<a href="#ID_BENCHMARK_SCEN4">6.2.4 场景4</a>）。</p>
<p>consumer和partition在进行消息是否被消费掉的确认行为上，有两种方式：</p>
<ul>
<li>自动提交：
<ul>
<li>设置<code class="language-text">enable.auto.commit=true</code></li>
<li>更新的频率根据参数<code class="language-text">auto.commit.interval.ms</code>来定，这种方式被称为<code class="language-text">at most once</code></li>
<li>consumer fetch到消息后，partition就会更新offset，无论是否消费成功</li>
</ul>
</li>
<li>手动提交：
<ul>
<li>设置<code class="language-text">enable.auto.commit=false</code></li>
<li>这种方式被称为<code class="language-text">at least once</code></li>
<li>consumer fetch到消息后，必须在消费成功后调用方法<code class="language-text">consumer.commitSync()</code>，手动通知partition更新offset</li>
<li>如果消费失败，则offset不会更新，此条消息会被重复消费一次</li>
</ul>
</li>
</ul>
<p>关于partition和consumer之间的关系，更多可以看下：</p>
<p><a href="https://stackoverflow.com/questions/45175424/how-multiple-consumer-group-consumers-work-across-partition-on-the-same-topic-in" target="_blank" rel="nofollow noopener noreferrer">How multiple consumer group consumers work across partition on the same topic in Kafka?</a></p>
<blockquote>
<p>If you want to have more consumers than partitions and still have performance enhancement and process only each message once, then you should increase the number of partitions in the topics so that there are at least as many partitions as consumers. Often topics are created with 2 times as many partitions needed to start, just so more consumers can be added later if needed without having to repartition the topic.</p>
</blockquote>
<p><a href="https://blog.csdn.net/pursuer211/article/details/79799478" target="_blank" rel="nofollow noopener noreferrer">kafka中partition和消费者对应关系</a></p>
<blockquote>
<p>1个partition只能被同组的一个consumer消费，同组的consumer则起到均衡效果</p>
</blockquote>
<p>以及自动提交相关：<a href="https://medium.com/@danieljameskay/understanding-the-enable-auto-commit-kafka-consumer-property-12fa0ade7b65" target="_blank" rel="nofollow noopener noreferrer">Understanding the ‘enable.auto.commit’ Kafka Consumer property</a>。</p>
<h2 id="44-临时消费压力应急" style="position:relative;"><a href="#44-%E4%B8%B4%E6%97%B6%E6%B6%88%E8%B4%B9%E5%8E%8B%E5%8A%9B%E5%BA%94%E6%80%A5" aria-label="44 临时消费压力应急 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4.4 临时消费压力应急</h2>
<p>如果因某些原因，之前设计的partition分片数量不够导致能够上工的consumer数量不够，且consumer的消费速率跟不上的时候，就会发生消息堆积。如果堆积的情况比较严重的话，就需要程序介入处理。</p>
<p>思路如下：</p>
<ol>
<li>老的partition以及老的topic肯定不能动，就算重新进行repartition整个集群重新平衡耗费的时间也是难以忍受的</li>
<li>创建新的topic</li>
<li>将新的topic的partition设到consumer消费速率能跟上的数量</li>
<li>将新的consumer部署上去，消费新设置的topic和partition</li>
<li>将老的topic以及partition上挂载的consumer全部停止</li>
<li>在老的topic以及partition上挂载临时consumer，这批consumer不做任何逻辑处理，只是将老的topic内的消息全部读取出来，并输入到新的topic里</li>
</ol>
<p>这样老的topic里的消息就全部分发到新的topic里了，且新的topic的partition数量很高，可以挂载很多consumer处理堆积的消息。</p>
<h1 id="5-kafka监控--高可用" style="position:relative;"><a href="#5-kafka%E7%9B%91%E6%8E%A7--%E9%AB%98%E5%8F%AF%E7%94%A8" aria-label="5 kafka监控  高可用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Kafka监控 &#x26; 高可用</h1>
<h2 id="51-监控" style="position:relative;"><a href="#51-%E7%9B%91%E6%8E%A7" aria-label="51 监控 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.1 监控</h2>
<p>监控方面，datadog的几篇文章非常不错，值得一读，不过版本有点老了，文章是2016年的：</p>
<ul>
<li><a href="https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/" target="_blank" rel="nofollow noopener noreferrer">Monitoring Kafka performance metrics - P1</a></li>
<li><a href="https://www.datadoghq.com/blog/collecting-kafka-performance-metrics/" target="_blank" rel="nofollow noopener noreferrer">Monitoring Kafka performance metrics - P2</a></li>
</ul>
<p>详细的指标列表及其含义，可以看这篇：<a href="https://docs.confluent.io/current/kafka/monitoring.html" target="_blank" rel="nofollow noopener noreferrer">Monitoring Kafka</a>。</p>
<h3 id="511-exporter--grafana-dashboard" style="position:relative;"><a href="#511-exporter--grafana-dashboard" aria-label="511 exporter  grafana dashboard permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.1.1 Exporter &#x26; Grafana Dashboard</h3>
<p>Prometheus的Exporter分为两块：</p>
<ul>
<li>以Java为runtime的通用监控：prometheus/jmx_exporter
<ul>
<li>代码：<a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="nofollow noopener noreferrer">prometheus/jmx_exporter</a></li>
<li>镜像：<a href="https://hub.docker.com/r/sscaling/jmx-prometheus-exporter" target="_blank" rel="nofollow noopener noreferrer">sscaling/jmx-prometheus-exporter</a>
<ul>
<li>sscaling/jmx-prometheus-exporter:0.11.0</li>
</ul>
</li>
<li>Dashboard：
<ul>
<li><a href="https://grafana.com/dashboards/721" target="_blank" rel="nofollow noopener noreferrer">Kafka Overview</a>，这个dashboard相当老了，一直没有更新，而且仅只有6个Panel，和kafka有关的panel更只有3个，基本没什么用；但未能找到更近一点的kafka专用dashboard</li>
<li><a href="https://grafana.com/dashboards/8563" target="_blank" rel="nofollow noopener noreferrer">JVM dashboard</a>，jmx通用dashboard，看上去更好点；但这个dashboard变量设置的是job，所以在设置Prometheus的时候就需要将多个kafka的数据采集到同一个job里，而不是分开</li>
<li><a href="https://grafana.com/dashboards/7727" target="_blank" rel="nofollow noopener noreferrer">JMX exporter prometheus</a>，另一款jmx通用dashboard；这个dashboard是为了在k8s中使用而特化的，也不够灵活</li>
</ul>
</li>
</ul>
</li>
<li>列在Prometheus官方列表上的第三方Exporter：danielqsj/kafka_exporter
<ul>
<li>代码：<a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="nofollow noopener noreferrer">danielqsj/kafka_exporter</a></li>
<li>镜像：<a href="https://hub.docker.com/r/danielqsj/kafka-exporter" target="_blank" rel="nofollow noopener noreferrer">danielqsj/kafka-exporter</a>
<ul>
<li>danielqsj/kafka-exporter:v1.2.0</li>
</ul>
</li>
<li>Dashboard：<a href="https://grafana.com/dashboards/7589" target="_blank" rel="nofollow noopener noreferrer">Kafka Exporter Overview</a></li>
<li>该Exporter使用Golang编写，更专注于部分Kafka业务相关metrics，对于核心的Java runtime metrics仍旧需要jmx_exporter</li>
</ul>
</li>
</ul>
<p>此外，还有一个confluent公司的grafana dashboard配置，没找到对应的labs dashboard地址，但该配置文件本身也有参考价值：<a href="https://github.com/kubernauts/kafka-confluent-platform/blob/master/grafana-kafka-dashboard.json" target="_blank" rel="nofollow noopener noreferrer">kafka-confluent-platform/grafana-kafka-dashboard.json</a>。</p>
<p>可参考的jmx_exporter配置：</p>
<ul>
<li><a href="https://github.com/oded-dd/prometheus-jmx-kafka" target="_blank" rel="nofollow noopener noreferrer">oded-dd/prometheus-jmx-kafka</a></li>
<li><a href="https://github.com/Mousavi310/kafka-grafana" target="_blank" rel="nofollow noopener noreferrer">Mousavi310/kafka-grafana</a></li>
</ul>
<h3 id="512-docker实践" style="position:relative;"><a href="#512-docker%E5%AE%9E%E8%B7%B5" aria-label="512 docker实践 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.1.2 Docker实践</h3>
<p>实际运行范例参见：</p>
<ul>
<li><a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/conf/dev/kafka-cluster.yaml" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/conf/dev/kafka-cluster.yaml</a></li>
<li><a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/conf/dev/prometheus-cluster.yaml" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/conf/dev/prometheus-cluster.yaml</a></li>
<li><a href="https://github.com/agreatfool/dist-system-practice/tree/master/golang/src/dist-system-practice/vendors/kafka" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/vendors/kafka/</a></li>
<li><a href="https://github.com/agreatfool/dist-system-practice/tree/master/golang/src/dist-system-practice/vendors/prometheus/grafana/dashboards" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/vendors/prometheus/grafana/dashboards/</a></li>
</ul>
<p>Exporter方面，jmx_exporter和kafka_exporter同时使用，两者侧重不同。jmx_exporter主要用来进行JVM监控，针对java runtime自身的状态进行监控，而kafka_exporter则针对kafka运行状况进行监控（其实只要不怕麻烦自己处理dashboard，则jmx_exporter就完全足够了）。</p>
<p>jmx_exporter的部署有两种选择，一是独立的容器进行部署，好处是可观察性强，且不会对kafka容器造成影响，缺点是部署更繁杂，配置内容更多；二是修改kafka容器，添加几项配置项，就可以直接在kafka容器内启动一个java进程，进行metrics输出。这里实践使用的是第二种方法，配置修改如下：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">  <span class="token key atrule">kafka_1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token punctuation">...</span>
    <span class="token punctuation">...</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /private/tmp/jmx_prometheus_javaagent<span class="token punctuation">-</span>0.9.jar<span class="token punctuation">:</span>/usr/local/bin/jmx_prometheus_javaagent<span class="token punctuation">-</span>0.9.jar
      <span class="token punctuation">-</span> /private/tmp/jmx<span class="token punctuation">-</span>kafka<span class="token punctuation">-</span>2_0_0.yaml<span class="token punctuation">:</span>/etc/jmx<span class="token punctuation">-</span>exporter/jmx<span class="token punctuation">-</span>kafka<span class="token punctuation">-</span>2_0_0.yaml
      <span class="token punctuation">-</span> <span class="token punctuation">...</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"19092:9092"</span> <span class="token comment"># client port</span>
      <span class="token punctuation">-</span> <span class="token string">"17071:7071"</span> <span class="token comment"># jmx prometheus metrics</span>
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9092"</span> <span class="token comment"># client port</span>
      <span class="token punctuation">-</span> <span class="token string">"9093"</span> <span class="token comment"># internal traffic</span>
      <span class="token punctuation">-</span> <span class="token string">"9991"</span> <span class="token comment"># jmx</span>
      <span class="token punctuation">-</span> <span class="token string">"7071"</span> <span class="token comment"># jmx prometheus metrics</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token string">"always"</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*KAFKA_LOGGING_DEFAULTS</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
      <span class="token key atrule">JMX_PORT</span><span class="token punctuation">:</span> <span class="token number">9991</span>
      <span class="token key atrule">KAFKA_OPTS</span><span class="token punctuation">:</span> <span class="token string">"-javaagent:/usr/local/bin/jmx_prometheus_javaagent-0.9.jar=7071:/etc/jmx-exporter/jmx-kafka-2_0_0.yaml"</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*KAFKA_ENV_DEFAULTS</span></code></pre></div>
<p><code class="language-text">JMX_PORT</code>告知kafka在启动的时候需要一并启动jmx，<code class="language-text">KAFKA_OPTS</code>告知kafka在启动时一并需要启动jmx_exporter，而这个exporter的jar包以及配置文件则是通过bind mount放入容器内的。</p>
<p>配置文件主要来自于：<a href="https://github.com/Mousavi310/kafka-grafana/blob/master/jmx-exporter/kafka-2_0_0.yml" target="_blank" rel="nofollow noopener noreferrer">kafka-grafana/jmx-exporter/kafka-2_0_0.yml</a>。此外，因为使用通用jmx dashboard：<a href="https://grafana.com/dashboards/8563" target="_blank" rel="nofollow noopener noreferrer">JVM dashboard</a>来进行数据展示，该配置文件中也放入了部分这个dashboard要求的数据转换规则：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">lowercaseOutputLabelNames</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token comment"># JMX common</span>
<span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">'java.lang&lt;type=OperatingSystem>&lt;>(committed_virtual_memory|free_physical_memory|free_swap_space|total_physical_memory|total_swap_space)_size:'</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> os_$1_bytes
  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE
  <span class="token key atrule">attrNameSnakeCase</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">'java.lang&lt;type=OperatingSystem>&lt;>((?!process_cpu_time)\w+):'</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> os_$1
  <span class="token key atrule">type</span><span class="token punctuation">:</span> GAUGE
  <span class="token key atrule">attrNameSnakeCase</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">...</span></code></pre></div>
<p>此外还有prometheus集群采集添加以及grafana dashboard导入，都是常规操作，就不多说了。</p>
<h2 id="52-高可用" style="position:relative;"><a href="#52-%E9%AB%98%E5%8F%AF%E7%94%A8" aria-label="52 高可用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5.2 高可用</h2>
<p>在之前的<a href="#ID_CLUSTER">4.2 集群</a>中，已经介绍过了Kafka的集群模式，可以看到Kafka天然就是分布式的，而且在设计之初就考虑到了集群的高可用。本文之前章节内关于集群的内容偏简单了，只介绍了大致的设计。如有需要更深入了解分布式和高可用的细节，则可以阅读唯品会的：<a href="https://www.infoq.cn/article/depth-interpretation-of-kafka-data-reliability" target="_blank" rel="nofollow noopener noreferrer">Kafka 数据可靠性深度解读</a>，这篇讲解非常透彻，基本上可以当经典来看了。</p>
<p>Kafka的高可用配置，有几个配置项控制了集群的安全程度。这里需要记住一点，整个集群越安全集群的吞吐量就越低，这是等价交换的，不可能不付出任何代价就获得数据的安全性。唯品会的文章讲解的细节非常多，但我们真正执行操作的时候可以只知其然，懂得哪几个配置项需要操作即可：</p>
<ul>
<li>topic：
<ul>
<li><code class="language-text">replication.factor</code>：每个partition会拥有多少个replica</li>
<li><code class="language-text">min.insync.replicas</code>：partition的leader节点要求当前在线的replica节点的数量，如果实际在线数量少于这个数值，客户端的请求会被拒绝：<code class="language-text">org.apache.kafka.common.errors.NotEnoughReplicasExceptoin: Messages are rejected since there are fewer in-sync replicas than required</code></li>
</ul>
</li>
<li>broker：
<ul>
<li><code class="language-text">unclean.leader.election.enable</code>：是否允许out-of-sync replica成为leader</li>
</ul>
</li>
<li>producer：
<ul>
<li>producer.type：消息生产者提交消息到kafka服务器的时候的模式，可选：sync或async
<ul>
<li><code class="language-text">sync</code>拥有很好的安全性</li>
<li><code class="language-text">async</code>拥有更高的吞吐量，可以批量进行消息发送</li>
</ul>
</li>
<li>request.required.acks：kafka服务器在收到消息之后何时对生产者进行完成反馈
<ul>
<li><code class="language-text">1（默认）</code>：partition的leader节点收取完成即反馈，如果在follower同步数据之前leader宕机则数据丢失</li>
<li><code class="language-text">0</code>：producer不等待kafka服务器反馈即直接进行后续发送，拥有最高的吞吐量以及最低的安全性</li>
<li><code class="language-text">-1</code>：partition的所有节点包括了leader以及所有的follower全部都确认数据同步完成再反馈，最高的安全性以及最低的吞吐量</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>要保证数据写入到Kafka是安全的，高可靠的，需要如下配置：</p>
<ul>
<li>topic：
<ul>
<li>replication.factor>=3：即副本数至少是3个</li>
<li>2&#x3C;=min.insync.replicas&#x3C;=replication.factor：要求每个partition leader的在线replica数量最少保持2个</li>
</ul>
</li>
<li>broker：
<ul>
<li>unclean.leader.election.enable=false：不允许out-of-sync replica成为leader</li>
</ul>
</li>
<li>producer：
<ul>
<li>request.required.acks=-1(all)：producer发送的消息请求必须让partition所有的replica都同步完毕才会返回成功</li>
<li>producer.type=sync：producer发送的消息以同步方式发送，即在写入成功之前，producer必须等待</li>
</ul>
</li>
</ul>
<h1 id="6-kafka-benchmark" style="position:relative;"><a href="#6-kafka-benchmark" aria-label="6 kafka benchmark permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. Kafka Benchmark</h1>
<p>这里的内容全部是转载自唯品会的：<a href="https://www.infoq.cn/article/depth-interpretation-of-kafka-data-reliability" target="_blank" rel="nofollow noopener noreferrer">Kafka 数据可靠性深度解读</a>。网上的资料很容易失效，因此在这里做下转载。</p>
<p>Benchmark的Kafka版本是：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">0.10.1.0</code></pre></div>
<h2 id="61-测试环境" style="position:relative;"><a href="#61-%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83" aria-label="61 测试环境 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.1 测试环境</h2>
<p>Kafka broker 用到了 4 台机器，分别为 broker[0/1/2/3] 配置如下：</p>
<ul>
<li>CPU: 24core/2.6GHZ</li>
<li>Memory: 62G</li>
<li>Network: 4000Mb</li>
<li>OS/kernel: CentOs release 6.6 (Final)</li>
<li>Disk: 1089G</li>
<li>Kafka 版本：0.10.1.0</li>
</ul>
<p>broker 端 JVM 参数设置：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">-Xmx8G -Xms8G -server -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:+CMSScavengeBeforeRemark -XX:+DisableExplicitGC -Djava.awt.headless=true -Xloggc:/apps/service/kafka/bin/../logs/kafkaServer-gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=9999</code></pre></div>
<p>客户端机器配置：</p>
<ul>
<li>CPU: 24core/2.6GHZ</li>
<li>Memory: 3G</li>
<li>Network: 1000Mb</li>
<li>OS/kernel: CentOs release 6.3 (Final)</li>
<li>Disk: 240G</li>
</ul>
<h2 id="62-不同场景测试" style="position:relative;"><a href="#62-%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E6%B5%8B%E8%AF%95" aria-label="62 不同场景测试 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2 不同场景测试</h2>
<h3 id="621-场景1" style="position:relative;"><a href="#621-%E5%9C%BA%E6%99%AF1" aria-label="621 场景1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2.1 场景1</h3>
<p>测试不同的副本数、min.insync.replicas 策略以及 request.required.acks 策略（以下简称 acks 策略）对于发送速度（TPS）的影响。</p>
<p>具体配置：</p>
<ul>
<li>一个 producer</li>
<li>发送方式为 sync</li>
<li>消息体大小为 1kB</li>
<li>partition 数为 12</li>
<li>副本数为：1/2/4</li>
<li>min.insync.replicas 分别为 1/2/4</li>
<li>acks 分别为 -1（all）/1/0</li>
</ul>
<p>具体测试数据如下表（min.insync.replicas 只在 acks=-1 时有效）：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-06.jpg" alt=""></p>
<p>测试结果分析：</p>
<ul>
<li>客户端的 acks 策略对发送的 TPS 有较大的影响，TPS：acks_0 > acks_1 > ack_-1;</li>
<li>副本数越高，TPS 越低；副本数一致时，min.insync.replicas 不影响 TPS；</li>
<li>acks=0/1 时，TPS 与 min.insync.replicas 参数以及副本数无关，仅受 acks 策略的影响。</li>
</ul>
<p>下面将 partition 的个数设置为 1，来进一步确认下不同的 acks 策略、不同的 min.insync.replicas 策略以及不同的副本数对于发送速度的影响，详细请看情景 2 和情景 3。</p>
<h3 id="622-场景2" style="position:relative;"><a href="#622-%E5%9C%BA%E6%99%AF2" aria-label="622 场景2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2.2 场景2</h3>
<p>在 partition 个数固定为 1，测试不同的副本数和 min.insync.replicas 策略对发送速度的影响。</p>
<p>具体配置：</p>
<ul>
<li>一个 producer</li>
<li>发送方式为 sync</li>
<li>消息体大小为 1kB</li>
<li>producer 端 acks=-1(all)</li>
<li>变换副本数：2/3/4</li>
<li>min.insync.replicas 设置为：1/2/4</li>
</ul>
<p>测试结果如下：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-07.jpg" alt=""></p>
<p>测试结果分析：</p>
<p>副本数越高，TPS 越低（这点与场景 1 的测试结论吻合），但是当 partition 数为 1 时差距甚微。min.insync.replicas 不影响 TPS。</p>
<h3 id="623-场景3" style="position:relative;"><a href="#623-%E5%9C%BA%E6%99%AF3" aria-label="623 场景3 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2.3 场景3</h3>
<p>在 partition 个数固定为 1，测试不同的 acks 策略和副本数对发送速度的影响。</p>
<p>具体配置：</p>
<ul>
<li>一个 producer</li>
<li>发送方式为 sync</li>
<li>消息体大小为 1kB</li>
<li>min.insync.replicas=1</li>
<li>topic 副本数为：1/2/4</li>
<li>acks： 0/1/-1</li>
</ul>
<p>测试结果如下：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-08.jpg" alt=""></p>
<p>测试结果分析（与情景 1 一致）：</p>
<ul>
<li>副本数越多，TPS 越低；</li>
<li>客户端的 acks 策略对发送的 TPS 有较大的影响，TPS：acks_0 > acks_1 > ack_-1。</li>
</ul>
<h3 id="624-场景4-id_benchmark_scen4" style="position:relative;"><a href="#624-%E5%9C%BA%E6%99%AF4-id_benchmark_scen4" aria-label="624 场景4 id_benchmark_scen4 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2.4 场景4 {#ID_BENCHMARK_SCEN4}</h3>
<p>测试不同 partition 数对发送速率的影响</p>
<p>具体配置：</p>
<ul>
<li>一个 producer</li>
<li>消息体大小为 1KB</li>
<li>发送方式为 sync</li>
<li>topic 副本数为 2</li>
<li>min.insync.replicas=2</li>
<li>acks=-1</li>
<li>partition 数量设置为 1/2/4/8/12</li>
</ul>
<p>测试结果：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-09.jpg" alt=""></p>
<p>测试结果分析：</p>
<p>partition 的不同会影响 TPS，随着 partition 的个数的增长 TPS 会有所增长，但并不是一直成正比关系，到达一定临界值时，partition 数量的增加反而会使 TPS 略微降低。</p>
<h3 id="625-场景5" style="position:relative;"><a href="#625-%E5%9C%BA%E6%99%AF5" aria-label="625 场景5 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2.5 场景5</h3>
<p>通过将集群中部分 broker 设置成不可服务状态，测试对客户端以及消息落盘的影响。</p>
<p>具体配置：</p>
<ul>
<li>一个 producer</li>
<li>消息体大小 1KB</li>
<li>发送方式为 sync</li>
<li>topic 副本数为 4</li>
<li>min.insync.replicas 设置为 2</li>
<li>acks=-1</li>
<li>retries=0/100000000</li>
<li>partition 数为 12</li>
</ul>
<p>具体测试数据如下表：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-10.jpg" alt=""></p>
<p>出错信息：</p>
<ul>
<li>错误 1：客户端返回异常，部分数据可落盘，部分失败：org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</li>
<li>错误 2：[WARN]internals.Sender - Got error produce response with correlation id 19369 on topic-partition default_channel_replicas_4_1-3, retrying (999999999 attempts left). Error: NETWORK_EXCEPTION</li>
<li>错误 3： [WARN]internals.Sender - Got error produce response with correlation id 77890 on topic-partition default_channel_replicas_4_1-8, retrying (999999859 attempts left). Error: NOT_ENOUGH_REPLICAS</li>
<li>错误 4： [WARN]internals.Sender - Got error produce response with correlation id 77705 on topic-partition default_channel_replicas_4_1-3, retrying (999999999 attempts left). Error: NOT_ENOUGH_REPLICAS_AFTER_APPEND</li>
</ul>
<p>测试结果分析：</p>
<ul>
<li>kill 两台 broker 后，客户端可以继续发送。broker 减少后，partition 的 leader 分布在剩余的两台 broker 上，造成了 TPS 的减小；</li>
<li>kill 三台 broker 后，客户端无法继续发送。Kafka 的自动重试功能开始起作用，当大于等于 min.insync.replicas 数量的 broker 恢复后，可以继续发送；</li>
<li>当 retries 不为 0 时，消息有重复落盘；客户端成功返回的消息都成功落盘，异常时部分消息可以落盘。</li>
</ul>
<h3 id="626-场景6" style="position:relative;"><a href="#626-%E5%9C%BA%E6%99%AF6" aria-label="626 场景6 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.2.6 场景6</h3>
<p>测试单个 producer 的发送延迟，以及端到端的延迟。</p>
<p>具体配置：</p>
<ul>
<li>一个 producer</li>
<li>消息体大小 1KB</li>
<li>发送方式为 sync</li>
<li>topic 副本数为 4</li>
<li>min.insync.replicas 设置为 2</li>
<li>acks=-1</li>
<li>partition 数为 12</li>
</ul>
<p>测试数据及结果（单位为 ms）：</p>
<p><img src="/media/posts/2019/04/kafka-note/message-queue-11.jpg" alt=""></p>
<h2 id="63-各场景测试总结" style="position:relative;"><a href="#63-%E5%90%84%E5%9C%BA%E6%99%AF%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93" aria-label="63 各场景测试总结 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6.3 各场景测试总结</h2>
<ul>
<li>当 acks=-1 时，Kafka 发送端的 TPS 受限于 topic 的副本数量（ISR 中），副本越多 TPS 越低；</li>
<li>acks=0 时，TPS 最高，其次为 1，最差为 -1，即 TPS：acks_0 > acks_1 > ack_-1；</li>
<li>min.insync.replicas 参数不影响 TPS；</li>
<li>partition 的不同会影响 TPS，随着 partition 的个数的增长 TPS 会有所增长，但并不是一直成正比关系，到达一定临界值时，partition 数量的增加反而会使 TPS 略微降低；</li>
<li>Kafka 在 acks=-1,min.insync.replicas>=1 时，具有高可靠性，所有成功返回的消息都可以落盘。</li>
</ul>
<h1 id="7-kafka使用范例" style="position:relative;"><a href="#7-kafka%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B" aria-label="7 kafka使用范例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>7. Kafka使用范例</h1>
<p>实验使用的还是下载下来的Kafka，版本如头部申明的是<code class="language-text">2.2.0</code>。范例代码可以在Github查看：<a href="https://github.com/agreatfool/dist-system-practice/tree/master/experiment/kafka" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/experiment/kafka/</a>。</p>
<h1 id="8-在docker内部署集群" style="position:relative;"><a href="#8-%E5%9C%A8docker%E5%86%85%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4" aria-label="8 在docker内部署集群 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8. 在Docker内部署集群</h1>
<p>一般来说部署一个以上的docker容器组成集群，可以使用bash脚本的方法，自己编写命令一个个启动，但更好的方法是使用<code class="language-text">docker-compose</code>命令，读取配置文件，将整个集群按设定的模式启动起来。可运行范例可以查看：<a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/conf/dev/kafka-cluster.yaml" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/conf/dev/kafka-cluster.yaml</a>。</p>
<p>启动脚本：<a href="https://github.com/agreatfool/dist-system-practice/blob/master/golang/src/dist-system-practice/bash/dev/docker_kafka.sh" target="_blank" rel="nofollow noopener noreferrer">dist-system-practice/bash/dev/docker_kafka.sh</a>。</p>
<p>主要有几个点需要注意下。</p>
<h2 id="81-重要配置项" style="position:relative;"><a href="#81-%E9%87%8D%E8%A6%81%E9%85%8D%E7%BD%AE%E9%A1%B9" aria-label="81 重要配置项 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.1 重要配置项</h2>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka_1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"wurstmeister/kafka:2.12-2.2.0"</span> <span class="token comment"># 一定需要</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">"kafka_1"</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> <span class="token string">"kafka_1"</span> <span class="token comment"># 使用这个名字来让同network的其他服务进行访问</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"zookeeper"</span> <span class="token comment"># 保证启动先后顺序</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /private/tmp/jmx_prometheus_javaagent<span class="token punctuation">-</span>0.9.jar<span class="token punctuation">:</span>/usr/local/bin/jmx_prometheus_javaagent<span class="token punctuation">-</span>0.9.jar
      <span class="token punctuation">-</span> /private/tmp/jmx<span class="token punctuation">-</span>kafka<span class="token punctuation">-</span>2_0_0.yaml<span class="token punctuation">:</span>/etc/jmx<span class="token punctuation">-</span>exporter/jmx<span class="token punctuation">-</span>kafka<span class="token punctuation">-</span>2_0_0.yaml
      <span class="token punctuation">-</span> kafka_vol_1<span class="token punctuation">:</span>/tmp/kafka/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"net"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"19092:9092"</span> <span class="token comment"># client port # 保证非同一network的其他服务也能访问，但这么做要求每个kafka service都监听不同的端口，相互不能冲突</span>
      <span class="token punctuation">-</span> <span class="token string">"17071:7071"</span> <span class="token comment"># jmx prometheus metrics</span>
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"9092"</span> <span class="token comment"># client port</span>
      <span class="token punctuation">-</span> <span class="token string">"9093"</span> <span class="token comment"># internal traffic # kafka集群内部流量走的端口号</span>
      <span class="token punctuation">-</span> <span class="token string">"9991"</span> <span class="token comment"># jmx # jmx进程本身监听的地址，提供给jmx_exporter连接用</span>
      <span class="token punctuation">-</span> <span class="token string">"7071"</span> <span class="token comment"># jmx prometheus metrics # jmx_exporter监听的地址，提供给prometheus抓取metrics</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> <span class="token string">"always"</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"json-file"</span> <span class="token comment"># 日志输出以json格式，容易让聚合工具使用</span>
      <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token string">"512m"</span> <span class="token comment"># 保证日志最大尺寸不会过大占用过多系统磁盘</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">KAFKA_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"INSIDE://0.0.0.0:9093,OUTSIDE://0.0.0.0:9092"</span> <span class="token comment"># kafka的实际监听地址，一般不是0.0.0.0就是容器名</span>
      <span class="token key atrule">KAFKA_ADVERTISED_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"INSIDE://kafka_1:9093,OUTSIDE://127.0.0.1:19092"</span> <span class="token comment"># kafka发布到zookeeper，让客户端获取并凭之连接kafka的地址，一定需要是客户端能访问到的地址，INSIDE部分供集群内部流量使用，OUTSIDE供客户端使用</span>
      <span class="token key atrule">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="token punctuation">:</span> <span class="token string">"INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT"</span> <span class="token comment"># 明确内部外部的通讯协议</span>
      <span class="token key atrule">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="token punctuation">:</span> INSIDE <span class="token comment"># 告诉kafka集群上面的INSIDE和OUTSIDE配置哪个才是供集群内部流量使用的，按语义一般是INSIDE</span>
      <span class="token key atrule">KAFKA_BROKER_ID</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 必须每个kafka broker单独一个，不可重复</span>
      <span class="token key atrule">JMX_PORT</span><span class="token punctuation">:</span> <span class="token number">9991</span> <span class="token comment"># jmx监听的地址</span>
      <span class="token key atrule">KAFKA_OPTS</span><span class="token punctuation">:</span> <span class="token string">"-javaagent:/usr/local/bin/jmx_prometheus_javaagent-0.9.jar=7071:/etc/jmx-exporter/jmx-kafka-2_0_0.yaml"</span> <span class="token comment"># kafka在启动时一并会给予启动</span>
      <span class="token key atrule">KAFKA_ZOOKEEPER_CONNECT</span><span class="token punctuation">:</span> <span class="token string">"zookeeper:2181"</span> <span class="token comment"># 告知kafka zookeeper的地址</span>
      <span class="token key atrule">KAFKA_LOG_DIRS</span><span class="token punctuation">:</span> <span class="token string">"/tmp/kafka-logs"</span> <span class="token comment"># kafka实际的数据存放位置，推荐使用volume进行该地址的local映射</span>
      <span class="token key atrule">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># kafka内部用来保存topic的offset的数据，其replication数量</span>
      <span class="token key atrule">KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># kafka内部用来保存transaction state log的数据，其replication数量</span>
      <span class="token key atrule">KAFKA_MIN_INSYNC_REPLICAS</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># partition的leader节点要求当前在线的replica节点的数量</span></code></pre></div>
<p>关于<code class="language-text">LISTENER</code>相关的几个配置（用于集群访问）更多的可以看下：<a href="#DOCKER_OUT_NET">8.2 对容器外应用提供服务</a>。</p>
<p>参见：</p>
<ul>
<li><a href="https://docs.confluent.io/current/kafka/deployment.html" target="_blank" rel="nofollow noopener noreferrer">Running Kafka in Production</a></li>
</ul>
<h2 id="82-对容器外应用提供服务-docker_out_net" style="position:relative;"><a href="#82-%E5%AF%B9%E5%AE%B9%E5%99%A8%E5%A4%96%E5%BA%94%E7%94%A8%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1-docker_out_net" aria-label="82 对容器外应用提供服务 docker_out_net permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.2 对容器外应用提供服务 {#DOCKER_OUT_NET}</h2>
<p>在docker中部署集群有一个比较大的问题就是容器内部和外部的网络访问地址是隔离的，而kafka集群部分节点的相互发现是根据配置：<code class="language-text">KAFKA_ADVERTISED_LISTENERS</code>来进行通知的。</p>
<p>如果该配置内的地址填写的是<code class="language-text">127.0.0.1</code>这样的回环地址或容器外的IP，那么容器内各kafka节点之间的通讯就会有问题（因为容器内各节点拿到的配置地址都是容器外的IP）。而如果将该配置内的地址都配置成docker容器的名字，那么在容器内部的流量是没问题了，但外部访问kafka服务的应用程序拿到的地址则是容器的名字，就没法访问了。</p>
<p>所以对于需要向容器外部环境的应用提供服务的情况来说，需要做好几项配置的调整（这里说的配置都是kafka的配置，不涉及到zookeeper的配置，事实上集群部署的配置中zookeeper相关的内容非常简单）：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">KAFKA_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"INSIDE://0.0.0.0:9093,OUTSIDE://0.0.0.0:9092"</span>
<span class="token key atrule">KAFKA_ADVERTISED_LISTENERS</span><span class="token punctuation">:</span> <span class="token string">"INSIDE://kafka_1:9093,OUTSIDE://127.0.0.1:19092"</span>
<span class="token key atrule">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="token punctuation">:</span> <span class="token string">"INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT"</span>
<span class="token key atrule">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="token punctuation">:</span> INSIDE</code></pre></div>
<p>kafka的配置中，现在可以将内部流量和外部流量的监听地址分离开来，在配置<code class="language-text">LISTENERS</code>相关的配置时，使用<code class="language-text">,</code>将<code class="language-text">INSIDE</code>和<code class="language-text">OUTSIDE</code>隔离开来即可。一般来说，<code class="language-text">INSIDE</code>的地址会配置成当前节点的容器名，或者就直接设置成<code class="language-text">0.0.0.0</code>。而<code class="language-text">OUTSIDE</code>则根据自身需求设置即可，这里的范例是给本机开发测试用，因此设置的是<code class="language-text">127.0.0.1</code>。</p>
<p><code class="language-text">KAFKA_INTER_BROKER_LISTENER_NAME</code>配置项则是告诉kafka，集群各broker节点之间是使用INSIDE还是OUTSIDE配置作为集群内部流量的通讯地址。此外需要注意的是，该配置的<code class="language-text">INSIDE</code>和<code class="language-text">OUTSIDE</code>监听的端口是<code class="language-text">不可以重复</code>的，因为实际上kafka就是开了两个端口都在监听。</p>
<p>一般第一次在本地设置集群进行开发和调试的时候，这里是个大坑，非常麻烦。配置不正确就会发现kafka完全无法通讯。</p>
<h2 id="83-docker-compose-scale" style="position:relative;"><a href="#83-docker-compose-scale" aria-label="83 docker compose scale permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.3 docker-compose scale</h2>
<p>一般来说，kafka service的配置不适合在配置文件中只设置一份，然后使用docker-compose scale的方法进行横向扩展。</p>
<p>适用scale的场景只有完全无状态，且各个节点之间的配置完全相同的情况，而kafka各节点一般最好设置自身的<code class="language-text">container_name</code>，然后在监听地址中使用正确的容器名作为地址，来进行相互通讯。</p>
<h2 id="84-yaml配置重用" style="position:relative;"><a href="#84-yaml%E9%85%8D%E7%BD%AE%E9%87%8D%E7%94%A8" aria-label="84 yaml配置重用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.4 yaml配置重用</h2>
<p>因为无法使用scale的缘故，必须手写大量的kafka service节点yaml配置，这倒也不算是大问题。关键的问题在于有大量重复的配置项，如果后面要修改，就很麻烦，怕漏改或者改错。</p>
<p>因此最好的方法是使用yaml的配置重用，来设置共通的配置，然后像变量一样重用。这可以参见我之前提到的范例配置文件：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">x-kafka-environment-defaults</span><span class="token punctuation">:</span> <span class="token important">&amp;KAFKA_ENV_DEFAULTS</span>
  <span class="token punctuation">...</span>
  <span class="token comment"># 在这里放默认的配置</span>
  <span class="token punctuation">...</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka_1</span><span class="token punctuation">:</span>
    <span class="token punctuation">...</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*KAFKA_ENV_DEFAULTS</span> <span class="token comment"># 这样就把作为变量的配置全部导入到这个点上了</span></code></pre></div>
<h2 id="84-相关参考" style="position:relative;"><a href="#84-%E7%9B%B8%E5%85%B3%E5%8F%82%E8%80%83" aria-label="84 相关参考 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>8.4 相关参考</h2>
<ul>
<li><a href="https://better-coding.com/building-apache-kafka-cluster-using-docker-compose-and-virtualbox/" target="_blank" rel="nofollow noopener noreferrer">Building Apache Kafka cluster using docker-compose and VirtualBox</a></li>
<li><a href="https://www.kaaproject.org/kafka-docker" target="_blank" rel="nofollow noopener noreferrer">Deploying a Kafka broker in a Docker container</a></li>
</ul>
<h1 id="9-写性能与安全性" style="position:relative;"><a href="#9-%E5%86%99%E6%80%A7%E8%83%BD%E4%B8%8E%E5%AE%89%E5%85%A8%E6%80%A7" aria-label="9 写性能与安全性 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>9. 写性能与安全性</h1>
<p>在进行测试的过程中，发现写入的速度比较慢，基本上每次写入在kafka集群这边会耗时1秒多，完全不能接受了。之前的博文中也提到了，集群安全性和写入性能是反比的，主要有几项因素：</p>
<ul>
<li>producer的写入模式：同步、异步
<ul>
<li>异步拥有最佳的性能，但安全性极差</li>
<li>同步性能很差，但安全性有保证</li>
</ul>
</li>
<li>acks写入的集群同步模式：-1完全同步、0完全不等待同步、1Leader节点同步
<ul>
<li>0拥有最佳性能，最低的安全性</li>
<li>-1拥有最佳性能，但性能最低</li>
<li>1则比较均衡</li>
</ul>
</li>
<li>partition数量：acks如果为-1，则需要同步所有节点，partition数量越多则性能越低</li>
</ul>
<p>后续进行了一些研究和测试。</p>
<p>集群共3个broker，topic分片如下：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Topic:work-topic	PartitionCount:3	ReplicationFactor:3	Configs:
	Topic: work-topic	Partition: 0	Leader: 2	Replicas: 2,0,1	Isr: 2,0,1
	Topic: work-topic	Partition: 1	Leader: 1	Replicas: 1,2,0	Isr: 1,2,0
	Topic: work-topic	Partition: 2	Leader: 0	Replicas: 0,1,2	Isr: 0,1,2</code></pre></div>
<p>查了下官方配置，<code class="language-text">producer.acks</code>这个现在放在<code class="language-text">3.3 Producer Configs</code>里，命名为<code class="language-text">acks</code>（<a href="https://kafka.apache.org/22/documentation.html#producerconfigs" target="_blank" rel="nofollow noopener noreferrer">链接</a>）。需要注意的是，这一项配置并不是服务端的配置项，而是连接上来的客户端producer所进行的设置，是否acks根据客户端producer的要求而变动。这很反直觉，我一开始一直都以为这是服务端的配置项，没想到居然是客户端的。</p>
<p>acks在kafka-go的使用，可以查看注释：<a href="https://github.com/segmentio/kafka-go/blob/v0.2.4/writer.go#L101" target="_blank" rel="nofollow noopener noreferrer">kafka-go/writer.go</a>，默认是-1，也就是最安全但最慢的那种。</p>
<p>此外，写入模式是同步还是异步也是客户端设置，见：<a href="https://github.com/segmentio/kafka-go/blob/v0.2.4/writer.go#L105" target="_blank" rel="nofollow noopener noreferrer">kafka-go/writer.go</a>。</p>
<p>在上面提到的几项要素中，集群规模和partition数量之类都是业务要求，一般不会轻易变动，所以测试主要是实验在不同写入模式和acks情况下的性能变动。</p>
<p>测试：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">同步 -1 1秒+
同步 1  1秒+
同步 0  1秒+
异步 -1 0.2ms 几乎瞬间完成
异步 1  0.2ms 几乎瞬间完成
异步 0  0.2ms 几乎瞬间完成</code></pre></div>
<p>结论：性能只在于是否将客户端设置成异步写入，acks对性能的影响微乎其微。</p>
<p>但上述的测试是在MAC本地环境进行的，有几项因素不够稳定：</p>
<ul>
<li>kafka集群的内存很小</li>
<li>磁盘IO和实际情况差别较大</li>
<li>集群规模过小</li>
<li>partition数量很少（集群和partition数量很小能够部分解释为什么acks的改动基本上不影响性能）</li>
</ul>
<p>因此上述测试的结论主要是参考价值，不能作为最终结论。如果后续需要严谨结论的话，需要在真实机器上测试，并需要开启go的profiling，观察下kafka类库中的写入到底是怎么完成的，以及kafka集群的响应情况。此外，即便是模拟集群1秒左右的同步写入速度也实在是太慢了，后续还需要深入profiling，到底这1秒做了什么（无论是kafka还是go客户端）。</p>
<h1 id="10-todo" style="position:relative;"><a href="#10-todo" aria-label="10 todo permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10. TODO</h1>
<ul>
<li>深入研究Kafka的监控Metrics</li>
<li>Kafka集群同步写入性能较低的原因解析</li>
</ul>
<h1 id="资料" style="position:relative;"><a href="#%E8%B5%84%E6%96%99" aria-label="资料 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>资料</h1>
<h2 id="链接" style="position:relative;"><a href="#%E9%93%BE%E6%8E%A5" aria-label="链接 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>链接</h2>
<ul>
<li><a href="http://www.kubiji.cn/book/apache_kafka/APACHEKAFKAJiaoCheng/APACHEKAFKAGaiShu.html" target="_blank" rel="nofollow noopener noreferrer">Apache kafka中文手册</a></li>
<li><a href="https://www.infoq.cn/article/distributed-queue-programme-model-actual-combat-optimization" target="_blank" rel="nofollow noopener noreferrer">分布式队列编程：从模型、实战到优化</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&#x26;mid=2651745361&#x26;idx=1&#x26;sn=5f0f67484a0de4b0dd2796848ef9cc94" target="_blank" rel="nofollow noopener noreferrer">分布式队列编程优化篇</a></li>
<li><a href="https://www.jianshu.com/p/7a6deaba34d2" target="_blank" rel="nofollow noopener noreferrer">如何保证消息队列的高可用和幂等性以及数据丢失，顺序一致性</a></li>
<li><a href="https://www.infoq.cn/article/kafka-vs-rabbitmq" target="_blank" rel="nofollow noopener noreferrer">消息中间件选型分析：从 Kafka 与 RabbitMQ 的对比看全局</a></li>
<li><a href="https://www.infoq.cn/article/dXJ3EYIp*WaHfmVwlMeu" target="_blank" rel="nofollow noopener noreferrer">滴滴出行基于 RocketMQ 构建企业级消息队列服务的实践</a></li>
<li><a href="https://stackoverflow.com/questions/39586635/why-is-kafka-pull-based-instead-of-push-based" target="_blank" rel="nofollow noopener noreferrer">Why is Kafka pull-based instead of push-based?</a></li>
<li><a href="https://medium.com/@philipfeng/modern-open-source-messaging-apache-kafka-rabbitmq-nats-pulsar-and-nsq-ca3bf7422db5" target="_blank" rel="nofollow noopener noreferrer">Modern Open Source Messaging: NATS, RabbitMQ, Apache Kafka, hmbdc, Synapse, NSQ and Pulsar</a></li>
<li><a href="https://www.cnblogs.com/huxi2b/p/6223228.html" target="_blank" rel="nofollow noopener noreferrer">Kafka消费组(consumer group)</a></li>
<li><a href="https://stackoverflow.com/questions/45175424/how-multiple-consumer-group-consumers-work-across-partition-on-the-same-topic-in" target="_blank" rel="nofollow noopener noreferrer">How multiple consumer group consumers work across partition on the same topic in Kafka?</a></li>
<li><a href="https://blog.csdn.net/pursuer211/article/details/79799478" target="_blank" rel="nofollow noopener noreferrer">kafka中partition和消费者对应关系</a></li>
<li><a href="https://medium.com/@danieljameskay/understanding-the-enable-auto-commit-kafka-consumer-property-12fa0ade7b65" target="_blank" rel="nofollow noopener noreferrer">Understanding the ‘enable.auto.commit’ Kafka Consumer property</a></li>
<li><a href="https://www.datadoghq.com/blog/monitoring-kafka-performance-metrics/" target="_blank" rel="nofollow noopener noreferrer">Monitoring Kafka performance metrics - P1</a></li>
<li><a href="https://www.datadoghq.com/blog/collecting-kafka-performance-metrics/" target="_blank" rel="nofollow noopener noreferrer">Monitoring Kafka performance metrics - P2</a></li>
<li><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="nofollow noopener noreferrer">danielqsj/kafka_exporter</a></li>
<li><a href="https://docs.confluent.io/current/kafka/monitoring.html" target="_blank" rel="nofollow noopener noreferrer">Monitoring Kafka</a></li>
<li><a href="https://www.infoq.cn/article/depth-interpretation-of-kafka-data-reliability" target="_blank" rel="nofollow noopener noreferrer">Kafka 数据可靠性深度解读</a></li>
<li><a href="https://better-coding.com/building-apache-kafka-cluster-using-docker-compose-and-virtualbox/" target="_blank" rel="nofollow noopener noreferrer">Building Apache Kafka cluster using docker-compose and VirtualBox</a></li>
<li><a href="https://www.kaaproject.org/kafka-docker" target="_blank" rel="nofollow noopener noreferrer">Deploying a Kafka broker in a Docker container</a></li>
<li><a href="https://docs.confluent.io/current/kafka/deployment.html" target="_blank" rel="nofollow noopener noreferrer">Running Kafka in Production</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/47388267" target="_blank" rel="nofollow noopener noreferrer">比拼Kafka，大数据分析新秀Pulsar到底好在哪</a></li>
<li><a href="https://www.slideshare.net/merlimat/high-performance-messaging-with-apache-pulsar" target="_blank" rel="nofollow noopener noreferrer">High performance messaging with Apache Pulsar</a></li>
<li><a href="https://www.infoq.cn/article/Us*a8umKXT9LpV9hA6tF" target="_blank" rel="nofollow noopener noreferrer">选择 Pulsar 而不是 Kafka 的 7 大理由</a></li>
<li><a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="nofollow noopener noreferrer">prometheus/jmx_exporter</a></li>
<li><a href="https://hub.docker.com/r/sscaling/jmx-prometheus-exporter" target="_blank" rel="nofollow noopener noreferrer">sscaling/jmx-prometheus-exporter</a></li>
<li><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="nofollow noopener noreferrer">danielqsj/kafka_exporter</a></li>
<li><a href="https://hub.docker.com/r/danielqsj/kafka-exporter" target="_blank" rel="nofollow noopener noreferrer">danielqsj/kafka-exporter</a></li>
<li><a href="https://github.com/oded-dd/prometheus-jmx-kafka" target="_blank" rel="nofollow noopener noreferrer">oded-dd/prometheus-jmx-kafka</a></li>
<li><a href="https://github.com/Mousavi310/kafka-grafana" target="_blank" rel="nofollow noopener noreferrer">Mousavi310/kafka-grafana</a></li>
</ul>
<blockquote>
<p>EOF</p>
</blockquote></div></div></div><div class="Post-module--footer--NpFTW"><div class="Meta-module--meta--3YYBJ"><p class="Meta-module--date--U0EV3">Published<!-- --> <!-- -->2019/4/29</p></div><div class="Tags-module--tags--1r6Jk"><ul class="Tags-module--list--3a6Ka"><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/kafka/">Kafka</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/messagequeue/">MessageQueue</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/keynote/">Keynote</a></li></ul></div><div class="Author-module--author--2kT-Q"><p class="Author-module--bio--2YX8-">Some tech &amp; personal blog posts<a class="Author-module--twitter--1B6I5" href="https://github.com/agreatfool" rel="noopener noreferrer" target="_blank"><strong>Jonathan Dai</strong> on Github</a></p></div></div><div class="Post-module--comments--2bE-0"><div id="disqus_thread"></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2019/04/kafka-note";window.___webpackCompilationHash="371f6387a60c9395e7f3";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c743c10e2eb6467040f1.js"],"app":["/app-591a9ca27468496ecc74.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-0c915c7b1bdb5eac4fdf.js"],"component---src-templates-categories-template-categories-template-tsx":["/component---src-templates-categories-template-categories-template-tsx-5cf1ee016fbabd4cc244.js"],"component---src-templates-category-template-category-template-tsx":["/component---src-templates-category-template-category-template-tsx-b229c8135c3921c8d3f6.js"],"component---src-templates-index-template-index-template-tsx":["/component---src-templates-index-template-index-template-tsx-ae0b72bf804b6a6d8f8b.js"],"component---src-templates-not-found-template-not-found-template-tsx":["/component---src-templates-not-found-template-not-found-template-tsx-34764a7195a0a3d20525.js"],"component---src-templates-page-template-page-template-tsx":["/component---src-templates-page-template-page-template-tsx-8d9df3d13cb146b2b124.js"],"component---src-templates-post-template-post-template-tsx":["/component---src-templates-post-template-post-template-tsx-55cf601722552b1f230a.js"],"component---src-templates-tag-template-tag-template-tsx":["/component---src-templates-tag-template-tag-template-tsx-dd56e504ecc95c1d80fe.js"],"component---src-templates-tags-template-tags-template-tsx":["/component---src-templates-tags-template-tags-template-tsx-285b7a03795d0591a93e.js"]};/*]]>*/</script><script src="/polyfill-c743c10e2eb6467040f1.js" nomodule=""></script><script src="/app-591a9ca27468496ecc74.js" async=""></script><script src="/framework-c14ed818a88fa3beed0f.js" async=""></script><script src="/webpack-runtime-62a0cf7d177c0bdb700e.js" async=""></script></body></html>