<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.20.0"/><meta name="theme-color" content="hsl(31, 92%, 62%)"/><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:site_name" content="NSQ Note - Blog by Jonathan Dai"/><meta data-react-helmet="true" property="og:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="NSQ Note - Blog by Jonathan Dai"/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="twitter:image" content="https://xenojoshua.com/media/default-social-image.jpg"/><style data-href="/styles.73ba2c353057148cd83d.css" data-identity="gatsby-global-css">html{font-size:100}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizelegibility;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#212121;font-size:16px;line-height:1.625;margin:0 0 0 calc(100vw - 100%)}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:40px;line-height:52px;margin-bottom:26px;margin-top:104px}h2{font-size:27px;line-height:39px}h2,h3{margin-bottom:13px;margin-top:52px}h3{font-size:22px;line-height:26px}h4{font-size:19.2px;margin-top:39px}h4,h5{line-height:26px;margin-bottom:13px}h5,h6{font-size:16px;margin-top:65px}h6{line-height:26px;margin-bottom:13px}img{max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#212121 0,#212121 15px,transparent 0,transparent 26px);background-size:100% 26px;color:#212121;height:26px;margin:52px auto;width:100px}a{color:#5c92ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a145}b,strong{font-weight:600}ul{list-style:square;margin-bottom:26px}ul li{margin-bottom:10px;padding:0 5px}p{line-height:26px;margin-bottom:26px}blockquote{font-style:italic;padding:0;text-align:center}figure{display:block;height:auto;width:100%}figcaption{color:#212121;font-size:14px;font-style:italic;line-height:19.5px;margin-bottom:0;margin-top:6.5px;text-align:center}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:310px;padding:0 26px}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83;cursor:help}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}blockquote{border-left:5px solid #424242!important;color:#424242!important;display:block!important;font-style:normal!important;padding-left:1rem!important;text-align:left!important}table{border-collapse:collapse;box-shadow:0 0 20px rgba(0,0,0,.15)}thead tr{background-color:#009879;color:#fff;text-align:left}td,th{padding:12px 15px}tbody tr{border-bottom:1px solid #ddd}tbody tr:nth-of-type(2n){background-color:#f3f3f3}tbody tr:last-of-type{border-bottom:2px solid #009879}h1{margin-top:0!important}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky{margin-bottom:32.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky:last-child{margin-bottom:13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W{font-size:27px;line-height:39px;margin-bottom:13px;margin-top:0}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE{color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--title--1qA0W .Feed-module--link--GNuXE:hover{border-bottom:1px solid #212121;color:#212121}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--description--UXUO2{font-size:16px;line-height:26px;margin-bottom:19.5px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--time--17yla{color:#212121;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--divider--3kBgQ{margin:0 13px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE{color:#f7a145;font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--meta--ECIPa .Feed-module--category--DGEwP .Feed-module--link--GNuXE:hover{color:#5c92ff}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-{color:#5c92ff;font-size:16px}.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:focus,.Feed-module--feed--3dYe7 .Feed-module--item--ooOky .Feed-module--more--Axk8-:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Layout-module--layout--36KWw{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--36KWw:before{content:"";display:table}.Layout-module--layout--36KWw:after{clear:both;content:"";display:table}.Page-module--page--2Y5e7{margin-bottom:52px}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:26px 19.5px 0}.Page-module--page--2Y5e7 .Page-module--title--Z69a4{font-size:40px;font-weight:600;line-height:52px;margin-bottom:37.7px;margin-top:0}.Page-module--page--2Y5e7 .Page-module--body--hPYHN{font-size:16px;line-height:26px;margin:0 0 26px}@media screen and (min-width:685px){.Page-module--page--2Y5e7{width:calc(58.275% - 12.5px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(12n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(12n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:32.5px 19.5px 0}}@media screen and (min-width:960px){.Page-module--page--2Y5e7{width:calc(66.6% - 10px)}.Page-module--page--2Y5e7:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--2Y5e7:last-child{margin-right:0}.Page-module--page--2Y5e7:nth-child(3n){float:right;margin-right:0}.Page-module--page--2Y5e7:nth-child(3n+1){clear:both}.Page-module--page--2Y5e7 .Page-module--inner--3HKeR{padding:39px 26px 0}}.Pagination-module--pagination--3KtNE{display:flex;margin-top:52px}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8{text-align:left;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:focus,.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--previous--3Jp_8 .Pagination-module--previousLink--1mLDH.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj{text-align:right;width:50%}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5{color:#f7a145;font-size:26px;font-weight:700}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:focus,.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5:hover{color:#5c92ff}.Pagination-module--pagination--3KtNE .Pagination-module--next--PX9hj .Pagination-module--nextLink--DTlD5.Pagination-module--disable--4zAQA{color:#9b9b9b;pointer-events:none}.Author-module--author--12DFk .Author-module--photo--1WT_U{background-clip:padding-box;border-radius:50%;display:inline-block;height:75px;margin-bottom:0;width:75px}.Author-module--author--12DFk .Author-module--title--2UdHe{font-size:18px;font-weight:600;line-height:29.25px;margin:13px 0}.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:focus,.Author-module--author--12DFk .Author-module--title--2UdHe .Author-module--link--1dqxo:hover{color:#212121}.Author-module--author--12DFk .Author-module--subtitle--3HDSh{color:#878787;line-height:26px;margin-bottom:26px}.Icon-module--icon--fdMTB{fill:currentcolor;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;speak:none;stroke:currentcolor;stroke-width:0;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--3rFuK{margin-bottom:26px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:13px 0;max-width:150px;padding:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X{align-content:center;align-items:center;border:1px solid #ebebeb;border-radius:50%;display:flex;height:35px;justify-content:center;line-height:35px;margin:6.5px;padding:0;text-align:center;width:35px}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X:nth-child(3n+1){margin-left:0}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi{border:0;color:#212121;display:flex}.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:focus,.Contacts-module--contacts--3rFuK .Contacts-module--list--3gIi_ .Contacts-module--item--3aZ8X .Contacts-module--link--2rGsi:hover{color:#5c92ff}.Copyright-module--copyright--1IQFN{color:#999;font-size:14px}.Menu-module--menu--3SbXJ{margin-bottom:26px}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI{list-style:none;margin:0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8{margin:13px 0;padding:0}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV{border:0;color:#212121;font-size:16px;font-weight:400}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:focus,.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Menu-module--menu--3SbXJ .Menu-module--list--1n4ZI .Menu-module--item--DDbJ8 .Menu-module--link--3lstV.Menu-module--active--aYO_r{border-bottom:1px solid #212121;color:#212121}.Sidebar-module--sidebar--1NhQN{width:100%}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:26px 19.5px 0;position:relative}@media screen and (min-width:685px){.Sidebar-module--sidebar--1NhQN{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(12n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:32.5px 19.5px 0}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);bottom:0;content:"";height:540px;position:absolute;right:-10px;top:30px;width:1px}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1NhQN{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1NhQN:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1NhQN:last-child{margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1NhQN:nth-child(3n+1){clear:both}.Sidebar-module--sidebar--1NhQN .Sidebar-module--inner--12iqG{padding:39px}}.Author-module--author--2kT-Q{border-top:1px solid #e6e6e6;line-height:26px;margin-bottom:52px;margin-top:26px;max-width:640px;padding-top:26px}.Author-module--author--2kT-Q .Author-module--bio--2YX8- .Author-module--twitter--1B6I5{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2kT-Q{margin-left:auto;margin-right:auto}}.Content-module--content--3dNJJ{margin:0 auto;max-width:945px;padding:0 13px}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:32px;font-weight:600;line-height:42.9px;margin:26px auto 0;max-width:640px;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure{margin-bottom:26px}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote{font-style:italic;margin-top:0;padding:26px 0;text-align:center}.Content-module--content--3dNJJ .Content-module--body--3LJXt figure blockquote p{font-size:26.9072px;line-height:39px;margin-bottom:26px;margin-top:0;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt a{text-decoration:underline}.Content-module--content--3dNJJ .Content-module--body--3LJXt *{margin-left:auto;margin-right:auto;max-width:640px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{visibility:hidden}.Content-module--content--3dNJJ .Content-module--body--3LJXt img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3dNJJ{padding:0}.Content-module--content--3dNJJ .Content-module--title--3vQh6{font-size:48px;line-height:58.5px;margin-bottom:39px;margin-top:58.5px}.Content-module--content--3dNJJ .Content-module--body--3LJXt,.Content-module--content--3dNJJ .Content-module--body--3LJXt p{font-size:18px;line-height:29.25px;margin-bottom:29.25px}.Content-module--content--3dNJJ .Content-module--body--3LJXt h2>a{padding-right:26px;visibility:unset}}.Meta-module--meta--3YYBJ .Meta-module--date--U0EV3{font-style:italic}.Tags-module--tags--1r6Jk{margin-bottom:13px}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka{list-style:none;padding:0}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ{display:inline-block;margin:13px 3.25px}@media screen and (min-width:685px){.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ:first-child{margin-left:0;padding-left:0}}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:inline-block;height:35px;line-height:35px;padding:0 19.5px;text-decoration:none}.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:focus,.Tags-module--tags--1r6Jk .Tags-module--list--3a6Ka .Tags-module--item--2JSXQ .Tags-module--link--hkiai:hover{color:#5c92ff}.Gallery-module--gallery--2g0Rf{grid-gap:.5em;display:grid;grid-auto-rows:16vw;grid-template-columns:repeat(4,1fr)}.Gallery-module--gallery--2g0Rf>*{box-shadow:0 2px 8px 0 rgba(0,0,0,.2),0 3px 20px 0 rgba(0,0,0,.19)}.Gallery-module--gallery--2g0Rf>:hover{cursor:pointer;-webkit-filter:blur(4px);filter:blur(4px);transition:all .5s ease}.Gallery-module--gallery--2g0Rf>:nth-child(6n+3){grid-column:span 1;grid-row:span 2}.Gallery-module--gallery--2g0Rf>:nth-child(6n+2),.Gallery-module--gallery--2g0Rf>:nth-child(6n+5),.Gallery-module--gallery--2g0Rf>:nth-child(6n+6){grid-column:span 2;grid-row:span 2}.Post-module--post--mo55f .Post-module--content--3cRzw{margin:0 auto}.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{margin:0 auto;max-width:640px;padding:0 13px}.Post-module--post--mo55f .Post-module--button--27HfC{border:1px solid #e6e6e6;border-radius:20px;color:#212121;display:block;font-size:16px;font-weight:400;height:35px;line-height:35px;margin-left:auto;margin-right:auto;margin-top:26px;max-width:90px;padding:0 26px;text-align:center}.Post-module--post--mo55f .Post-module--button--27HfC:focus,.Post-module--post--mo55f .Post-module--button--27HfC:hover{color:#5c92ff}@media screen and (min-width:960px){.Post-module--post--mo55f .Post-module--comments--2bE-0,.Post-module--post--mo55f .Post-module--footer--NpFTW{padding:0}.Post-module--post--mo55f .Post-module--button--27HfC{left:30px;margin:0;max-width:none;position:fixed;top:30px}}</style><link rel="alternate" type="application/rss+xml" title="Blog by Jonathan Dai" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-FHVTN0K4SH"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FHVTN0K4SH', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=bc5f0053fc3ffc2dfb62b5abaa975347" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=bc5f0053fc3ffc2dfb62b5abaa975347"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">NSQ Note - Blog by Jonathan Dai</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--36KWw"><div class="Post-module--post--mo55f"><a class="Post-module--button--27HfC" href="/">All Articles</a><div class="Post-module--content--3cRzw"><div class="Content-module--content--3dNJJ"><h1 class="Content-module--title--3vQh6">NSQ Note</h1><div class="Content-module--body--3LJXt"><div class="table-of-contents">
<ul>
<li><a href="#1-%E5%89%8D%E8%A8%80">1. 前言</a></li>
<li><a href="#2-%E7%AE%80%E4%BB%8B">2. 简介</a></li>
<li><a href="#3-%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8">3. 入门使用</a>
<ul>
<li><a href="#31-%E7%BB%84%E4%BB%B6">3.1 组件</a></li>
<li><a href="#32-%E7%9B%91%E6%8E%A7">3.2 监控</a></li>
</ul>
</li>
<li><a href="#4-%E7%BB%86%E8%8A%82%E6%B7%B1%E5%85%A5">4. 细节深入</a>
<ul>
<li><a href="#nsqd%E6%B6%88%E6%81%AF%E4%B8%8D%E6%8C%81%E4%B9%85">nsqd消息不持久</a></li>
<li><a href="#at-least-once">at least once</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E7%9A%84%E6%8A%95%E9%80%92%E6%98%AF%E6%97%A0%E5%BA%8F%E7%9A%84">消息的投递是无序的</a></li>
<li><a href="#nsqlookupd%E5%BB%B6%E8%BF%9F">nsqlookupd延迟</a></li>
<li><a href="#%E6%80%A7%E8%83%BD">性能</a></li>
<li><a href="#topic%E5%92%8Cchannel">topic和channel</a></li>
<li><a href="#%E8%87%AA%E5%8A%A8%E6%B6%88%E5%A4%B1%E7%9A%84topic%E5%92%8Cchannel">自动消失的topic和channel</a></li>
<li><a href="#max-in-flight">max-in-flight</a></li>
<li><a href="#%E5%87%8F%E8%BD%BBgc%E5%8E%8B%E5%8A%9B">减轻GC压力</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">消息生命周期</a></li>
<li><a href="#admin-metrics">Admin Metrics</a></li>
</ul>
</li>
<li><a href="#5-%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B">5. 使用范例</a>
<ul>
<li><a href="#pubbeforesub">pubBeforeSub</a></li>
<li><a href="#samemessagemultichannel">sameMessageMultiChannel</a></li>
<li><a href="#subbeforepub">subBeforePub</a></li>
<li><a href="#errormessage">errorMessage</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="1-前言" style="position:relative;"><a href="#1-%E5%89%8D%E8%A8%80" aria-label="1 前言 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 前言</h2>
<p>说到消息队列一般就会直接想起Kafka、Rocket、Rabbit之类的全功能消息队列。但实际上在应用程序制作的过程中，我们也很需要一些小而精巧的消息队列用来进行某些业务上的解耦，或者降低主业务的消耗、耗时等。 类似于redis作者的这个：<a href="https://github.com/antirez/disque" target="_blank" rel="nofollow noopener noreferrer">antirez / disque</a>。其中Nsq就是一款非常小巧而实用的消息队列，特别是它还基于Go语言编写，特别符合性能要求以及当前云原生的大方向。</p>
<h2 id="2-简介" style="position:relative;"><a href="#2-%E7%AE%80%E4%BB%8B" aria-label="2 简介 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. 简介</h2>
<p>Nsq的官方网站在：<a href="https://nsq.io/" target="_blank" rel="nofollow noopener noreferrer">nsq.io</a>。</p>
<p>一些比较关键的文档位置：</p>
<ul>
<li><a href="https://nsq.io/overview/quick_start.html" target="_blank" rel="nofollow noopener noreferrer">Quick Start</a>：快速上手使用</li>
<li><a href="https://nsq.io/overview/features_and_guarantees.html" target="_blank" rel="nofollow noopener noreferrer">FEATURES &#x26; GUARANTEES</a>：一些核心功能点，和需要注意的特性</li>
<li><a href="https://nsq.io/overview/faq.html" target="_blank" rel="nofollow noopener noreferrer">FAQ</a></li>
<li><a href="https://nsq.io/overview/performance.html" target="_blank" rel="nofollow noopener noreferrer">Performance</a>：官方的性能测试指标</li>
<li><a href="https://nsq.io/overview/design.html" target="_blank" rel="nofollow noopener noreferrer">Design</a>：Nsq的核心设计，应该是所有官方文档中最重要的一篇了</li>
<li><a href="https://nsq.io/overview/internals.html" target="_blank" rel="nofollow noopener noreferrer">INTERNALS</a>：一些Nsq内部实现相关的细节</li>
</ul>
<p>此外，还有一份PPT，虽然年代比较久远了（2012年），但基本上把所有Nsq中比较重要的点都提及到了，如果需要快速过一遍的话，看这篇PPT也是个不错的选择：<a href="https://speakerdeck.com/snakes/nsq-nyc-golang-meetup" target="_blank" rel="nofollow noopener noreferrer">NSQ - NYC Golang Meetup</a>。</p>
<h2 id="3-入门使用" style="position:relative;"><a href="#3-%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8" aria-label="3 入门使用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. 入门使用</h2>
<p>快速入门可以查看官方文档：<a href="https://nsq.io/overview/quick_start.html" target="_blank" rel="nofollow noopener noreferrer">Quick Start</a>。Node的npm包在：<a href="https://www.npmjs.com/package/nsqjs" target="_blank" rel="nofollow noopener noreferrer">nsqjs</a>。</p>
<h3 id="31-组件" style="position:relative;"><a href="#31-%E7%BB%84%E4%BB%B6" aria-label="31 组件 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.1 组件</h3>
<p>Nsq主要有3个组件：</p>
<ul>
<li>nsqd：真正的消息队列服务进程，消息收发都是由客户端直接和nsqd沟通完成，没有任何第三方中间成员</li>
<li>nsqlookupd：消息队列的拓扑管理，主要负责：
<ul>
<li>nsqd的注册，存活管理</li>
<li>topic和channel的管理，所有的topic有哪些，分别分布在哪几个nsqd上lookupd都知道</li>
<li>客户端会先到lookupd上查询目标的topic，找到之后再与某个匹配的nsqd进行连接，最后收发消息</li>
</ul>
</li>
<li>nsqadmin：管理界面，功能非常丰富</li>
</ul>
<p>关于各组件的启动参数，以及HTTP的API，都可以在官方文档中找到。需要记住的只有一点，末尾为0的端口都是TCP端口，1的端口都是HTTP端口。</p>
<ul>
<li><a href="https://nsq.io/components/nsqd.html" target="_blank" rel="nofollow noopener noreferrer">NSQD</a>
<ul>
<li><a href="https://nsq.io/components/nsqd.html#debugging-and-profiling" target="_blank" rel="nofollow noopener noreferrer">Debugging and Profiling</a></li>
<li><a href="https://nsq.io/components/nsqd.html#tls" target="_blank" rel="nofollow noopener noreferrer">TLS</a></li>
<li><a href="https://nsq.io/components/nsqd.html#auth" target="_blank" rel="nofollow noopener noreferrer">AUTH</a></li>
<li><a href="https://nsq.io/components/nsqd.html#end-to-end-processing-latency" target="_blank" rel="nofollow noopener noreferrer">End-to-End Processing Latency</a></li>
<li><a href="https://nsq.io/components/nsqd.html#statsd--graphite-integration" target="_blank" rel="nofollow noopener noreferrer">Statsd / Graphite Integration</a></li>
</ul>
</li>
<li><a href="https://nsq.io/components/nsqlookupd.html" target="_blank" rel="nofollow noopener noreferrer">NSQLOOKUPD</a>
<ul>
<li><a href="https://nsq.io/components/nsqlookupd.html#deletion-and-tombstones" target="_blank" rel="nofollow noopener noreferrer">Deletion and Tombstones</a></li>
</ul>
</li>
<li><a href="https://nsq.io/components/nsqadmin.html" target="_blank" rel="nofollow noopener noreferrer">NSQADMIN</a>
<ul>
<li><a href="https://nsq.io/components/nsqadmin.html#statsd--graphite-integration" target="_blank" rel="nofollow noopener noreferrer">statsd / Graphite Integration</a></li>
<li><a href="https://nsq.io/components/nsqadmin.html#admin-notifications" target="_blank" rel="nofollow noopener noreferrer">Admin Notifications</a></li>
<li><a href="https://nsq.io/components/nsqadmin.html#metrics" target="_blank" rel="nofollow noopener noreferrer">Metrics</a></li>
</ul>
</li>
<li><a href="https://nsq.io/components/utilities.html" target="_blank" rel="nofollow noopener noreferrer">UTILITIES</a>：一系列实用的Nsq工具组件
<ul>
<li><a href="https://nsq.io/components/utilities.html#nsq_stat" target="_blank" rel="nofollow noopener noreferrer">nsq_stat</a></li>
<li><a href="https://nsq.io/components/utilities.html#nsq_tail" target="_blank" rel="nofollow noopener noreferrer">nsq_tail</a></li>
<li><a href="https://nsq.io/components/utilities.html#nsq_to_file" target="_blank" rel="nofollow noopener noreferrer">nsq_to_file</a></li>
<li><a href="https://nsq.io/components/utilities.html#nsq_to_http" target="_blank" rel="nofollow noopener noreferrer">nsq_to_http</a></li>
<li><a href="https://nsq.io/components/utilities.html#nsq_to_nsq" target="_blank" rel="nofollow noopener noreferrer">nsq_to_nsq</a></li>
<li><a href="https://nsq.io/components/utilities.html#to_nsq" target="_blank" rel="nofollow noopener noreferrer">to_nsq</a></li>
</ul>
</li>
</ul>
<h3 id="32-监控" style="position:relative;"><a href="#32-%E7%9B%91%E6%8E%A7" aria-label="32 监控 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3.2 监控</h3>
<p>作为go语言编写的组件，理所当然的Nsq的各组件会暴露HTTP的<code class="language-text">/debug/pprof</code>终端，作为性能查询的输出终端。</p>
<h2 id="4-细节深入" style="position:relative;"><a href="#4-%E7%BB%86%E8%8A%82%E6%B7%B1%E5%85%A5" aria-label="4 细节深入 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. 细节深入</h2>
<p>接下来的章节，我会把所有我个人觉得比较重要的Nsq相关内容都列进去。</p>
<h3 id="nsqd消息不持久" style="position:relative;"><a href="#nsqd%E6%B6%88%E6%81%AF%E4%B8%8D%E6%8C%81%E4%B9%85" aria-label="nsqd消息不持久 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nsqd消息不持久</h3>
<p>默认行为是所有收到的消息都存储在nsqd的内存中，且没有任何内建的replication机制。所以默认情况下，节点挂掉的话，消息会丢失，如果这种情况不可接受，就需要自己做一些机制来规避消息丢失。</p>
<p><code class="language-text">--mem-queue-size</code>参数可以限定存储在内存中的消息数量，如果超量，则会将后续的消息存储在磁盘上。将该值设置为0可以将消息全部存储在磁盘上。</p>
<h3 id="at-least-once" style="position:relative;"><a href="#at-least-once" aria-label="at least once permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>at least once</h3>
<p>消息消费失败或超时会requeue，并在后续重新进行分发，所以一条消息可能会被多次投递到client进行消费，以保证该消息确定被消费完毕。消费者需要做好幂等，否则一条消息可能会别重复消费多次。</p>
<h3 id="消息的投递是无序的" style="position:relative;"><a href="#%E6%B6%88%E6%81%AF%E7%9A%84%E6%8A%95%E9%80%92%E6%98%AF%E6%97%A0%E5%BA%8F%E7%9A%84" aria-label="消息的投递是无序的 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息的投递是无序的</h3>
<p>nsqd只管将消息按顺序投递出去，但消息可能因为网络原因等导致最终消费的顺序和投递的顺序不一致。</p>
<h3 id="nsqlookupd延迟" style="position:relative;"><a href="#nsqlookupd%E5%BB%B6%E8%BF%9F" aria-label="nsqlookupd延迟 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>nsqlookupd延迟</h3>
<p>服务发现被设计为最终一致。在扩散的过程中，可能会有时间差。客户端会最终从nsqlookupd获得所有的topic信息。</p>
<p>测试应用中很可能出现的一情况就是：nsqlookupd上并没有任何topic消息，producer创建，nsqd上创建出topic，并在之后同步topic信息到nsqlookupd。而在这之前早得多consumer就已经连上nsqlookupd并没有收到任何topic的信息，这中间会有一个时间差。consumer会静止在那里，直到配置的lookup间隔时间到了，然后consumer会再次查询nsqlookupd，并最终或得到topic信息以及所属的nsqd。</p>
<p>可以看下这几个comment：</p>
<ul>
<li><a href="https://github.com/nsqio/nsqio.github.io/issues/42#issuecomment-432905203" target="_blank" rel="nofollow noopener noreferrer">docs: clarify when topics are created automatically #42 #comment-432905203</a></li>
<li><a href="https://github.com/nsqio/nsqio.github.io/issues/42#issuecomment-432905514" target="_blank" rel="nofollow noopener noreferrer">docs: clarify when topics are created automatically #42 #comment-432905514</a></li>
</ul>
<h3 id="性能" style="position:relative;"><a href="#%E6%80%A7%E8%83%BD" aria-label="性能 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>性能</h3>
<p>看官方文档：<a href="https://nsq.io/overview/performance.html" target="_blank" rel="nofollow noopener noreferrer">Performance</a>。</p>
<h3 id="topic和channel" style="position:relative;"><a href="#topic%E5%92%8Cchannel" aria-label="topic和channel permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>topic和channel</h3>
<p>估计这是使用Nsq的程序员最初最难搞懂的东西。一般来说其他的消息队列都是将消息发布到topic中，然后多个consumer消费一个topic。但Nsq在topic和consumer之间还插入了一个channel的概念。</p>
<p>这里主要是看一个图：</p>
<p><img src="/media/posts/2020/12/nsq-note/nsq_topic_channel.gif" alt=""></p>
<p>需要理解的最重要的概念是，同一个topic下的所有channel，都会得到进入topic的消息的拷贝。同样一份消息，进入topic后会分别拷贝并进入每一个channel，每个channel都需要各自的consumer把消息消费掉，否则就会造成消息积压。</p>
<p>简单来说：如果你希望和一般的消息队列一样的 topic => consumers，那么就让所有该topic下的消费者使用同一个channel即可。</p>
<p>channel的设计让Nsq可以做一些其他消息队列做不到的用途，最为常见的是：消息广播。多个consumer都需要在某个业务触发的时候得到通知，那么就在某个topic下，让所有的consumer都定义一个自己的channel连接进去（topic_channel_node_1/…），这样所有的consumer都各自占据了一个channel，而所有的channel都会得到topic内消息的拷贝，所以他们会都得到同样的消息通知。</p>
<h3 id="自动消失的topic和channel" style="position:relative;"><a href="#%E8%87%AA%E5%8A%A8%E6%B6%88%E5%A4%B1%E7%9A%84topic%E5%92%8Cchannel" aria-label="自动消失的topic和channel permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>自动消失的topic和channel</h3>
<p>topic和channel都是持久化的，默认情况下在创建成功后，他们都是不会自动消失的，时间长了之后清理就会比较麻烦。而上面的例子中那种类似消息通知的情况，其实topic和channel都是生命周期非常短暂的，一般我们希望他们在没用了之后就被销毁掉。</p>
<p>在topic和channel的名字后面添加<code class="language-text">#ephemeral</code>可以做到这点，当所有连接在topic或channel上的producer/consumer都断开连接之后，nsqd就会自动删除该topic或channel。</p>
<p>需要注意的是，<code class="language-text">#ephemeral</code>命名的topic/channel在超过<code class="language-text">--mem-queue-size</code>的限制之后不会将消息写入磁盘，而是直接丢弃。这点行为上和普通的topic/channel非常不同，一定要小心注意。</p>
<h3 id="max-in-flight" style="position:relative;"><a href="#max-in-flight" aria-label="max in flight permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>max-in-flight</h3>
<p>客户端可以设置该值（比如说10），然后客户端在连接到nsqd的时候会发送<code class="language-text">RDY 10</code>过去，nsqd就会知道该client的同时处理能力。在接下来的消息推送过程中，nsqd会不断向该client推送消息，直到目前已分发且尚未反馈结果的消息数量达到该数值（10）为止。这是为了更好的性能，client程序如果实现了多线程的话，可以充分利用线程和CPU来消费消息，而不是只有一个线程在工作，其他的都在闲置。</p>
<p>对于node程序来说，这个数值就没有意义了，因为node进程只有一个工作线程。</p>
<p>还可以看下这个comment：<a href="https://github.com/nsqio/go-nsq/issues/221#issuecomment-352865779" target="_blank" rel="nofollow noopener noreferrer">Question about concurrency and Max in Flight #221</a>。</p>
<h3 id="减轻gc压力" style="position:relative;"><a href="#%E5%87%8F%E8%BD%BBgc%E5%8E%8B%E5%8A%9B" aria-label="减轻gc压力 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>减轻GC压力</h3>
<p>见官方文档：<a href="https://nsq.io/overview/internals.html#reducing-gc-pressure" target="_blank" rel="nofollow noopener noreferrer">Reducing GC Pressure</a>。</p>
<h3 id="消息生命周期" style="position:relative;"><a href="#%E6%B6%88%E6%81%AF%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-label="消息生命周期 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>消息生命周期</h3>
<p>一条消息的生命周期（消费端）主要是控制在client手中，这点和普通的消息队列的设计理念完全不同，这里需要花点时间稍微整理下。</p>
<p>消息的创建是producer连接到nsqd，并进行publish的操作，这点没有任何问题。创建成功消息就收到了，失败的话，则消息在nsqd上不存在。</p>
<p>消息的消费由nsqd向连接的consumer进行推送：</p>
<ul>
<li>消息已分发且尚未反馈（未到超时时间），状态：In-Flight</li>
<li>消息已分发且超时没有反馈（该超时的时长是在客户端设置的！），状态：Time Out，该消息会被nsqd重新requeue（REQ）
<ul>
<li>消息在处理中，且耗时很长，可以由客户端进行 Touch，这样该消息就不会Time Out</li>
</ul>
</li>
<li>消息发送后，可以由客户端主动进行requeue（REQ）
<ul>
<li>requeue行为可以附带设置延迟（Deferred）</li>
</ul>
</li>
<li>消息发送后，如果客户端出错被认为是有问题的，客户端自身需要恢复，则客户端可以将该消息反馈为backoff，这个操作会导致：
<ul>
<li>nsqd会将该消息requeue，消息本身会再次（如果设置延迟的话，也会Deferred）分发</li>
<li>此外这个操作会导致客户端将自身的RDY设置为0，意味着这个客户端短时间内将拒绝处理任何消息</li>
</ul>
</li>
<li>消息发送后，如果该消息之前被requeue则该消息会附带Attempts（重试）数，客户端在尝试失败后，会匹配失败次数，如果超过限制，则该消息会被DISCARD，即客户端会直接将该消息标记为Finished（FIN）
<ul>
<li>如果客户端的max attempts设置为0，则可以无限次重试，不会被discard</li>
</ul>
</li>
<li>消息发送后，可以由客户端标记为完成Finished（FIN）</li>
</ul>
<p>可以看到Nsq的客户端有很大的权利，特别是失败重试的决策是由客户端做的，如果超限消息就会被丢弃，标记为完成。</p>
<p>更多关于Timeout相关，请见comment：<a href="https://github.com/nsqio/nsq/issues/1028#issuecomment-385126434" target="_blank" rel="nofollow noopener noreferrer">Timeout options #1028</a>。</p>
<p>关于requeue和backoff的详细分析，可以看这篇：<a href="https://github.com/judwhite/NsqSharp/wiki/NSQ-Requeue-and-Backoff" target="_blank" rel="nofollow noopener noreferrer">NSQ Requeue and Backoff</a>。</p>
<h3 id="admin-metrics" style="position:relative;"><a href="#admin-metrics" aria-label="admin metrics permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://nsq.io/components/nsqadmin.html#metrics" target="_blank" rel="nofollow noopener noreferrer">Admin Metrics</a></h3>
<p>Admin统计数据里的一些词汇可以简单解释下：</p>
<p>Message Queues：</p>
<ul>
<li>Depth：当前存储在内存和磁盘上的消息总量（尚未被分发）</li>
<li>In-Flight：目前已经被分发，但尚未被标记为 完成（FIN）、重新入队（REQ）或是超时的消息总量</li>
<li>Deferred：目前被重新入队且显式标记为推迟处理并且尚未到重新分发阶段的消息总量</li>
</ul>
<p>Statistics：</p>
<ul>
<li>Requeued：消息因超时或被显式要求而重新入队的次数</li>
<li>Timed Out：消息因超过设定的超时时长未响应，而被标记为超时的次数</li>
<li>Messages：在节点启动之后收到的消息总数</li>
<li>Rate：过去两次statsd间隔间，每秒新收到的消息数量</li>
<li>Connections：连接总数</li>
</ul>
<p>Client Connections：</p>
<ul>
<li>NSQd Host：Address of the nsqd node this client is connected to.</li>
<li>In-flight：当前发送给该client等待返回的消息数量</li>
<li>Ready Count：当前client节点最高in-flight可能的消息数量</li>
<li>Finished：所有当前client节点标记为FIN的消息数量</li>
<li>Requeued：同上，REQ</li>
<li>Messages：所有发送给该client节点的消息数量</li>
</ul>
<h2 id="5-使用范例" style="position:relative;"><a href="#5-%E4%BD%BF%E7%94%A8%E8%8C%83%E4%BE%8B" aria-label="5 使用范例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. 使用范例</h2>
<p>光说理论上的东西比较枯燥，实践操作也是比较重要的，下面可以通过几个例子来看下Nsq的一些行为。</p>
<h3 id="pubbeforesub" style="position:relative;"><a href="#pubbeforesub" aria-label="pubbeforesub permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pubBeforeSub</h3>
<p>If there is no topic on <code class="language-text">nsqd</code> (first execution), reader will suck for a long time. Since at the first time reader connect to lookupd, there hasn’t been updated with the published topics info yet. So it will suck until readers retrieve topics info next time.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pubBeforeSub:
    Two writers initialized
    Two writers publish <span class="token number">3</span> messages each into topic <span class="token string">"TOPIC1"</span> <span class="token punctuation">(</span>total <span class="token number">6</span><span class="token punctuation">)</span>
    One of the writer publish <span class="token number">1</span> message into topic <span class="token string">"TOPIC2_UNI"</span>
    Two readers created <span class="token keyword">for</span> topic <span class="token string">"TOPIC1"</span> with the same channel <span class="token string">"TOPIC1_READER_CHANNEL"</span>
    One reader created <span class="token keyword">for</span> topic <span class="token string">"TOPIC2_UNI"</span> with channel <span class="token string">"TOPIC2_UNI#ephemeral"</span>
    -
    Two readers share the total <span class="token number">6</span> messages <span class="token keyword">in</span> topic <span class="token string">"TOPIC1"</span>
    One reader consume the message <span class="token keyword">in</span> topic <span class="token string">"TOPIC2_UNI"</span></code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">➜  couchnsq git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ ./bash/nsq_run.sh
  Nsq:Writer:bgF6l bgF6l: ready +0ms
  Nsq:Writer:Plwtx Plwtx: ready +0ms
  Nsq:Reader:oiFQg oiFQg: nsqd connected: <span class="token string">"10.10.2.126:4250"</span> +0ms
  Nsq:Reader:oiFQg oiFQg: nsqd connected: <span class="token string">"10.10.2.126:4150"</span> +0ms
  Nsq:Reader:MmLbX MmLbX: nsqd connected: <span class="token string">"10.10.2.126:4250"</span> +0ms
  Nsq:Reader:MmLbX MmLbX: nsqd connected: <span class="token string">"10.10.2.126:4150"</span> +0ms
  Nsq:Reader:8hpju 8hpju: nsqd connected: <span class="token string">"10.10.2.126:4250"</span> +0ms
  Nsq:Reader:oiFQg oiFQg: message 0e38318eeb01e000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC1:jQ77FfY8lS<span class="token string">"}"</span> +16ms
  Nsq:Message oiFQg: message 0e38318eeb01e000 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eeb01e000
  Nsq:Message "</span> +0ms
  Nsq:Reader:MmLbX MmLbX: message 0e38318eeb01e001 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC1:ONvD8mH4Jq<span class="token string">"}"</span> +16ms
  Nsq:Message MmLbX: message 0e38318eeb01e001 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eeb01e001
  Nsq:Message "</span> +1ms
  Nsq:Reader:8hpju 8hpju: ready +17ms
  Nsq:Reader:MmLbX MmLbX: message 0e38318eeb01e002 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC1:7xjankTlzU<span class="token string">"}"</span> +3ms
  Nsq:Message MmLbX: message 0e38318eeb01e002 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eeb01e002
  Nsq:Message "</span> +3ms
  Nsq:Reader:oiFQg oiFQg: message 0e38318eeb435000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC1:bQOiIt7BLE<span class="token string">"}"</span> +5ms
  Nsq:Message oiFQg: message 0e38318eeb435000 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eeb435000
  Nsq:Message "</span> +1ms
  Nsq:Reader:8hpju 8hpju: message 0e38318eec435000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC2_UNI:Ms10V0jtpc<span class="token string">"}"</span> +3ms
  Nsq:Message 8hpju: message 0e38318eec435000 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eec435000
  Nsq:Message "</span> +1ms
  Nsq:Reader:MmLbX MmLbX: message 0e38318eeb435001 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC1:APZJDBiVP9<span class="token string">"}"</span> +3ms
  Nsq:Message MmLbX: message 0e38318eeb435001 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eeb435001
  Nsq:Message "</span> +1ms
  Nsq:Reader:MmLbX MmLbX: message 0e38318eeb435002 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC1:CXF6AQVBDr<span class="token string">"}"</span> +53ms
  Nsq:Message MmLbX: message 0e38318eeb435002 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38318eeb435002
  Nsq:Message "</span> +53ms
^C  Nsq:Writer:bgF6l bgF6l: closed +1m
  Nsq:Writer:Plwtx Plwtx: closed +1m
  Nsq:Reader:oiFQg oiFQg: notReady +26s
  Nsq:Reader:MmLbX MmLbX: notReady +25s
  Nsq:Reader:8hpju 8hpju: notReady +26s
NsqTest: all cleared</code></pre></div>
<h3 id="samemessagemultichannel" style="position:relative;"><a href="#samemessagemultichannel" aria-label="samemessagemultichannel permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sameMessageMultiChannel</h3>
<p>Multiple channels subscribe the same topic will receive duplicate messages.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">sameMessageMultiChannel:
    Two writers initialized
    One of the writer publish <span class="token number">1</span> message into topic <span class="token string">"TOPIC_SAME"</span>
    Two readers created <span class="token keyword">for</span> topic <span class="token string">"TOPIC_SAME"</span> with two channels <span class="token string">"TOPIC_SAME_CHANNEL_1/2"</span> subscribe the same topic
    -
    Two readers receive the same message</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">➜  couchnsq git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ ./bash/nsq_run.sh
  Nsq:Writer:oeAOC oeAOC: ready +0ms
  Nsq:Writer:EdW9U EdW9U: ready +0ms
  Nsq:Reader:SuqpY SuqpY: nsqd connected: <span class="token string">"10.10.2.126:4250"</span> +0ms
  Nsq:Reader:vKCk9 vKCk9: nsqd connected: <span class="token string">"10.10.2.126:4250"</span> +0ms
  Nsq:Reader:vKCk9 vKCk9: ready +5ms
  Nsq:Reader:SuqpY SuqpY: ready +6ms
  Nsq:Reader:vKCk9 vKCk9: message 0e38322140035000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC_SAME:Hn4tB5UA0N<span class="token string">"}"</span> +3ms
  Nsq:Message vKCk9: message 0e38322140035000 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38322140035000
  Nsq:Message "</span> +0ms
  Nsq:Reader:SuqpY SuqpY: message 0e38322140035000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC_SAME:Hn4tB5UA0N<span class="token string">"}"</span> +3ms
  Nsq:Message SuqpY: message 0e38322140035000 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38322140035000
  Nsq:Message "</span> +0ms
^C  Nsq:Writer:oeAOC oeAOC: closed +3s
  Nsq:Writer:EdW9U EdW9U: closed +3s
  Nsq:Reader:vKCk9 vKCk9: notReady +3s
  Nsq:Reader:SuqpY SuqpY: notReady +3s
NsqTest: all cleared</code></pre></div>
<h3 id="subbeforepub" style="position:relative;"><a href="#subbeforepub" aria-label="subbeforepub permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>subBeforePub</h3>
<p>If the topic not deleted before execution (or first run). Reader will suck for a long time, the reason have been explained previously.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">subBeforePub:
    Two writers initialized
    One reader create to subscribe an non-existing topic <span class="token string">"TOPIC_UNKNOWN"</span>
    One of the writer <span class="token function">wait</span> 1000ms, <span class="token keyword">then</span> publish <span class="token number">1</span> message into topic <span class="token string">"TOPIC_UNKNOWN"</span>
    -
    One reader <span class="token function">wait</span> <span class="token keyword">for</span> a long <span class="token function">time</span> <span class="token keyword">then</span> receive the message</code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">➜  couchnsq git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ ./bash/nsq_run.sh
  Nsq:Writer:2Fr6p 2Fr6p: ready +0ms
  Nsq:Writer:vFIw5 vFIw5: ready +0ms
  Nsq:Reader:uR6Lp uR6Lp: nsqd connected: <span class="token string">"10.10.2.126:4150"</span> +0ms
  Nsq:Reader:uR6Lp uR6Lp: ready +5ms
  Nsq:Reader:uR6Lp uR6Lp: message 0e38323df741e000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>TOPIC_UNKNOWN:kCwBySUMY0<span class="token string">"}"</span> +984ms
  Nsq:Message uR6Lp: message 0e38323df741e000 respond: <span class="token string">"0"</span>, <span class="token string">"FIN 0e38323df741e000
  Nsq:Message "</span> +0ms
^C  Nsq:Writer:2Fr6p 2Fr6p: closed +3s
  Nsq:Writer:vFIw5 vFIw5: closed +3s
  Nsq:Reader:uR6Lp uR6Lp: notReady +2s
NsqTest: all cleared</code></pre></div>
<h3 id="errormessage" style="position:relative;"><a href="#errormessage" aria-label="errormessage permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>errorMessage</h3>
<p>Send error message, and message would be requeue with backoff in the reader, finally it would be discarded (finished).</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"maxAttempts"</span><span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">➜  couchnsq git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ ./bash/nsq_run.sh
  Nsq:Writer:5P9rd 5P9rd: ready +0ms
  Nsq:Writer:KKhyz KKhyz: ready +0ms
  Nsq:Reader:hSWmK hSWmK: nsqd connected: <span class="token string">"10.10.2.126:4150"</span> +0ms
  Nsq:Reader:hSWmK hSWmK: ready +5ms
  Nsq:Reader:hSWmK hSWmK: message 0e3832a5bb01e000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>should throw error:WGZ9VlLLPa<span class="token string">"}"</span> +4ms
  Nsq:Reader:hSWmK hSWmK: message 0e3832a5bb01e000 error <span class="token operator">&amp;</span> requeue, attempts: <span class="token number">1</span> +1ms
  Nsq:Message hSWmK: message 0e3832a5bb01e000 backoff +0ms
  Nsq:Message hSWmK: message 0e3832a5bb01e000 respond: <span class="token string">"1"</span>, <span class="token string">"REQ 0e3832a5bb01e000 2000
  Nsq:Message "</span> +1ms
  Nsq:Reader:hSWmK hSWmK: message 0e3832a5bb01e000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>should throw error:WGZ9VlLLPa<span class="token string">"}"</span> +4s
  Nsq:Reader:hSWmK hSWmK: message 0e3832a5bb01e000 error <span class="token operator">&amp;</span> requeue, attempts: <span class="token number">2</span> +0ms
  Nsq:Message hSWmK: message 0e3832a5bb01e000 backoff +4s
  Nsq:Message hSWmK: message 0e3832a5bb01e000 respond: <span class="token string">"1"</span>, <span class="token string">"REQ 0e3832a5bb01e000 2000
  Nsq:Message "</span> +0ms
  Nsq:Reader:hSWmK hSWmK: message 0e3832a5bb01e000 got: <span class="token string">"{"</span>msg<span class="token string">":"</span>should throw error:WGZ9VlLLPa<span class="token string">"}"</span> +7s
  Nsq:Reader:hSWmK hSWmK: message 0e3832a5bb01e000 error <span class="token operator">&amp;</span> requeue, attempts: <span class="token number">3</span> +0ms
  Nsq:Message hSWmK: message 0e3832a5bb01e000 backoff +7s
  Nsq:Message hSWmK: message 0e3832a5bb01e000 respond: <span class="token string">"1"</span>, <span class="token string">"REQ 0e3832a5bb01e000 2000
  Nsq:Message "</span> +0ms
  Nsq:Reader:hSWmK hSWmK: message discarded: <span class="token string">"{"</span>msg<span class="token string">":"</span>should throw error:WGZ9VlLLPa<span class="token string">"}"</span> +11s
^C  Nsq:Writer:5P9rd 5P9rd: closed +23s
  Nsq:Writer:KKhyz KKhyz: closed +23s
  Nsq:Reader:hSWmK hSWmK: notReady +2s
NsqTest: all cleared</code></pre></div>
<blockquote>
<p>EOF</p>
</blockquote></div></div></div><div class="Post-module--footer--NpFTW"><div class="Meta-module--meta--3YYBJ"><p class="Meta-module--date--U0EV3">Published<!-- --> <!-- -->2020/12/31</p></div><div class="Tags-module--tags--1r6Jk"><ul class="Tags-module--list--3a6Ka"><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/nsq/">Nsq</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/messagequeue/">MessageQueue</a></li><li class="Tags-module--item--2JSXQ"><a class="Tags-module--link--hkiai" href="/tag/keynote/">Keynote</a></li></ul></div><div class="Author-module--author--2kT-Q"><p class="Author-module--bio--2YX8-">Some tech &amp; personal blog posts<a class="Author-module--twitter--1B6I5" href="https://github.com/agreatfool" rel="noopener noreferrer" target="_blank"><strong>Jonathan Dai</strong> on Github</a></p></div></div><div class="Post-module--comments--2bE-0"><div id="disqus_thread"></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2020/12/nsq-note";window.___webpackCompilationHash="0d4aee76ea314ec4b292";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-e212462f23ca5a50f487.js"],"app":["/app-0f92688bebb8baf761b5.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-0c915c7b1bdb5eac4fdf.js"],"component---src-templates-categories-template-categories-template-tsx":["/component---src-templates-categories-template-categories-template-tsx-94c6e6f05e922a0131c9.js"],"component---src-templates-category-template-category-template-tsx":["/component---src-templates-category-template-category-template-tsx-f517b0c0105ad6c2232c.js"],"component---src-templates-index-template-index-template-tsx":["/component---src-templates-index-template-index-template-tsx-3866c4783dc8a0fe6798.js"],"component---src-templates-not-found-template-not-found-template-tsx":["/component---src-templates-not-found-template-not-found-template-tsx-4cf57627eba764adc6f2.js"],"component---src-templates-page-template-page-template-tsx":["/component---src-templates-page-template-page-template-tsx-3e9c924c62fa8a8ed11c.js"],"component---src-templates-post-template-post-template-tsx":["/component---src-templates-post-template-post-template-tsx-97307c6a1e144b6353c9.js"],"component---src-templates-tag-template-tag-template-tsx":["/component---src-templates-tag-template-tag-template-tsx-2e76e7e6d3fd88dd1c96.js"],"component---src-templates-tags-template-tags-template-tsx":["/component---src-templates-tags-template-tags-template-tsx-7f2df64aecbc4949dcce.js"]};/*]]>*/</script><script src="/polyfill-e212462f23ca5a50f487.js" nomodule=""></script><script src="/app-0f92688bebb8baf761b5.js" async=""></script><script src="/framework-c14ed818a88fa3beed0f.js" async=""></script><script src="/webpack-runtime-c4f132164b75f788a4e6.js" async=""></script></body></html>